<!DOCTYPE html><html lang="zh-hans" dir="ltr"><head><meta charSet="utf-8"/><link rel="preconnect" href="https://1FCF9AYYAT-dsn.algolia.net"/><link rel="preload" as="style" href="/_next/static/css/69c3dd7f95e90f41.css"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-B1E83PJ3RT"></script><link rel="preload" as="script" href="/_next/static/chunks/webpack-7aa5606533a0da22.js"/><link rel="preload" as="script" href="/_next/static/chunks/framework-60dbcc17f2b10a40.js"/><link rel="preload" as="script" href="/_next/static/chunks/main-691602c61f9ae952.js"/><link rel="preload" as="script" href="/_next/static/chunks/pages/_app-91cab47494e285be.js"/><link rel="preload" as="script" href="/_next/static/chunks/181-0c884f228c508338.js"/><link rel="preload" as="script" href="/_next/static/chunks/962-d27b3139d5233d22.js"/><link rel="preload" as="script" href="/_next/static/chunks/pages/%5B%5B...markdownPath%5D%5D-3fa615249ba59b83.js"/><link rel="preload" as="script" href="/_next/static/o3sV9gi4zL8eH-vfCdLA_/_buildManifest.js"/><link rel="preload" as="script" href="/_next/static/o3sV9gi4zL8eH-vfCdLA_/_ssgManifest.js"/><link rel="preload" href="/fonts/Source-Code-Pro-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><link rel="preload" href="https://react.dev/fonts/Optimistic_Display_W_Md.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><link rel="preload" href="https://react.dev/fonts/Optimistic_Display_W_SBd.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><link rel="preload" href="https://react.dev/fonts/Optimistic_Display_W_Bd.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><link rel="preload" href="https://react.dev/fonts/Optimistic_Text_W_Md.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><link rel="preload" href="https://react.dev/fonts/Optimistic_Text_W_Bd.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><link rel="preload" href="https://react.dev/fonts/Optimistic_Text_W_Rg.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><link rel="preload" href="https://react.dev/fonts/Optimistic_Text_W_It.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><link rel="preload" href="/_next/static/css/69c3dd7f95e90f41.css" as="style"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>使用 Effect 进行同步 – React 中文文档</title><link rel="canonical" href="https://zh-hans.react.dev/learn/synchronizing-with-effects"/><link rel="alternate" href="https://react.dev/learn/synchronizing-with-effects" hrefLang="x-default"/><link rel="alternate" hrefLang="en" href="https://react.dev/learn/synchronizing-with-effects"/><link rel="alternate" hrefLang="zh-hans" href="https://zh-hans.react.dev/learn/synchronizing-with-effects"/><link rel="alternate" hrefLang="es" href="https://es.react.dev/learn/synchronizing-with-effects"/><link rel="alternate" hrefLang="fr" href="https://fr.react.dev/learn/synchronizing-with-effects"/><link rel="alternate" hrefLang="ja" href="https://ja.react.dev/learn/synchronizing-with-effects"/><link rel="alternate" hrefLang="tr" href="https://tr.react.dev/learn/synchronizing-with-effects"/><link rel="alternate" hrefLang="ko" href="https://ko.react.dev/learn/synchronizing-with-effects"/><meta property="fb:app_id" content="623268441017527"/><meta property="og:type" content="website"/><meta property="og:url" content="https://zh-hans.react.dev/learn/synchronizing-with-effects"/><meta property="og:title" content="使用 Effect 进行同步 – React 中文文档"/><meta property="og:description" content="The library for web and native user interfaces"/><meta property="og:image" content="https://zh-hans.react.dev/images/og-learn.png"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@reactjs"/><meta name="twitter:creator" content="@reactjs"/><meta name="twitter:title" content="使用 Effect 进行同步 – React 中文文档"/><meta name="twitter:description" content="The library for web and native user interfaces"/><meta name="twitter:image" content="https://zh-hans.react.dev/images/og-learn.png"/><meta name="google-site-verification" content="sIlAGs48RulR4DdP95YSWNKZIEtCqQmRjzn-Zq-CcD0"/><meta name="algolia-search-order" content="43"/><meta name="next-head-count" content="36"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/><link rel="manifest" href="/site.webmanifest"/><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#404756"/><meta name="msapplication-TileColor" content="#2b5797"/><meta name="theme-color" content="#23272f"/><link rel="preload" as="image" imageSrcSet="/_next/image?url=%2Fimages%2Fuwu.png&amp;w=64&amp;q=75 1x, /_next/image?url=%2Fimages%2Fuwu.png&amp;w=128&amp;q=75 2x" fetchPriority="high"/><link rel="stylesheet" href="/_next/static/css/69c3dd7f95e90f41.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" noModule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-7aa5606533a0da22.js" defer=""></script><script src="/_next/static/chunks/framework-60dbcc17f2b10a40.js" defer=""></script><script src="/_next/static/chunks/main-691602c61f9ae952.js" defer=""></script><script src="/_next/static/chunks/pages/_app-91cab47494e285be.js" defer=""></script><script src="/_next/static/chunks/181-0c884f228c508338.js" defer=""></script><script src="/_next/static/chunks/962-d27b3139d5233d22.js" defer=""></script><script src="/_next/static/chunks/pages/%5B%5B...markdownPath%5D%5D-3fa615249ba59b83.js" defer=""></script><script src="/_next/static/o3sV9gi4zL8eH-vfCdLA_/_buildManifest.js" defer=""></script><script src="/_next/static/o3sV9gi4zL8eH-vfCdLA_/_ssgManifest.js" defer=""></script></head><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());gtag('config', 'G-B1E83PJ3RT');</script><body class="font-text font-medium antialiased text-lg bg-wash dark:bg-wash-dark text-secondary dark:text-secondary-dark leading-base"><script>
              (function () {
                try {
                  let logShown = false;
                  function setUwu(isUwu) {
                    try {
                      if (isUwu) {
                        localStorage.setItem('uwu', true);
                        document.documentElement.classList.add('uwu');
                        if (!logShown) {
                          console.log('uwu mode! turn off with ?uwu=0');
                          console.log('logo credit to @sawaratsuki1004 via https://github.com/SAWARATSUKI/ServiceLogos');
                          logShown = true;
                        }
                      } else {
                        localStorage.removeItem('uwu');
                        document.documentElement.classList.remove('uwu');
                        console.log('uwu mode off. turn on with ?uwu');
                      }
                    } catch (err) { }
                  }
                  window.__setUwu = setUwu;
                  function checkQueryParam() {
                    const params = new URLSearchParams(window.location.search);
                    const value = params.get('uwu');
                    switch(value) {
                      case '':
                      case 'true':
                      case '1':
                        return true;
                      case 'false':
                      case '0':
                        return false;
                      default:
                        return null;
                    }
                  }
                  function checkLocalStorage() {
                    try {
                      return localStorage.getItem('uwu') === 'true';
                    } catch (err) {
                      return false;
                    }
                  }
                  const uwuQueryParam = checkQueryParam();
                  if (uwuQueryParam != null) {
                    setUwu(uwuQueryParam);
                  } else if (checkLocalStorage()) {
                    document.documentElement.classList.add('uwu');
                  }
                } catch (err) { }
              })();
            </script><script>
                (function () {
                  function setTheme(newTheme) {
                    window.__theme = newTheme;
                    if (newTheme === 'dark') {
                      document.documentElement.classList.add('dark');
                    } else if (newTheme === 'light') {
                      document.documentElement.classList.remove('dark');
                    }
                  }

                  var preferredTheme;
                  try {
                    preferredTheme = localStorage.getItem('theme');
                  } catch (err) { }

                  window.__setPreferredTheme = function(newTheme) {
                    preferredTheme = newTheme;
                    setTheme(newTheme);
                    try {
                      localStorage.setItem('theme', newTheme);
                    } catch (err) { }
                  };

                  var initialTheme = preferredTheme;
                  var darkQuery = window.matchMedia('(prefers-color-scheme: dark)');

                  if (!initialTheme) {
                    initialTheme = darkQuery.matches ? 'dark' : 'light';
                  }
                  setTheme(initialTheme);

                  darkQuery.addEventListener('change', function (e) {
                    if (!preferredTheme) {
                      setTheme(e.matches ? 'dark' : 'light');
                    }
                  });

                  // Detect whether the browser is Mac to display platform specific content
                  // An example of such content can be the keyboard shortcut displayed in the search bar
                  document.documentElement.classList.add(
                      window.navigator.platform.includes('Mac')
                      ? "platform-mac" 
                      : "platform-win"
                  );
                })();
              </script><div id="__next"><div></div><div class="z-40 sticky top-0"><nav class="duration-300 backdrop-filter backdrop-blur-lg backdrop-saturate-200 transition-shadow bg-opacity-90 items-center w-full flex justify-between bg-wash dark:bg-wash-dark dark:bg-opacity-95 px-1.5 lg:pe-5 lg:ps-4 z-40"><div class="flex items-center justify-between w-full h-16 gap-0 sm:gap-3"><div class="flex flex-row 3xl:flex-1 items-centers"><button type="button" aria-label="Menu" class="active:scale-95 transition-transform flex lg:hidden w-12 h-12 rounded-full items-center justify-center hover:bg-primary/5 hover:dark:bg-primary-dark/5 outline-link"><svg width="1.33em" height="1.33em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button><span data-state="closed" class="flex items-center" style="-webkit-touch-callout:none"><div class="flex items-center"><div class="uwu-visible flex items-center justify-center h-full"><a href="/"><img alt="logo by @sawaratsuki1004" title="logo by @sawaratsuki1004" fetchPriority="high" width="63" height="32" decoding="async" data-nimg="1" class="h-8" style="color:transparent" srcSet="/_next/image?url=%2Fimages%2Fuwu.png&amp;w=64&amp;q=75 1x, /_next/image?url=%2Fimages%2Fuwu.png&amp;w=128&amp;q=75 2x" src="/_next/image?url=%2Fimages%2Fuwu.png&amp;w=128&amp;q=75"/></a></div><div class="uwu-hidden"><a class="active:scale-95 overflow-hidden transition-transform relative items-center text-primary dark:text-primary-dark p-1 whitespace-nowrap outline-link rounded-full 3xl:rounded-xl inline-flex text-lg font-normal gap-2" href="/"><svg width="100%" height="100%" viewBox="-10.5 -9.45 21 18.9" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-sm me-0 w-10 h-10 text-brand dark:text-brand-dark flex origin-center transition-all ease-in-out"><circle cx="0" cy="0" r="2" fill="currentColor"></circle><g stroke="currentColor" stroke-width="1" fill="none"><ellipse rx="10" ry="4.5"></ellipse><ellipse rx="10" ry="4.5" transform="rotate(60)"></ellipse><ellipse rx="10" ry="4.5" transform="rotate(120)"></ellipse></g></svg><span class="sr-only 3xl:not-sr-only">React</span></a></div></div></span><div class="flex flex-column justify-center items-center"><a class=" flex py-2 flex-column justify-center items-center text-gray-50 dark:text-gray-30 hover:text-link hover:dark:text-link-dark hover:underline text-sm ms-1 cursor-pointer" href="/versions">v<!-- -->18.3.1</a></div></div><div class="items-center justify-center flex-1 hidden w-full md:flex 3xl:w-auto 3xl:shrink-0 3xl:justify-center"><button type="button" class="flex 3xl:w-[56rem] 3xl:mx-0 relative ps-4 pe-1 py-1 h-10 bg-gray-30/20 dark:bg-gray-40/20 outline-none focus:outline-link betterhover:hover:bg-opacity-80 pointer items-center text-start w-full text-gray-30 rounded-full align-middle text-base"><svg width="1em" height="1em" viewBox="0 0 20 20" class="align-middle me-3 text-gray-30 shrink-0 group-betterhover:hover:text-gray-70"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" stroke-width="2" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg>搜索<span class="hidden ms-auto sm:flex item-center me-1"><kbd class="w-5 h-5 border border-transparent me-1 bg-wash dark:bg-wash-dark text-gray-30 align-middle p-0 inline-flex justify-center items-center text-xs text-center rounded-md" data-platform="mac">⌘</kbd><kbd class="w-10 h-5 border border-transparent me-1 bg-wash dark:bg-wash-dark text-gray-30 align-middle p-0 inline-flex justify-center items-center text-xs text-center rounded-md" data-platform="win">Ctrl</kbd><kbd class="w-5 h-5 border border-transparent me-1 bg-wash dark:bg-wash-dark text-gray-30 align-middle p-0 inline-flex justify-center items-center text-xs text-center rounded-md">K</kbd></span></button></div><div class="text-base justify-center items-center gap-1.5 flex 3xl:flex-1 flex-row 3xl:justify-end"><div class="mx-2.5 gap-1.5 hidden lg:flex"></div><div class="flex w-full md:hidden"></div><div class="flex items-center -space-x-2.5 xs:space-x-0 "><div class="flex md:hidden"><button aria-label="Search" type="button" class="flex items-center justify-center w-12 h-12 transition-transform rounded-full active:scale-95 md:hidden hover:bg-secondary-button hover:dark:bg-secondary-button-dark outline-link"><svg width="1em" height="1em" viewBox="0 0 20 20" class="w-5 h-5 align-middle"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" stroke-width="2" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg></button></div><div class="flex dark:hidden"><button type="button" aria-label="Use Dark Mode" class="flex items-center justify-center w-12 h-12 transition-transform rounded-full active:scale-95 hover:bg-primary/5 hover:dark:bg-primary-dark/5 outline-link"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 32 32"><g fill="none" fill-rule="evenodd" transform="translate(-440 -200)"><path fill="currentColor" fill-rule="nonzero" stroke="currentColor" stroke-width="0.5" d="M102,21 C102,18.1017141 103.307179,15.4198295 105.51735,13.6246624 C106.001939,13.2310647 105.821611,12.4522936 105.21334,12.3117518 C104.322006,12.1058078 103.414758,12 102.5,12 C95.8722864,12 90.5,17.3722864 90.5,24 C90.5,30.6277136 95.8722864,36 102.5,36 C106.090868,36 109.423902,34.4109093 111.690274,31.7128995 C112.091837,31.2348572 111.767653,30.5041211 111.143759,30.4810139 C106.047479,30.2922628 102,26.1097349 102,21 Z M102.5,34.5 C96.7007136,34.5 92,29.7992864 92,24 C92,18.2007136 96.7007136,13.5 102.5,13.5 C102.807386,13.5 103.113925,13.5136793 103.419249,13.5407785 C101.566047,15.5446378 100.5,18.185162 100.5,21 C100.5,26.3198526 104.287549,30.7714322 109.339814,31.7756638 L109.516565,31.8092927 C107.615276,33.5209452 105.138081,34.5 102.5,34.5 Z" transform="translate(354.5 192)"></path><polygon points="444 228 468 228 468 204 444 204"></polygon></g></svg></button></div><div class="hidden dark:flex"><button type="button" aria-label="Use Light Mode" class="flex items-center justify-center w-12 h-12 transition-transform rounded-full active:scale-95 hover:bg-primary/5 hover:dark:bg-primary-dark/5 outline-link"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><g fill="none" fill-rule="evenodd" transform="translate(-442 -200)"><g fill="currentColor" transform="translate(356 144)"><path fill-rule="nonzero" d="M108.5 24C108.5 27.5902136 105.590214 30.5 102 30.5 98.4097864 30.5 95.5 27.5902136 95.5 24 95.5 20.4097864 98.4097864 17.5 102 17.5 105.590214 17.5 108.5 20.4097864 108.5 24zM107 24C107 21.2382136 104.761786 19 102 19 99.2382136 19 97 21.2382136 97 24 97 26.7617864 99.2382136 29 102 29 104.761786 29 107 26.7617864 107 24zM101 12.75L101 14.75C101 15.1642136 101.335786 15.5 101.75 15.5 102.164214 15.5 102.5 15.1642136 102.5 14.75L102.5 12.75C102.5 12.3357864 102.164214 12 101.75 12 101.335786 12 101 12.3357864 101 12.75zM95.7255165 14.6323616L96.7485165 16.4038616C96.9556573 16.7625614 97.4143618 16.8854243 97.7730616 16.6782835 98.1317614 16.4711427 98.2546243 16.0124382 98.0474835 15.6537384L97.0244835 13.8822384C96.8173427 13.5235386 96.3586382 13.4006757 95.9999384 13.6078165 95.6412386 13.8149573 95.5183757 14.2736618 95.7255165 14.6323616zM91.8822384 19.0244835L93.6537384 20.0474835C94.0124382 20.2546243 94.4711427 20.1317614 94.6782835 19.7730616 94.8854243 19.4143618 94.7625614 18.9556573 94.4038616 18.7485165L92.6323616 17.7255165C92.2736618 17.5183757 91.8149573 17.6412386 91.6078165 17.9999384 91.4006757 18.3586382 91.5235386 18.8173427 91.8822384 19.0244835zM90.75 25L92.75 25C93.1642136 25 93.5 24.6642136 93.5 24.25 93.5 23.8357864 93.1642136 23.5 92.75 23.5L90.75 23.5C90.3357864 23.5 90 23.8357864 90 24.25 90 24.6642136 90.3357864 25 90.75 25zM92.6323616 30.2744835L94.4038616 29.2514835C94.7625614 29.0443427 94.8854243 28.5856382 94.6782835 28.2269384 94.4711427 27.8682386 94.0124382 27.7453757 93.6537384 27.9525165L91.8822384 28.9755165C91.5235386 29.1826573 91.4006757 29.6413618 91.6078165 30.0000616 91.8149573 30.3587614 92.2736618 30.4816243 92.6323616 30.2744835zM97.0244835 34.1177616L98.0474835 32.3462616C98.2546243 31.9875618 98.1317614 31.5288573 97.7730616 31.3217165 97.4143618 31.1145757 96.9556573 31.2374386 96.7485165 31.5961384L95.7255165 33.3676384C95.5183757 33.7263382 95.6412386 34.1850427 95.9999384 34.3921835 96.3586382 34.5993243 96.8173427 34.4764614 97.0244835 34.1177616zM103 35.25L103 33.25C103 32.8357864 102.664214 32.5 102.25 32.5 101.835786 32.5 101.5 32.8357864 101.5 33.25L101.5 35.25C101.5 35.6642136 101.835786 36 102.25 36 102.664214 36 103 35.6642136 103 35.25zM108.274483 33.3676384L107.251483 31.5961384C107.044343 31.2374386 106.585638 31.1145757 106.226938 31.3217165 105.868239 31.5288573 105.745376 31.9875618 105.952517 32.3462616L106.975517 34.1177616C107.182657 34.4764614 107.641362 34.5993243 108.000062 34.3921835 108.358761 34.1850427 108.481624 33.7263382 108.274483 33.3676384zM112.117762 28.9755165L110.346262 27.9525165C109.987562 27.7453757 109.528857 27.8682386 109.321717 28.2269384 109.114576 28.5856382 109.237439 29.0443427 109.596138 29.2514835L111.367638 30.2744835C111.726338 30.4816243 112.185043 30.3587614 112.392183 30.0000616 112.599324 29.6413618 112.476461 29.1826573 112.117762 28.9755165zM113.25 23L111.25 23C110.835786 23 110.5 23.3357864 110.5 23.75 110.5 24.1642136 110.835786 24.5 111.25 24.5L113.25 24.5C113.664214 24.5 114 24.1642136 114 23.75 114 23.3357864 113.664214 23 113.25 23zM111.367638 17.7255165L109.596138 18.7485165C109.237439 18.9556573 109.114576 19.4143618 109.321717 19.7730616 109.528857 20.1317614 109.987562 20.2546243 110.346262 20.0474835L112.117762 19.0244835C112.476461 18.8173427 112.599324 18.3586382 112.392183 17.9999384 112.185043 17.6412386 111.726338 17.5183757 111.367638 17.7255165zM106.975517 13.8822384L105.952517 15.6537384C105.745376 16.0124382 105.868239 16.4711427 106.226938 16.6782835 106.585638 16.8854243 107.044343 16.7625614 107.251483 16.4038616L108.274483 14.6323616C108.481624 14.2736618 108.358761 13.8149573 108.000062 13.6078165 107.641362 13.4006757 107.182657 13.5235386 106.975517 13.8822384z" transform="translate(0 48)" stroke="currentColor" stroke-width="0.25"></path><path d="M98.6123,60.1372 C98.6123,59.3552 98.8753,58.6427 99.3368,58.0942 C99.5293,57.8657 99.3933,57.5092 99.0943,57.5017 C99.0793,57.5012 99.0633,57.5007 99.0483,57.5007 C97.1578,57.4747 95.5418,59.0312 95.5008,60.9217 C95.4578,62.8907 97.0408,64.5002 98.9998,64.5002 C99.7793,64.5002 100.4983,64.2452 101.0798,63.8142 C101.3183,63.6372 101.2358,63.2627 100.9478,63.1897 C99.5923,62.8457 98.6123,61.6072 98.6123,60.1372" transform="translate(3 11)"></path></g><polygon points="444 228 468 228 468 204 444 204"></polygon></g></svg></button></div><div class="flex"><a class="active:scale-95 transition-transform flex w-12 h-12 rounded-full items-center justify-center hover:bg-primary/5 hover:dark:bg-primary-dark/5 outline-link" aria-label="Translations" href="/community/translations"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d=" M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z "></path></svg></a></div><div class="flex"></div></div></div></div></nav></div><div class="grid grid-cols-only-content lg:grid-cols-sidebar-content 2xl:grid-cols-sidebar-content-toc"><div class="lg:-mt-16 z-10"><div class="fixed top-0 py-0 shadow lg:pt-16 lg:sticky start-0 end-0 lg:shadow-none"><div class="sticky top-0 lg:bottom-0 lg:h-[calc(100vh-4rem)] flex flex-col"><div class="overflow-y-scroll no-bg-scrollbar lg:w-[342px] grow bg-wash dark:bg-wash-dark" style="overscroll-behavior:contain"><aside class="lg:grow flex-col w-full pb-8 lg:pb-0 lg:max-w-custom-xs z-10 hidden lg:block"><nav role="navigation" style="--bg-opacity:.2" class="w-full pt-6 scrolling-touch lg:h-auto grow pe-0 lg:pe-5 lg:pb-16 md:pt-4 lg:pt-4 scrolling-gpu"><!--$--><ul><h3 class="mb-1 text-sm font-bold ms-5 text-tertiary dark:text-tertiary-dark">起步</h3><li><a title="快速入门" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between ps-5 text-base font-bold text-primary dark:text-primary-dark" href="/learn"><div>快速入门<!-- --> </div><span class="pe-1 text-tertiary dark:text-tertiary-dark"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" class="duration-100 ease-in transition -rotate-90 rtl:rotate-90" style="min-width:20px;min-height:20px"><g fill="none" fill-rule="evenodd" transform="translate(-446 -398)"><path fill="currentColor" fill-rule="nonzero" d="M95.8838835,240.366117 C95.3957281,239.877961 94.6042719,239.877961 94.1161165,240.366117 C93.6279612,240.854272 93.6279612,241.645728 94.1161165,242.133883 L98.6161165,246.633883 C99.1042719,247.122039 99.8957281,247.122039 100.383883,246.633883 L104.883883,242.133883 C105.372039,241.645728 105.372039,240.854272 104.883883,240.366117 C104.395728,239.877961 103.604272,239.877961 103.116117,240.366117 L99.5,243.982233 L95.8838835,240.366117 Z" transform="translate(356.5 164.5)"></path><polygon points="446 418 466 418 466 398 446 398"></polygon></g></svg></span></a><div class="opacity-50" style="transition:opacity 250ms ease-in-out"><div id="react-collapsed-panel-:R8im6:" aria-hidden="true" role="region" style="box-sizing:border-box;display:none;height:0px;overflow:hidden"><ul><li><a title="教程：井字棋游戏" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-secondary dark:text-secondary-dark" href="/learn/tutorial-tic-tac-toe"><div>教程：井字棋游戏<!-- --> </div></a></li><li><a title="React 哲学" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-secondary dark:text-secondary-dark" href="/learn/thinking-in-react"><div>React 哲学<!-- --> </div></a></li></ul></div></div></li><li><a title="安装" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between ps-5 text-base font-bold text-primary dark:text-primary-dark" href="/learn/installation"><div>安装<!-- --> </div><span class="pe-1 text-tertiary dark:text-tertiary-dark"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" class="duration-100 ease-in transition -rotate-90 rtl:rotate-90" style="min-width:20px;min-height:20px"><g fill="none" fill-rule="evenodd" transform="translate(-446 -398)"><path fill="currentColor" fill-rule="nonzero" d="M95.8838835,240.366117 C95.3957281,239.877961 94.6042719,239.877961 94.1161165,240.366117 C93.6279612,240.854272 93.6279612,241.645728 94.1161165,242.133883 L98.6161165,246.633883 C99.1042719,247.122039 99.8957281,247.122039 100.383883,246.633883 L104.883883,242.133883 C105.372039,241.645728 105.372039,240.854272 104.883883,240.366117 C104.395728,239.877961 103.604272,239.877961 103.116117,240.366117 L99.5,243.982233 L95.8838835,240.366117 Z" transform="translate(356.5 164.5)"></path><polygon points="446 418 466 418 466 398 446 398"></polygon></g></svg></span></a><div class="opacity-50" style="transition:opacity 250ms ease-in-out"><div id="react-collapsed-panel-:R8qm6:" aria-hidden="true" role="region" style="box-sizing:border-box;display:none;height:0px;overflow:hidden"><ul><li><a title="启动一个新的 React 项目" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-secondary dark:text-secondary-dark" href="/learn/start-a-new-react-project"><div>启动一个新的 React 项目<!-- --> </div></a></li><li><a title="将 React 添加到现有项目中" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-secondary dark:text-secondary-dark" href="/learn/add-react-to-an-existing-project"><div>将 React 添加到现有项目中<!-- --> </div></a></li><li><a title="编辑器设置" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-secondary dark:text-secondary-dark" href="/learn/editor-setup"><div>编辑器设置<!-- --> </div></a></li><li><a title="使用 TypeScript" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-secondary dark:text-secondary-dark" href="/learn/typescript"><div>使用 TypeScript<!-- --> </div></a></li><li><a title="React 开发者工具" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-secondary dark:text-secondary-dark" href="/learn/react-developer-tools"><div>React 开发者工具<!-- --> </div></a></li><li><a title="React Compiler" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-secondary dark:text-secondary-dark" href="/learn/react-compiler"><div>React Compiler<!-- --> <svg class="ms-2 text-gray-30 dark:text-gray-60 inline-block w-4 h-4 align-[-3px]" width="20px" height="20px" viewBox="0 0 20 20" version="1.1" xmlns="http://www.w3.org/2000/svg"><title> - This feature is available in the latest Canary</title><g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="noun-labs-1201738-(2)" transform="translate(2, 0)" fill="currentColor" fill-rule="nonzero"><path d="M10.2865804,5.55665262 L10.2865804,2.22331605 L10.8591544,2.22331605 C11.0103911,2.22244799 11.1551447,2.16342155 11.2617505,2.05914367 C11.3684534,1.95486857 11.4282767,1.81370176 11.4282767,1.66667106 L11.4282767,0.556642208 C11.4282767,0.40907262 11.3678934,0.26747526 11.2605218,0.16308627 C11.1531503,0.0587028348 11.0074938,0 10.8556998,0 L5.14338868,0 C4.9915947,0 4.84594391,0.0587028348 4.73856664,0.16308627 C4.63119507,0.267469704 4.57081178,0.40907262 4.57081178,0.556642208 L4.57081178,1.66667106 C4.57081178,1.81434899 4.63119507,1.95594912 4.73856664,2.06033811 C4.8459382,2.16472155 4.9915947,2.22331605 5.14338868,2.22331605 L5.71596273,2.22331605 L5.71596273,5.55665262 C5.71596273,8.38665538 2.97295619,9.88999017 0.651686904,15.5566623 C-0.0957823782,17.360053 -2.00560068,20 7.99951567,20 C18.004632,20 16.0948137,17.3600252 15.3507732,15.5566623 C13.0124432,9.88999017 10.2865804,8.38665538 10.2865804,5.55665262 Z M9.89570197,10.709991 C10.0921412,10.709991 10.2805515,10.7858383 10.4193876,10.9209301 C10.5583466,11.0559135 10.6363652,11.2390693 10.6363652,11.4300417 C10.6363652,11.6210141 10.5583466,11.8040698 10.4193876,11.9391533 C10.2805401,12.0741367 10.0921412,12.1499813 9.89570197,12.1499813 C9.6992627,12.1499813 9.51096673,12.074134 9.37201631,11.9391533 C9.23316875,11.8040615 9.15515307,11.6210141 9.15515307,11.4300417 C9.15515307,11.2390693 9.2331716,11.0559024 9.37201631,10.9209301 C9.57264221,10.7258996 9.61239426,10.709991 9.89570197,10.709991 Z M8.98919546,9.04212824 C9.09790709,9.14792278 9.15884755,9.29158681 9.1585213,9.44110085 C9.15829001,9.59073155 9.09678989,9.73407335 8.98763252,9.83954568 C8.87847514,9.945018 8.73069852,10.0039347 8.57678157,10.0033977 C8.42286747,10.0027392 8.27565088,9.94273467 8.16727355,9.83639845 C8.05900765,9.73006224 7.99873866,9.58628988 7.99963013,9.43664806 C8.00052304,9.28788403 8.0620221,9.14542556 8.17051087,9.04048101 C8.27911107,8.93555591 8.42599335,8.87663641 8.57913312,8.87663641 C8.73291864,8.87665585 8.88047525,8.93622535 8.98919546,9.04212824 Z M7.99965585,17.9999981 C4.91377349,17.9999981 3.29882839,17.7332867 2.51364277,17.4999976 C2.37780966,17.4476975 2.26954376,17.3439641 2.21396931,17.2125528 C2.15838628,17.0811499 2.16006066,16.9334692 2.21876871,16.8033858 C2.6144474,15.5921346 3.14916224,14.4280501 3.81316983,13.3333824 C5.980145,9.82337899 8.22941036,13.8867718 10.0980836,13.8867718 C11.9666996,13.8867718 11.4695868,12.1534924 12.1827971,13.3333824 C12.8511505,14.4269112 13.3916656,15.5896902 13.794259,16.8000524 C13.8533022,16.9322137 13.8537479,17.0822749 13.7952635,17.2147751 C13.7368889,17.3472613 13.6248314,17.4504531 13.4856467,17.5000531 C12.6833967,17.7332867 11.0855382,17.9999981 7.99965585,17.9999981 Z" id="Shape"></path></g></g></svg></div></a></li></ul></div></div></li><li role="separator" class="mt-4 mb-2 ms-5 border-b border-border dark:border-border-dark"></li><h3 class="mb-1 text-sm font-bold ms-5 text-tertiary dark:text-tertiary-dark mt-2">学习 React</h3><li><a title="描述 UI" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between ps-5 text-base font-bold text-primary dark:text-primary-dark" href="/learn/describing-the-ui"><div>描述 UI<!-- --> </div><span class="pe-1 text-tertiary dark:text-tertiary-dark"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" class="duration-100 ease-in transition -rotate-90 rtl:rotate-90" style="min-width:20px;min-height:20px"><g fill="none" fill-rule="evenodd" transform="translate(-446 -398)"><path fill="currentColor" fill-rule="nonzero" d="M95.8838835,240.366117 C95.3957281,239.877961 94.6042719,239.877961 94.1161165,240.366117 C93.6279612,240.854272 93.6279612,241.645728 94.1161165,242.133883 L98.6161165,246.633883 C99.1042719,247.122039 99.8957281,247.122039 100.383883,246.633883 L104.883883,242.133883 C105.372039,241.645728 105.372039,240.854272 104.883883,240.366117 C104.395728,239.877961 103.604272,239.877961 103.116117,240.366117 L99.5,243.982233 L95.8838835,240.366117 Z" transform="translate(356.5 164.5)"></path><polygon points="446 418 466 418 466 398 446 398"></polygon></g></svg></span></a><div class="opacity-50" style="transition:opacity 250ms ease-in-out"><div id="react-collapsed-panel-:R9am6:" aria-hidden="true" role="region" style="box-sizing:border-box;display:none;height:0px;overflow:hidden"><ul><li><a title="你的第一个组件" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-secondary dark:text-secondary-dark" href="/learn/your-first-component"><div>你的第一个组件<!-- --> </div></a></li><li><a title="组件的导入与导出" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-secondary dark:text-secondary-dark" href="/learn/importing-and-exporting-components"><div>组件的导入与导出<!-- --> </div></a></li><li><a title="使用 JSX 书写标签语言" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-secondary dark:text-secondary-dark" href="/learn/writing-markup-with-jsx"><div>使用 JSX 书写标签语言<!-- --> </div></a></li><li><a title="在 JSX 中通过大括号使用 JavaScript" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-secondary dark:text-secondary-dark" href="/learn/javascript-in-jsx-with-curly-braces"><div>在 JSX 中通过大括号使用 JavaScript<!-- --> </div></a></li><li><a title="将 Props 传递给组件" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-secondary dark:text-secondary-dark" href="/learn/passing-props-to-a-component"><div>将 Props 传递给组件<!-- --> </div></a></li><li><a title="条件渲染" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-secondary dark:text-secondary-dark" href="/learn/conditional-rendering"><div>条件渲染<!-- --> </div></a></li><li><a title="渲染列表" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-secondary dark:text-secondary-dark" href="/learn/rendering-lists"><div>渲染列表<!-- --> </div></a></li><li><a title="保持组件纯粹" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-secondary dark:text-secondary-dark" href="/learn/keeping-components-pure"><div>保持组件纯粹<!-- --> </div></a></li><li><a title="将 UI 视为树" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-secondary dark:text-secondary-dark" href="/learn/understanding-your-ui-as-a-tree"><div>将 UI 视为树<!-- --> </div></a></li></ul></div></div></li><li><a title="添加交互" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between ps-5 text-base font-bold text-primary dark:text-primary-dark" href="/learn/adding-interactivity"><div>添加交互<!-- --> </div><span class="pe-1 text-tertiary dark:text-tertiary-dark"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" class="duration-100 ease-in transition -rotate-90 rtl:rotate-90" style="min-width:20px;min-height:20px"><g fill="none" fill-rule="evenodd" transform="translate(-446 -398)"><path fill="currentColor" fill-rule="nonzero" d="M95.8838835,240.366117 C95.3957281,239.877961 94.6042719,239.877961 94.1161165,240.366117 C93.6279612,240.854272 93.6279612,241.645728 94.1161165,242.133883 L98.6161165,246.633883 C99.1042719,247.122039 99.8957281,247.122039 100.383883,246.633883 L104.883883,242.133883 C105.372039,241.645728 105.372039,240.854272 104.883883,240.366117 C104.395728,239.877961 103.604272,239.877961 103.116117,240.366117 L99.5,243.982233 L95.8838835,240.366117 Z" transform="translate(356.5 164.5)"></path><polygon points="446 418 466 418 466 398 446 398"></polygon></g></svg></span></a><div class="opacity-50" style="transition:opacity 250ms ease-in-out"><div id="react-collapsed-panel-:R9im6:" aria-hidden="true" role="region" style="box-sizing:border-box;display:none;height:0px;overflow:hidden"><ul><li><a title="响应事件" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-secondary dark:text-secondary-dark" href="/learn/responding-to-events"><div>响应事件<!-- --> </div></a></li><li><a title="state：组件的记忆" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-secondary dark:text-secondary-dark" href="/learn/state-a-components-memory"><div>state：组件的记忆<!-- --> </div></a></li><li><a title="渲染和提交" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-secondary dark:text-secondary-dark" href="/learn/render-and-commit"><div>渲染和提交<!-- --> </div></a></li><li><a title="state 如同一张快照" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-secondary dark:text-secondary-dark" href="/learn/state-as-a-snapshot"><div>state 如同一张快照<!-- --> </div></a></li><li><a title="把一系列 state 更新加入队列" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-secondary dark:text-secondary-dark" href="/learn/queueing-a-series-of-state-updates"><div>把一系列 state 更新加入队列<!-- --> </div></a></li><li><a title="更新 state 中的对象" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-secondary dark:text-secondary-dark" href="/learn/updating-objects-in-state"><div>更新 state 中的对象<!-- --> </div></a></li><li><a title="更新 state 中的数组" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-secondary dark:text-secondary-dark" href="/learn/updating-arrays-in-state"><div>更新 state 中的数组<!-- --> </div></a></li></ul></div></div></li><li><a title="状态管理" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between ps-5 text-base font-bold text-primary dark:text-primary-dark" href="/learn/managing-state"><div>状态管理<!-- --> </div><span class="pe-1 text-tertiary dark:text-tertiary-dark"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" class="duration-100 ease-in transition -rotate-90 rtl:rotate-90" style="min-width:20px;min-height:20px"><g fill="none" fill-rule="evenodd" transform="translate(-446 -398)"><path fill="currentColor" fill-rule="nonzero" d="M95.8838835,240.366117 C95.3957281,239.877961 94.6042719,239.877961 94.1161165,240.366117 C93.6279612,240.854272 93.6279612,241.645728 94.1161165,242.133883 L98.6161165,246.633883 C99.1042719,247.122039 99.8957281,247.122039 100.383883,246.633883 L104.883883,242.133883 C105.372039,241.645728 105.372039,240.854272 104.883883,240.366117 C104.395728,239.877961 103.604272,239.877961 103.116117,240.366117 L99.5,243.982233 L95.8838835,240.366117 Z" transform="translate(356.5 164.5)"></path><polygon points="446 418 466 418 466 398 446 398"></polygon></g></svg></span></a><div class="opacity-50" style="transition:opacity 250ms ease-in-out"><div id="react-collapsed-panel-:R9qm6:" aria-hidden="true" role="region" style="box-sizing:border-box;display:none;height:0px;overflow:hidden"><ul><li><a title="用 State 响应输入" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-secondary dark:text-secondary-dark" href="/learn/reacting-to-input-with-state"><div>用 State 响应输入<!-- --> </div></a></li><li><a title="选择 State 结构" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-secondary dark:text-secondary-dark" href="/learn/choosing-the-state-structure"><div>选择 State 结构<!-- --> </div></a></li><li><a title="在组件间共享状态" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-secondary dark:text-secondary-dark" href="/learn/sharing-state-between-components"><div>在组件间共享状态<!-- --> </div></a></li><li><a title="对 state 进行保留和重置" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-secondary dark:text-secondary-dark" href="/learn/preserving-and-resetting-state"><div>对 state 进行保留和重置<!-- --> </div></a></li><li><a title="迁移状态逻辑至 Reducer 中" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-secondary dark:text-secondary-dark" href="/learn/extracting-state-logic-into-a-reducer"><div>迁移状态逻辑至 Reducer 中<!-- --> </div></a></li><li><a title="使用 Context 深层传递参数" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-secondary dark:text-secondary-dark" href="/learn/passing-data-deeply-with-context"><div>使用 Context 深层传递参数<!-- --> </div></a></li><li><a title="使用 Reducer 和 Context 拓展你的应用" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-secondary dark:text-secondary-dark" href="/learn/scaling-up-with-reducer-and-context"><div>使用 Reducer 和 Context 拓展你的应用<!-- --> </div></a></li></ul></div></div></li><li><a title="脱围机制" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between ps-5 text-base font-bold text-primary dark:text-primary-dark" href="/learn/escape-hatches"><div>脱围机制<!-- --> </div><span class="pe-1 text-link dark:text-link-dark"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" class="duration-100 ease-in transition rotate-0" style="min-width:20px;min-height:20px"><g fill="none" fill-rule="evenodd" transform="translate(-446 -398)"><path fill="currentColor" fill-rule="nonzero" d="M95.8838835,240.366117 C95.3957281,239.877961 94.6042719,239.877961 94.1161165,240.366117 C93.6279612,240.854272 93.6279612,241.645728 94.1161165,242.133883 L98.6161165,246.633883 C99.1042719,247.122039 99.8957281,247.122039 100.383883,246.633883 L104.883883,242.133883 C105.372039,241.645728 105.372039,240.854272 104.883883,240.366117 C104.395728,239.877961 103.604272,239.877961 103.116117,240.366117 L99.5,243.982233 L95.8838835,240.366117 Z" transform="translate(356.5 164.5)"></path><polygon points="446 418 466 418 466 398 446 398"></polygon></g></svg></span></a><div class="opacity-100" style="transition:opacity 250ms ease-in-out"><div id="react-collapsed-panel-:Ra2m6:" aria-hidden="false" role="region" style="box-sizing:border-box"><ul><li><a title="使用 ref 引用值" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-secondary dark:text-secondary-dark" href="/learn/referencing-values-with-refs"><div>使用 ref 引用值<!-- --> </div></a></li><li><a title="使用 ref 操作 DOM" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-secondary dark:text-secondary-dark" href="/learn/manipulating-the-dom-with-refs"><div>使用 ref 操作 DOM<!-- --> </div></a></li><li><a title="使用 Effect 进行同步" target="" aria-current="page" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-link dark:text-link-dark bg-highlight dark:bg-highlight-dark border-blue-40 hover:bg-highlight hover:text-link dark:hover:bg-highlight-dark dark:hover:text-link-dark" href="/learn/synchronizing-with-effects"><div>使用 Effect 进行同步<!-- --> </div></a></li><li><a title="你可能不需要 Effect" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-secondary dark:text-secondary-dark" href="/learn/you-might-not-need-an-effect"><div>你可能不需要 Effect<!-- --> </div></a></li><li><a title="响应式 Effect 的生命周期" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-secondary dark:text-secondary-dark" href="/learn/lifecycle-of-reactive-effects"><div>响应式 Effect 的生命周期<!-- --> </div></a></li><li><a title="将事件从 Effect 中分开" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-secondary dark:text-secondary-dark" href="/learn/separating-events-from-effects"><div>将事件从 Effect 中分开<!-- --> </div></a></li><li><a title="移除 Effect 依赖" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-secondary dark:text-secondary-dark" href="/learn/removing-effect-dependencies"><div>移除 Effect 依赖<!-- --> </div></a></li><li><a title="使用自定义 Hook 复用逻辑" target="" class="p-2 pe-2 w-full rounded-none lg:rounded-e-2xl text-start hover:bg-gray-5 dark:hover:bg-gray-80 relative flex items-center justify-between text-sm ps-6 ps-5 text-base text-secondary dark:text-secondary-dark" href="/learn/reusing-logic-with-custom-hooks"><div>使用自定义 Hook 复用逻辑<!-- --> </div></a></li></ul></div></div></li></ul><!--/$--><div class="h-20"></div></nav><div class="fixed bottom-0 hidden lg:block"><div class="max-w-custom-xs w-80 lg:w-auto py-3 shadow-lg rounded-lg m-4 bg-wash dark:bg-gray-95 px-4 flex"><p class="w-full text-lg font-bold text-primary dark:text-primary-dark me-4">这个页面对你有帮助吗？</p><button aria-label="Yes" class="px-3 rounded-lg bg-secondary-button dark:bg-secondary-button-dark text-primary dark:text-primary-dark me-2"><svg width="16" height="18" viewBox="0 0 16 18" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M9.36603 0.384603C9.36605 0.384617 9.36601 0.384588 9.36603 0.384603L9.45902 0.453415C9.99732 0.851783 10.3873 1.42386 10.5654 2.07648C10.7435 2.72909 10.6993 3.42385 10.44 4.04763L9.27065 6.86008H12.6316C13.5249 6.86008 14.3817 7.22121 15.0134 7.86402C15.6451 8.50683 16 9.37868 16 10.2877V13.7154C16 14.8518 15.5564 15.9416 14.7668 16.7451C13.9771 17.5486 12.9062 18 11.7895 18H5.05263C3.71259 18 2.42743 17.4583 1.47988 16.4941C0.532325 15.5299 0 14.2221 0 12.8585V11.2511C2.40928e-06 9.87711 0.463526 8.54479 1.31308 7.47688L6.66804 0.745592C6.98662 0.345136 7.44414 0.08434 7.94623 0.0171605C8.4483 -0.0500155 8.95656 0.0815891 9.36603 0.384603ZM8.37542 1.77064C8.31492 1.72587 8.23987 1.70646 8.16579 1.71637C8.09171 1.72628 8.02415 1.76477 7.97708 1.82393L2.62213 8.55522C2.0153 9.31801 1.68421 10.2697 1.68421 11.2511V12.8585C1.68421 13.7676 2.03909 14.6394 2.67079 15.2822C3.30249 15.925 4.15927 16.2862 5.05263 16.2862H11.7895C12.4595 16.2862 13.1021 16.0153 13.5759 15.5332C14.0496 15.0511 14.3158 14.3972 14.3158 13.7154V10.2877C14.3158 9.83321 14.1383 9.39729 13.8225 9.07588C13.5066 8.75448 13.0783 8.57392 12.6316 8.57392H8C7.71763 8.57392 7.45405 8.4299 7.29806 8.19039C7.14206 7.95087 7.11442 7.64774 7.22445 7.38311L8.88886 3.37986C9 3.11253 9.01896 2.81477 8.94262 2.53507C8.8663 2.25541 8.69921 2.01027 8.46853 1.83954L8.37542 1.77064Z" fill="currentColor"></path></svg></button><button aria-label="No" class="px-3 rounded-lg bg-secondary-button dark:bg-secondary-button-dark text-primary dark:text-primary-dark"><svg width="16" height="18" viewBox="0 0 16 18" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6.63397 17.6154C6.63395 17.6154 6.63399 17.6154 6.63397 17.6154L6.54098 17.5466C6.00268 17.1482 5.61269 16.5761 5.43458 15.9235C5.25648 15.2709 5.30069 14.5761 5.56004 13.9524L6.72935 11.1399L3.36842 11.1399C2.47506 11.1399 1.61829 10.7788 0.986585 10.136C0.354883 9.49316 8.1991e-07 8.62132 8.99384e-07 7.71225L1.19904e-06 4.28458C1.29838e-06 3.14824 0.443605 2.05844 1.23323 1.25492C2.02286 0.451403 3.09383 -1.12829e-06 4.21053 -1.03067e-06L10.9474 -4.41715e-07C12.2874 -3.24565e-07 13.5726 0.541687 14.5201 1.50591C15.4677 2.47013 16 3.77789 16 5.1415L16 6.74893C16 8.12289 15.5365 9.45521 14.6869 10.5231L9.33196 17.2544C9.01338 17.6549 8.55586 17.9157 8.05377 17.9828C7.5517 18.05 7.04344 17.9184 6.63397 17.6154ZM7.62458 16.2294C7.68508 16.2741 7.76013 16.2935 7.83421 16.2836C7.90829 16.2737 7.97585 16.2352 8.02292 16.1761L13.3779 9.44478C13.9847 8.68199 14.3158 7.73033 14.3158 6.74892L14.3158 5.1415C14.3158 4.23242 13.9609 3.36058 13.3292 2.71777C12.6975 2.07496 11.8407 1.71383 10.9474 1.71383L4.21053 1.71383C3.5405 1.71383 2.89793 1.98468 2.42415 2.46679C1.95038 2.94889 1.68421 3.60277 1.68421 4.28458L1.68421 7.71225C1.68421 8.16679 1.86166 8.60271 2.1775 8.92411C2.49335 9.24552 2.92174 9.42608 3.36842 9.42608L8 9.42608C8.28237 9.42608 8.54595 9.5701 8.70195 9.80961C8.85794 10.0491 8.88558 10.3523 8.77555 10.6169L7.11114 14.6201C7 14.8875 6.98105 15.1852 7.05738 15.4649C7.1337 15.7446 7.30079 15.9897 7.53147 16.1605L7.62458 16.2294Z" fill="currentColor"></path></svg></button></div></div></aside></div></div></div></div><!--$--><main class="min-w-0 isolate"><article class="font-normal break-words text-primary dark:text-primary-dark"><div class="ps-0"><div class=""><div class="px-5 sm:px-12 pt-3.5"><div class="max-w-4xl ms-0 2xl:mx-auto"><div class="flex flex-wrap"><div class="flex mb-3 mt-0.5 items-center"><a class="text-link dark:text-link-dark text-sm tracking-wide font-bold uppercase me-1 hover:underline" href="/learn">学习 React</a><span class="inline-block me-1 text-link dark:text-link-dark text-lg rtl:rotate-180"><svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6.86612 13.6161C6.37796 14.1043 6.37796 14.8957 6.86612 15.3839C7.35427 15.872 8.14572 15.872 8.63388 15.3839L13.1339 10.8839C13.622 10.3957 13.622 9.60428 13.1339 9.11612L8.63388 4.61612C8.14572 4.12797 7.35427 4.12797 6.86612 4.61612C6.37796 5.10428 6.37796 5.89573 6.86612 6.38388L10.4822 10L6.86612 13.6161Z" fill="currentColor"></path></svg></span></div><div class="flex mb-3 mt-0.5 items-center"><a class="text-link dark:text-link-dark text-sm tracking-wide font-bold uppercase me-1 hover:underline" href="/learn/escape-hatches">脱围机制</a><span class="inline-block me-1 text-link dark:text-link-dark text-lg rtl:rotate-180"><svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6.86612 13.6161C6.37796 14.1043 6.37796 14.8957 6.86612 15.3839C7.35427 15.872 8.14572 15.872 8.63388 15.3839L13.1339 10.8839C13.622 10.3957 13.622 9.60428 13.1339 9.11612L8.63388 4.61612C8.14572 4.12797 7.35427 4.12797 6.86612 4.61612C6.37796 5.10428 6.37796 5.89573 6.86612 6.38388L10.4822 10L6.86612 13.6161Z" fill="currentColor"></path></svg></span></div></div><h1 class="mdx-heading mt-0 text-primary dark:text-primary-dark -mx-.5 break-words text-5xl font-display font-bold leading-tight">使用 Effect 进行同步<a href="#undefined" aria-label="Link for this heading" title="Link for this heading" class="mdx-header-anchor hidden"><svg width="1em" height="1em" viewBox="0 0 13 13" xmlns="http://www.w3.org/2000/svg" class="text-gray-70 ms-2 h-5 w-5"><g fill="currentColor" fill-rule="evenodd"><path d="M7.778 7.975a2.5 2.5 0 0 0 .347-3.837L6.017 2.03a2.498 2.498 0 0 0-3.542-.007 2.5 2.5 0 0 0 .006 3.543l1.153 1.15c.07-.29.154-.563.25-.773.036-.077.084-.16.14-.25L3.18 4.85a1.496 1.496 0 0 1 .002-2.12 1.496 1.496 0 0 1 2.12 0l2.124 2.123a1.496 1.496 0 0 1-.333 2.37c.16.246.42.504.685.752z"></path><path d="M5.657 4.557a2.5 2.5 0 0 0-.347 3.837l2.108 2.108a2.498 2.498 0 0 0 3.542.007 2.5 2.5 0 0 0-.006-3.543L9.802 5.815c-.07.29-.154.565-.25.774-.036.076-.084.16-.14.25l.842.84c.585.587.59 1.532 0 2.122-.587.585-1.532.59-2.12 0L6.008 7.68a1.496 1.496 0 0 1 .332-2.372c-.16-.245-.42-.503-.685-.75z"></path></g></svg></a></h1></div></div></div><div class="px-5 sm:px-12"><div class="max-w-7xl mx-auto"><div class="max-w-4xl ms-0 2xl:mx-auto"><div class="font-display text-xl text-primary dark:text-primary-dark leading-relaxed"><p class="whitespace-pre-wrap my-4">有些组件需要与外部系统同步。例如，你可能希望根据 React state 控制非 React 组件、建立服务器连接或当组件在页面显示时发送分析日志。Effect 允许你在渲染结束后执行一些代码，以便将组件与 React 外部的某个系统相同步。</p></div>
<div class="p-6 xl:p-8 pb-4 xl:pb-6 bg-card dark:bg-card-dark rounded-2xl shadow-inner-border dark:shadow-inner-border-dark text-base text-secondary dark:text-secondary-dark my-8"><h3 class="mdx-heading text-primary dark:text-primary-dark mt-0 mb-3 leading-tight text-2xl font-display leading-9 text-primary dark:text-primary-dark font-bold my-6">你将会学习到</h3><ul class="ms-6 my-3 list-disc">
<li class="leading-relaxed mb-1">什么是 Effect</li>
<li class="leading-relaxed mb-1">Effect 与事件（event）有何不同</li>
<li class="leading-relaxed mb-1">如何在组件中声明 Effect</li>
<li class="leading-relaxed mb-1">如何避免不必要地重新运行 Effect</li>
<li class="leading-relaxed mb-1">为什么 Effect 在开发环境中会运行两次以及如何解决这个问题</li>
</ul></div>
<h2 id="what-are-effects-and-how-are-they-different-from-events" class="mdx-heading text-3xl font-display leading-10 text-primary dark:text-primary-dark font-bold my-6">什么是 Effect，它与事件（event）有何不同？ <a href="#what-are-effects-and-how-are-they-different-from-events" aria-label="Link for 什么是 Effect，它与事件（event）有何不同？ " title="Link for 什么是 Effect，它与事件（event）有何不同？ " class="mdx-header-anchor inline-block"><svg width="1em" height="1em" viewBox="0 0 13 13" xmlns="http://www.w3.org/2000/svg" class="text-gray-70 ms-2 h-5 w-5"><g fill="currentColor" fill-rule="evenodd"><path d="M7.778 7.975a2.5 2.5 0 0 0 .347-3.837L6.017 2.03a2.498 2.498 0 0 0-3.542-.007 2.5 2.5 0 0 0 .006 3.543l1.153 1.15c.07-.29.154-.563.25-.773.036-.077.084-.16.14-.25L3.18 4.85a1.496 1.496 0 0 1 .002-2.12 1.496 1.496 0 0 1 2.12 0l2.124 2.123a1.496 1.496 0 0 1-.333 2.37c.16.246.42.504.685.752z"></path><path d="M5.657 4.557a2.5 2.5 0 0 0-.347 3.837l2.108 2.108a2.498 2.498 0 0 0 3.542.007 2.5 2.5 0 0 0-.006-3.543L9.802 5.815c-.07.29-.154.565-.25.774-.036.076-.084.16-.14.25l.842.84c.585.587.59 1.532 0 2.122-.587.585-1.532.59-2.12 0L6.008 7.68a1.496 1.496 0 0 1 .332-2.372c-.16-.245-.42-.503-.685-.75z"></path></g></svg></a></h2>
<p class="whitespace-pre-wrap my-4">在接触 Effect 之前，你需要熟悉 React 组件中的两种逻辑类型：</p>
<ul class="ms-6 my-3 list-disc">
<li class="leading-relaxed mb-1">
<p class="whitespace-pre-wrap my-4"><strong class="font-bold">渲染代码</strong>（在 <a class="inline text-link dark:text-link-dark border-b border-link border-opacity-0 hover:border-opacity-100 duration-100 ease-in transition leading-normal" href="/learn/describing-the-ui">描述 UI</a> 中有介绍）位于组件的顶层。你在这里处理 props 和 state，对它们进行转换，并返回希望在页面上显示的 JSX。<a class="inline text-link dark:text-link-dark border-b border-link border-opacity-0 hover:border-opacity-100 duration-100 ease-in transition leading-normal" href="/learn/keeping-components-pure">渲染代码必须是纯粹的</a>——就像数学公式一样，它只应该“计算”结果，而不做其他任何事情。</p>
</li>
<li class="leading-relaxed mb-1">
<p class="whitespace-pre-wrap my-4"><strong class="font-bold">事件处理程序</strong>（在 <a class="inline text-link dark:text-link-dark border-b border-link border-opacity-0 hover:border-opacity-100 duration-100 ease-in transition leading-normal" href="/learn/adding-interactivity">添加交互性</a> 中有介绍）是组件内部的嵌套函数，它们不光进行计算, 还会执行一些操作。事件处理程序可能会更新输入字段、提交 HTTP POST 请求来购买产品，或者将用户导航到另一个页面。事件处理程序包含由特定用户操作（例如按钮点击或输入）引起的“副作用”（它们改变了程序的状态）。</p>
</li>
</ul>
<p class="whitespace-pre-wrap my-4">有时这还不够。考虑一个 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">ChatRoom</code> 组件，它在页面上显示时必须连接到聊天服务器。连接到服务器并不是纯粹的计算（它是一个副作用），因此它不能在渲染期间发生。然而，并没有一个特定的事件（比如点击）能让 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">ChatRoom</code> 被显示。</p>
<p class="whitespace-pre-wrap my-4"><strong class="font-bold">Effect 允许你指定由渲染自身，而不是特定事件引起的副作用</strong>。在聊天中发送消息是一个“事件”，因为它直接由用户点击特定按钮引起。然而，建立服务器连接是一个 Effect，因为无论哪种交互致使组件出现，它都应该发生。Effect 在 <a class="inline text-link dark:text-link-dark border-b border-link border-opacity-0 hover:border-opacity-100 duration-100 ease-in transition leading-normal" href="/learn/render-and-commit">提交</a> 结束后、页面更新后运行。此时是将 React 组件与外部系统（如网络或第三方库）同步的最佳时机。</p>
<div class="expandable-callout pt-8 pb-4 px-5 sm:px-8 my-8 relative rounded-none shadow-inner-border -mx-5 sm:mx-auto sm:rounded-2xl bg-green-5 dark:bg-green-60 dark:bg-opacity-20 text-primary dark:text-primary-dark text-lg"><h3 class="text-2xl font-display font-bold text-green-60 dark:text-green-40"><svg class="inline me-3 mb-1 text-lg text-green-60 dark:text-green-40" width="2em" height="2em" viewBox="0 0 72 72" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_40_48064)"><path d="M24 27C24 25.3431 25.3431 24 27 24H45C46.6569 24 48 25.3431 48 27C48 28.6569 46.6569 30 45 30H27C25.3431 30 24 28.6569 24 27Z" fill="currentColor"></path><path d="M24 39C24 37.3431 25.3431 36 27 36H39C40.6569 36 42 37.3431 42 39C42 40.6569 40.6569 42 39 42H27C25.3431 42 24 40.6569 24 39Z" fill="currentColor"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M12 18C12 13.0294 16.0294 9 21 9H51C55.9706 9 60 13.0294 60 18V54C60 58.9706 55.9706 63 51 63H21C16.0294 63 12 58.9706 12 54V18ZM21 15H51C52.6569 15 54 16.3431 54 18V54C54 55.6569 52.6569 57 51 57H21C19.3431 57 18 55.6569 18 54V18C18 16.3431 19.3431 15 21 15Z" fill="currentColor"></path></g><defs><clipPath id="clip0_40_48064"><rect width="72" height="72" fill="white"></rect></clipPath></defs></svg>注意</h3><div class="relative"><div class="py-2"><p class="whitespace-pre-wrap my-4">在本文此处和后续文本中，大写的 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">Effect</code> 是 React 中的专有定义——由渲染引起的副作用。至于更广泛的编程概念(任何改变程序状态或外部系统的行为)，我们则使用“副作用（side effect）” 来指代。</p></div></div></div>
<h2 id="you-might-not-need-an-effect" class="mdx-heading text-3xl font-display leading-10 text-primary dark:text-primary-dark font-bold my-6">你可能不需要 Effect <a href="#you-might-not-need-an-effect" aria-label="Link for 你可能不需要 Effect " title="Link for 你可能不需要 Effect " class="mdx-header-anchor inline-block"><svg width="1em" height="1em" viewBox="0 0 13 13" xmlns="http://www.w3.org/2000/svg" class="text-gray-70 ms-2 h-5 w-5"><g fill="currentColor" fill-rule="evenodd"><path d="M7.778 7.975a2.5 2.5 0 0 0 .347-3.837L6.017 2.03a2.498 2.498 0 0 0-3.542-.007 2.5 2.5 0 0 0 .006 3.543l1.153 1.15c.07-.29.154-.563.25-.773.036-.077.084-.16.14-.25L3.18 4.85a1.496 1.496 0 0 1 .002-2.12 1.496 1.496 0 0 1 2.12 0l2.124 2.123a1.496 1.496 0 0 1-.333 2.37c.16.246.42.504.685.752z"></path><path d="M5.657 4.557a2.5 2.5 0 0 0-.347 3.837l2.108 2.108a2.498 2.498 0 0 0 3.542.007 2.5 2.5 0 0 0-.006-3.543L9.802 5.815c-.07.29-.154.565-.25.774-.036.076-.084.16-.14.25l.842.84c.585.587.59 1.532 0 2.122-.587.585-1.532.59-2.12 0L6.008 7.68a1.496 1.496 0 0 1 .332-2.372c-.16-.245-.42-.503-.685-.75z"></path></g></svg></a></h2>
<p class="whitespace-pre-wrap my-4"><strong class="font-bold">不要急着在你的组件中使用 Effect</strong>。记住，Effect 通常用于暂时“跳出” React 并与一些 <strong class="font-bold">外部</strong> 系统进行同步。这包括浏览器 API、第三方小部件，以及网络等等。如果你的 Effect 只是根据其他状态来调整某些状态，那么 <a class="inline text-link dark:text-link-dark border-b border-link border-opacity-0 hover:border-opacity-100 duration-100 ease-in transition leading-normal" href="/learn/you-might-not-need-an-effect">你可能并不需要一个 Effect</a>。</p>
<h2 id="how-to-write-an-effect" class="mdx-heading text-3xl font-display leading-10 text-primary dark:text-primary-dark font-bold my-6">如何编写 Effect <a href="#how-to-write-an-effect" aria-label="Link for 如何编写 Effect " title="Link for 如何编写 Effect " class="mdx-header-anchor inline-block"><svg width="1em" height="1em" viewBox="0 0 13 13" xmlns="http://www.w3.org/2000/svg" class="text-gray-70 ms-2 h-5 w-5"><g fill="currentColor" fill-rule="evenodd"><path d="M7.778 7.975a2.5 2.5 0 0 0 .347-3.837L6.017 2.03a2.498 2.498 0 0 0-3.542-.007 2.5 2.5 0 0 0 .006 3.543l1.153 1.15c.07-.29.154-.563.25-.773.036-.077.084-.16.14-.25L3.18 4.85a1.496 1.496 0 0 1 .002-2.12 1.496 1.496 0 0 1 2.12 0l2.124 2.123a1.496 1.496 0 0 1-.333 2.37c.16.246.42.504.685.752z"></path><path d="M5.657 4.557a2.5 2.5 0 0 0-.347 3.837l2.108 2.108a2.498 2.498 0 0 0 3.542.007 2.5 2.5 0 0 0-.006-3.543L9.802 5.815c-.07.29-.154.565-.25.774-.036.076-.084.16-.14.25l.842.84c.585.587.59 1.532 0 2.122-.587.585-1.532.59-2.12 0L6.008 7.68a1.496 1.496 0 0 1 .332-2.372c-.16-.245-.42-.503-.685-.75z"></path></g></svg></a></h2>
<p class="whitespace-pre-wrap my-4">要编写一个 Effect, 请遵循以下三个步骤：</p>
<ol class="ms-6 my-3 list-decimal">
<li class="leading-relaxed mb-1"><strong class="font-bold">声明 Effect</strong>。通常 Effect 会在每次 <a class="inline text-link dark:text-link-dark border-b border-link border-opacity-0 hover:border-opacity-100 duration-100 ease-in transition leading-normal" href="/learn/render-and-commit">提交</a> 后运行。</li>
<li class="leading-relaxed mb-1"><strong class="font-bold">指定 Effect 依赖</strong>。大多数 Effect 应该按需运行，而不是在每次渲染后都运行。例如，淡入动画应该只在组件出现时触发。连接和断开服务器的操作只应在组件出现和消失时，或者切换聊天室时执行。你将通过指定 <strong class="font-bold">依赖项</strong> 来学习如何控制这一点。</li>
<li class="leading-relaxed mb-1"><strong class="font-bold">必要时添加清理操作</strong>。一些 Effect 需要指定如何停止、撤销，或者清除它们所执行的操作。例如，“连接”需要“断开”，“订阅”需要“退订”，而“获取数据”需要“取消”或者“忽略”。你将学习如何通过返回一个 <strong class="font-bold">清理函数</strong> 来实现这些。</li>
</ol>
<p class="whitespace-pre-wrap my-4">让我们详细看看每一步。</p>
<h3 id="step-1-declare-an-effect" class="mdx-heading text-2xl font-display leading-9 text-primary dark:text-primary-dark font-bold my-6">第一步：声明 Effect <a href="#step-1-declare-an-effect" aria-label="Link for 第一步：声明 Effect " title="Link for 第一步：声明 Effect " class="mdx-header-anchor inline-block"><svg width="1em" height="1em" viewBox="0 0 13 13" xmlns="http://www.w3.org/2000/svg" class="text-gray-70 ms-2 h-5 w-5"><g fill="currentColor" fill-rule="evenodd"><path d="M7.778 7.975a2.5 2.5 0 0 0 .347-3.837L6.017 2.03a2.498 2.498 0 0 0-3.542-.007 2.5 2.5 0 0 0 .006 3.543l1.153 1.15c.07-.29.154-.563.25-.773.036-.077.084-.16.14-.25L3.18 4.85a1.496 1.496 0 0 1 .002-2.12 1.496 1.496 0 0 1 2.12 0l2.124 2.123a1.496 1.496 0 0 1-.333 2.37c.16.246.42.504.685.752z"></path><path d="M5.657 4.557a2.5 2.5 0 0 0-.347 3.837l2.108 2.108a2.498 2.498 0 0 0 3.542.007 2.5 2.5 0 0 0-.006-3.543L9.802 5.815c-.07.29-.154.565-.25.774-.036.076-.084.16-.14.25l.842.84c.585.587.59 1.532 0 2.122-.587.585-1.532.59-2.12 0L6.008 7.68a1.496 1.496 0 0 1 .332-2.372c-.16-.245-.42-.503-.685-.75z"></path></g></svg></a></h3>
<p class="whitespace-pre-wrap my-4">先从 React 中导入 <a class="inline text-link dark:text-link-dark border-b border-link border-opacity-0 hover:border-opacity-100 duration-100 ease-in transition leading-normal" href="/reference/react/useEffect"><code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">useEffect</code> Hook</a>：</p>
<!--$--><div dir="ltr" class="sandpack sandpack--codeblock rounded-2xl h-full w-full overflow-x-auto flex items-center bg-wash dark:bg-gray-95 shadow-lg my-8" style="contain:content"><div class="sp-wrapper"><div class="sp-stack"><div class="sp-code-editor"><pre class="sp-cm sp-pristine sp-javascript flex align-start"><code class="sp-pre-placeholder grow-[2]"><div class="cm-line "><span class="sp-syntax-keyword">import</span> <span class="sp-syntax-punctuation">{</span> <span class="sp-syntax-plain">useEffect</span> <span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-keyword">from</span> <span class="sp-syntax-string">&#x27;react&#x27;</span><span class="sp-syntax-punctuation">;</span></div></code></pre></div></div></div></div><!--/$-->
<p class="whitespace-pre-wrap my-4">再在组件顶部调用, 并在其中加入一些代码：</p>
<!--$--><div dir="ltr" class="sandpack sandpack--codeblock rounded-2xl h-full w-full overflow-x-auto flex items-center bg-wash dark:bg-gray-95 shadow-lg my-8" style="contain:content"><div class="sp-wrapper"><div class="sp-stack"><div class="sp-code-editor"><pre class="sp-cm sp-pristine sp-javascript flex align-start"><code class="sp-pre-placeholder grow-[2]"><div class="cm-line "><span class="sp-syntax-keyword">function</span> <span class="sp-syntax-definition">MyComponent</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line bg-github-highlight dark:bg-opacity-10">  <span class="sp-syntax-definition">useEffect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line bg-github-highlight dark:bg-opacity-10">    <span class="sp-syntax-comment">// 每次渲染后都会执行此处的代码</span><br/></div><div class="cm-line bg-github-highlight dark:bg-opacity-10">  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line ">  <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-tag">div</span> <span class="sp-syntax-punctuation">/&gt;</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line "><span class="sp-syntax-punctuation">}</span></div></code></pre></div></div></div></div><!--/$-->
<p class="whitespace-pre-wrap my-4">每当你的组件渲染时，React 会先更新页面，然后再运行 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">useEffect</code> 中的代码。换句话说，<strong class="font-bold"><code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">useEffect</code> 会“延迟”一段代码的运行，直到渲染结果反映在页面上</strong>。</p>
<p class="whitespace-pre-wrap my-4">接下来，让我们看看如何使用 Effect 来与外部系统同步。考虑一个 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">&lt;VideoPlayer&gt;</code> React 组件。我们想要通过传递一个 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">isPlaying</code> prop 来控制它播放或者暂停：</p>
<!--$--><div dir="ltr" class="sandpack sandpack--codeblock rounded-2xl h-full w-full overflow-x-auto flex items-center bg-wash dark:bg-gray-95 shadow-lg my-8" style="contain:content"><div class="sp-wrapper"><div class="sp-stack"><div class="sp-code-editor"><pre class="sp-cm sp-pristine sp-javascript flex align-start"><code class="sp-pre-placeholder grow-[2]"><div class="cm-line "><span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-definition">VideoPlayer</span> <span class="sp-syntax-property">isPlaying</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">isPlaying</span><span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-punctuation">/&gt;</span><span class="sp-syntax-punctuation">;</span></div></code></pre></div></div></div></div><!--/$-->
<p class="whitespace-pre-wrap my-4">这个 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">VideoPlayer</code> 组件渲染了浏览器内置的 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/video" target="_blank" rel="nofollow noopener noreferrer" class="inline text-link dark:text-link-dark border-b border-link border-opacity-0 hover:border-opacity-100 duration-100 ease-in transition leading-normal"><code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">&lt;video&gt;</code></a> 标签：</p>
<!--$--><div dir="ltr" class="sandpack sandpack--codeblock rounded-2xl h-full w-full overflow-x-auto flex items-center bg-wash dark:bg-gray-95 shadow-lg my-8" style="contain:content"><div class="sp-wrapper"><div class="sp-stack"><div class="sp-code-editor"><pre class="sp-cm sp-pristine sp-javascript flex align-start"><code class="sp-pre-placeholder grow-[2]"><div class="cm-line "><span class="sp-syntax-keyword">function</span> <span class="sp-syntax-definition">VideoPlayer</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">{</span> <span class="sp-syntax-property">src</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-property">isPlaying</span> <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line ">  <span class="sp-syntax-comment">// TODO：使用 isPlaying 做一些事情</span><br/></div><div class="cm-line ">  <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-tag">video</span> <span class="sp-syntax-property">src</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">src</span><span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-punctuation">/&gt;</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line "><span class="sp-syntax-punctuation">}</span></div></code></pre></div></div></div></div><!--/$-->
<p class="whitespace-pre-wrap my-4">但是，浏览器的 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">&lt;video&gt;</code> 标签没有 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">isPlaying</code> 属性。控制它的唯一方式是在 DOM 元素上调用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLMediaElement/play" target="_blank" rel="nofollow noopener noreferrer" class="inline text-link dark:text-link-dark border-b border-link border-opacity-0 hover:border-opacity-100 duration-100 ease-in transition leading-normal"><code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">play()</code></a> 和 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLMediaElement/pause" target="_blank" rel="nofollow noopener noreferrer" class="inline text-link dark:text-link-dark border-b border-link border-opacity-0 hover:border-opacity-100 duration-100 ease-in transition leading-normal"><code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">pause()</code></a> 方法。因此，<strong class="font-bold">你需要将 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">isPlaying</code> prop 的值（表示视频当前是否应该播放）与 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">play()</code> 和 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">pause()</code> 等函数的调用进行同步</strong>。</p>
<p class="whitespace-pre-wrap my-4">我们首先需要获取 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">&lt;video&gt;</code> DOM 节点的 <a class="inline text-link dark:text-link-dark border-b border-link border-opacity-0 hover:border-opacity-100 duration-100 ease-in transition leading-normal" href="/learn/manipulating-the-dom-with-refs">对象引用</a>。</p>
<p class="whitespace-pre-wrap my-4">你可能会尝试在渲染期间调用 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">play()</code> 或 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">pause()</code>，但这样做是不对的：</p>
</div><!--$--><div class="sandpack sandpack--playground w-full my-8" dir="ltr"><div class="sp-wrapper"><div class="shadow-lg dark:shadow-lg-dark rounded-lg" style="contain:content"><div class="bg-wash dark:bg-card-dark flex justify-between items-center relative z-10 border-b border-border dark:border-border-dark rounded-t-lg text-lg"><div class="flex-1 grow min-w-0 px-4 lg:px-6"><div><div class="relative overflow-hidden"><div class="w-[fit-content] invisible"><div class=" sp-tabs" translate="no"><div aria-label="Select active file" class=" sp-tabs-scrollable-container" role="tablist"><button aria-selected="true" class="  sp-tab-button" data-active="true" role="tab" title="/src/App.js" type="button">App.js</button></div></div></div><button class="absolute top-0 start-[2px]" id="headlessui-listbox-button-:Rj52cq6:" aria-haspopup="true" aria-expanded="false" data-headlessui-state=""><span class="h-full py-2 px-1 mt-px -mb-px flex border-b text-link dark:text-link-dark border-link dark:border-link-dark items-center text-md leading-tight truncate" style="max-width:160px">App.js</span></button></div></div></div><div class="px-3 flex items-center justify-end text-start" translate="yes"><button class="text-sm text-primary dark:text-primary-dark inline-flex items-center hover:text-link duration-100 ease-in transition mx-1" title="Reset Sandbox" type="button"><svg width="1em" height="1em" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="inline mx-1 relative"><path d="M13.8982 5.20844C12.4626 4.88688 10.9686 4.93769 9.55821 5.35604L11.8524 3.06184C11.8989 3.0154 11.9357 2.96028 11.9608 2.89961C11.986 2.83894 11.9989 2.77391 11.9989 2.70824C11.9989 2.64256 11.986 2.57754 11.9608 2.51686C11.9357 2.45619 11.8989 2.40107 11.8524 2.35464L11.1456 1.64784C11.0992 1.60139 11.0441 1.56455 10.9834 1.53942C10.9227 1.51428 10.8577 1.50134 10.792 1.50134C10.7263 1.50134 10.6613 1.51428 10.6006 1.53942C10.54 1.56455 10.4848 1.60139 10.4384 1.64784L6.14571 5.94054C6.00654 6.07969 5.89615 6.2449 5.82083 6.42673C5.74551 6.60855 5.70675 6.80343 5.70675 7.00024C5.70675 7.19704 5.74551 7.39192 5.82083 7.57374C5.89615 7.75557 6.00654 7.92078 6.14571 8.05994L10.4387 12.3529C10.5325 12.4465 10.6595 12.4991 10.792 12.4991C10.9245 12.4991 11.0516 12.4465 11.1453 12.3529L11.8527 11.6455C11.9463 11.5518 11.9989 11.4247 11.9989 11.2922C11.9989 11.1598 11.9463 11.0327 11.8527 10.9389L8.77481 7.86104C9.99795 7.16236 11.415 6.8801 12.8125 7.05678C14.21 7.23347 15.5122 7.85953 16.523 8.84064C17.5338 9.82176 18.1983 11.1048 18.4165 12.4964C18.6347 13.888 18.3947 15.3129 17.7328 16.5562C17.0708 17.7996 16.0227 18.7942 14.7463 19.3902C13.47 19.9861 12.0345 20.1511 10.6563 19.8603C9.27798 19.5695 8.03152 18.8387 7.10469 17.778C6.17786 16.7172 5.62086 15.384 5.51761 13.9791C5.51156 13.8512 5.45689 13.7303 5.36477 13.6413C5.27265 13.5522 5.15001 13.5017 5.02191 13.5H4.02081C3.95297 13.4996 3.88574 13.5129 3.8232 13.5392C3.76065 13.5655 3.70408 13.6042 3.6569 13.6529C3.60972 13.7017 3.57291 13.7595 3.54869 13.8228C3.52448 13.8862 3.51336 13.9538 3.51601 14.0216C3.61349 15.5965 4.1473 17.1132 5.0577 18.4019C5.9681 19.6906 7.21917 20.7006 8.6709 21.3188C10.1226 21.937 11.7178 22.139 13.2778 21.9022C14.8378 21.6654 16.3011 20.9992 17.504 19.978C18.7069 18.9569 19.6019 17.6212 20.0889 16.1203C20.5759 14.6195 20.6356 13.0128 20.2614 11.4799C19.8872 9.94705 19.0938 8.54858 17.97 7.44098C16.8462 6.33339 15.4363 5.56037 13.8982 5.20844V5.20844Z" fill="currentColor"></path></svg> 重置</button><a href="https://codesandbox.io/api/v1/sandboxes/define?undefined&amp;environment=create-react-app" rel="noreferrer noopener" target="_blank" title="Open in CodeSandbox" class="text-sm text-primary dark:text-primary-dark inline-flex items-center hover:text-link duration-100 ease-in transition mx-1 ms-2 md:ms-1"><svg width="1em" height="1em" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="inline mx-1 relative top-[1px]"><path d="M20.5001 2H15.5001C15.3675 2 15.2403 2.05268 15.1465 2.14645C15.0528 2.24021 15.0001 2.36739 15.0001 2.5V3.5C15.0001 3.63261 15.0528 3.75979 15.1465 3.85355C15.2403 3.94732 15.3675 4 15.5001 4H18.5901L7.6501 14.94C7.60323 14.9865 7.56604 15.0418 7.54065 15.1027C7.51527 15.1636 7.5022 15.229 7.5022 15.295C7.5022 15.361 7.51527 15.4264 7.54065 15.4873C7.56604 15.5482 7.60323 15.6035 7.6501 15.65L8.3501 16.35C8.39658 16.3969 8.45188 16.4341 8.51281 16.4594C8.57374 16.4848 8.63909 16.4979 8.7051 16.4979C8.7711 16.4979 8.83646 16.4848 8.89738 16.4594C8.95831 16.4341 9.01362 16.3969 9.0601 16.35L20.0001 5.41V8.5C20.0001 8.63261 20.0528 8.75979 20.1465 8.85355C20.2403 8.94732 20.3675 9 20.5001 9H21.5001C21.6327 9 21.7599 8.94732 21.8537 8.85355C21.9474 8.75979 22.0001 8.63261 22.0001 8.5V3.5C22.0001 3.10218 21.8421 2.72064 21.5608 2.43934C21.2795 2.15804 20.8979 2 20.5001 2V2Z" fill="currentColor"></path><path d="M21.5 13H20.5C20.3674 13 20.2402 13.0527 20.1464 13.1464C20.0527 13.2402 20 13.3674 20 13.5V20H4V4H10.5C10.6326 4 10.7598 3.94732 10.8536 3.85355C10.9473 3.75979 11 3.63261 11 3.5V2.5C11 2.36739 10.9473 2.24021 10.8536 2.14645C10.7598 2.05268 10.6326 2 10.5 2H3.5C3.10218 2 2.72064 2.15804 2.43934 2.43934C2.15804 2.72064 2 3.10218 2 3.5V20.5C2 20.8978 2.15804 21.2794 2.43934 21.5607C2.72064 21.842 3.10218 22 3.5 22H20.5C20.8978 22 21.2794 21.842 21.5607 21.5607C21.842 21.2794 22 20.8978 22 20.5V13.5C22 13.3674 21.9473 13.2402 21.8536 13.1464C21.7598 13.0527 21.6326 13 21.5 13Z" fill="currentColor"></path></svg><span class="hidden md:block">Fork</span></a></div></div><div class=" sp-layout"><div class=" sp-editor sp-stack"><div class=" sp-code-editor"><div aria-autocomplete="list" aria-label="Code Editor for App.js" aria-multiline="true" class="sp-pristine sp-javascript   sp-cm" role="textbox" tabindex="0" translate="no"><pre class=" sp-pre-placeholder" style="margin-left:var(--sp-space-11)"><span class="sp-syntax-keyword">import</span> <span class="sp-syntax-punctuation">{</span> <span class="sp-syntax-plain">useState</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">useRef</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">useEffect</span> <span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-keyword">from</span> <span class="sp-syntax-string">&#x27;react&#x27;</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-keyword">function</span> <span class="sp-syntax-definition">VideoPlayer</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">{</span> <span class="sp-syntax-property">src</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-property">isPlaying</span> <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">ref</span> = <span class="sp-syntax-definition">useRef</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-keyword">null</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>

  <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">isPlaying</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-plain">ref</span>.<span class="sp-syntax-property">current</span>.<span class="sp-syntax-property">play</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>  <span class="sp-syntax-comment">// 渲染期间不能调用 `play()`。 </span>
  <span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-keyword">else</span> <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-plain">ref</span>.<span class="sp-syntax-property">current</span>.<span class="sp-syntax-property">pause</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span> <span class="sp-syntax-comment">// 同样，调用 `pause()` 也不行。</span>
  <span class="sp-syntax-punctuation">}</span>

  <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-tag">video</span> <span class="sp-syntax-property">ref</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">ref</span><span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-property">src</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">src</span><span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-property">loop</span> <span class="sp-syntax-property">playsInline</span> <span class="sp-syntax-punctuation">/&gt;</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-punctuation">}</span>

<span class="sp-syntax-keyword">export</span> <span class="sp-syntax-keyword">default</span> <span class="sp-syntax-keyword">function</span> <span class="sp-syntax-definition">App</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-plain">isPlaying</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">setIsPlaying</span><span class="sp-syntax-punctuation">]</span> = <span class="sp-syntax-definition">useState</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-static">false</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-punctuation">(</span>
    <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-punctuation">&gt;</span>
      <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-tag">button</span> <span class="sp-syntax-property">onClick</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-definition">setIsPlaying</span><span class="sp-syntax-punctuation">(</span>!<span class="sp-syntax-plain">isPlaying</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">&gt;</span>
        <span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">isPlaying</span> ? <span class="sp-syntax-string">&#x27;暂停&#x27;</span> : <span class="sp-syntax-string">&#x27;播放&#x27;</span><span class="sp-syntax-punctuation">}</span>
      <span class="sp-syntax-punctuation">&lt;/</span><span class="sp-syntax-tag">button</span><span class="sp-syntax-punctuation">&gt;</span>
      <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-definition">VideoPlayer</span>
        <span class="sp-syntax-property">isPlaying</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">isPlaying</span><span class="sp-syntax-punctuation">}</span>
        <span class="sp-syntax-property">src</span>=<span class="sp-syntax-string">&quot;https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4&quot;</span>
      <span class="sp-syntax-punctuation">/&gt;</span>
    <span class="sp-syntax-punctuation">&lt;/</span><span class="sp-syntax-punctuation">&gt;</span>
  <span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-punctuation">}</span>

</pre></div></div></div><div class=" order-last xl:order-2 sp-stack"><div class="p-0 sm:p-2 md:p-4 lg:p-8 bg-card dark:bg-wash-dark h-full relative md:rounded-b-lg lg:rounded-b-none"><div style="position:relative"><iframe class="rounded-t-none bg-white md:shadow-md sm:rounded-lg w-full max-w-full transition-opacity absolute opacity-0 pointer-events-none duration-75" title="Sandbox Preview" style="height:15px;z-index:-1"></iframe></div></div></div><button translate="yes" class="sandpack-expand flex text-base justify-between dark:border-card-dark bg-wash dark:bg-card-dark items-center z-10 p-1 w-full order-2 xl:order-last border-b-1 relative top-0"><span class="flex p-2 focus:outline-none text-primary dark:text-primary-dark leading-[20px]"><svg class="rotate-0 inline me-1.5 text-xl" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><g fill="none" fill-rule="evenodd" transform="translate(-446 -398)"><path fill="currentColor" fill-rule="nonzero" d="M95.8838835,240.366117 C95.3957281,239.877961 94.6042719,239.877961 94.1161165,240.366117 C93.6279612,240.854272 93.6279612,241.645728 94.1161165,242.133883 L98.6161165,246.633883 C99.1042719,247.122039 99.8957281,247.122039 100.383883,246.633883 L104.883883,242.133883 C105.372039,241.645728 105.372039,240.854272 104.883883,240.366117 C104.395728,239.877961 103.604272,239.877961 103.116117,240.366117 L99.5,243.982233 L95.8838835,240.366117 Z" transform="translate(356.5 164.5)"></path><polygon points="446 418 466 418 466 398 446 398"></polygon></g></svg>显示更多</span></button></div></div></div></div><!--/$--><div class="max-w-4xl ms-0 2xl:mx-auto">
<p class="whitespace-pre-wrap my-4">这段代码之所以不对，是因为它试图在渲染期间对 DOM 节点进行操作。在 React 中，<a class="inline text-link dark:text-link-dark border-b border-link border-opacity-0 hover:border-opacity-100 duration-100 ease-in transition leading-normal" href="/learn/keeping-components-pure">渲染应该是纯粹的计算</a> JSX，不应该包含任何像修改 DOM 这样的副作用。</p>
<p class="whitespace-pre-wrap my-4">而且，当第一次调用 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">VideoPlayer</code> 时，对应的 DOM 节点还不存在！因为 React 在你返回 JSX 之前不知道要创建什么样的 DOM，所以没有 DOM 节点可以调用 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">play()</code> 或 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">pause()</code> 方法。</p>
<p class="whitespace-pre-wrap my-4">解决办法是 <strong class="font-bold">使用 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">useEffect</code> 包裹副作用，把它分离到渲染逻辑的计算过程之外</strong>：</p>
<!--$--><div dir="ltr" class="sandpack sandpack--codeblock rounded-2xl h-full w-full overflow-x-auto flex items-center bg-wash dark:bg-gray-95 shadow-lg my-8" style="contain:content"><div class="sp-wrapper"><div class="sp-stack"><div class="sp-code-editor"><pre class="sp-cm sp-pristine sp-javascript flex align-start"><code class="sp-pre-placeholder grow-[2]"><div class="cm-line "><span class="sp-syntax-keyword">import</span> <span class="sp-syntax-punctuation">{</span> <span class="sp-syntax-plain">useEffect</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">useRef</span> <span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-keyword">from</span> <span class="sp-syntax-string">&#x27;react&#x27;</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line "><br/></div><div class="cm-line "><span class="sp-syntax-keyword">function</span> <span class="sp-syntax-definition">VideoPlayer</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">{</span> <span class="sp-syntax-property">src</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-property">isPlaying</span> <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line ">  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">ref</span> = <span class="sp-syntax-definition">useRef</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-keyword">null</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line "><br/></div><div class="cm-line bg-github-highlight dark:bg-opacity-10">  <span class="sp-syntax-definition">useEffect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line ">    <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">isPlaying</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line ">      <span class="sp-syntax-plain">ref</span>.<span class="sp-syntax-property">current</span>.<span class="sp-syntax-property">play</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line ">    <span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-keyword">else</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line ">      <span class="sp-syntax-plain">ref</span>.<span class="sp-syntax-property">current</span>.<span class="sp-syntax-property">pause</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line ">    <span class="sp-syntax-punctuation">}</span><br/></div><div class="cm-line bg-github-highlight dark:bg-opacity-10">  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line "><br/></div><div class="cm-line ">  <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-tag">video</span> <span class="sp-syntax-property">ref</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">ref</span><span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-property">src</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">src</span><span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-property">loop</span> <span class="sp-syntax-property">playsInline</span> <span class="sp-syntax-punctuation">/&gt;</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line "><span class="sp-syntax-punctuation">}</span></div></code></pre></div></div></div></div><!--/$-->
<p class="whitespace-pre-wrap my-4">通过将 DOM 更新封装在 Effect 中，你可以让 React 先更新页面，然后再运行 Effect。</p>
<p class="whitespace-pre-wrap my-4">当 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">VideoPlayer</code> 组件渲染时（无论是否为首次渲染），会发生以下几件事：首先 React 会更新页面，确保 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">&lt;video&gt;</code> 标签带着正确的 props 出现在 DOM 中；接着 React 将运行 Effect；最后 Effect 将根据 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">isPlaying</code> 的值调用 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">play()</code> 或 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">pause()</code>。</p>
<p class="whitespace-pre-wrap my-4">试试点击几次播放和暂停按钮，观察视频播放器的行为是如何与 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">isPlaying</code> 的值相同步的：</p>
</div><!--$--><div class="sandpack sandpack--playground w-full my-8" dir="ltr"><div class="sp-wrapper"><div class="shadow-lg dark:shadow-lg-dark rounded-lg" style="contain:content"><div class="bg-wash dark:bg-card-dark flex justify-between items-center relative z-10 border-b border-border dark:border-border-dark rounded-t-lg text-lg"><div class="flex-1 grow min-w-0 px-4 lg:px-6"><div><div class="relative overflow-hidden"><div class="w-[fit-content] invisible"><div class=" sp-tabs" translate="no"><div aria-label="Select active file" class=" sp-tabs-scrollable-container" role="tablist"><button aria-selected="true" class="  sp-tab-button" data-active="true" role="tab" title="/src/App.js" type="button">App.js</button></div></div></div><button class="absolute top-0 start-[2px]" id="headlessui-listbox-button-:Rj54cq6:" aria-haspopup="true" aria-expanded="false" data-headlessui-state=""><span class="h-full py-2 px-1 mt-px -mb-px flex border-b text-link dark:text-link-dark border-link dark:border-link-dark items-center text-md leading-tight truncate" style="max-width:160px">App.js</span></button></div></div></div><div class="px-3 flex items-center justify-end text-start" translate="yes"><button class="text-sm text-primary dark:text-primary-dark inline-flex items-center hover:text-link duration-100 ease-in transition mx-1" title="Reset Sandbox" type="button"><svg width="1em" height="1em" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="inline mx-1 relative"><path d="M13.8982 5.20844C12.4626 4.88688 10.9686 4.93769 9.55821 5.35604L11.8524 3.06184C11.8989 3.0154 11.9357 2.96028 11.9608 2.89961C11.986 2.83894 11.9989 2.77391 11.9989 2.70824C11.9989 2.64256 11.986 2.57754 11.9608 2.51686C11.9357 2.45619 11.8989 2.40107 11.8524 2.35464L11.1456 1.64784C11.0992 1.60139 11.0441 1.56455 10.9834 1.53942C10.9227 1.51428 10.8577 1.50134 10.792 1.50134C10.7263 1.50134 10.6613 1.51428 10.6006 1.53942C10.54 1.56455 10.4848 1.60139 10.4384 1.64784L6.14571 5.94054C6.00654 6.07969 5.89615 6.2449 5.82083 6.42673C5.74551 6.60855 5.70675 6.80343 5.70675 7.00024C5.70675 7.19704 5.74551 7.39192 5.82083 7.57374C5.89615 7.75557 6.00654 7.92078 6.14571 8.05994L10.4387 12.3529C10.5325 12.4465 10.6595 12.4991 10.792 12.4991C10.9245 12.4991 11.0516 12.4465 11.1453 12.3529L11.8527 11.6455C11.9463 11.5518 11.9989 11.4247 11.9989 11.2922C11.9989 11.1598 11.9463 11.0327 11.8527 10.9389L8.77481 7.86104C9.99795 7.16236 11.415 6.8801 12.8125 7.05678C14.21 7.23347 15.5122 7.85953 16.523 8.84064C17.5338 9.82176 18.1983 11.1048 18.4165 12.4964C18.6347 13.888 18.3947 15.3129 17.7328 16.5562C17.0708 17.7996 16.0227 18.7942 14.7463 19.3902C13.47 19.9861 12.0345 20.1511 10.6563 19.8603C9.27798 19.5695 8.03152 18.8387 7.10469 17.778C6.17786 16.7172 5.62086 15.384 5.51761 13.9791C5.51156 13.8512 5.45689 13.7303 5.36477 13.6413C5.27265 13.5522 5.15001 13.5017 5.02191 13.5H4.02081C3.95297 13.4996 3.88574 13.5129 3.8232 13.5392C3.76065 13.5655 3.70408 13.6042 3.6569 13.6529C3.60972 13.7017 3.57291 13.7595 3.54869 13.8228C3.52448 13.8862 3.51336 13.9538 3.51601 14.0216C3.61349 15.5965 4.1473 17.1132 5.0577 18.4019C5.9681 19.6906 7.21917 20.7006 8.6709 21.3188C10.1226 21.937 11.7178 22.139 13.2778 21.9022C14.8378 21.6654 16.3011 20.9992 17.504 19.978C18.7069 18.9569 19.6019 17.6212 20.0889 16.1203C20.5759 14.6195 20.6356 13.0128 20.2614 11.4799C19.8872 9.94705 19.0938 8.54858 17.97 7.44098C16.8462 6.33339 15.4363 5.56037 13.8982 5.20844V5.20844Z" fill="currentColor"></path></svg> 重置</button><a href="https://codesandbox.io/api/v1/sandboxes/define?undefined&amp;environment=create-react-app" rel="noreferrer noopener" target="_blank" title="Open in CodeSandbox" class="text-sm text-primary dark:text-primary-dark inline-flex items-center hover:text-link duration-100 ease-in transition mx-1 ms-2 md:ms-1"><svg width="1em" height="1em" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="inline mx-1 relative top-[1px]"><path d="M20.5001 2H15.5001C15.3675 2 15.2403 2.05268 15.1465 2.14645C15.0528 2.24021 15.0001 2.36739 15.0001 2.5V3.5C15.0001 3.63261 15.0528 3.75979 15.1465 3.85355C15.2403 3.94732 15.3675 4 15.5001 4H18.5901L7.6501 14.94C7.60323 14.9865 7.56604 15.0418 7.54065 15.1027C7.51527 15.1636 7.5022 15.229 7.5022 15.295C7.5022 15.361 7.51527 15.4264 7.54065 15.4873C7.56604 15.5482 7.60323 15.6035 7.6501 15.65L8.3501 16.35C8.39658 16.3969 8.45188 16.4341 8.51281 16.4594C8.57374 16.4848 8.63909 16.4979 8.7051 16.4979C8.7711 16.4979 8.83646 16.4848 8.89738 16.4594C8.95831 16.4341 9.01362 16.3969 9.0601 16.35L20.0001 5.41V8.5C20.0001 8.63261 20.0528 8.75979 20.1465 8.85355C20.2403 8.94732 20.3675 9 20.5001 9H21.5001C21.6327 9 21.7599 8.94732 21.8537 8.85355C21.9474 8.75979 22.0001 8.63261 22.0001 8.5V3.5C22.0001 3.10218 21.8421 2.72064 21.5608 2.43934C21.2795 2.15804 20.8979 2 20.5001 2V2Z" fill="currentColor"></path><path d="M21.5 13H20.5C20.3674 13 20.2402 13.0527 20.1464 13.1464C20.0527 13.2402 20 13.3674 20 13.5V20H4V4H10.5C10.6326 4 10.7598 3.94732 10.8536 3.85355C10.9473 3.75979 11 3.63261 11 3.5V2.5C11 2.36739 10.9473 2.24021 10.8536 2.14645C10.7598 2.05268 10.6326 2 10.5 2H3.5C3.10218 2 2.72064 2.15804 2.43934 2.43934C2.15804 2.72064 2 3.10218 2 3.5V20.5C2 20.8978 2.15804 21.2794 2.43934 21.5607C2.72064 21.842 3.10218 22 3.5 22H20.5C20.8978 22 21.2794 21.842 21.5607 21.5607C21.842 21.2794 22 20.8978 22 20.5V13.5C22 13.3674 21.9473 13.2402 21.8536 13.1464C21.7598 13.0527 21.6326 13 21.5 13Z" fill="currentColor"></path></svg><span class="hidden md:block">Fork</span></a></div></div><div class=" sp-layout"><div class=" sp-editor sp-stack"><div class=" sp-code-editor"><div aria-autocomplete="list" aria-label="Code Editor for App.js" aria-multiline="true" class="sp-pristine sp-javascript   sp-cm" role="textbox" tabindex="0" translate="no"><pre class=" sp-pre-placeholder" style="margin-left:var(--sp-space-11)"><span class="sp-syntax-keyword">import</span> <span class="sp-syntax-punctuation">{</span> <span class="sp-syntax-plain">useState</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">useRef</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">useEffect</span> <span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-keyword">from</span> <span class="sp-syntax-string">&#x27;react&#x27;</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-keyword">function</span> <span class="sp-syntax-definition">VideoPlayer</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">{</span> <span class="sp-syntax-property">src</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-property">isPlaying</span> <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">ref</span> = <span class="sp-syntax-definition">useRef</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-keyword">null</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>

  <span class="sp-syntax-definition">useEffect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">isPlaying</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
      <span class="sp-syntax-plain">ref</span>.<span class="sp-syntax-property">current</span>.<span class="sp-syntax-property">play</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-keyword">else</span> <span class="sp-syntax-punctuation">{</span>
      <span class="sp-syntax-plain">ref</span>.<span class="sp-syntax-property">current</span>.<span class="sp-syntax-property">pause</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-punctuation">}</span>
  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>

  <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-tag">video</span> <span class="sp-syntax-property">ref</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">ref</span><span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-property">src</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">src</span><span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-property">loop</span> <span class="sp-syntax-property">playsInline</span> <span class="sp-syntax-punctuation">/&gt;</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-punctuation">}</span>

<span class="sp-syntax-keyword">export</span> <span class="sp-syntax-keyword">default</span> <span class="sp-syntax-keyword">function</span> <span class="sp-syntax-definition">App</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-plain">isPlaying</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">setIsPlaying</span><span class="sp-syntax-punctuation">]</span> = <span class="sp-syntax-definition">useState</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-static">false</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-punctuation">(</span>
    <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-punctuation">&gt;</span>
      <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-tag">button</span> <span class="sp-syntax-property">onClick</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-definition">setIsPlaying</span><span class="sp-syntax-punctuation">(</span>!<span class="sp-syntax-plain">isPlaying</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">&gt;</span>
        <span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">isPlaying</span> ? <span class="sp-syntax-string">&#x27;暂停&#x27;</span> : <span class="sp-syntax-string">&#x27;播放&#x27;</span><span class="sp-syntax-punctuation">}</span>
      <span class="sp-syntax-punctuation">&lt;/</span><span class="sp-syntax-tag">button</span><span class="sp-syntax-punctuation">&gt;</span>
      <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-definition">VideoPlayer</span>
        <span class="sp-syntax-property">isPlaying</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">isPlaying</span><span class="sp-syntax-punctuation">}</span>
        <span class="sp-syntax-property">src</span>=<span class="sp-syntax-string">&quot;https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4&quot;</span>
      <span class="sp-syntax-punctuation">/&gt;</span>
    <span class="sp-syntax-punctuation">&lt;/</span><span class="sp-syntax-punctuation">&gt;</span>
  <span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-punctuation">}</span>

</pre></div></div></div><div class=" order-last xl:order-2 sp-stack"><div class="p-0 sm:p-2 md:p-4 lg:p-8 bg-card dark:bg-wash-dark h-full relative md:rounded-b-lg lg:rounded-b-none"><div style="position:relative"><iframe class="rounded-t-none bg-white md:shadow-md sm:rounded-lg w-full max-w-full transition-opacity absolute opacity-0 pointer-events-none duration-75" title="Sandbox Preview" style="height:15px;z-index:-1"></iframe></div></div></div><button translate="yes" class="sandpack-expand flex text-base justify-between dark:border-card-dark bg-wash dark:bg-card-dark items-center z-10 p-1 w-full order-2 xl:order-last border-b-1 relative top-0"><span class="flex p-2 focus:outline-none text-primary dark:text-primary-dark leading-[20px]"><svg class="rotate-0 inline me-1.5 text-xl" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><g fill="none" fill-rule="evenodd" transform="translate(-446 -398)"><path fill="currentColor" fill-rule="nonzero" d="M95.8838835,240.366117 C95.3957281,239.877961 94.6042719,239.877961 94.1161165,240.366117 C93.6279612,240.854272 93.6279612,241.645728 94.1161165,242.133883 L98.6161165,246.633883 C99.1042719,247.122039 99.8957281,247.122039 100.383883,246.633883 L104.883883,242.133883 C105.372039,241.645728 105.372039,240.854272 104.883883,240.366117 C104.395728,239.877961 103.604272,239.877961 103.116117,240.366117 L99.5,243.982233 L95.8838835,240.366117 Z" transform="translate(356.5 164.5)"></path><polygon points="446 418 466 418 466 398 446 398"></polygon></g></svg>显示更多</span></button></div></div></div></div><!--/$--><div class="max-w-4xl ms-0 2xl:mx-auto">
<p class="whitespace-pre-wrap my-4">在这个示例中，你同步到 React state 的“外部系统”是浏览器媒体 API。你也可以使用类似的方法将传统的非 React 代码（如 jQuery 插件）封装成声明式的 React 组件。</p>
<p class="whitespace-pre-wrap my-4">需要注意的是，控制视频播放器在实际应用中要复杂得多：比如调用 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">play()</code> 可能会失败、用户可能会使用内置的浏览器控件来进行播放或暂停等操作。本例子是一个非常简化且不完整的示例。</p>
<div class="expandable-callout pt-8 pb-4 px-5 sm:px-8 my-8 relative rounded-none shadow-inner-border -mx-5 sm:mx-auto sm:rounded-2xl bg-yellow-5 dark:bg-yellow-60 dark:bg-opacity-20"><h3 class="text-2xl font-display font-bold text-yellow-50 dark:text-yellow-40"><svg class="inline me-3 mb-1 text-lg text-yellow-50 dark:text-yellow-40" width="2em" height="2em" viewBox="0 0 72 72" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_738_836)"><path fill-rule="evenodd" clip-rule="evenodd" d="M27 48L27 57.3409L40.0772 48L55.6975 48C57.1595 48 58.1986 47.0112 58.3851 45.8604C59.1824 40.9398 60 34.619 60 29.625C60 24.7282 59.2125 18.7546 58.4302 14.0813C58.2445 12.9721 57.2326 12 55.7805 12L16.2195 12C14.7674 12 13.7555 12.9721 13.5698 14.0813C12.7875 18.7546 12 24.7282 12 29.625C12 34.619 12.8176 40.9398 13.6149 45.8604C13.8014 47.0112 14.8404 48 16.3025 48H27ZM42 54H55.6975C59.9534 54 63.6271 51.0213 64.3078 46.8201C65.1161 41.8322 66 35.1209 66 29.625C66 24.2196 65.1449 17.8522 64.3478 13.0906C63.6513 8.93026 59.9987 6 55.7805 6H16.2195C12.0013 6 8.34867 8.93026 7.65218 13.0906C6.85505 17.8522 6 24.2196 6 29.625C6 35.1209 6.88391 41.8322 7.69215 46.8201C8.37291 51.0213 12.0466 54 16.3025 54H21L21 63.1704C21 65.6106 23.7581 67.0299 25.7437 65.6116L42 54ZM39 39.3686C39 40.9422 38 41.9912 36 41.9912C34 41.9912 33 40.9422 33 39.3686C33 37.7951 34 36.746 36 36.746C38 36.746 39 37.7951 39 39.3686ZM38.1771 20.2412C38.1771 18.9986 37.1697 17.9912 35.9271 17.9912C34.6845 17.9912 33.6771 18.9986 33.6771 20.2412V31.5956C33.6771 32.8382 34.6845 33.8456 35.9271 33.8456C37.1697 33.8456 38.1771 32.8382 38.1771 31.5956V20.2412Z" fill="currentColor"></path></g><defs><clipPath id="clip0_738_836"><rect width="72" height="72" fill="white"></rect></clipPath></defs></svg>陷阱</h3><div class="relative"><div class="py-2"><p class="whitespace-pre-wrap my-4">默认情况下，Effect 会在 <strong class="font-bold">每次</strong> 渲染后运行。<strong class="font-bold">正因如此，以下代码会陷入死循环</strong>：</p><!--$--><div dir="ltr" class="sandpack sandpack--codeblock rounded-2xl h-full w-full overflow-x-auto flex items-center bg-wash dark:bg-gray-95 shadow-lg my-8" style="contain:content"><div class="sp-wrapper"><div class="sp-stack"><div class="sp-code-editor"><pre class="sp-cm sp-pristine sp-javascript flex align-start"><code class="sp-pre-placeholder grow-[2]"><div class="cm-line "><span class="sp-syntax-keyword">const</span> <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-plain">count</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">setCount</span><span class="sp-syntax-punctuation">]</span> = <span class="sp-syntax-definition">useState</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-static">0</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line "><span class="sp-syntax-definition">useEffect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line ">  <span class="sp-syntax-definition">setCount</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">count</span> + <span class="sp-syntax-static">1</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line "><span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span></div></code></pre></div></div></div></div><!--/$--><p class="whitespace-pre-wrap my-4">Effect 在渲染结束后运行。更新 state 会触发重新渲染。在 Effect 中直接更新 state 就像是把电源插座的插头插回自身：Effect 运行、更新 state、触发重新渲染、于是又触发 Effect 运行、再次更新 state，继而再次触发重新渲染。如此反复，从而陷入死循环。</p><p class="whitespace-pre-wrap my-4">Effect 应该用于将你的组件与一个 <strong class="font-bold">外部</strong> 的系统保持同步。如果没有外部系统，你只是想根据其他状态调整一些状态，那么 <a class="inline text-link dark:text-link-dark border-b border-link border-opacity-0 hover:border-opacity-100 duration-100 ease-in transition leading-normal" href="/learn/you-might-not-need-an-effect">你也许不需要 Effect</a>。</p></div></div></div>
<h3 id="step-2-specify-the-effect-dependencies" class="mdx-heading text-2xl font-display leading-9 text-primary dark:text-primary-dark font-bold my-6">第二步：指定 Effect 的依赖项 <a href="#step-2-specify-the-effect-dependencies" aria-label="Link for 第二步：指定 Effect 的依赖项 " title="Link for 第二步：指定 Effect 的依赖项 " class="mdx-header-anchor inline-block"><svg width="1em" height="1em" viewBox="0 0 13 13" xmlns="http://www.w3.org/2000/svg" class="text-gray-70 ms-2 h-5 w-5"><g fill="currentColor" fill-rule="evenodd"><path d="M7.778 7.975a2.5 2.5 0 0 0 .347-3.837L6.017 2.03a2.498 2.498 0 0 0-3.542-.007 2.5 2.5 0 0 0 .006 3.543l1.153 1.15c.07-.29.154-.563.25-.773.036-.077.084-.16.14-.25L3.18 4.85a1.496 1.496 0 0 1 .002-2.12 1.496 1.496 0 0 1 2.12 0l2.124 2.123a1.496 1.496 0 0 1-.333 2.37c.16.246.42.504.685.752z"></path><path d="M5.657 4.557a2.5 2.5 0 0 0-.347 3.837l2.108 2.108a2.498 2.498 0 0 0 3.542.007 2.5 2.5 0 0 0-.006-3.543L9.802 5.815c-.07.29-.154.565-.25.774-.036.076-.084.16-.14.25l.842.84c.585.587.59 1.532 0 2.122-.587.585-1.532.59-2.12 0L6.008 7.68a1.496 1.496 0 0 1 .332-2.372c-.16-.245-.42-.503-.685-.75z"></path></g></svg></a></h3>
<p class="whitespace-pre-wrap my-4">默认情况下，Effect 会在 <strong class="font-bold">每次</strong> 渲染后运行。但往往 <strong class="font-bold">这并不是你想要的</strong>：</p>
<ul class="ms-6 my-3 list-disc">
<li class="leading-relaxed mb-1">有时，它可能会很慢。与外部系统的同步并不总是即时的，所以你可能希望在不必要时跳过它。例如，你不会想在每次打字时都得重新连接聊天服务器。</li>
<li class="leading-relaxed mb-1">有时，它可能会出错。例如，你不会想在每次按键时都触发组件的淡入动画。动画应该只在组件首次出现时播放。</li>
</ul>
<p class="whitespace-pre-wrap my-4">为了演示这个问题，以下是在之前的示例中加入了一些 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">console.log</code> 调用和一个更新父组件 state 的文本输入框。注意在输入时是如何触发 Effect 重新运行的：</p>
</div><!--$--><div class="sandpack sandpack--playground w-full my-8" dir="ltr"><div class="sp-wrapper"><div class="shadow-lg dark:shadow-lg-dark rounded-lg" style="contain:content"><div class="bg-wash dark:bg-card-dark flex justify-between items-center relative z-10 border-b border-border dark:border-border-dark rounded-t-lg text-lg"><div class="flex-1 grow min-w-0 px-4 lg:px-6"><div><div class="relative overflow-hidden"><div class="w-[fit-content] invisible"><div class=" sp-tabs" translate="no"><div aria-label="Select active file" class=" sp-tabs-scrollable-container" role="tablist"><button aria-selected="true" class="  sp-tab-button" data-active="true" role="tab" title="/src/App.js" type="button">App.js</button></div></div></div><button class="absolute top-0 start-[2px]" id="headlessui-listbox-button-:Rj56cq6:" aria-haspopup="true" aria-expanded="false" data-headlessui-state=""><span class="h-full py-2 px-1 mt-px -mb-px flex border-b text-link dark:text-link-dark border-link dark:border-link-dark items-center text-md leading-tight truncate" style="max-width:160px">App.js</span></button></div></div></div><div class="px-3 flex items-center justify-end text-start" translate="yes"><button class="text-sm text-primary dark:text-primary-dark inline-flex items-center hover:text-link duration-100 ease-in transition mx-1" title="Reset Sandbox" type="button"><svg width="1em" height="1em" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="inline mx-1 relative"><path d="M13.8982 5.20844C12.4626 4.88688 10.9686 4.93769 9.55821 5.35604L11.8524 3.06184C11.8989 3.0154 11.9357 2.96028 11.9608 2.89961C11.986 2.83894 11.9989 2.77391 11.9989 2.70824C11.9989 2.64256 11.986 2.57754 11.9608 2.51686C11.9357 2.45619 11.8989 2.40107 11.8524 2.35464L11.1456 1.64784C11.0992 1.60139 11.0441 1.56455 10.9834 1.53942C10.9227 1.51428 10.8577 1.50134 10.792 1.50134C10.7263 1.50134 10.6613 1.51428 10.6006 1.53942C10.54 1.56455 10.4848 1.60139 10.4384 1.64784L6.14571 5.94054C6.00654 6.07969 5.89615 6.2449 5.82083 6.42673C5.74551 6.60855 5.70675 6.80343 5.70675 7.00024C5.70675 7.19704 5.74551 7.39192 5.82083 7.57374C5.89615 7.75557 6.00654 7.92078 6.14571 8.05994L10.4387 12.3529C10.5325 12.4465 10.6595 12.4991 10.792 12.4991C10.9245 12.4991 11.0516 12.4465 11.1453 12.3529L11.8527 11.6455C11.9463 11.5518 11.9989 11.4247 11.9989 11.2922C11.9989 11.1598 11.9463 11.0327 11.8527 10.9389L8.77481 7.86104C9.99795 7.16236 11.415 6.8801 12.8125 7.05678C14.21 7.23347 15.5122 7.85953 16.523 8.84064C17.5338 9.82176 18.1983 11.1048 18.4165 12.4964C18.6347 13.888 18.3947 15.3129 17.7328 16.5562C17.0708 17.7996 16.0227 18.7942 14.7463 19.3902C13.47 19.9861 12.0345 20.1511 10.6563 19.8603C9.27798 19.5695 8.03152 18.8387 7.10469 17.778C6.17786 16.7172 5.62086 15.384 5.51761 13.9791C5.51156 13.8512 5.45689 13.7303 5.36477 13.6413C5.27265 13.5522 5.15001 13.5017 5.02191 13.5H4.02081C3.95297 13.4996 3.88574 13.5129 3.8232 13.5392C3.76065 13.5655 3.70408 13.6042 3.6569 13.6529C3.60972 13.7017 3.57291 13.7595 3.54869 13.8228C3.52448 13.8862 3.51336 13.9538 3.51601 14.0216C3.61349 15.5965 4.1473 17.1132 5.0577 18.4019C5.9681 19.6906 7.21917 20.7006 8.6709 21.3188C10.1226 21.937 11.7178 22.139 13.2778 21.9022C14.8378 21.6654 16.3011 20.9992 17.504 19.978C18.7069 18.9569 19.6019 17.6212 20.0889 16.1203C20.5759 14.6195 20.6356 13.0128 20.2614 11.4799C19.8872 9.94705 19.0938 8.54858 17.97 7.44098C16.8462 6.33339 15.4363 5.56037 13.8982 5.20844V5.20844Z" fill="currentColor"></path></svg> 重置</button><a href="https://codesandbox.io/api/v1/sandboxes/define?undefined&amp;environment=create-react-app" rel="noreferrer noopener" target="_blank" title="Open in CodeSandbox" class="text-sm text-primary dark:text-primary-dark inline-flex items-center hover:text-link duration-100 ease-in transition mx-1 ms-2 md:ms-1"><svg width="1em" height="1em" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="inline mx-1 relative top-[1px]"><path d="M20.5001 2H15.5001C15.3675 2 15.2403 2.05268 15.1465 2.14645C15.0528 2.24021 15.0001 2.36739 15.0001 2.5V3.5C15.0001 3.63261 15.0528 3.75979 15.1465 3.85355C15.2403 3.94732 15.3675 4 15.5001 4H18.5901L7.6501 14.94C7.60323 14.9865 7.56604 15.0418 7.54065 15.1027C7.51527 15.1636 7.5022 15.229 7.5022 15.295C7.5022 15.361 7.51527 15.4264 7.54065 15.4873C7.56604 15.5482 7.60323 15.6035 7.6501 15.65L8.3501 16.35C8.39658 16.3969 8.45188 16.4341 8.51281 16.4594C8.57374 16.4848 8.63909 16.4979 8.7051 16.4979C8.7711 16.4979 8.83646 16.4848 8.89738 16.4594C8.95831 16.4341 9.01362 16.3969 9.0601 16.35L20.0001 5.41V8.5C20.0001 8.63261 20.0528 8.75979 20.1465 8.85355C20.2403 8.94732 20.3675 9 20.5001 9H21.5001C21.6327 9 21.7599 8.94732 21.8537 8.85355C21.9474 8.75979 22.0001 8.63261 22.0001 8.5V3.5C22.0001 3.10218 21.8421 2.72064 21.5608 2.43934C21.2795 2.15804 20.8979 2 20.5001 2V2Z" fill="currentColor"></path><path d="M21.5 13H20.5C20.3674 13 20.2402 13.0527 20.1464 13.1464C20.0527 13.2402 20 13.3674 20 13.5V20H4V4H10.5C10.6326 4 10.7598 3.94732 10.8536 3.85355C10.9473 3.75979 11 3.63261 11 3.5V2.5C11 2.36739 10.9473 2.24021 10.8536 2.14645C10.7598 2.05268 10.6326 2 10.5 2H3.5C3.10218 2 2.72064 2.15804 2.43934 2.43934C2.15804 2.72064 2 3.10218 2 3.5V20.5C2 20.8978 2.15804 21.2794 2.43934 21.5607C2.72064 21.842 3.10218 22 3.5 22H20.5C20.8978 22 21.2794 21.842 21.5607 21.5607C21.842 21.2794 22 20.8978 22 20.5V13.5C22 13.3674 21.9473 13.2402 21.8536 13.1464C21.7598 13.0527 21.6326 13 21.5 13Z" fill="currentColor"></path></svg><span class="hidden md:block">Fork</span></a></div></div><div class=" sp-layout"><div class=" sp-editor sp-stack"><div class=" sp-code-editor"><div aria-autocomplete="list" aria-label="Code Editor for App.js" aria-multiline="true" class="sp-pristine sp-javascript   sp-cm" role="textbox" tabindex="0" translate="no"><pre class=" sp-pre-placeholder" style="margin-left:var(--sp-space-11)"><span class="sp-syntax-keyword">import</span> <span class="sp-syntax-punctuation">{</span> <span class="sp-syntax-plain">useState</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">useRef</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">useEffect</span> <span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-keyword">from</span> <span class="sp-syntax-string">&#x27;react&#x27;</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-keyword">function</span> <span class="sp-syntax-definition">VideoPlayer</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">{</span> <span class="sp-syntax-property">src</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-property">isPlaying</span> <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">ref</span> = <span class="sp-syntax-definition">useRef</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-keyword">null</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>

  <span class="sp-syntax-definition">useEffect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">isPlaying</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
      <span class="sp-syntax-plain">console</span>.<span class="sp-syntax-property">log</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-string">&#x27;调用 video.play()&#x27;</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
      <span class="sp-syntax-plain">ref</span>.<span class="sp-syntax-property">current</span>.<span class="sp-syntax-property">play</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-keyword">else</span> <span class="sp-syntax-punctuation">{</span>
      <span class="sp-syntax-plain">console</span>.<span class="sp-syntax-property">log</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-string">&#x27;调用 video.pause()&#x27;</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
      <span class="sp-syntax-plain">ref</span>.<span class="sp-syntax-property">current</span>.<span class="sp-syntax-property">pause</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-punctuation">}</span>
  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>

  <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-tag">video</span> <span class="sp-syntax-property">ref</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">ref</span><span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-property">src</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">src</span><span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-property">loop</span> <span class="sp-syntax-property">playsInline</span> <span class="sp-syntax-punctuation">/&gt;</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-punctuation">}</span>

<span class="sp-syntax-keyword">export</span> <span class="sp-syntax-keyword">default</span> <span class="sp-syntax-keyword">function</span> <span class="sp-syntax-definition">App</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-plain">isPlaying</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">setIsPlaying</span><span class="sp-syntax-punctuation">]</span> = <span class="sp-syntax-definition">useState</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-static">false</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-plain">text</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">setText</span><span class="sp-syntax-punctuation">]</span> = <span class="sp-syntax-definition">useState</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-string">&#x27;&#x27;</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-punctuation">(</span>
    <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-punctuation">&gt;</span>
      <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-tag">input</span> <span class="sp-syntax-property">value</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">text</span><span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-property">onChange</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">e</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-definition">setText</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">target</span>.<span class="sp-syntax-property">value</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-punctuation">/&gt;</span>
      <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-tag">button</span> <span class="sp-syntax-property">onClick</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-definition">setIsPlaying</span><span class="sp-syntax-punctuation">(</span>!<span class="sp-syntax-plain">isPlaying</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">&gt;</span>
        <span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">isPlaying</span> ? <span class="sp-syntax-string">&#x27;暂停&#x27;</span> : <span class="sp-syntax-string">&#x27;播放&#x27;</span><span class="sp-syntax-punctuation">}</span>
      <span class="sp-syntax-punctuation">&lt;/</span><span class="sp-syntax-tag">button</span><span class="sp-syntax-punctuation">&gt;</span>
      <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-definition">VideoPlayer</span>
        <span class="sp-syntax-property">isPlaying</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">isPlaying</span><span class="sp-syntax-punctuation">}</span>
        <span class="sp-syntax-property">src</span>=<span class="sp-syntax-string">&quot;https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4&quot;</span>
      <span class="sp-syntax-punctuation">/&gt;</span>
    <span class="sp-syntax-punctuation">&lt;/</span><span class="sp-syntax-punctuation">&gt;</span>
  <span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-punctuation">}</span>

</pre></div></div></div><div class=" order-last xl:order-2 sp-stack"><div class="p-0 sm:p-2 md:p-4 lg:p-8 bg-card dark:bg-wash-dark h-full relative md:rounded-b-lg lg:rounded-b-none"><div style="position:relative"><iframe class="rounded-t-none bg-white md:shadow-md sm:rounded-lg w-full max-w-full transition-opacity absolute opacity-0 pointer-events-none duration-75" title="Sandbox Preview" style="height:15px;z-index:-1"></iframe></div></div></div><button translate="yes" class="sandpack-expand flex text-base justify-between dark:border-card-dark bg-wash dark:bg-card-dark items-center z-10 p-1 w-full order-2 xl:order-last border-b-1 relative top-0"><span class="flex p-2 focus:outline-none text-primary dark:text-primary-dark leading-[20px]"><svg class="rotate-0 inline me-1.5 text-xl" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><g fill="none" fill-rule="evenodd" transform="translate(-446 -398)"><path fill="currentColor" fill-rule="nonzero" d="M95.8838835,240.366117 C95.3957281,239.877961 94.6042719,239.877961 94.1161165,240.366117 C93.6279612,240.854272 93.6279612,241.645728 94.1161165,242.133883 L98.6161165,246.633883 C99.1042719,247.122039 99.8957281,247.122039 100.383883,246.633883 L104.883883,242.133883 C105.372039,241.645728 105.372039,240.854272 104.883883,240.366117 C104.395728,239.877961 103.604272,239.877961 103.116117,240.366117 L99.5,243.982233 L95.8838835,240.366117 Z" transform="translate(356.5 164.5)"></path><polygon points="446 418 466 418 466 398 446 398"></polygon></g></svg>显示更多</span></button></div></div></div></div><!--/$--><div class="max-w-4xl ms-0 2xl:mx-auto">
<p class="whitespace-pre-wrap my-4">通过在调用 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">useEffect</code> 时指定一个 <strong class="font-bold">依赖数组</strong> 作为第二个参数，你可以让 React <strong class="font-bold">跳过不必要地重新运行 Effect</strong>。首先，在上面示例的第 14 行中传入一个空数组 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">[]</code>：</p>
<!--$--><div dir="ltr" class="sandpack sandpack--codeblock rounded-2xl h-full w-full overflow-x-auto flex items-center bg-wash dark:bg-gray-95 shadow-lg my-8" style="contain:content"><div class="sp-wrapper"><div class="sp-stack"><div class="sp-code-editor"><pre class="sp-cm sp-pristine sp-javascript flex align-start"><code class="sp-pre-placeholder grow-[2]"><div class="cm-line ">  <span class="sp-syntax-definition">useEffect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line ">    <span class="sp-syntax-comment">// ...</span><br/></div><div class="cm-line bg-github-highlight dark:bg-opacity-10">  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span></div></code></pre></div></div></div></div><!--/$-->
<p class="whitespace-pre-wrap my-4">你会看到一个错误提示：<code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">React Hook useEffect has a missing dependency: &#x27;isPlaying&#x27;</code>：</p>
</div><!--$--><div class="sandpack sandpack--playground w-full my-8" dir="ltr"><div class="sp-wrapper"><div class="shadow-lg dark:shadow-lg-dark rounded-lg" style="contain:content"><div class="bg-wash dark:bg-card-dark flex justify-between items-center relative z-10 border-b border-border dark:border-border-dark rounded-t-lg text-lg"><div class="flex-1 grow min-w-0 px-4 lg:px-6"><div><div class="relative overflow-hidden"><div class="w-[fit-content] invisible"><div class=" sp-tabs" translate="no"><div aria-label="Select active file" class=" sp-tabs-scrollable-container" role="tablist"><button aria-selected="true" class="  sp-tab-button" data-active="true" role="tab" title="/src/App.js" type="button">App.js</button></div></div></div><button class="absolute top-0 start-[2px]" id="headlessui-listbox-button-:Rj58cq6:" aria-haspopup="true" aria-expanded="false" data-headlessui-state=""><span class="h-full py-2 px-1 mt-px -mb-px flex border-b text-link dark:text-link-dark border-link dark:border-link-dark items-center text-md leading-tight truncate" style="max-width:160px">App.js</span></button></div></div></div><div class="px-3 flex items-center justify-end text-start" translate="yes"><button class="text-sm text-primary dark:text-primary-dark inline-flex items-center hover:text-link duration-100 ease-in transition mx-1" title="Reset Sandbox" type="button"><svg width="1em" height="1em" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="inline mx-1 relative"><path d="M13.8982 5.20844C12.4626 4.88688 10.9686 4.93769 9.55821 5.35604L11.8524 3.06184C11.8989 3.0154 11.9357 2.96028 11.9608 2.89961C11.986 2.83894 11.9989 2.77391 11.9989 2.70824C11.9989 2.64256 11.986 2.57754 11.9608 2.51686C11.9357 2.45619 11.8989 2.40107 11.8524 2.35464L11.1456 1.64784C11.0992 1.60139 11.0441 1.56455 10.9834 1.53942C10.9227 1.51428 10.8577 1.50134 10.792 1.50134C10.7263 1.50134 10.6613 1.51428 10.6006 1.53942C10.54 1.56455 10.4848 1.60139 10.4384 1.64784L6.14571 5.94054C6.00654 6.07969 5.89615 6.2449 5.82083 6.42673C5.74551 6.60855 5.70675 6.80343 5.70675 7.00024C5.70675 7.19704 5.74551 7.39192 5.82083 7.57374C5.89615 7.75557 6.00654 7.92078 6.14571 8.05994L10.4387 12.3529C10.5325 12.4465 10.6595 12.4991 10.792 12.4991C10.9245 12.4991 11.0516 12.4465 11.1453 12.3529L11.8527 11.6455C11.9463 11.5518 11.9989 11.4247 11.9989 11.2922C11.9989 11.1598 11.9463 11.0327 11.8527 10.9389L8.77481 7.86104C9.99795 7.16236 11.415 6.8801 12.8125 7.05678C14.21 7.23347 15.5122 7.85953 16.523 8.84064C17.5338 9.82176 18.1983 11.1048 18.4165 12.4964C18.6347 13.888 18.3947 15.3129 17.7328 16.5562C17.0708 17.7996 16.0227 18.7942 14.7463 19.3902C13.47 19.9861 12.0345 20.1511 10.6563 19.8603C9.27798 19.5695 8.03152 18.8387 7.10469 17.778C6.17786 16.7172 5.62086 15.384 5.51761 13.9791C5.51156 13.8512 5.45689 13.7303 5.36477 13.6413C5.27265 13.5522 5.15001 13.5017 5.02191 13.5H4.02081C3.95297 13.4996 3.88574 13.5129 3.8232 13.5392C3.76065 13.5655 3.70408 13.6042 3.6569 13.6529C3.60972 13.7017 3.57291 13.7595 3.54869 13.8228C3.52448 13.8862 3.51336 13.9538 3.51601 14.0216C3.61349 15.5965 4.1473 17.1132 5.0577 18.4019C5.9681 19.6906 7.21917 20.7006 8.6709 21.3188C10.1226 21.937 11.7178 22.139 13.2778 21.9022C14.8378 21.6654 16.3011 20.9992 17.504 19.978C18.7069 18.9569 19.6019 17.6212 20.0889 16.1203C20.5759 14.6195 20.6356 13.0128 20.2614 11.4799C19.8872 9.94705 19.0938 8.54858 17.97 7.44098C16.8462 6.33339 15.4363 5.56037 13.8982 5.20844V5.20844Z" fill="currentColor"></path></svg> 重置</button><a href="https://codesandbox.io/api/v1/sandboxes/define?undefined&amp;environment=create-react-app" rel="noreferrer noopener" target="_blank" title="Open in CodeSandbox" class="text-sm text-primary dark:text-primary-dark inline-flex items-center hover:text-link duration-100 ease-in transition mx-1 ms-2 md:ms-1"><svg width="1em" height="1em" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="inline mx-1 relative top-[1px]"><path d="M20.5001 2H15.5001C15.3675 2 15.2403 2.05268 15.1465 2.14645C15.0528 2.24021 15.0001 2.36739 15.0001 2.5V3.5C15.0001 3.63261 15.0528 3.75979 15.1465 3.85355C15.2403 3.94732 15.3675 4 15.5001 4H18.5901L7.6501 14.94C7.60323 14.9865 7.56604 15.0418 7.54065 15.1027C7.51527 15.1636 7.5022 15.229 7.5022 15.295C7.5022 15.361 7.51527 15.4264 7.54065 15.4873C7.56604 15.5482 7.60323 15.6035 7.6501 15.65L8.3501 16.35C8.39658 16.3969 8.45188 16.4341 8.51281 16.4594C8.57374 16.4848 8.63909 16.4979 8.7051 16.4979C8.7711 16.4979 8.83646 16.4848 8.89738 16.4594C8.95831 16.4341 9.01362 16.3969 9.0601 16.35L20.0001 5.41V8.5C20.0001 8.63261 20.0528 8.75979 20.1465 8.85355C20.2403 8.94732 20.3675 9 20.5001 9H21.5001C21.6327 9 21.7599 8.94732 21.8537 8.85355C21.9474 8.75979 22.0001 8.63261 22.0001 8.5V3.5C22.0001 3.10218 21.8421 2.72064 21.5608 2.43934C21.2795 2.15804 20.8979 2 20.5001 2V2Z" fill="currentColor"></path><path d="M21.5 13H20.5C20.3674 13 20.2402 13.0527 20.1464 13.1464C20.0527 13.2402 20 13.3674 20 13.5V20H4V4H10.5C10.6326 4 10.7598 3.94732 10.8536 3.85355C10.9473 3.75979 11 3.63261 11 3.5V2.5C11 2.36739 10.9473 2.24021 10.8536 2.14645C10.7598 2.05268 10.6326 2 10.5 2H3.5C3.10218 2 2.72064 2.15804 2.43934 2.43934C2.15804 2.72064 2 3.10218 2 3.5V20.5C2 20.8978 2.15804 21.2794 2.43934 21.5607C2.72064 21.842 3.10218 22 3.5 22H20.5C20.8978 22 21.2794 21.842 21.5607 21.5607C21.842 21.2794 22 20.8978 22 20.5V13.5C22 13.3674 21.9473 13.2402 21.8536 13.1464C21.7598 13.0527 21.6326 13 21.5 13Z" fill="currentColor"></path></svg><span class="hidden md:block">Fork</span></a></div></div><div class=" sp-layout"><div class=" sp-editor sp-stack"><div class=" sp-code-editor"><div aria-autocomplete="list" aria-label="Code Editor for App.js" aria-multiline="true" class="sp-pristine sp-javascript   sp-cm" role="textbox" tabindex="0" translate="no"><pre class=" sp-pre-placeholder" style="margin-left:var(--sp-space-11)"><span class="sp-syntax-keyword">import</span> <span class="sp-syntax-punctuation">{</span> <span class="sp-syntax-plain">useState</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">useRef</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">useEffect</span> <span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-keyword">from</span> <span class="sp-syntax-string">&#x27;react&#x27;</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-keyword">function</span> <span class="sp-syntax-definition">VideoPlayer</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">{</span> <span class="sp-syntax-property">src</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-property">isPlaying</span> <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">ref</span> = <span class="sp-syntax-definition">useRef</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-keyword">null</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>

  <span class="sp-syntax-definition">useEffect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">isPlaying</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
      <span class="sp-syntax-plain">console</span>.<span class="sp-syntax-property">log</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-string">&#x27;调用 video.play()&#x27;</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
      <span class="sp-syntax-plain">ref</span>.<span class="sp-syntax-property">current</span>.<span class="sp-syntax-property">play</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-keyword">else</span> <span class="sp-syntax-punctuation">{</span>
      <span class="sp-syntax-plain">console</span>.<span class="sp-syntax-property">log</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-string">&#x27;调用 video.pause()&#x27;</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
      <span class="sp-syntax-plain">ref</span>.<span class="sp-syntax-property">current</span>.<span class="sp-syntax-property">pause</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-punctuation">}</span>
  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span> <span class="sp-syntax-comment">// 这将产生错误</span>

  <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-tag">video</span> <span class="sp-syntax-property">ref</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">ref</span><span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-property">src</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">src</span><span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-property">loop</span> <span class="sp-syntax-property">playsInline</span> <span class="sp-syntax-punctuation">/&gt;</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-punctuation">}</span>

<span class="sp-syntax-keyword">export</span> <span class="sp-syntax-keyword">default</span> <span class="sp-syntax-keyword">function</span> <span class="sp-syntax-definition">App</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-plain">isPlaying</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">setIsPlaying</span><span class="sp-syntax-punctuation">]</span> = <span class="sp-syntax-definition">useState</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-static">false</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-plain">text</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">setText</span><span class="sp-syntax-punctuation">]</span> = <span class="sp-syntax-definition">useState</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-string">&#x27;&#x27;</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-punctuation">(</span>
    <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-punctuation">&gt;</span>
      <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-tag">input</span> <span class="sp-syntax-property">value</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">text</span><span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-property">onChange</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">e</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-definition">setText</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">target</span>.<span class="sp-syntax-property">value</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-punctuation">/&gt;</span>
      <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-tag">button</span> <span class="sp-syntax-property">onClick</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-definition">setIsPlaying</span><span class="sp-syntax-punctuation">(</span>!<span class="sp-syntax-plain">isPlaying</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">&gt;</span>
        <span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">isPlaying</span> ? <span class="sp-syntax-string">&#x27;暂停&#x27;</span> : <span class="sp-syntax-string">&#x27;播放&#x27;</span><span class="sp-syntax-punctuation">}</span>
      <span class="sp-syntax-punctuation">&lt;/</span><span class="sp-syntax-tag">button</span><span class="sp-syntax-punctuation">&gt;</span>
      <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-definition">VideoPlayer</span>
        <span class="sp-syntax-property">isPlaying</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">isPlaying</span><span class="sp-syntax-punctuation">}</span>
        <span class="sp-syntax-property">src</span>=<span class="sp-syntax-string">&quot;https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4&quot;</span>
      <span class="sp-syntax-punctuation">/&gt;</span>
    <span class="sp-syntax-punctuation">&lt;/</span><span class="sp-syntax-punctuation">&gt;</span>
  <span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-punctuation">}</span>

</pre></div></div></div><div class=" order-last xl:order-2 sp-stack"><div class="p-0 sm:p-2 md:p-4 lg:p-8 bg-card dark:bg-wash-dark h-full relative md:rounded-b-lg lg:rounded-b-none"><div style="position:relative"><iframe class="rounded-t-none bg-white md:shadow-md sm:rounded-lg w-full max-w-full transition-opacity absolute opacity-0 pointer-events-none duration-75" title="Sandbox Preview" style="height:15px;z-index:-1"></iframe></div></div></div><button translate="yes" class="sandpack-expand flex text-base justify-between dark:border-card-dark bg-wash dark:bg-card-dark items-center z-10 p-1 w-full order-2 xl:order-last border-b-1 relative top-0"><span class="flex p-2 focus:outline-none text-primary dark:text-primary-dark leading-[20px]"><svg class="rotate-0 inline me-1.5 text-xl" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><g fill="none" fill-rule="evenodd" transform="translate(-446 -398)"><path fill="currentColor" fill-rule="nonzero" d="M95.8838835,240.366117 C95.3957281,239.877961 94.6042719,239.877961 94.1161165,240.366117 C93.6279612,240.854272 93.6279612,241.645728 94.1161165,242.133883 L98.6161165,246.633883 C99.1042719,247.122039 99.8957281,247.122039 100.383883,246.633883 L104.883883,242.133883 C105.372039,241.645728 105.372039,240.854272 104.883883,240.366117 C104.395728,239.877961 103.604272,239.877961 103.116117,240.366117 L99.5,243.982233 L95.8838835,240.366117 Z" transform="translate(356.5 164.5)"></path><polygon points="446 418 466 418 466 398 446 398"></polygon></g></svg>显示更多</span></button></div></div></div></div><!--/$--><div class="max-w-4xl ms-0 2xl:mx-auto">
<p class="whitespace-pre-wrap my-4">原因在于，你的 Effect 内部代码依赖于 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">isPlaying</code> prop 来决定该做什么，但你并没有显式声明这个依赖关系。为了解决这个问题，将 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">isPlaying</code> 添加至依赖数组中：</p>
<!--$--><div dir="ltr" class="sandpack sandpack--codeblock rounded-2xl h-full w-full overflow-x-auto flex items-center bg-wash dark:bg-gray-95 shadow-lg my-8" style="contain:content"><div class="sp-wrapper"><div class="sp-stack"><div class="sp-code-editor"><pre class="sp-cm sp-pristine sp-javascript flex align-start"><code class="sp-pre-placeholder grow-[2]"><div class="cm-line ">  <span class="sp-syntax-definition">useEffect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line bg-github-highlight dark:bg-opacity-10">    <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">isPlaying</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span> <span class="sp-syntax-comment">// isPlaying 在此处使用……</span><br/></div><div class="cm-line ">      <span class="sp-syntax-comment">// ...</span><br/></div><div class="cm-line ">    <span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-keyword">else</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line ">      <span class="sp-syntax-comment">// ...</span><br/></div><div class="cm-line ">    <span class="sp-syntax-punctuation">}</span><br/></div><div class="cm-line bg-github-highlight dark:bg-opacity-10">  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-plain">isPlaying</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span> <span class="sp-syntax-comment">// ……所以它必须在此处声明！</span></div></code></pre></div></div></div></div><!--/$-->
<p class="whitespace-pre-wrap my-4">现在所有的依赖都已经声明，所以没有错误了。指定 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">[isPlaying]</code> 作为依赖数组会告诉 React：如果 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">isPlaying</code> 与上次渲染时相同，就跳过重新运行 Effect。这样一来，输入框的输入不会触发 Effect 重新运行，只有按下播放/暂停按钮会触发。</p>
</div><!--$--><div class="sandpack sandpack--playground w-full my-8" dir="ltr"><div class="sp-wrapper"><div class="shadow-lg dark:shadow-lg-dark rounded-lg" style="contain:content"><div class="bg-wash dark:bg-card-dark flex justify-between items-center relative z-10 border-b border-border dark:border-border-dark rounded-t-lg text-lg"><div class="flex-1 grow min-w-0 px-4 lg:px-6"><div><div class="relative overflow-hidden"><div class="w-[fit-content] invisible"><div class=" sp-tabs" translate="no"><div aria-label="Select active file" class=" sp-tabs-scrollable-container" role="tablist"><button aria-selected="true" class="  sp-tab-button" data-active="true" role="tab" title="/src/App.js" type="button">App.js</button></div></div></div><button class="absolute top-0 start-[2px]" id="headlessui-listbox-button-:Rj5acq6:" aria-haspopup="true" aria-expanded="false" data-headlessui-state=""><span class="h-full py-2 px-1 mt-px -mb-px flex border-b text-link dark:text-link-dark border-link dark:border-link-dark items-center text-md leading-tight truncate" style="max-width:160px">App.js</span></button></div></div></div><div class="px-3 flex items-center justify-end text-start" translate="yes"><button class="text-sm text-primary dark:text-primary-dark inline-flex items-center hover:text-link duration-100 ease-in transition mx-1" title="Reset Sandbox" type="button"><svg width="1em" height="1em" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="inline mx-1 relative"><path d="M13.8982 5.20844C12.4626 4.88688 10.9686 4.93769 9.55821 5.35604L11.8524 3.06184C11.8989 3.0154 11.9357 2.96028 11.9608 2.89961C11.986 2.83894 11.9989 2.77391 11.9989 2.70824C11.9989 2.64256 11.986 2.57754 11.9608 2.51686C11.9357 2.45619 11.8989 2.40107 11.8524 2.35464L11.1456 1.64784C11.0992 1.60139 11.0441 1.56455 10.9834 1.53942C10.9227 1.51428 10.8577 1.50134 10.792 1.50134C10.7263 1.50134 10.6613 1.51428 10.6006 1.53942C10.54 1.56455 10.4848 1.60139 10.4384 1.64784L6.14571 5.94054C6.00654 6.07969 5.89615 6.2449 5.82083 6.42673C5.74551 6.60855 5.70675 6.80343 5.70675 7.00024C5.70675 7.19704 5.74551 7.39192 5.82083 7.57374C5.89615 7.75557 6.00654 7.92078 6.14571 8.05994L10.4387 12.3529C10.5325 12.4465 10.6595 12.4991 10.792 12.4991C10.9245 12.4991 11.0516 12.4465 11.1453 12.3529L11.8527 11.6455C11.9463 11.5518 11.9989 11.4247 11.9989 11.2922C11.9989 11.1598 11.9463 11.0327 11.8527 10.9389L8.77481 7.86104C9.99795 7.16236 11.415 6.8801 12.8125 7.05678C14.21 7.23347 15.5122 7.85953 16.523 8.84064C17.5338 9.82176 18.1983 11.1048 18.4165 12.4964C18.6347 13.888 18.3947 15.3129 17.7328 16.5562C17.0708 17.7996 16.0227 18.7942 14.7463 19.3902C13.47 19.9861 12.0345 20.1511 10.6563 19.8603C9.27798 19.5695 8.03152 18.8387 7.10469 17.778C6.17786 16.7172 5.62086 15.384 5.51761 13.9791C5.51156 13.8512 5.45689 13.7303 5.36477 13.6413C5.27265 13.5522 5.15001 13.5017 5.02191 13.5H4.02081C3.95297 13.4996 3.88574 13.5129 3.8232 13.5392C3.76065 13.5655 3.70408 13.6042 3.6569 13.6529C3.60972 13.7017 3.57291 13.7595 3.54869 13.8228C3.52448 13.8862 3.51336 13.9538 3.51601 14.0216C3.61349 15.5965 4.1473 17.1132 5.0577 18.4019C5.9681 19.6906 7.21917 20.7006 8.6709 21.3188C10.1226 21.937 11.7178 22.139 13.2778 21.9022C14.8378 21.6654 16.3011 20.9992 17.504 19.978C18.7069 18.9569 19.6019 17.6212 20.0889 16.1203C20.5759 14.6195 20.6356 13.0128 20.2614 11.4799C19.8872 9.94705 19.0938 8.54858 17.97 7.44098C16.8462 6.33339 15.4363 5.56037 13.8982 5.20844V5.20844Z" fill="currentColor"></path></svg> 重置</button><a href="https://codesandbox.io/api/v1/sandboxes/define?undefined&amp;environment=create-react-app" rel="noreferrer noopener" target="_blank" title="Open in CodeSandbox" class="text-sm text-primary dark:text-primary-dark inline-flex items-center hover:text-link duration-100 ease-in transition mx-1 ms-2 md:ms-1"><svg width="1em" height="1em" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="inline mx-1 relative top-[1px]"><path d="M20.5001 2H15.5001C15.3675 2 15.2403 2.05268 15.1465 2.14645C15.0528 2.24021 15.0001 2.36739 15.0001 2.5V3.5C15.0001 3.63261 15.0528 3.75979 15.1465 3.85355C15.2403 3.94732 15.3675 4 15.5001 4H18.5901L7.6501 14.94C7.60323 14.9865 7.56604 15.0418 7.54065 15.1027C7.51527 15.1636 7.5022 15.229 7.5022 15.295C7.5022 15.361 7.51527 15.4264 7.54065 15.4873C7.56604 15.5482 7.60323 15.6035 7.6501 15.65L8.3501 16.35C8.39658 16.3969 8.45188 16.4341 8.51281 16.4594C8.57374 16.4848 8.63909 16.4979 8.7051 16.4979C8.7711 16.4979 8.83646 16.4848 8.89738 16.4594C8.95831 16.4341 9.01362 16.3969 9.0601 16.35L20.0001 5.41V8.5C20.0001 8.63261 20.0528 8.75979 20.1465 8.85355C20.2403 8.94732 20.3675 9 20.5001 9H21.5001C21.6327 9 21.7599 8.94732 21.8537 8.85355C21.9474 8.75979 22.0001 8.63261 22.0001 8.5V3.5C22.0001 3.10218 21.8421 2.72064 21.5608 2.43934C21.2795 2.15804 20.8979 2 20.5001 2V2Z" fill="currentColor"></path><path d="M21.5 13H20.5C20.3674 13 20.2402 13.0527 20.1464 13.1464C20.0527 13.2402 20 13.3674 20 13.5V20H4V4H10.5C10.6326 4 10.7598 3.94732 10.8536 3.85355C10.9473 3.75979 11 3.63261 11 3.5V2.5C11 2.36739 10.9473 2.24021 10.8536 2.14645C10.7598 2.05268 10.6326 2 10.5 2H3.5C3.10218 2 2.72064 2.15804 2.43934 2.43934C2.15804 2.72064 2 3.10218 2 3.5V20.5C2 20.8978 2.15804 21.2794 2.43934 21.5607C2.72064 21.842 3.10218 22 3.5 22H20.5C20.8978 22 21.2794 21.842 21.5607 21.5607C21.842 21.2794 22 20.8978 22 20.5V13.5C22 13.3674 21.9473 13.2402 21.8536 13.1464C21.7598 13.0527 21.6326 13 21.5 13Z" fill="currentColor"></path></svg><span class="hidden md:block">Fork</span></a></div></div><div class=" sp-layout"><div class=" sp-editor sp-stack"><div class=" sp-code-editor"><div aria-autocomplete="list" aria-label="Code Editor for App.js" aria-multiline="true" class="sp-pristine sp-javascript   sp-cm" role="textbox" tabindex="0" translate="no"><pre class=" sp-pre-placeholder" style="margin-left:var(--sp-space-11)"><span class="sp-syntax-keyword">import</span> <span class="sp-syntax-punctuation">{</span> <span class="sp-syntax-plain">useState</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">useRef</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">useEffect</span> <span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-keyword">from</span> <span class="sp-syntax-string">&#x27;react&#x27;</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-keyword">function</span> <span class="sp-syntax-definition">VideoPlayer</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">{</span> <span class="sp-syntax-property">src</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-property">isPlaying</span> <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">ref</span> = <span class="sp-syntax-definition">useRef</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-keyword">null</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>

  <span class="sp-syntax-definition">useEffect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">isPlaying</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
      <span class="sp-syntax-plain">console</span>.<span class="sp-syntax-property">log</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-string">&#x27;调用 video.play()&#x27;</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
      <span class="sp-syntax-plain">ref</span>.<span class="sp-syntax-property">current</span>.<span class="sp-syntax-property">play</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-keyword">else</span> <span class="sp-syntax-punctuation">{</span>
      <span class="sp-syntax-plain">console</span>.<span class="sp-syntax-property">log</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-string">&#x27;调用 video.pause()&#x27;</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
      <span class="sp-syntax-plain">ref</span>.<span class="sp-syntax-property">current</span>.<span class="sp-syntax-property">pause</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-punctuation">}</span>
  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-plain">isPlaying</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>

  <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-tag">video</span> <span class="sp-syntax-property">ref</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">ref</span><span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-property">src</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">src</span><span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-property">loop</span> <span class="sp-syntax-property">playsInline</span> <span class="sp-syntax-punctuation">/&gt;</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-punctuation">}</span>

<span class="sp-syntax-keyword">export</span> <span class="sp-syntax-keyword">default</span> <span class="sp-syntax-keyword">function</span> <span class="sp-syntax-definition">App</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-plain">isPlaying</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">setIsPlaying</span><span class="sp-syntax-punctuation">]</span> = <span class="sp-syntax-definition">useState</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-static">false</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-plain">text</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">setText</span><span class="sp-syntax-punctuation">]</span> = <span class="sp-syntax-definition">useState</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-string">&#x27;&#x27;</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-punctuation">(</span>
    <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-punctuation">&gt;</span>
      <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-tag">input</span> <span class="sp-syntax-property">value</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">text</span><span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-property">onChange</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">e</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-definition">setText</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">target</span>.<span class="sp-syntax-property">value</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-punctuation">/&gt;</span>
      <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-tag">button</span> <span class="sp-syntax-property">onClick</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-definition">setIsPlaying</span><span class="sp-syntax-punctuation">(</span>!<span class="sp-syntax-plain">isPlaying</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">&gt;</span>
        <span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">isPlaying</span> ? <span class="sp-syntax-string">&#x27;暂停&#x27;</span> : <span class="sp-syntax-string">&#x27;播放&#x27;</span><span class="sp-syntax-punctuation">}</span>
      <span class="sp-syntax-punctuation">&lt;/</span><span class="sp-syntax-tag">button</span><span class="sp-syntax-punctuation">&gt;</span>
      <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-definition">VideoPlayer</span>
        <span class="sp-syntax-property">isPlaying</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">isPlaying</span><span class="sp-syntax-punctuation">}</span>
        <span class="sp-syntax-property">src</span>=<span class="sp-syntax-string">&quot;https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4&quot;</span>
      <span class="sp-syntax-punctuation">/&gt;</span>
    <span class="sp-syntax-punctuation">&lt;/</span><span class="sp-syntax-punctuation">&gt;</span>
  <span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-punctuation">}</span>

</pre></div></div></div><div class=" order-last xl:order-2 sp-stack"><div class="p-0 sm:p-2 md:p-4 lg:p-8 bg-card dark:bg-wash-dark h-full relative md:rounded-b-lg lg:rounded-b-none"><div style="position:relative"><iframe class="rounded-t-none bg-white md:shadow-md sm:rounded-lg w-full max-w-full transition-opacity absolute opacity-0 pointer-events-none duration-75" title="Sandbox Preview" style="height:15px;z-index:-1"></iframe></div></div></div><button translate="yes" class="sandpack-expand flex text-base justify-between dark:border-card-dark bg-wash dark:bg-card-dark items-center z-10 p-1 w-full order-2 xl:order-last border-b-1 relative top-0"><span class="flex p-2 focus:outline-none text-primary dark:text-primary-dark leading-[20px]"><svg class="rotate-0 inline me-1.5 text-xl" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><g fill="none" fill-rule="evenodd" transform="translate(-446 -398)"><path fill="currentColor" fill-rule="nonzero" d="M95.8838835,240.366117 C95.3957281,239.877961 94.6042719,239.877961 94.1161165,240.366117 C93.6279612,240.854272 93.6279612,241.645728 94.1161165,242.133883 L98.6161165,246.633883 C99.1042719,247.122039 99.8957281,247.122039 100.383883,246.633883 L104.883883,242.133883 C105.372039,241.645728 105.372039,240.854272 104.883883,240.366117 C104.395728,239.877961 103.604272,239.877961 103.116117,240.366117 L99.5,243.982233 L95.8838835,240.366117 Z" transform="translate(356.5 164.5)"></path><polygon points="446 418 466 418 466 398 446 398"></polygon></g></svg>显示更多</span></button></div></div></div></div><!--/$--><div class="max-w-4xl ms-0 2xl:mx-auto">
<p class="whitespace-pre-wrap my-4">依赖数组可以包含多个依赖项。只有当你指定的 <strong class="font-bold">所有</strong> 依赖项的值都与上一次渲染时完全相同，React 才会跳过重新运行该 Effect。React 使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/is" target="_blank" rel="nofollow noopener noreferrer" class="inline text-link dark:text-link-dark border-b border-link border-opacity-0 hover:border-opacity-100 duration-100 ease-in transition leading-normal"><code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">Object.is</code></a> 来比较依赖项的值。有关详细信息，请参阅 <a class="inline text-link dark:text-link-dark border-b border-link border-opacity-0 hover:border-opacity-100 duration-100 ease-in transition leading-normal" href="/reference/react/useEffect#reference"><code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">useEffect</code> 参考文档</a>。</p>
<p class="whitespace-pre-wrap my-4"><strong class="font-bold">请注意，你不能随意“选择”依赖项</strong>。如果你指定的依赖项与 React 根据 Effect 内部代码所推断出的依赖项不匹配，你将收到来自 lint 的错误提示。这有助于捕捉代码中的许多 bug。如果你不希望某些代码重新运行，<a class="inline text-link dark:text-link-dark border-b border-link border-opacity-0 hover:border-opacity-100 duration-100 ease-in transition leading-normal" href="/learn/lifecycle-of-reactive-effects#what-to-do-when-you-dont-want-to-re-synchronize">那么你应当 <strong class="font-bold">修改 Effect 代码本身</strong>，使其不再“需要”该依赖项</a>。</p>
<div class="expandable-callout pt-8 pb-4 px-5 sm:px-8 my-8 relative rounded-none shadow-inner-border -mx-5 sm:mx-auto sm:rounded-2xl bg-yellow-5 dark:bg-yellow-60 dark:bg-opacity-20"><h3 class="text-2xl font-display font-bold text-yellow-50 dark:text-yellow-40"><svg class="inline me-3 mb-1 text-lg text-yellow-50 dark:text-yellow-40" width="2em" height="2em" viewBox="0 0 72 72" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_738_836)"><path fill-rule="evenodd" clip-rule="evenodd" d="M27 48L27 57.3409L40.0772 48L55.6975 48C57.1595 48 58.1986 47.0112 58.3851 45.8604C59.1824 40.9398 60 34.619 60 29.625C60 24.7282 59.2125 18.7546 58.4302 14.0813C58.2445 12.9721 57.2326 12 55.7805 12L16.2195 12C14.7674 12 13.7555 12.9721 13.5698 14.0813C12.7875 18.7546 12 24.7282 12 29.625C12 34.619 12.8176 40.9398 13.6149 45.8604C13.8014 47.0112 14.8404 48 16.3025 48H27ZM42 54H55.6975C59.9534 54 63.6271 51.0213 64.3078 46.8201C65.1161 41.8322 66 35.1209 66 29.625C66 24.2196 65.1449 17.8522 64.3478 13.0906C63.6513 8.93026 59.9987 6 55.7805 6H16.2195C12.0013 6 8.34867 8.93026 7.65218 13.0906C6.85505 17.8522 6 24.2196 6 29.625C6 35.1209 6.88391 41.8322 7.69215 46.8201C8.37291 51.0213 12.0466 54 16.3025 54H21L21 63.1704C21 65.6106 23.7581 67.0299 25.7437 65.6116L42 54ZM39 39.3686C39 40.9422 38 41.9912 36 41.9912C34 41.9912 33 40.9422 33 39.3686C33 37.7951 34 36.746 36 36.746C38 36.746 39 37.7951 39 39.3686ZM38.1771 20.2412C38.1771 18.9986 37.1697 17.9912 35.9271 17.9912C34.6845 17.9912 33.6771 18.9986 33.6771 20.2412V31.5956C33.6771 32.8382 34.6845 33.8456 35.9271 33.8456C37.1697 33.8456 38.1771 32.8382 38.1771 31.5956V20.2412Z" fill="currentColor"></path></g><defs><clipPath id="clip0_738_836"><rect width="72" height="72" fill="white"></rect></clipPath></defs></svg>陷阱</h3><div class="relative"><div class="py-2"><p class="whitespace-pre-wrap my-4">没有依赖数组和使用空数组 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">[]</code> 作为依赖数组，行为是不同的：</p><!--$--><div dir="ltr" class="sandpack sandpack--codeblock rounded-2xl h-full w-full overflow-x-auto flex items-center bg-wash dark:bg-gray-95 shadow-lg my-8" style="contain:content"><div class="sp-wrapper"><div class="sp-stack"><div class="sp-code-editor"><pre class="sp-cm sp-pristine sp-javascript flex align-start"><code class="sp-pre-placeholder grow-[2]"><div class="cm-line "><span class="sp-syntax-definition">useEffect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line ">  <span class="sp-syntax-comment">// 这里的代码会在每次渲染后运行</span><br/></div><div class="cm-line bg-github-highlight dark:bg-opacity-10"><span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line "><br/></div><div class="cm-line "><span class="sp-syntax-definition">useEffect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line ">  <span class="sp-syntax-comment">// 这里的代码只会在组件挂载（首次出现）时运行</span><br/></div><div class="cm-line bg-github-highlight dark:bg-opacity-10"><span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line "><br/></div><div class="cm-line "><span class="sp-syntax-definition">useEffect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line ">  <span class="sp-syntax-comment">// 这里的代码不但会在组件挂载时运行，而且当 a 或 b 的值自上次渲染后发生变化后也会运行</span><br/></div><div class="cm-line bg-github-highlight dark:bg-opacity-10"><span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-plain">a</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">b</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span></div></code></pre></div></div></div></div><!--/$--><p class="whitespace-pre-wrap my-4">我们会在下一步详细了解什么是 <strong class="font-bold">挂载（mount）</strong>。</p></div></div></div>
<details class="my-12 rounded-2xl shadow-inner-border dark:shadow-inner-border-dark relative dark:bg-opacity-20 dark:bg-purple-60 bg-purple-5"><summary class="list-none p-8" tabindex="-1"><h5 class="mb-4 uppercase font-bold flex items-center text-sm dark:text-purple-30 text-purple-50"><svg class="inline me-2 dark:text-purple-30 text-purple-40" width="1.5em" height="1.5em" viewBox="0 0 72 72" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M34.7409 59.7228L32.9567 58.9094C27.2672 56.3157 20.7328 56.3157 15.0433 58.9094C12.6018 60.0224 9.39163 59.0275 8.44602 56.0621C7.45647 52.9589 5.99975 46.5898 6 35.9997C6.00029 23.5648 8.00803 18.3599 9.11099 16.4196C9.67795 15.4222 10.5255 14.8455 11.2254 14.5264L12.0179 14.1651C19.6351 10.6926 28.4011 10.6738 36 14.1733C43.5989 10.6738 52.3649 10.6926 59.9821 14.1651L60.7746 14.5264C61.4745 14.8455 62.3221 15.4222 62.889 16.4196C63.992 18.3599 65.9997 23.5648 66 35.9997C66.0002 46.5898 64.5435 52.9589 63.554 56.0621C62.6084 59.0275 59.3982 60.0224 56.9567 58.9094C51.2672 56.3157 44.7328 56.3157 39.0433 58.9094L37.2591 59.7228C37.1986 59.7508 37.1373 59.7767 37.0753 59.8004C36.4484 60.0411 35.7556 60.0653 35.1102 59.8648C34.9847 59.8258 34.8613 59.7784 34.7409 59.7228ZM14.5068 19.6246C20.3733 16.9501 27.0874 16.8775 33 19.4067V52.473C26.7613 50.32 19.9378 50.471 13.7811 52.9261C13.0005 49.9843 11.9998 44.547 12 35.9998C12.0002 25.5786 13.4879 21.1893 14.1179 19.8018L14.5068 19.6246ZM39 52.473C45.2387 50.32 52.0622 50.471 58.2189 52.9261C58.9995 49.9843 60.0002 44.547 60 35.9998C59.9998 25.5786 58.5121 21.1893 57.8821 19.8018L57.4932 19.6246C51.6267 16.9501 44.9126 16.8775 39 19.4067V52.473Z" fill="currentColor"></path></svg>深入探讨</h5><div class="mb-4"><h4 id="why-was-the-ref-omitted-from-the-dependency-array" class="mdx-heading text-xl font-bold text-primary dark:text-primary-dark text-xl font-display font-bold leading-9 my-4">为什么依赖数组中可以省略 ref? <a href="#why-was-the-ref-omitted-from-the-dependency-array" aria-label="Link for 为什么依赖数组中可以省略 ref? " title="Link for 为什么依赖数组中可以省略 ref? " class="mdx-header-anchor inline-block"><svg width="1em" height="1em" viewBox="0 0 13 13" xmlns="http://www.w3.org/2000/svg" class="text-gray-70 ms-2 h-5 w-5"><g fill="currentColor" fill-rule="evenodd"><path d="M7.778 7.975a2.5 2.5 0 0 0 .347-3.837L6.017 2.03a2.498 2.498 0 0 0-3.542-.007 2.5 2.5 0 0 0 .006 3.543l1.153 1.15c.07-.29.154-.563.25-.773.036-.077.084-.16.14-.25L3.18 4.85a1.496 1.496 0 0 1 .002-2.12 1.496 1.496 0 0 1 2.12 0l2.124 2.123a1.496 1.496 0 0 1-.333 2.37c.16.246.42.504.685.752z"></path><path d="M5.657 4.557a2.5 2.5 0 0 0-.347 3.837l2.108 2.108a2.498 2.498 0 0 0 3.542.007 2.5 2.5 0 0 0-.006-3.543L9.802 5.815c-.07.29-.154.565-.25.774-.036.076-.084.16-.14.25l.842.84c.585.587.59 1.532 0 2.122-.587.585-1.532.59-2.12 0L6.008 7.68a1.496 1.496 0 0 1 .332-2.372c-.16-.245-.42-.503-.685-.75z"></path></g></svg></a></h4></div><button class="bg-purple-50 border-purple-50 hover:bg-purple-40 focus:bg-purple-50 active:bg-purple-50 text-base leading-tight font-bold rounded-full py-2 px-4 focus:outline focus:outline-offset-2 focus:outline-link dark:focus:outline-link-dark inline-flex items-center my-1 bg-link border-link text-white hover:bg-link focus:bg-link active:bg-link"><span class="me-1"><svg class="rotate-0" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><g fill="none" fill-rule="evenodd" transform="translate(-446 -398)"><path fill="currentColor" fill-rule="nonzero" d="M95.8838835,240.366117 C95.3957281,239.877961 94.6042719,239.877961 94.1161165,240.366117 C93.6279612,240.854272 93.6279612,241.645728 94.1161165,242.133883 L98.6161165,246.633883 C99.1042719,247.122039 99.8957281,247.122039 100.383883,246.633883 L104.883883,242.133883 C105.372039,241.645728 105.372039,240.854272 104.883883,240.366117 C104.395728,239.877961 103.604272,239.877961 103.116117,240.366117 L99.5,243.982233 L95.8838835,240.366117 Z" transform="translate(356.5 164.5)"></path><polygon points="446 418 466 418 466 398 446 398"></polygon></g></svg></span>显示更多</button></summary><div class="p-8 border-t dark:border-purple-60 border-purple-10 "><p class="whitespace-pre-wrap my-4">下面的 Effect 同时使用了 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">ref</code> 与 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">isPlaying</code> prop，但是只有 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">isPlaying</code> 被声明为依赖项：</p><!--$--><div dir="ltr" class="sandpack sandpack--codeblock rounded-2xl h-full w-full overflow-x-auto flex items-center bg-wash dark:bg-gray-95 shadow-lg my-8" style="contain:content"><div class="sp-wrapper"><div class="sp-stack"><div class="sp-code-editor"><pre class="sp-cm sp-pristine sp-javascript flex align-start"><code class="sp-pre-placeholder grow-[2]"><div class="cm-line "><span class="sp-syntax-keyword">function</span> <span class="sp-syntax-definition">VideoPlayer</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">{</span> <span class="sp-syntax-property">src</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-property">isPlaying</span> <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line ">  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">ref</span> = <span class="sp-syntax-definition">useRef</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-keyword">null</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line ">  <span class="sp-syntax-definition">useEffect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line ">    <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">isPlaying</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line ">      <span class="sp-syntax-plain">ref</span>.<span class="sp-syntax-property">current</span>.<span class="sp-syntax-property">play</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line ">    <span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-keyword">else</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line ">      <span class="sp-syntax-plain">ref</span>.<span class="sp-syntax-property">current</span>.<span class="sp-syntax-property">pause</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line ">    <span class="sp-syntax-punctuation">}</span><br/></div><div class="cm-line bg-github-highlight dark:bg-opacity-10">  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-plain">isPlaying</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span></div></code></pre></div></div></div></div><!--/$--><p class="whitespace-pre-wrap my-4">这是因为 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">ref</code> 具有 <strong class="font-bold">稳定</strong> 的标识：React 确保你在 <a class="inline text-link dark:text-link-dark border-b border-link border-opacity-0 hover:border-opacity-100 duration-100 ease-in transition leading-normal" href="/reference/react/useRef#returns">每轮渲染中调用同一个 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">useRef</code> 时，总能获得相同的对象</a>。ref 不会改变，所以它不会导致重新运行 Effect。因此，在依赖数组中它可有可无。把它加进去也可以：</p><!--$--><div dir="ltr" class="sandpack sandpack--codeblock rounded-2xl h-full w-full overflow-x-auto flex items-center bg-wash dark:bg-gray-95 shadow-lg my-8" style="contain:content"><div class="sp-wrapper"><div class="sp-stack"><div class="sp-code-editor"><pre class="sp-cm sp-pristine sp-javascript flex align-start"><code class="sp-pre-placeholder grow-[2]"><div class="cm-line "><span class="sp-syntax-keyword">function</span> <span class="sp-syntax-definition">VideoPlayer</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">{</span> <span class="sp-syntax-property">src</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-property">isPlaying</span> <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line ">  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">ref</span> = <span class="sp-syntax-definition">useRef</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-keyword">null</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line ">  <span class="sp-syntax-definition">useEffect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line ">    <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">isPlaying</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line ">      <span class="sp-syntax-plain">ref</span>.<span class="sp-syntax-property">current</span>.<span class="sp-syntax-property">play</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line ">    <span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-keyword">else</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line ">      <span class="sp-syntax-plain">ref</span>.<span class="sp-syntax-property">current</span>.<span class="sp-syntax-property">pause</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line ">    <span class="sp-syntax-punctuation">}</span><br/></div><div class="cm-line bg-github-highlight dark:bg-opacity-10">  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-plain">isPlaying</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">ref</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span></div></code></pre></div></div></div></div><!--/$--><p class="whitespace-pre-wrap my-4"><code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">useState</code> 返回的 <a class="inline text-link dark:text-link-dark border-b border-link border-opacity-0 hover:border-opacity-100 duration-100 ease-in transition leading-normal" href="/reference/react/useState#setstate"><code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">set</code> 函数</a> 也具有稳定的标识，因此它们通常也会被省略。如果在省略某个依赖项时 linter 不会报错，那么这么做就是安全的。</p><p class="whitespace-pre-wrap my-4">省略始终稳定的依赖项仅在 linter 能“看到”对象是稳定的时候才有效。例如，如果 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">ref</code> 是从父组件传递过来的，则必须在依赖数组中指定它。这很有必要，因为你无法确定父组件是一直传递相同的 ref，还是根据条件传递不同的 ref。所以，你的 Effect 会依赖于被传递的是哪个 ref。</p></div></details>
<h3 id="step-3-add-cleanup-if-needed" class="mdx-heading text-2xl font-display leading-9 text-primary dark:text-primary-dark font-bold my-6">第三步：按需添加清理（cleanup）函数 <a href="#step-3-add-cleanup-if-needed" aria-label="Link for 第三步：按需添加清理（cleanup）函数 " title="Link for 第三步：按需添加清理（cleanup）函数 " class="mdx-header-anchor inline-block"><svg width="1em" height="1em" viewBox="0 0 13 13" xmlns="http://www.w3.org/2000/svg" class="text-gray-70 ms-2 h-5 w-5"><g fill="currentColor" fill-rule="evenodd"><path d="M7.778 7.975a2.5 2.5 0 0 0 .347-3.837L6.017 2.03a2.498 2.498 0 0 0-3.542-.007 2.5 2.5 0 0 0 .006 3.543l1.153 1.15c.07-.29.154-.563.25-.773.036-.077.084-.16.14-.25L3.18 4.85a1.496 1.496 0 0 1 .002-2.12 1.496 1.496 0 0 1 2.12 0l2.124 2.123a1.496 1.496 0 0 1-.333 2.37c.16.246.42.504.685.752z"></path><path d="M5.657 4.557a2.5 2.5 0 0 0-.347 3.837l2.108 2.108a2.498 2.498 0 0 0 3.542.007 2.5 2.5 0 0 0-.006-3.543L9.802 5.815c-.07.29-.154.565-.25.774-.036.076-.084.16-.14.25l.842.84c.585.587.59 1.532 0 2.122-.587.585-1.532.59-2.12 0L6.008 7.68a1.496 1.496 0 0 1 .332-2.372c-.16-.245-.42-.503-.685-.75z"></path></g></svg></a></h3>
<p class="whitespace-pre-wrap my-4">考虑一个不同的例子。假如你正在编写一个 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">ChatRoom</code> 组件，该组件在显示时需要连接到聊天服务器。现在为你提供了 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">createConnection()</code> API，该 API 返回一个包含 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">connect()</code> 与 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">disconnection()</code> 方法的对象。如何确保组件在显示时始终保持连接？</p>
<p class="whitespace-pre-wrap my-4">从编写 Effect 的逻辑开始：</p>
<!--$--><div dir="ltr" class="sandpack sandpack--codeblock rounded-2xl h-full w-full overflow-x-auto flex items-center bg-wash dark:bg-gray-95 shadow-lg my-8" style="contain:content"><div class="sp-wrapper"><div class="sp-stack"><div class="sp-code-editor"><pre class="sp-cm sp-pristine sp-javascript flex align-start"><code class="sp-pre-placeholder grow-[2]"><div class="cm-line "><span class="sp-syntax-definition">useEffect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line ">  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">connection</span> = <span class="sp-syntax-definition">createConnection</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line ">  <span class="sp-syntax-plain">connection</span>.<span class="sp-syntax-property">connect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line "><span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span></div></code></pre></div></div></div></div><!--/$-->
<p class="whitespace-pre-wrap my-4">如果每次重新渲染后都得进行连接，这会很慢，所以你需要添加依赖数组：</p>
<!--$--><div dir="ltr" class="sandpack sandpack--codeblock rounded-2xl h-full w-full overflow-x-auto flex items-center bg-wash dark:bg-gray-95 shadow-lg my-8" style="contain:content"><div class="sp-wrapper"><div class="sp-stack"><div class="sp-code-editor"><pre class="sp-cm sp-pristine sp-javascript flex align-start"><code class="sp-pre-placeholder grow-[2]"><div class="cm-line "><span class="sp-syntax-definition">useEffect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line ">  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">connection</span> = <span class="sp-syntax-definition">createConnection</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line ">  <span class="sp-syntax-plain">connection</span>.<span class="sp-syntax-property">connect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line bg-github-highlight dark:bg-opacity-10"><span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span></div></code></pre></div></div></div></div><!--/$-->
<p class="whitespace-pre-wrap my-4"><strong class="font-bold">由于 Effect 中的代码没有使用任何 props 或 state，所以依赖数组为空数组 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">[]</code>。这告诉 React 仅在组件“挂载”（即首次显示在页面上）时运行此代码</strong>。</p>
<p class="whitespace-pre-wrap my-4">试试运行下面的代码：</p>
</div><!--$--><div class="sandpack sandpack--playground w-full my-8" dir="ltr"><div class="sp-wrapper"><div class="shadow-lg dark:shadow-lg-dark rounded-lg" style="contain:content"><div class="bg-wash dark:bg-card-dark flex justify-between items-center relative z-10 border-b border-border dark:border-border-dark rounded-t-lg text-lg"><div class="flex-1 grow min-w-0 px-4 lg:px-6"><div><div class="relative overflow-hidden"><div class="w-[fit-content] invisible"><div class=" sp-tabs" translate="no"><div aria-label="Select active file" class=" sp-tabs-scrollable-container" role="tablist"><button aria-selected="true" class="  sp-tab-button" data-active="true" role="tab" title="/src/App.js" type="button">App.js</button><button aria-selected="false" class="  sp-tab-button" data-active="false" role="tab" title="/src/chat.js" type="button">chat.js</button></div></div></div><button class="absolute top-0 start-[2px]" id="headlessui-listbox-button-:Rj5ccq6:" aria-haspopup="true" aria-expanded="false" data-headlessui-state=""><span class="h-full py-2 px-1 mt-px -mb-px flex border-b text-link dark:text-link-dark border-link dark:border-link-dark items-center text-md leading-tight truncate" style="max-width:160px">App.js<span class="ms-2"><svg class="rotate-0" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><g fill="none" fill-rule="evenodd" transform="translate(-446 -398)"><path fill="currentColor" fill-rule="nonzero" d="M95.8838835,240.366117 C95.3957281,239.877961 94.6042719,239.877961 94.1161165,240.366117 C93.6279612,240.854272 93.6279612,241.645728 94.1161165,242.133883 L98.6161165,246.633883 C99.1042719,247.122039 99.8957281,247.122039 100.383883,246.633883 L104.883883,242.133883 C105.372039,241.645728 105.372039,240.854272 104.883883,240.366117 C104.395728,239.877961 103.604272,239.877961 103.116117,240.366117 L99.5,243.982233 L95.8838835,240.366117 Z" transform="translate(356.5 164.5)"></path><polygon points="446 418 466 418 466 398 446 398"></polygon></g></svg></span></span></button></div></div></div><div class="px-3 flex items-center justify-end text-start" translate="yes"><button class="text-sm text-primary dark:text-primary-dark inline-flex items-center hover:text-link duration-100 ease-in transition mx-1" title="Reset Sandbox" type="button"><svg width="1em" height="1em" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="inline mx-1 relative"><path d="M13.8982 5.20844C12.4626 4.88688 10.9686 4.93769 9.55821 5.35604L11.8524 3.06184C11.8989 3.0154 11.9357 2.96028 11.9608 2.89961C11.986 2.83894 11.9989 2.77391 11.9989 2.70824C11.9989 2.64256 11.986 2.57754 11.9608 2.51686C11.9357 2.45619 11.8989 2.40107 11.8524 2.35464L11.1456 1.64784C11.0992 1.60139 11.0441 1.56455 10.9834 1.53942C10.9227 1.51428 10.8577 1.50134 10.792 1.50134C10.7263 1.50134 10.6613 1.51428 10.6006 1.53942C10.54 1.56455 10.4848 1.60139 10.4384 1.64784L6.14571 5.94054C6.00654 6.07969 5.89615 6.2449 5.82083 6.42673C5.74551 6.60855 5.70675 6.80343 5.70675 7.00024C5.70675 7.19704 5.74551 7.39192 5.82083 7.57374C5.89615 7.75557 6.00654 7.92078 6.14571 8.05994L10.4387 12.3529C10.5325 12.4465 10.6595 12.4991 10.792 12.4991C10.9245 12.4991 11.0516 12.4465 11.1453 12.3529L11.8527 11.6455C11.9463 11.5518 11.9989 11.4247 11.9989 11.2922C11.9989 11.1598 11.9463 11.0327 11.8527 10.9389L8.77481 7.86104C9.99795 7.16236 11.415 6.8801 12.8125 7.05678C14.21 7.23347 15.5122 7.85953 16.523 8.84064C17.5338 9.82176 18.1983 11.1048 18.4165 12.4964C18.6347 13.888 18.3947 15.3129 17.7328 16.5562C17.0708 17.7996 16.0227 18.7942 14.7463 19.3902C13.47 19.9861 12.0345 20.1511 10.6563 19.8603C9.27798 19.5695 8.03152 18.8387 7.10469 17.778C6.17786 16.7172 5.62086 15.384 5.51761 13.9791C5.51156 13.8512 5.45689 13.7303 5.36477 13.6413C5.27265 13.5522 5.15001 13.5017 5.02191 13.5H4.02081C3.95297 13.4996 3.88574 13.5129 3.8232 13.5392C3.76065 13.5655 3.70408 13.6042 3.6569 13.6529C3.60972 13.7017 3.57291 13.7595 3.54869 13.8228C3.52448 13.8862 3.51336 13.9538 3.51601 14.0216C3.61349 15.5965 4.1473 17.1132 5.0577 18.4019C5.9681 19.6906 7.21917 20.7006 8.6709 21.3188C10.1226 21.937 11.7178 22.139 13.2778 21.9022C14.8378 21.6654 16.3011 20.9992 17.504 19.978C18.7069 18.9569 19.6019 17.6212 20.0889 16.1203C20.5759 14.6195 20.6356 13.0128 20.2614 11.4799C19.8872 9.94705 19.0938 8.54858 17.97 7.44098C16.8462 6.33339 15.4363 5.56037 13.8982 5.20844V5.20844Z" fill="currentColor"></path></svg> 重置</button><a href="https://codesandbox.io/api/v1/sandboxes/define?undefined&amp;environment=create-react-app" rel="noreferrer noopener" target="_blank" title="Open in CodeSandbox" class="text-sm text-primary dark:text-primary-dark inline-flex items-center hover:text-link duration-100 ease-in transition mx-1 ms-2 md:ms-1"><svg width="1em" height="1em" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="inline mx-1 relative top-[1px]"><path d="M20.5001 2H15.5001C15.3675 2 15.2403 2.05268 15.1465 2.14645C15.0528 2.24021 15.0001 2.36739 15.0001 2.5V3.5C15.0001 3.63261 15.0528 3.75979 15.1465 3.85355C15.2403 3.94732 15.3675 4 15.5001 4H18.5901L7.6501 14.94C7.60323 14.9865 7.56604 15.0418 7.54065 15.1027C7.51527 15.1636 7.5022 15.229 7.5022 15.295C7.5022 15.361 7.51527 15.4264 7.54065 15.4873C7.56604 15.5482 7.60323 15.6035 7.6501 15.65L8.3501 16.35C8.39658 16.3969 8.45188 16.4341 8.51281 16.4594C8.57374 16.4848 8.63909 16.4979 8.7051 16.4979C8.7711 16.4979 8.83646 16.4848 8.89738 16.4594C8.95831 16.4341 9.01362 16.3969 9.0601 16.35L20.0001 5.41V8.5C20.0001 8.63261 20.0528 8.75979 20.1465 8.85355C20.2403 8.94732 20.3675 9 20.5001 9H21.5001C21.6327 9 21.7599 8.94732 21.8537 8.85355C21.9474 8.75979 22.0001 8.63261 22.0001 8.5V3.5C22.0001 3.10218 21.8421 2.72064 21.5608 2.43934C21.2795 2.15804 20.8979 2 20.5001 2V2Z" fill="currentColor"></path><path d="M21.5 13H20.5C20.3674 13 20.2402 13.0527 20.1464 13.1464C20.0527 13.2402 20 13.3674 20 13.5V20H4V4H10.5C10.6326 4 10.7598 3.94732 10.8536 3.85355C10.9473 3.75979 11 3.63261 11 3.5V2.5C11 2.36739 10.9473 2.24021 10.8536 2.14645C10.7598 2.05268 10.6326 2 10.5 2H3.5C3.10218 2 2.72064 2.15804 2.43934 2.43934C2.15804 2.72064 2 3.10218 2 3.5V20.5C2 20.8978 2.15804 21.2794 2.43934 21.5607C2.72064 21.842 3.10218 22 3.5 22H20.5C20.8978 22 21.2794 21.842 21.5607 21.5607C21.842 21.2794 22 20.8978 22 20.5V13.5C22 13.3674 21.9473 13.2402 21.8536 13.1464C21.7598 13.0527 21.6326 13 21.5 13Z" fill="currentColor"></path></svg><span class="hidden md:block">Fork</span></a></div></div><div class=" rounded-b-lg overflow-hidden sp-layout"><div class=" sp-editor sp-stack"><div class=" sp-code-editor"><div aria-autocomplete="list" aria-label="Code Editor for App.js" aria-multiline="true" class="sp-pristine sp-javascript   sp-cm" role="textbox" tabindex="0" translate="no"><pre class=" sp-pre-placeholder" style="margin-left:var(--sp-space-11)"><span class="sp-syntax-keyword">import</span> <span class="sp-syntax-punctuation">{</span> <span class="sp-syntax-plain">useEffect</span> <span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-keyword">from</span> <span class="sp-syntax-string">&#x27;react&#x27;</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-keyword">import</span> <span class="sp-syntax-punctuation">{</span> <span class="sp-syntax-plain">createConnection</span> <span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-keyword">from</span> <span class="sp-syntax-string">&#x27;./chat.js&#x27;</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-keyword">export</span> <span class="sp-syntax-keyword">default</span> <span class="sp-syntax-keyword">function</span> <span class="sp-syntax-definition">ChatRoom</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-definition">useEffect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">connection</span> = <span class="sp-syntax-definition">createConnection</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-plain">connection</span>.<span class="sp-syntax-property">connect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-tag">h1</span><span class="sp-syntax-punctuation">&gt;</span>欢迎来到聊天室！<span class="sp-syntax-punctuation">&lt;/</span><span class="sp-syntax-tag">h1</span><span class="sp-syntax-punctuation">&gt;</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-punctuation">}</span>

</pre></div></div></div><div class=" order-last xl:order-2 sp-stack"><div class="p-0 sm:p-2 md:p-4 lg:p-8 bg-card dark:bg-wash-dark h-full relative md:rounded-b-lg lg:rounded-b-none"><div style="position:relative"><iframe class="rounded-t-none bg-white md:shadow-md sm:rounded-lg w-full max-w-full transition-opacity absolute opacity-0 pointer-events-none duration-75" title="Sandbox Preview" style="height:15px;z-index:-1"></iframe></div></div></div></div></div></div></div><!--/$--><div class="max-w-4xl ms-0 2xl:mx-auto">
<p class="whitespace-pre-wrap my-4">这里的 Effect 仅在组件挂载时运行，所以你可能以为 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">&quot;✅ 连接中……&quot;</code> 只会在控制台中被打印一次。<strong class="font-bold">然而实际情况是 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">&quot;✅ 连接中……&quot;</code> 被打印了两次！为什么会这样</strong>？</p>
<p class="whitespace-pre-wrap my-4">假设 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">ChatRoom</code> 组件是一个大型多页面应用中的一部分。用户最初在 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">ChatRoom</code> 页面上。组件挂载并调用 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">connection.connect()</code> 。接着用户可能会导航到另一个页面，比如切换到“设置”页面，于是 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">ChatRoom</code> 组件被卸载。最后，当用户点击“返回”时，<code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">ChatRoom</code> 组件再次挂载。这将建立第二个连接——但第一个连接从未被销毁！随着用户在应用中来回切换，连接将会不断累积。</p>
<p class="whitespace-pre-wrap my-4">这类 bug 在没有大量手动测试的情况下很容易被忽略。为了帮助你快速发现它们，在开发环境中，React 会在组件首次挂载后立即重新挂载一次。</p>
<p class="whitespace-pre-wrap my-4">两次出现 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">&quot;✅ 连接中……&quot;</code> 能够帮助你注意到真正的问题：在代码中，组件被卸载时没有关闭连接。</p>
<p class="whitespace-pre-wrap my-4">为了解决这个问题，可以在 Effect 中返回一个 <strong class="font-bold">清理（cleanup）函数</strong> 。</p>
<!--$--><div dir="ltr" class="sandpack sandpack--codeblock rounded-2xl h-full w-full overflow-x-auto flex items-center bg-wash dark:bg-gray-95 shadow-lg my-8" style="contain:content"><div class="sp-wrapper"><div class="sp-stack"><div class="sp-code-editor"><pre class="sp-cm sp-pristine sp-javascript flex align-start"><code class="sp-pre-placeholder grow-[2]"><div class="cm-line ">  <span class="sp-syntax-definition">useEffect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line ">    <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">connection</span> = <span class="sp-syntax-definition">createConnection</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line ">    <span class="sp-syntax-plain">connection</span>.<span class="sp-syntax-property">connect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line bg-github-highlight dark:bg-opacity-10">    <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line bg-github-highlight dark:bg-opacity-10">      <span class="sp-syntax-plain">connection</span>.<span class="sp-syntax-property">disconnect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line bg-github-highlight dark:bg-opacity-10">    <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line ">  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span></div></code></pre></div></div></div></div><!--/$-->
<p class="whitespace-pre-wrap my-4">React 会在每次 Effect 重新运行之前调用清理函数，并在组件卸载（被移除）时最后一次调用清理函数。让我们看看实现清理函数后会发生什么：</p>
</div><!--$--><div class="sandpack sandpack--playground w-full my-8" dir="ltr"><div class="sp-wrapper"><div class="shadow-lg dark:shadow-lg-dark rounded-lg" style="contain:content"><div class="bg-wash dark:bg-card-dark flex justify-between items-center relative z-10 border-b border-border dark:border-border-dark rounded-t-lg text-lg"><div class="flex-1 grow min-w-0 px-4 lg:px-6"><div><div class="relative overflow-hidden"><div class="w-[fit-content] invisible"><div class=" sp-tabs" translate="no"><div aria-label="Select active file" class=" sp-tabs-scrollable-container" role="tablist"><button aria-selected="true" class="  sp-tab-button" data-active="true" role="tab" title="/src/App.js" type="button">App.js</button><button aria-selected="false" class="  sp-tab-button" data-active="false" role="tab" title="/src/chat.js" type="button">chat.js</button></div></div></div><button class="absolute top-0 start-[2px]" id="headlessui-listbox-button-:Rj5ecq6:" aria-haspopup="true" aria-expanded="false" data-headlessui-state=""><span class="h-full py-2 px-1 mt-px -mb-px flex border-b text-link dark:text-link-dark border-link dark:border-link-dark items-center text-md leading-tight truncate" style="max-width:160px">App.js<span class="ms-2"><svg class="rotate-0" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><g fill="none" fill-rule="evenodd" transform="translate(-446 -398)"><path fill="currentColor" fill-rule="nonzero" d="M95.8838835,240.366117 C95.3957281,239.877961 94.6042719,239.877961 94.1161165,240.366117 C93.6279612,240.854272 93.6279612,241.645728 94.1161165,242.133883 L98.6161165,246.633883 C99.1042719,247.122039 99.8957281,247.122039 100.383883,246.633883 L104.883883,242.133883 C105.372039,241.645728 105.372039,240.854272 104.883883,240.366117 C104.395728,239.877961 103.604272,239.877961 103.116117,240.366117 L99.5,243.982233 L95.8838835,240.366117 Z" transform="translate(356.5 164.5)"></path><polygon points="446 418 466 418 466 398 446 398"></polygon></g></svg></span></span></button></div></div></div><div class="px-3 flex items-center justify-end text-start" translate="yes"><button class="text-sm text-primary dark:text-primary-dark inline-flex items-center hover:text-link duration-100 ease-in transition mx-1" title="Reset Sandbox" type="button"><svg width="1em" height="1em" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="inline mx-1 relative"><path d="M13.8982 5.20844C12.4626 4.88688 10.9686 4.93769 9.55821 5.35604L11.8524 3.06184C11.8989 3.0154 11.9357 2.96028 11.9608 2.89961C11.986 2.83894 11.9989 2.77391 11.9989 2.70824C11.9989 2.64256 11.986 2.57754 11.9608 2.51686C11.9357 2.45619 11.8989 2.40107 11.8524 2.35464L11.1456 1.64784C11.0992 1.60139 11.0441 1.56455 10.9834 1.53942C10.9227 1.51428 10.8577 1.50134 10.792 1.50134C10.7263 1.50134 10.6613 1.51428 10.6006 1.53942C10.54 1.56455 10.4848 1.60139 10.4384 1.64784L6.14571 5.94054C6.00654 6.07969 5.89615 6.2449 5.82083 6.42673C5.74551 6.60855 5.70675 6.80343 5.70675 7.00024C5.70675 7.19704 5.74551 7.39192 5.82083 7.57374C5.89615 7.75557 6.00654 7.92078 6.14571 8.05994L10.4387 12.3529C10.5325 12.4465 10.6595 12.4991 10.792 12.4991C10.9245 12.4991 11.0516 12.4465 11.1453 12.3529L11.8527 11.6455C11.9463 11.5518 11.9989 11.4247 11.9989 11.2922C11.9989 11.1598 11.9463 11.0327 11.8527 10.9389L8.77481 7.86104C9.99795 7.16236 11.415 6.8801 12.8125 7.05678C14.21 7.23347 15.5122 7.85953 16.523 8.84064C17.5338 9.82176 18.1983 11.1048 18.4165 12.4964C18.6347 13.888 18.3947 15.3129 17.7328 16.5562C17.0708 17.7996 16.0227 18.7942 14.7463 19.3902C13.47 19.9861 12.0345 20.1511 10.6563 19.8603C9.27798 19.5695 8.03152 18.8387 7.10469 17.778C6.17786 16.7172 5.62086 15.384 5.51761 13.9791C5.51156 13.8512 5.45689 13.7303 5.36477 13.6413C5.27265 13.5522 5.15001 13.5017 5.02191 13.5H4.02081C3.95297 13.4996 3.88574 13.5129 3.8232 13.5392C3.76065 13.5655 3.70408 13.6042 3.6569 13.6529C3.60972 13.7017 3.57291 13.7595 3.54869 13.8228C3.52448 13.8862 3.51336 13.9538 3.51601 14.0216C3.61349 15.5965 4.1473 17.1132 5.0577 18.4019C5.9681 19.6906 7.21917 20.7006 8.6709 21.3188C10.1226 21.937 11.7178 22.139 13.2778 21.9022C14.8378 21.6654 16.3011 20.9992 17.504 19.978C18.7069 18.9569 19.6019 17.6212 20.0889 16.1203C20.5759 14.6195 20.6356 13.0128 20.2614 11.4799C19.8872 9.94705 19.0938 8.54858 17.97 7.44098C16.8462 6.33339 15.4363 5.56037 13.8982 5.20844V5.20844Z" fill="currentColor"></path></svg> 重置</button><a href="https://codesandbox.io/api/v1/sandboxes/define?undefined&amp;environment=create-react-app" rel="noreferrer noopener" target="_blank" title="Open in CodeSandbox" class="text-sm text-primary dark:text-primary-dark inline-flex items-center hover:text-link duration-100 ease-in transition mx-1 ms-2 md:ms-1"><svg width="1em" height="1em" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="inline mx-1 relative top-[1px]"><path d="M20.5001 2H15.5001C15.3675 2 15.2403 2.05268 15.1465 2.14645C15.0528 2.24021 15.0001 2.36739 15.0001 2.5V3.5C15.0001 3.63261 15.0528 3.75979 15.1465 3.85355C15.2403 3.94732 15.3675 4 15.5001 4H18.5901L7.6501 14.94C7.60323 14.9865 7.56604 15.0418 7.54065 15.1027C7.51527 15.1636 7.5022 15.229 7.5022 15.295C7.5022 15.361 7.51527 15.4264 7.54065 15.4873C7.56604 15.5482 7.60323 15.6035 7.6501 15.65L8.3501 16.35C8.39658 16.3969 8.45188 16.4341 8.51281 16.4594C8.57374 16.4848 8.63909 16.4979 8.7051 16.4979C8.7711 16.4979 8.83646 16.4848 8.89738 16.4594C8.95831 16.4341 9.01362 16.3969 9.0601 16.35L20.0001 5.41V8.5C20.0001 8.63261 20.0528 8.75979 20.1465 8.85355C20.2403 8.94732 20.3675 9 20.5001 9H21.5001C21.6327 9 21.7599 8.94732 21.8537 8.85355C21.9474 8.75979 22.0001 8.63261 22.0001 8.5V3.5C22.0001 3.10218 21.8421 2.72064 21.5608 2.43934C21.2795 2.15804 20.8979 2 20.5001 2V2Z" fill="currentColor"></path><path d="M21.5 13H20.5C20.3674 13 20.2402 13.0527 20.1464 13.1464C20.0527 13.2402 20 13.3674 20 13.5V20H4V4H10.5C10.6326 4 10.7598 3.94732 10.8536 3.85355C10.9473 3.75979 11 3.63261 11 3.5V2.5C11 2.36739 10.9473 2.24021 10.8536 2.14645C10.7598 2.05268 10.6326 2 10.5 2H3.5C3.10218 2 2.72064 2.15804 2.43934 2.43934C2.15804 2.72064 2 3.10218 2 3.5V20.5C2 20.8978 2.15804 21.2794 2.43934 21.5607C2.72064 21.842 3.10218 22 3.5 22H20.5C20.8978 22 21.2794 21.842 21.5607 21.5607C21.842 21.2794 22 20.8978 22 20.5V13.5C22 13.3674 21.9473 13.2402 21.8536 13.1464C21.7598 13.0527 21.6326 13 21.5 13Z" fill="currentColor"></path></svg><span class="hidden md:block">Fork</span></a></div></div><div class=" rounded-b-lg overflow-hidden sp-layout"><div class=" sp-editor sp-stack"><div class=" sp-code-editor"><div aria-autocomplete="list" aria-label="Code Editor for App.js" aria-multiline="true" class="sp-pristine sp-javascript   sp-cm" role="textbox" tabindex="0" translate="no"><pre class=" sp-pre-placeholder" style="margin-left:var(--sp-space-11)"><span class="sp-syntax-keyword">import</span> <span class="sp-syntax-punctuation">{</span> <span class="sp-syntax-plain">useState</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">useEffect</span> <span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-keyword">from</span> <span class="sp-syntax-string">&#x27;react&#x27;</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-keyword">import</span> <span class="sp-syntax-punctuation">{</span> <span class="sp-syntax-plain">createConnection</span> <span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-keyword">from</span> <span class="sp-syntax-string">&#x27;./chat.js&#x27;</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-keyword">export</span> <span class="sp-syntax-keyword">default</span> <span class="sp-syntax-keyword">function</span> <span class="sp-syntax-definition">ChatRoom</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-definition">useEffect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">connection</span> = <span class="sp-syntax-definition">createConnection</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-plain">connection</span>.<span class="sp-syntax-property">connect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-plain">connection</span>.<span class="sp-syntax-property">disconnect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-tag">h1</span><span class="sp-syntax-punctuation">&gt;</span>欢迎来到聊天室！<span class="sp-syntax-punctuation">&lt;/</span><span class="sp-syntax-tag">h1</span><span class="sp-syntax-punctuation">&gt;</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-punctuation">}</span>

</pre></div></div></div><div class=" order-last xl:order-2 sp-stack"><div class="p-0 sm:p-2 md:p-4 lg:p-8 bg-card dark:bg-wash-dark h-full relative md:rounded-b-lg lg:rounded-b-none"><div style="position:relative"><iframe class="rounded-t-none bg-white md:shadow-md sm:rounded-lg w-full max-w-full transition-opacity absolute opacity-0 pointer-events-none duration-75" title="Sandbox Preview" style="height:15px;z-index:-1"></iframe></div></div></div></div></div></div></div><!--/$--><div class="max-w-4xl ms-0 2xl:mx-auto">
<p class="whitespace-pre-wrap my-4">现在在开发环境下，你会看到三条控制台日志：</p>
<ol class="ms-6 my-3 list-decimal">
<li class="leading-relaxed mb-1"><code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">&quot;✅ 连接中……&quot;</code></li>
<li class="leading-relaxed mb-1"><code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">&quot;❌ 连接断开。&quot;</code></li>
<li class="leading-relaxed mb-1"><code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">&quot;✅ 连接中……&quot;</code></li>
</ol>
<p class="whitespace-pre-wrap my-4"><strong class="font-bold">在开发环境下，这是正确的行为</strong>。通过重新挂载你的组件，React 验证了离开页面再返回不会导致代码出错。因为本就应该先断开然后再重新连接！如果你很好地实现了清理函数，那么无论是只执行一次 Effect ，还是执行、清理、再执行，都应该没有用户可见的区别。之所以会有额外的一次 connect/disconnect 调用，是因为在开发环境下 React 在检测你代码中的 bug。因此这是正常现象，不要去试图消除它！</p>
<p class="whitespace-pre-wrap my-4"><strong class="font-bold">在生产环境下，你只会看到 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">&quot;✅ 连接中……&quot;</code> 打印一次</strong>。这是因为重新挂载组件只会在开发环境下发生，以此帮助你找到需要清理的 Effect。你可以通过关闭 <a class="inline text-link dark:text-link-dark border-b border-link border-opacity-0 hover:border-opacity-100 duration-100 ease-in transition leading-normal" href="/reference/react/StrictMode">严格模式</a> 来禁用这个行为，但我们建议保留它。它可以帮助你发现许多类似上述的 bug。</p>
<h2 id="how-to-handle-the-effect-firing-twice-in-development" class="mdx-heading text-3xl font-display leading-10 text-primary dark:text-primary-dark font-bold my-6">如何处理在开发环境下 Effect 运行了两次？ <a href="#how-to-handle-the-effect-firing-twice-in-development" aria-label="Link for 如何处理在开发环境下 Effect 运行了两次？ " title="Link for 如何处理在开发环境下 Effect 运行了两次？ " class="mdx-header-anchor inline-block"><svg width="1em" height="1em" viewBox="0 0 13 13" xmlns="http://www.w3.org/2000/svg" class="text-gray-70 ms-2 h-5 w-5"><g fill="currentColor" fill-rule="evenodd"><path d="M7.778 7.975a2.5 2.5 0 0 0 .347-3.837L6.017 2.03a2.498 2.498 0 0 0-3.542-.007 2.5 2.5 0 0 0 .006 3.543l1.153 1.15c.07-.29.154-.563.25-.773.036-.077.084-.16.14-.25L3.18 4.85a1.496 1.496 0 0 1 .002-2.12 1.496 1.496 0 0 1 2.12 0l2.124 2.123a1.496 1.496 0 0 1-.333 2.37c.16.246.42.504.685.752z"></path><path d="M5.657 4.557a2.5 2.5 0 0 0-.347 3.837l2.108 2.108a2.498 2.498 0 0 0 3.542.007 2.5 2.5 0 0 0-.006-3.543L9.802 5.815c-.07.29-.154.565-.25.774-.036.076-.084.16-.14.25l.842.84c.585.587.59 1.532 0 2.122-.587.585-1.532.59-2.12 0L6.008 7.68a1.496 1.496 0 0 1 .332-2.372c-.16-.245-.42-.503-.685-.75z"></path></g></svg></a></h2>
<p class="whitespace-pre-wrap my-4">React 有意在开发环境下重新挂载你的组件，来找到类似上例中的 bug。<strong class="font-bold">你需要思考的不是“如何只运行一次 Effect”，而是“如何修复我的 Effect 来让它在重新挂载后正常运行”</strong>。</p>
<p class="whitespace-pre-wrap my-4">通常，答案是实现清理函数。清理函数应该停止或撤销 Effect 所做的一切。原则是用户不应该感受到 Effect 只执行一次（在生产环境中）和连续执行“挂载 → 清理 → 挂载”（在开发环境中）之间的区别。</p>
<p class="whitespace-pre-wrap my-4">你将编写的大多数 Effect 都会符合下列的常见模式之一。</p>
<div class="expandable-callout pt-8 pb-4 px-5 sm:px-8 my-8 relative rounded-none shadow-inner-border -mx-5 sm:mx-auto sm:rounded-2xl bg-yellow-5 dark:bg-yellow-60 dark:bg-opacity-20"><h3 class="text-2xl font-display font-bold text-yellow-50 dark:text-yellow-40"><svg class="inline me-3 mb-1 text-lg text-yellow-50 dark:text-yellow-40" width="2em" height="2em" viewBox="0 0 72 72" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_738_836)"><path fill-rule="evenodd" clip-rule="evenodd" d="M27 48L27 57.3409L40.0772 48L55.6975 48C57.1595 48 58.1986 47.0112 58.3851 45.8604C59.1824 40.9398 60 34.619 60 29.625C60 24.7282 59.2125 18.7546 58.4302 14.0813C58.2445 12.9721 57.2326 12 55.7805 12L16.2195 12C14.7674 12 13.7555 12.9721 13.5698 14.0813C12.7875 18.7546 12 24.7282 12 29.625C12 34.619 12.8176 40.9398 13.6149 45.8604C13.8014 47.0112 14.8404 48 16.3025 48H27ZM42 54H55.6975C59.9534 54 63.6271 51.0213 64.3078 46.8201C65.1161 41.8322 66 35.1209 66 29.625C66 24.2196 65.1449 17.8522 64.3478 13.0906C63.6513 8.93026 59.9987 6 55.7805 6H16.2195C12.0013 6 8.34867 8.93026 7.65218 13.0906C6.85505 17.8522 6 24.2196 6 29.625C6 35.1209 6.88391 41.8322 7.69215 46.8201C8.37291 51.0213 12.0466 54 16.3025 54H21L21 63.1704C21 65.6106 23.7581 67.0299 25.7437 65.6116L42 54ZM39 39.3686C39 40.9422 38 41.9912 36 41.9912C34 41.9912 33 40.9422 33 39.3686C33 37.7951 34 36.746 36 36.746C38 36.746 39 37.7951 39 39.3686ZM38.1771 20.2412C38.1771 18.9986 37.1697 17.9912 35.9271 17.9912C34.6845 17.9912 33.6771 18.9986 33.6771 20.2412V31.5956C33.6771 32.8382 34.6845 33.8456 35.9271 33.8456C37.1697 33.8456 38.1771 32.8382 38.1771 31.5956V20.2412Z" fill="currentColor"></path></g><defs><clipPath id="clip0_738_836"><rect width="72" height="72" fill="white"></rect></clipPath></defs></svg>陷阱</h3><div class="relative"><div class="py-2"><h4 id="dont-use-refs-to-prevent-effects-from-firing" class="mdx-heading text-xl font-display font-bold leading-9 my-4">不要使用 ref 来防止触发 Effect <a href="#dont-use-refs-to-prevent-effects-from-firing" aria-label="Link for 不要使用 ref 来防止触发 Effect " title="Link for 不要使用 ref 来防止触发 Effect " class="mdx-header-anchor inline-block"><svg width="1em" height="1em" viewBox="0 0 13 13" xmlns="http://www.w3.org/2000/svg" class="text-gray-70 ms-2 h-5 w-5"><g fill="currentColor" fill-rule="evenodd"><path d="M7.778 7.975a2.5 2.5 0 0 0 .347-3.837L6.017 2.03a2.498 2.498 0 0 0-3.542-.007 2.5 2.5 0 0 0 .006 3.543l1.153 1.15c.07-.29.154-.563.25-.773.036-.077.084-.16.14-.25L3.18 4.85a1.496 1.496 0 0 1 .002-2.12 1.496 1.496 0 0 1 2.12 0l2.124 2.123a1.496 1.496 0 0 1-.333 2.37c.16.246.42.504.685.752z"></path><path d="M5.657 4.557a2.5 2.5 0 0 0-.347 3.837l2.108 2.108a2.498 2.498 0 0 0 3.542.007 2.5 2.5 0 0 0-.006-3.543L9.802 5.815c-.07.29-.154.565-.25.774-.036.076-.084.16-.14.25l.842.84c.585.587.59 1.532 0 2.122-.587.585-1.532.59-2.12 0L6.008 7.68a1.496 1.496 0 0 1 .332-2.372c-.16-.245-.42-.503-.685-.75z"></path></g></svg></a></h4><p class="whitespace-pre-wrap my-4">为了防止 Effect 在开发环境中触发两次，一个常见错误是使用 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">ref</code> 来让 Effect 只运行一次。例如，你可能会用 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">useRef</code> “修复”上述的 bug：</p><!--$--><div dir="ltr" class="sandpack sandpack--codeblock rounded-2xl h-full w-full overflow-x-auto flex items-center bg-wash dark:bg-gray-95 shadow-lg my-8" style="contain:content"><div class="sp-wrapper"><div class="sp-stack"><div class="sp-code-editor"><pre class="sp-cm sp-pristine sp-javascript flex align-start"><code class="sp-pre-placeholder grow-[2]"><div class="cm-line bg-github-highlight dark:bg-opacity-10">  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">connectionRef</span> = <span class="sp-syntax-definition">useRef</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-keyword">null</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line ">  <span class="sp-syntax-definition">useEffect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line bg-github-highlight dark:bg-opacity-10">    <span class="sp-syntax-comment">// 🚩 这并不能修复这个 bug！！！</span><br/></div><div class="cm-line bg-github-highlight dark:bg-opacity-10">    <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span>!<span class="sp-syntax-plain">connectionRef</span>.<span class="sp-syntax-property">current</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line ">      <span class="sp-syntax-plain">connectionRef</span>.<span class="sp-syntax-property">current</span> = <span class="sp-syntax-definition">createConnection</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line ">      <span class="sp-syntax-plain">connectionRef</span>.<span class="sp-syntax-property">current</span>.<span class="sp-syntax-property">connect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line ">    <span class="sp-syntax-punctuation">}</span><br/></div><div class="cm-line ">  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span></div></code></pre></div></div></div></div><!--/$--><p class="whitespace-pre-wrap my-4">它虽然使你在开发环境下只看到一次 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">“✅ 正在连接...”</code>，但并没有修复这个 bug。</p><p class="whitespace-pre-wrap my-4">当用户离开时，连接没有被关闭，当用户返回时，又会创建一个新的连接。随着用户浏览应用，连接会不断累积，就像“修复”之前一样。</p><p class="whitespace-pre-wrap my-4">要修复这个 bug，仅仅让 Effect 只运行一次是不够的。想要 Effect 在重新挂载后正常运行，就得按照之前的方法清除连接。</p><p class="whitespace-pre-wrap my-4">请看下面的示例，了解如何处理常见模式。</p></div></div></div>
<h3 id="controlling-non-react-widgets" class="mdx-heading text-2xl font-display leading-9 text-primary dark:text-primary-dark font-bold my-6">管理非 React 小部件 <a href="#controlling-non-react-widgets" aria-label="Link for 管理非 React 小部件 " title="Link for 管理非 React 小部件 " class="mdx-header-anchor inline-block"><svg width="1em" height="1em" viewBox="0 0 13 13" xmlns="http://www.w3.org/2000/svg" class="text-gray-70 ms-2 h-5 w-5"><g fill="currentColor" fill-rule="evenodd"><path d="M7.778 7.975a2.5 2.5 0 0 0 .347-3.837L6.017 2.03a2.498 2.498 0 0 0-3.542-.007 2.5 2.5 0 0 0 .006 3.543l1.153 1.15c.07-.29.154-.563.25-.773.036-.077.084-.16.14-.25L3.18 4.85a1.496 1.496 0 0 1 .002-2.12 1.496 1.496 0 0 1 2.12 0l2.124 2.123a1.496 1.496 0 0 1-.333 2.37c.16.246.42.504.685.752z"></path><path d="M5.657 4.557a2.5 2.5 0 0 0-.347 3.837l2.108 2.108a2.498 2.498 0 0 0 3.542.007 2.5 2.5 0 0 0-.006-3.543L9.802 5.815c-.07.29-.154.565-.25.774-.036.076-.084.16-.14.25l.842.84c.585.587.59 1.532 0 2.122-.587.585-1.532.59-2.12 0L6.008 7.68a1.496 1.496 0 0 1 .332-2.372c-.16-.245-.42-.503-.685-.75z"></path></g></svg></a></h3>
<p class="whitespace-pre-wrap my-4">有时你需要添加不是用 React 实现的 UI 小部件。比如说你想在你的页面添加一个地图组件。它有一个 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">setZoomLevel()</code> 方法，然后你希望地图的缩放比例和代码中的 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">zoomLevel</code> state 保持同步。你的 Effect 应该类似于：</p>
<!--$--><div dir="ltr" class="sandpack sandpack--codeblock rounded-2xl h-full w-full overflow-x-auto flex items-center bg-wash dark:bg-gray-95 shadow-lg my-8" style="contain:content"><div class="sp-wrapper"><div class="sp-stack"><div class="sp-code-editor"><pre class="sp-cm sp-pristine sp-javascript flex align-start"><code class="sp-pre-placeholder grow-[2]"><div class="cm-line "><span class="sp-syntax-definition">useEffect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line ">  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">map</span> = <span class="sp-syntax-plain">mapRef</span>.<span class="sp-syntax-property">current</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line ">  <span class="sp-syntax-plain">map</span>.<span class="sp-syntax-property">setZoomLevel</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">zoomLevel</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line "><span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-plain">zoomLevel</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span></div></code></pre></div></div></div></div><!--/$-->
<p class="whitespace-pre-wrap my-4">请注意，这种情况下不需要清理操作。在开发环境中，虽然 React 会调用 Effect 两次，但这没关系，因为用相同的值调用 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">setZoomLevel</code> 两次不会造成任何影响。虽然在开发环境下它可能会稍微慢一些，但问题不大，因为在生产环境下它不会多余地重新挂载。</p>
<p class="whitespace-pre-wrap my-4">有些 API 可能不允许你连续调用两次。例如，内置的 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLDialogElement" target="_blank" rel="nofollow noopener noreferrer" class="inline text-link dark:text-link-dark border-b border-link border-opacity-0 hover:border-opacity-100 duration-100 ease-in transition leading-normal"><code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">&lt;dialog&gt;</code></a> 元素的 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLDialogElement/showModal" target="_blank" rel="nofollow noopener noreferrer" class="inline text-link dark:text-link-dark border-b border-link border-opacity-0 hover:border-opacity-100 duration-100 ease-in transition leading-normal"><code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">showModal</code></a> 方法在连续被调用两次时会抛出异常。此时可以通过实现清理函数来使其关闭对话框：</p>
<!--$--><div dir="ltr" class="sandpack sandpack--codeblock rounded-2xl h-full w-full overflow-x-auto flex items-center bg-wash dark:bg-gray-95 shadow-lg my-8" style="contain:content"><div class="sp-wrapper"><div class="sp-stack"><div class="sp-code-editor"><pre class="sp-cm sp-pristine sp-javascript flex align-start"><code class="sp-pre-placeholder grow-[2]"><div class="cm-line "><span class="sp-syntax-definition">useEffect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line ">  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">dialog</span> = <span class="sp-syntax-plain">dialogRef</span>.<span class="sp-syntax-property">current</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line ">  <span class="sp-syntax-plain">dialog</span>.<span class="sp-syntax-property">showModal</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line bg-github-highlight dark:bg-opacity-10">  <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-plain">dialog</span>.<span class="sp-syntax-property">close</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line "><span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span></div></code></pre></div></div></div></div><!--/$-->
<p class="whitespace-pre-wrap my-4">在开发环境中，你的 Effect 会先调用 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">showModal()</code>，然后立即调用 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">close()</code>，之后再次调用 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">showModal()</code>。这与在生产环境中只调用一次 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">showModal()</code> 的用户可见行为是相同的。</p>
<h3 id="subscribing-to-events" class="mdx-heading text-2xl font-display leading-9 text-primary dark:text-primary-dark font-bold my-6">订阅事件 <a href="#subscribing-to-events" aria-label="Link for 订阅事件 " title="Link for 订阅事件 " class="mdx-header-anchor inline-block"><svg width="1em" height="1em" viewBox="0 0 13 13" xmlns="http://www.w3.org/2000/svg" class="text-gray-70 ms-2 h-5 w-5"><g fill="currentColor" fill-rule="evenodd"><path d="M7.778 7.975a2.5 2.5 0 0 0 .347-3.837L6.017 2.03a2.498 2.498 0 0 0-3.542-.007 2.5 2.5 0 0 0 .006 3.543l1.153 1.15c.07-.29.154-.563.25-.773.036-.077.084-.16.14-.25L3.18 4.85a1.496 1.496 0 0 1 .002-2.12 1.496 1.496 0 0 1 2.12 0l2.124 2.123a1.496 1.496 0 0 1-.333 2.37c.16.246.42.504.685.752z"></path><path d="M5.657 4.557a2.5 2.5 0 0 0-.347 3.837l2.108 2.108a2.498 2.498 0 0 0 3.542.007 2.5 2.5 0 0 0-.006-3.543L9.802 5.815c-.07.29-.154.565-.25.774-.036.076-.084.16-.14.25l.842.84c.585.587.59 1.532 0 2.122-.587.585-1.532.59-2.12 0L6.008 7.68a1.496 1.496 0 0 1 .332-2.372c-.16-.245-.42-.503-.685-.75z"></path></g></svg></a></h3>
<p class="whitespace-pre-wrap my-4">如果你的 Effect 订阅了某些事件，清理函数应退订这些事件：</p>
<!--$--><div dir="ltr" class="sandpack sandpack--codeblock rounded-2xl h-full w-full overflow-x-auto flex items-center bg-wash dark:bg-gray-95 shadow-lg my-8" style="contain:content"><div class="sp-wrapper"><div class="sp-stack"><div class="sp-code-editor"><pre class="sp-cm sp-pristine sp-javascript flex align-start"><code class="sp-pre-placeholder grow-[2]"><div class="cm-line "><span class="sp-syntax-definition">useEffect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line ">  <span class="sp-syntax-keyword">function</span> <span class="sp-syntax-definition">handleScroll</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">e</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line ">    <span class="sp-syntax-plain">console</span>.<span class="sp-syntax-property">log</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">window</span>.<span class="sp-syntax-property">scrollX</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">window</span>.<span class="sp-syntax-property">scrollY</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line ">  <span class="sp-syntax-punctuation">}</span><br/></div><div class="cm-line ">  <span class="sp-syntax-plain">window</span>.<span class="sp-syntax-property">addEventListener</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-string">&#x27;scroll&#x27;</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">handleScroll</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line bg-github-highlight dark:bg-opacity-10">  <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-plain">window</span>.<span class="sp-syntax-property">removeEventListener</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-string">&#x27;scroll&#x27;</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">handleScroll</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line "><span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span></div></code></pre></div></div></div></div><!--/$-->
<p class="whitespace-pre-wrap my-4">在开发环境中，你的 Effect 会先调用 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">addEventListener()</code>，然后立即调用 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">removeEventListener()</code>，接着再次使用相同的处理函数调用 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">addEventListener()</code>。因此，每次只会有一个有效订阅。这与在生产环境中只调用一次 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">addEventListener()</code> 所产生的用户可见行为是相同的。</p>
<h3 id="triggering-animations" class="mdx-heading text-2xl font-display leading-9 text-primary dark:text-primary-dark font-bold my-6">触发动画 <a href="#triggering-animations" aria-label="Link for 触发动画 " title="Link for 触发动画 " class="mdx-header-anchor inline-block"><svg width="1em" height="1em" viewBox="0 0 13 13" xmlns="http://www.w3.org/2000/svg" class="text-gray-70 ms-2 h-5 w-5"><g fill="currentColor" fill-rule="evenodd"><path d="M7.778 7.975a2.5 2.5 0 0 0 .347-3.837L6.017 2.03a2.498 2.498 0 0 0-3.542-.007 2.5 2.5 0 0 0 .006 3.543l1.153 1.15c.07-.29.154-.563.25-.773.036-.077.084-.16.14-.25L3.18 4.85a1.496 1.496 0 0 1 .002-2.12 1.496 1.496 0 0 1 2.12 0l2.124 2.123a1.496 1.496 0 0 1-.333 2.37c.16.246.42.504.685.752z"></path><path d="M5.657 4.557a2.5 2.5 0 0 0-.347 3.837l2.108 2.108a2.498 2.498 0 0 0 3.542.007 2.5 2.5 0 0 0-.006-3.543L9.802 5.815c-.07.29-.154.565-.25.774-.036.076-.084.16-.14.25l.842.84c.585.587.59 1.532 0 2.122-.587.585-1.532.59-2.12 0L6.008 7.68a1.496 1.496 0 0 1 .332-2.372c-.16-.245-.42-.503-.685-.75z"></path></g></svg></a></h3>
<p class="whitespace-pre-wrap my-4">如果你的 Effect 触发了一些动画，清理函数应将动画重置为初始状态：</p>
<!--$--><div dir="ltr" class="sandpack sandpack--codeblock rounded-2xl h-full w-full overflow-x-auto flex items-center bg-wash dark:bg-gray-95 shadow-lg my-8" style="contain:content"><div class="sp-wrapper"><div class="sp-stack"><div class="sp-code-editor"><pre class="sp-cm sp-pristine sp-javascript flex align-start"><code class="sp-pre-placeholder grow-[2]"><div class="cm-line "><span class="sp-syntax-definition">useEffect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line ">  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">node</span> = <span class="sp-syntax-plain">ref</span>.<span class="sp-syntax-property">current</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line ">  <span class="sp-syntax-plain">node</span>.<span class="sp-syntax-property">style</span>.<span class="sp-syntax-property">opacity</span> = <span class="sp-syntax-static">1</span><span class="sp-syntax-punctuation">;</span> <span class="sp-syntax-comment">// 触发动画</span><br/></div><div class="cm-line bg-github-highlight dark:bg-opacity-10">  <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line bg-github-highlight dark:bg-opacity-10">    <span class="sp-syntax-plain">node</span>.<span class="sp-syntax-property">style</span>.<span class="sp-syntax-property">opacity</span> = <span class="sp-syntax-static">0</span><span class="sp-syntax-punctuation">;</span> <span class="sp-syntax-comment">// 重置为初始值</span><br/></div><div class="cm-line bg-github-highlight dark:bg-opacity-10">  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line "><span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span></div></code></pre></div></div></div></div><!--/$-->
<p class="whitespace-pre-wrap my-4">在开发环境中，透明度由 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">1</code> 变为 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">0</code>，再变为 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">1</code>。这与在生产环境中，直接将其设置为 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">1</code> 具有相同的用户可见行为。如果你使用了支持补间动画的第三方动画库，你的清理函数应将时间轴重置为初始状态。</p>
<h3 id="fetching-data" class="mdx-heading text-2xl font-display leading-9 text-primary dark:text-primary-dark font-bold my-6">获取数据 <a href="#fetching-data" aria-label="Link for 获取数据 " title="Link for 获取数据 " class="mdx-header-anchor inline-block"><svg width="1em" height="1em" viewBox="0 0 13 13" xmlns="http://www.w3.org/2000/svg" class="text-gray-70 ms-2 h-5 w-5"><g fill="currentColor" fill-rule="evenodd"><path d="M7.778 7.975a2.5 2.5 0 0 0 .347-3.837L6.017 2.03a2.498 2.498 0 0 0-3.542-.007 2.5 2.5 0 0 0 .006 3.543l1.153 1.15c.07-.29.154-.563.25-.773.036-.077.084-.16.14-.25L3.18 4.85a1.496 1.496 0 0 1 .002-2.12 1.496 1.496 0 0 1 2.12 0l2.124 2.123a1.496 1.496 0 0 1-.333 2.37c.16.246.42.504.685.752z"></path><path d="M5.657 4.557a2.5 2.5 0 0 0-.347 3.837l2.108 2.108a2.498 2.498 0 0 0 3.542.007 2.5 2.5 0 0 0-.006-3.543L9.802 5.815c-.07.29-.154.565-.25.774-.036.076-.084.16-.14.25l.842.84c.585.587.59 1.532 0 2.122-.587.585-1.532.59-2.12 0L6.008 7.68a1.496 1.496 0 0 1 .332-2.372c-.16-.245-.42-.503-.685-.75z"></path></g></svg></a></h3>
<p class="whitespace-pre-wrap my-4">如果你的 Effect 需要获取数据，清理函数应 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/AbortController" target="_blank" rel="nofollow noopener noreferrer" class="inline text-link dark:text-link-dark border-b border-link border-opacity-0 hover:border-opacity-100 duration-100 ease-in transition leading-normal">中止请求</a> 或忽略其结果：</p>
<!--$--><div dir="ltr" class="sandpack sandpack--codeblock rounded-2xl h-full w-full overflow-x-auto flex items-center bg-wash dark:bg-gray-95 shadow-lg my-8" style="contain:content"><div class="sp-wrapper"><div class="sp-stack"><div class="sp-code-editor"><pre class="sp-cm sp-pristine sp-javascript flex align-start"><code class="sp-pre-placeholder grow-[2]"><div class="cm-line "><span class="sp-syntax-definition">useEffect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line bg-github-highlight dark:bg-opacity-10">  <span class="sp-syntax-keyword">let</span> <span class="sp-syntax-plain">ignore</span> = <span class="sp-syntax-static">false</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line "><br/></div><div class="cm-line ">  <span class="sp-syntax-keyword">async</span> <span class="sp-syntax-keyword">function</span> <span class="sp-syntax-definition">startFetching</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line ">    <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">json</span> = <span class="sp-syntax-keyword">await</span> <span class="sp-syntax-definition">fetchTodos</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">userId</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line bg-github-highlight dark:bg-opacity-10">    <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span>!<span class="sp-syntax-plain">ignore</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line ">      <span class="sp-syntax-definition">setTodos</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">json</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line ">    <span class="sp-syntax-punctuation">}</span><br/></div><div class="cm-line ">  <span class="sp-syntax-punctuation">}</span><br/></div><div class="cm-line "><br/></div><div class="cm-line ">  <span class="sp-syntax-definition">startFetching</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line "><br/></div><div class="cm-line bg-github-highlight dark:bg-opacity-10">  <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line bg-github-highlight dark:bg-opacity-10">    <span class="sp-syntax-plain">ignore</span> = <span class="sp-syntax-static">true</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line bg-github-highlight dark:bg-opacity-10">  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line "><span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-plain">userId</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span></div></code></pre></div></div></div></div><!--/$-->
<p class="whitespace-pre-wrap my-4">你无法“撤销”已经发生的网络请求，但是你的清理函数应当确保那些不再相关的请求不会继续影响你的应用。如果 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">userId</code> 从 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">&#x27;Alice&#x27;</code> 变为 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">&#x27;Bob&#x27;</code>，那么请确保 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">&#x27;Alice&#x27;</code> 的响应数据被忽略，即使它在 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">&#x27;Bob&#x27;</code> 之后到达。</p>
<p class="whitespace-pre-wrap my-4"><strong class="font-bold">在开发环境中，你会在浏览器调试工具的“网络”选项卡中看到两条请求</strong>。这是正常的。使用上述方法，第一个 Effect 将立即被清理，所以它的 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">ignore</code> 变量会被设置为 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">true</code>。因此，即使有额外的请求，由于有 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">if (!ignore)</code> 的检查，也不会影响 state。</p>
<p class="whitespace-pre-wrap my-4"><strong class="font-bold">在生产环境中，只会有一条请求</strong>。如果开发环境中的第二次请求给你造成了困扰，最好的办法是使用一个能够对请求去重并缓存响应的方案：</p>
<!--$--><div dir="ltr" class="sandpack sandpack--codeblock rounded-2xl h-full w-full overflow-x-auto flex items-center bg-wash dark:bg-gray-95 shadow-lg my-8" style="contain:content"><div class="sp-wrapper"><div class="sp-stack"><div class="sp-code-editor"><pre class="sp-cm sp-pristine sp-javascript flex align-start"><code class="sp-pre-placeholder grow-[2]"><div class="cm-line "><span class="sp-syntax-keyword">function</span> <span class="sp-syntax-definition">TodoList</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line ">  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">todos</span> = <span class="sp-syntax-definition">useSomeDataLibrary</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-string">`/api/user/</span><span class="sp-syntax-punctuation">${</span><span class="sp-syntax-plain">userId</span><span class="sp-syntax-punctuation">}</span><span class="sp-syntax-string">/todos`</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line ">  <span class="sp-syntax-comment">// ...</span></div></code></pre></div></div></div></div><!--/$-->
<p class="whitespace-pre-wrap my-4">这不仅可以提高开发体验，还可以让你的应用程序响应更快。例如，当用户点击返回按钮时，不用再等待数据重新加载，因为它已经被缓存。你可以自己构建这样的缓存机制，也可以使用很多在 Effect 中手动获取数据的替代方法。</p>
<details class="my-12 rounded-2xl shadow-inner-border dark:shadow-inner-border-dark relative dark:bg-opacity-20 dark:bg-purple-60 bg-purple-5"><summary class="list-none p-8" tabindex="-1"><h5 class="mb-4 uppercase font-bold flex items-center text-sm dark:text-purple-30 text-purple-50"><svg class="inline me-2 dark:text-purple-30 text-purple-40" width="1.5em" height="1.5em" viewBox="0 0 72 72" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M34.7409 59.7228L32.9567 58.9094C27.2672 56.3157 20.7328 56.3157 15.0433 58.9094C12.6018 60.0224 9.39163 59.0275 8.44602 56.0621C7.45647 52.9589 5.99975 46.5898 6 35.9997C6.00029 23.5648 8.00803 18.3599 9.11099 16.4196C9.67795 15.4222 10.5255 14.8455 11.2254 14.5264L12.0179 14.1651C19.6351 10.6926 28.4011 10.6738 36 14.1733C43.5989 10.6738 52.3649 10.6926 59.9821 14.1651L60.7746 14.5264C61.4745 14.8455 62.3221 15.4222 62.889 16.4196C63.992 18.3599 65.9997 23.5648 66 35.9997C66.0002 46.5898 64.5435 52.9589 63.554 56.0621C62.6084 59.0275 59.3982 60.0224 56.9567 58.9094C51.2672 56.3157 44.7328 56.3157 39.0433 58.9094L37.2591 59.7228C37.1986 59.7508 37.1373 59.7767 37.0753 59.8004C36.4484 60.0411 35.7556 60.0653 35.1102 59.8648C34.9847 59.8258 34.8613 59.7784 34.7409 59.7228ZM14.5068 19.6246C20.3733 16.9501 27.0874 16.8775 33 19.4067V52.473C26.7613 50.32 19.9378 50.471 13.7811 52.9261C13.0005 49.9843 11.9998 44.547 12 35.9998C12.0002 25.5786 13.4879 21.1893 14.1179 19.8018L14.5068 19.6246ZM39 52.473C45.2387 50.32 52.0622 50.471 58.2189 52.9261C58.9995 49.9843 60.0002 44.547 60 35.9998C59.9998 25.5786 58.5121 21.1893 57.8821 19.8018L57.4932 19.6246C51.6267 16.9501 44.9126 16.8775 39 19.4067V52.473Z" fill="currentColor"></path></svg>深入探讨</h5><div class="mb-4"><h4 id="what-are-good-alternatives-to-data-fetching-in-effects" class="mdx-heading text-xl font-bold text-primary dark:text-primary-dark text-xl font-display font-bold leading-9 my-4">在 Effect 中进行数据请求的替代方案 <a href="#what-are-good-alternatives-to-data-fetching-in-effects" aria-label="Link for 在 Effect 中进行数据请求的替代方案 " title="Link for 在 Effect 中进行数据请求的替代方案 " class="mdx-header-anchor inline-block"><svg width="1em" height="1em" viewBox="0 0 13 13" xmlns="http://www.w3.org/2000/svg" class="text-gray-70 ms-2 h-5 w-5"><g fill="currentColor" fill-rule="evenodd"><path d="M7.778 7.975a2.5 2.5 0 0 0 .347-3.837L6.017 2.03a2.498 2.498 0 0 0-3.542-.007 2.5 2.5 0 0 0 .006 3.543l1.153 1.15c.07-.29.154-.563.25-.773.036-.077.084-.16.14-.25L3.18 4.85a1.496 1.496 0 0 1 .002-2.12 1.496 1.496 0 0 1 2.12 0l2.124 2.123a1.496 1.496 0 0 1-.333 2.37c.16.246.42.504.685.752z"></path><path d="M5.657 4.557a2.5 2.5 0 0 0-.347 3.837l2.108 2.108a2.498 2.498 0 0 0 3.542.007 2.5 2.5 0 0 0-.006-3.543L9.802 5.815c-.07.29-.154.565-.25.774-.036.076-.084.16-.14.25l.842.84c.585.587.59 1.532 0 2.122-.587.585-1.532.59-2.12 0L6.008 7.68a1.496 1.496 0 0 1 .332-2.372c-.16-.245-.42-.503-.685-.75z"></path></g></svg></a></h4></div><button class="bg-purple-50 border-purple-50 hover:bg-purple-40 focus:bg-purple-50 active:bg-purple-50 text-base leading-tight font-bold rounded-full py-2 px-4 focus:outline focus:outline-offset-2 focus:outline-link dark:focus:outline-link-dark inline-flex items-center my-1 bg-link border-link text-white hover:bg-link focus:bg-link active:bg-link"><span class="me-1"><svg class="rotate-0" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><g fill="none" fill-rule="evenodd" transform="translate(-446 -398)"><path fill="currentColor" fill-rule="nonzero" d="M95.8838835,240.366117 C95.3957281,239.877961 94.6042719,239.877961 94.1161165,240.366117 C93.6279612,240.854272 93.6279612,241.645728 94.1161165,242.133883 L98.6161165,246.633883 C99.1042719,247.122039 99.8957281,247.122039 100.383883,246.633883 L104.883883,242.133883 C105.372039,241.645728 105.372039,240.854272 104.883883,240.366117 C104.395728,239.877961 103.604272,239.877961 103.116117,240.366117 L99.5,243.982233 L95.8838835,240.366117 Z" transform="translate(356.5 164.5)"></path><polygon points="446 418 466 418 466 398 446 398"></polygon></g></svg></span>显示更多</button></summary><div class="p-8 border-t dark:border-purple-60 border-purple-10 "><p class="whitespace-pre-wrap my-4">在 Effect 中直接编写 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">fetch</code> 请求 <a href="https://www.robinwieruch.de/react-hooks-fetch-data/" target="_blank" rel="nofollow noopener noreferrer" class="inline text-link dark:text-link-dark border-b border-link border-opacity-0 hover:border-opacity-100 duration-100 ease-in transition leading-normal">是一种常见的数据获取方式</a>，特别是在完全客户端渲染的应用中。然而，这种方法非常手动化，并且有明显的弊端：</p><ul class="ms-6 my-3 list-disc">
<li class="leading-relaxed mb-1"><strong class="font-bold">Effect 不会在服务端运行</strong>。这意味着最初由服务器渲染的 HTML 只会包含加载状态，而没有实际数据。客户端必须先下载所有的 JavaScript 并渲染应用，才会发现它需要加载数据——这并不高效。</li>
<li class="leading-relaxed mb-1"><strong class="font-bold">直接在 Effect 中进行数据请求，容易产生“网络瀑布（network waterfall）”</strong>。首先父组件渲染时请求一些数据，随后渲染子组件，接着子组件开始请求它们的数据。如果网络速度不快，这种方式会比并行获取所有数据慢得多。</li>
<li class="leading-relaxed mb-1"><strong class="font-bold">直接在 Effect 中进行数据请求往往无法预加载或缓存数据</strong>。例如，如果组件卸载后重新挂载，它必须重新获取数据。</li>
<li class="leading-relaxed mb-1"><strong class="font-bold">不够简洁</strong>。编写 fecth 请求时为了避免 <a href="https://maxrozen.com/race-conditions-fetching-data-react-with-useeffect" target="_blank" rel="nofollow noopener noreferrer" class="inline text-link dark:text-link-dark border-b border-link border-opacity-0 hover:border-opacity-100 duration-100 ease-in transition leading-normal">竞态条件（race condition）</a> 等问题，会需要很多样板代码。</li>
</ul><p class="whitespace-pre-wrap my-4">这些弊端并不仅限于 React。任何库在组件挂载时进行数据获取都会遇到这些问题。与路由处理一样，要做好数据获取并非易事，因此我们推荐以下方法：</p><ul class="ms-6 my-3 list-disc">
<li class="leading-relaxed mb-1"><strong class="font-bold">如果你正在使用 <a class="inline text-link dark:text-link-dark border-b border-link border-opacity-0 hover:border-opacity-100 duration-100 ease-in transition leading-normal" href="/learn/start-a-new-react-project#production-grade-react-frameworks">框架</a> ，请使用其内置的数据获取机制</strong>。现代 React 框架集成了高效的数据获取机制，不会出现上述问题。</li>
<li class="leading-relaxed mb-1"><strong class="font-bold">否则，请考虑使用或构建客户端缓存</strong>。流行的开源解决方案包括 <a href="https://tanstack.com/query/latest" target="_blank" rel="nofollow noopener noreferrer" class="inline text-link dark:text-link-dark border-b border-link border-opacity-0 hover:border-opacity-100 duration-100 ease-in transition leading-normal">React Query</a>、<a href="https://swr.vercel.app/" target="_blank" rel="nofollow noopener noreferrer" class="inline text-link dark:text-link-dark border-b border-link border-opacity-0 hover:border-opacity-100 duration-100 ease-in transition leading-normal">useSWR</a> 和 <a href="https://beta.reactrouter.com/en/main/start/overview" target="_blank" rel="nofollow noopener noreferrer" class="inline text-link dark:text-link-dark border-b border-link border-opacity-0 hover:border-opacity-100 duration-100 ease-in transition leading-normal">React Router v6.4+</a>。你也可以自己构建解决方案：在底层使用 Effect，但添加对请求的去重、缓存响应以及避免网络瀑布（通过预加载数据或将数据请求提升到路由层次）的逻辑。</li>
</ul><p class="whitespace-pre-wrap my-4">如果这些方法都不适合你，你可以继续直接在 Effect 中获取数据。</p></div></details>
<h3 id="sending-analytics" class="mdx-heading text-2xl font-display leading-9 text-primary dark:text-primary-dark font-bold my-6">发送分析报告 <a href="#sending-analytics" aria-label="Link for 发送分析报告 " title="Link for 发送分析报告 " class="mdx-header-anchor inline-block"><svg width="1em" height="1em" viewBox="0 0 13 13" xmlns="http://www.w3.org/2000/svg" class="text-gray-70 ms-2 h-5 w-5"><g fill="currentColor" fill-rule="evenodd"><path d="M7.778 7.975a2.5 2.5 0 0 0 .347-3.837L6.017 2.03a2.498 2.498 0 0 0-3.542-.007 2.5 2.5 0 0 0 .006 3.543l1.153 1.15c.07-.29.154-.563.25-.773.036-.077.084-.16.14-.25L3.18 4.85a1.496 1.496 0 0 1 .002-2.12 1.496 1.496 0 0 1 2.12 0l2.124 2.123a1.496 1.496 0 0 1-.333 2.37c.16.246.42.504.685.752z"></path><path d="M5.657 4.557a2.5 2.5 0 0 0-.347 3.837l2.108 2.108a2.498 2.498 0 0 0 3.542.007 2.5 2.5 0 0 0-.006-3.543L9.802 5.815c-.07.29-.154.565-.25.774-.036.076-.084.16-.14.25l.842.84c.585.587.59 1.532 0 2.122-.587.585-1.532.59-2.12 0L6.008 7.68a1.496 1.496 0 0 1 .332-2.372c-.16-.245-.42-.503-.685-.75z"></path></g></svg></a></h3>
<p class="whitespace-pre-wrap my-4">考虑以下代码，它在页面访问时发送一个分析事件：</p>
<!--$--><div dir="ltr" class="sandpack sandpack--codeblock rounded-2xl h-full w-full overflow-x-auto flex items-center bg-wash dark:bg-gray-95 shadow-lg my-8" style="contain:content"><div class="sp-wrapper"><div class="sp-stack"><div class="sp-code-editor"><pre class="sp-cm sp-pristine sp-javascript flex align-start"><code class="sp-pre-placeholder grow-[2]"><div class="cm-line "><span class="sp-syntax-definition">useEffect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line ">  <span class="sp-syntax-definition">logVisit</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">url</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span> <span class="sp-syntax-comment">// 发送 POST 请求</span><br/></div><div class="cm-line "><span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-plain">url</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span></div></code></pre></div></div></div></div><!--/$-->
<p class="whitespace-pre-wrap my-4">在开发环境中，对于每个 URL，<code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">logVisit</code> 都会被调用两次，因此你可能会尝试修复这个问题。<strong class="font-bold">我们建议保持不动</strong>。与之前示例类似，运行一次还是运行两次，在用户可见的行为上没有区别。从实际角度来看，<code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">logVisit</code> 不应该在开发环境中执行任何操作，因为你不会想让开发设备的日志影响生产环境的统计数据。每次保存文件时组件都会重新挂载，因此在开发环境中会记录额外的访问日志。</p>
<p class="whitespace-pre-wrap my-4"><strong class="font-bold">在生产环境中，不会有重复的访问日志</strong>。</p>
<p class="whitespace-pre-wrap my-4">为了调试发送的分析事件，你可以将应用部署到一个运行在生产模式下的暂存环境，或者暂时禁用 <a class="inline text-link dark:text-link-dark border-b border-link border-opacity-0 hover:border-opacity-100 duration-100 ease-in transition leading-normal" href="/reference/react/StrictMode">严格模式</a> 及其仅在开发环境中的重新挂载检查。你还可以在路由更改的事件处理程序中发送分析数据，而不是在 Effect 中发送。对于更精确的分析，可以使用<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Intersection_Observer_API" target="_blank" rel="nofollow noopener noreferrer" class="inline text-link dark:text-link-dark border-b border-link border-opacity-0 hover:border-opacity-100 duration-100 ease-in transition leading-normal">交叉观察器</a> 来跟踪哪些组件位于视口中以及它们保持可见的时间。</p>
<h3 id="not-an-effect-initializing-the-application" class="mdx-heading text-2xl font-display leading-9 text-primary dark:text-primary-dark font-bold my-6">不适用于 Effect：初始化应用 <a href="#not-an-effect-initializing-the-application" aria-label="Link for 不适用于 Effect：初始化应用 " title="Link for 不适用于 Effect：初始化应用 " class="mdx-header-anchor inline-block"><svg width="1em" height="1em" viewBox="0 0 13 13" xmlns="http://www.w3.org/2000/svg" class="text-gray-70 ms-2 h-5 w-5"><g fill="currentColor" fill-rule="evenodd"><path d="M7.778 7.975a2.5 2.5 0 0 0 .347-3.837L6.017 2.03a2.498 2.498 0 0 0-3.542-.007 2.5 2.5 0 0 0 .006 3.543l1.153 1.15c.07-.29.154-.563.25-.773.036-.077.084-.16.14-.25L3.18 4.85a1.496 1.496 0 0 1 .002-2.12 1.496 1.496 0 0 1 2.12 0l2.124 2.123a1.496 1.496 0 0 1-.333 2.37c.16.246.42.504.685.752z"></path><path d="M5.657 4.557a2.5 2.5 0 0 0-.347 3.837l2.108 2.108a2.498 2.498 0 0 0 3.542.007 2.5 2.5 0 0 0-.006-3.543L9.802 5.815c-.07.29-.154.565-.25.774-.036.076-.084.16-.14.25l.842.84c.585.587.59 1.532 0 2.122-.587.585-1.532.59-2.12 0L6.008 7.68a1.496 1.496 0 0 1 .332-2.372c-.16-.245-.42-.503-.685-.75z"></path></g></svg></a></h3>
<p class="whitespace-pre-wrap my-4">某些逻辑应该只在应用启动时运行一次。你可以将它放在组件外部：</p>
<!--$--><div dir="ltr" class="sandpack sandpack--codeblock rounded-2xl h-full w-full overflow-x-auto flex items-center bg-wash dark:bg-gray-95 shadow-lg my-8" style="contain:content"><div class="sp-wrapper"><div class="sp-stack"><div class="sp-code-editor"><pre class="sp-cm sp-pristine sp-javascript flex align-start"><code class="sp-pre-placeholder grow-[2]"><div class="cm-line "><span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-keyword">typeof</span> <span class="sp-syntax-plain">window</span> !== <span class="sp-syntax-string">&#x27;undefined&#x27;</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span> <span class="sp-syntax-comment">// 检查是否在浏览器中运行</span><br/></div><div class="cm-line bg-github-highlight dark:bg-opacity-10">  <span class="sp-syntax-definition">checkAuthToken</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line bg-github-highlight dark:bg-opacity-10">  <span class="sp-syntax-definition">loadDataFromLocalStorage</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line "><span class="sp-syntax-punctuation">}</span><br/></div><div class="cm-line "><br/></div><div class="cm-line "><span class="sp-syntax-keyword">function</span> <span class="sp-syntax-definition">App</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line ">  <span class="sp-syntax-comment">// ……</span><br/></div><div class="cm-line "><span class="sp-syntax-punctuation">}</span></div></code></pre></div></div></div></div><!--/$-->
<p class="whitespace-pre-wrap my-4">这可以确保此类逻辑只在浏览器加载页面后运行一次。</p>
<h3 id="not-an-effect-buying-a-product" class="mdx-heading text-2xl font-display leading-9 text-primary dark:text-primary-dark font-bold my-6">不适用于 Effect：购买商品 <a href="#not-an-effect-buying-a-product" aria-label="Link for 不适用于 Effect：购买商品 " title="Link for 不适用于 Effect：购买商品 " class="mdx-header-anchor inline-block"><svg width="1em" height="1em" viewBox="0 0 13 13" xmlns="http://www.w3.org/2000/svg" class="text-gray-70 ms-2 h-5 w-5"><g fill="currentColor" fill-rule="evenodd"><path d="M7.778 7.975a2.5 2.5 0 0 0 .347-3.837L6.017 2.03a2.498 2.498 0 0 0-3.542-.007 2.5 2.5 0 0 0 .006 3.543l1.153 1.15c.07-.29.154-.563.25-.773.036-.077.084-.16.14-.25L3.18 4.85a1.496 1.496 0 0 1 .002-2.12 1.496 1.496 0 0 1 2.12 0l2.124 2.123a1.496 1.496 0 0 1-.333 2.37c.16.246.42.504.685.752z"></path><path d="M5.657 4.557a2.5 2.5 0 0 0-.347 3.837l2.108 2.108a2.498 2.498 0 0 0 3.542.007 2.5 2.5 0 0 0-.006-3.543L9.802 5.815c-.07.29-.154.565-.25.774-.036.076-.084.16-.14.25l.842.84c.585.587.59 1.532 0 2.122-.587.585-1.532.59-2.12 0L6.008 7.68a1.496 1.496 0 0 1 .332-2.372c-.16-.245-.42-.503-.685-.75z"></path></g></svg></a></h3>
<p class="whitespace-pre-wrap my-4">有时，即使你编写了清理函数，也无法避免用户观察到 Effect 运行了两次。比如你的 Effect 发送了一个像购买商品这样的 POST 请求：</p>
<!--$--><div dir="ltr" class="sandpack sandpack--codeblock rounded-2xl h-full w-full overflow-x-auto flex items-center bg-wash dark:bg-gray-95 shadow-lg my-8" style="contain:content"><div class="sp-wrapper"><div class="sp-stack"><div class="sp-code-editor"><pre class="sp-cm sp-pristine sp-javascript flex align-start"><code class="sp-pre-placeholder grow-[2]"><div class="cm-line "><span class="sp-syntax-definition">useEffect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line bg-github-highlight dark:bg-opacity-10">  <span class="sp-syntax-comment">// 🔴 错误：此处的 Effect 在开发环境中会触发两次，暴露出代码中的问题。</span><br/></div><div class="cm-line bg-github-highlight dark:bg-opacity-10">  <span class="sp-syntax-definition">fetch</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-string">&#x27;/api/buy&#x27;</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-punctuation">{</span> <span class="sp-syntax-property">method</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-string">&#x27;POST&#x27;</span> <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line "><span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span></div></code></pre></div></div></div></div><!--/$-->
<p class="whitespace-pre-wrap my-4">你肯定不希望购买两次商品。这也是为什么你不应该把这种逻辑放在 Effect 中。如果用户跳转到另一个页面，然后按下“返回”按钮，你的 Effect 就会再次运行。你不希望用户在访问页面时就购买产品，而是在他们点击“购买”按钮时才购买。</p>
<p class="whitespace-pre-wrap my-4">购买操作并不是由渲染引起的，而是由特定的交互引起的。它应该只在用户按下按钮时执行。因此，<strong class="font-bold">它不应该写在 Effect 中，应当把 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">/api/buy</code> 请求移动到“购买”按钮的事件处理程序中</strong>：</p>
<!--$--><div dir="ltr" class="sandpack sandpack--codeblock rounded-2xl h-full w-full overflow-x-auto flex items-center bg-wash dark:bg-gray-95 shadow-lg my-8" style="contain:content"><div class="sp-wrapper"><div class="sp-stack"><div class="sp-code-editor"><pre class="sp-cm sp-pristine sp-javascript flex align-start"><code class="sp-pre-placeholder grow-[2]"><div class="cm-line ">  <span class="sp-syntax-keyword">function</span> <span class="sp-syntax-definition">handleClick</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line bg-github-highlight dark:bg-opacity-10">    <span class="sp-syntax-comment">// ✅ 购买行为是一个事件，因为它是由特定的交互引起的。</span><br/></div><div class="cm-line bg-github-highlight dark:bg-opacity-10">    <span class="sp-syntax-definition">fetch</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-string">&#x27;/api/buy&#x27;</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-punctuation">{</span> <span class="sp-syntax-property">method</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-string">&#x27;POST&#x27;</span> <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line ">  <span class="sp-syntax-punctuation">}</span></div></code></pre></div></div></div></div><!--/$-->
<p class="whitespace-pre-wrap my-4"><strong class="font-bold">这说明了如果重新挂载破坏了应用的逻辑，通常便暴露了存在的 bug</strong>。对用户而言，访问一个页面不应该与访问页面后点击链接、再按下“返回”按钮查看页面有区别。React 通过在开发环境中重新挂载组件来验证你的组件是否遵守这一原则。</p>
<h2 id="putting-it-all-together" class="mdx-heading text-3xl font-display leading-10 text-primary dark:text-primary-dark font-bold my-6">综合以上内容 <a href="#putting-it-all-together" aria-label="Link for 综合以上内容 " title="Link for 综合以上内容 " class="mdx-header-anchor inline-block"><svg width="1em" height="1em" viewBox="0 0 13 13" xmlns="http://www.w3.org/2000/svg" class="text-gray-70 ms-2 h-5 w-5"><g fill="currentColor" fill-rule="evenodd"><path d="M7.778 7.975a2.5 2.5 0 0 0 .347-3.837L6.017 2.03a2.498 2.498 0 0 0-3.542-.007 2.5 2.5 0 0 0 .006 3.543l1.153 1.15c.07-.29.154-.563.25-.773.036-.077.084-.16.14-.25L3.18 4.85a1.496 1.496 0 0 1 .002-2.12 1.496 1.496 0 0 1 2.12 0l2.124 2.123a1.496 1.496 0 0 1-.333 2.37c.16.246.42.504.685.752z"></path><path d="M5.657 4.557a2.5 2.5 0 0 0-.347 3.837l2.108 2.108a2.498 2.498 0 0 0 3.542.007 2.5 2.5 0 0 0-.006-3.543L9.802 5.815c-.07.29-.154.565-.25.774-.036.076-.084.16-.14.25l.842.84c.585.587.59 1.532 0 2.122-.587.585-1.532.59-2.12 0L6.008 7.68a1.496 1.496 0 0 1 .332-2.372c-.16-.245-.42-.503-.685-.75z"></path></g></svg></a></h2>
<p class="whitespace-pre-wrap my-4">这个演练场可以帮助你“感受” Effect 在实际中的工作方式。</p>
<p class="whitespace-pre-wrap my-4">这个例子使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/setTimeout" target="_blank" rel="nofollow noopener noreferrer" class="inline text-link dark:text-link-dark border-b border-link border-opacity-0 hover:border-opacity-100 duration-100 ease-in transition leading-normal"><code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">setTimeout</code></a> 调度一个日志记录，日志会在 Effect 运行三秒后显示输入的文本。清理函数会取消挂起的延时器。从按下“挂载组件”开始：</p>
</div><!--$--><div class="sandpack sandpack--playground w-full my-8" dir="ltr"><div class="sp-wrapper"><div class="shadow-lg dark:shadow-lg-dark rounded-lg" style="contain:content"><div class="bg-wash dark:bg-card-dark flex justify-between items-center relative z-10 border-b border-border dark:border-border-dark rounded-t-lg text-lg"><div class="flex-1 grow min-w-0 px-4 lg:px-6"><div><div class="relative overflow-hidden"><div class="w-[fit-content] invisible"><div class=" sp-tabs" translate="no"><div aria-label="Select active file" class=" sp-tabs-scrollable-container" role="tablist"><button aria-selected="true" class="  sp-tab-button" data-active="true" role="tab" title="/src/App.js" type="button">App.js</button></div></div></div><button class="absolute top-0 start-[2px]" id="headlessui-listbox-button-:Rj5gcq6:" aria-haspopup="true" aria-expanded="false" data-headlessui-state=""><span class="h-full py-2 px-1 mt-px -mb-px flex border-b text-link dark:text-link-dark border-link dark:border-link-dark items-center text-md leading-tight truncate" style="max-width:160px">App.js</span></button></div></div></div><div class="px-3 flex items-center justify-end text-start" translate="yes"><button class="text-sm text-primary dark:text-primary-dark inline-flex items-center hover:text-link duration-100 ease-in transition mx-1" title="Reset Sandbox" type="button"><svg width="1em" height="1em" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="inline mx-1 relative"><path d="M13.8982 5.20844C12.4626 4.88688 10.9686 4.93769 9.55821 5.35604L11.8524 3.06184C11.8989 3.0154 11.9357 2.96028 11.9608 2.89961C11.986 2.83894 11.9989 2.77391 11.9989 2.70824C11.9989 2.64256 11.986 2.57754 11.9608 2.51686C11.9357 2.45619 11.8989 2.40107 11.8524 2.35464L11.1456 1.64784C11.0992 1.60139 11.0441 1.56455 10.9834 1.53942C10.9227 1.51428 10.8577 1.50134 10.792 1.50134C10.7263 1.50134 10.6613 1.51428 10.6006 1.53942C10.54 1.56455 10.4848 1.60139 10.4384 1.64784L6.14571 5.94054C6.00654 6.07969 5.89615 6.2449 5.82083 6.42673C5.74551 6.60855 5.70675 6.80343 5.70675 7.00024C5.70675 7.19704 5.74551 7.39192 5.82083 7.57374C5.89615 7.75557 6.00654 7.92078 6.14571 8.05994L10.4387 12.3529C10.5325 12.4465 10.6595 12.4991 10.792 12.4991C10.9245 12.4991 11.0516 12.4465 11.1453 12.3529L11.8527 11.6455C11.9463 11.5518 11.9989 11.4247 11.9989 11.2922C11.9989 11.1598 11.9463 11.0327 11.8527 10.9389L8.77481 7.86104C9.99795 7.16236 11.415 6.8801 12.8125 7.05678C14.21 7.23347 15.5122 7.85953 16.523 8.84064C17.5338 9.82176 18.1983 11.1048 18.4165 12.4964C18.6347 13.888 18.3947 15.3129 17.7328 16.5562C17.0708 17.7996 16.0227 18.7942 14.7463 19.3902C13.47 19.9861 12.0345 20.1511 10.6563 19.8603C9.27798 19.5695 8.03152 18.8387 7.10469 17.778C6.17786 16.7172 5.62086 15.384 5.51761 13.9791C5.51156 13.8512 5.45689 13.7303 5.36477 13.6413C5.27265 13.5522 5.15001 13.5017 5.02191 13.5H4.02081C3.95297 13.4996 3.88574 13.5129 3.8232 13.5392C3.76065 13.5655 3.70408 13.6042 3.6569 13.6529C3.60972 13.7017 3.57291 13.7595 3.54869 13.8228C3.52448 13.8862 3.51336 13.9538 3.51601 14.0216C3.61349 15.5965 4.1473 17.1132 5.0577 18.4019C5.9681 19.6906 7.21917 20.7006 8.6709 21.3188C10.1226 21.937 11.7178 22.139 13.2778 21.9022C14.8378 21.6654 16.3011 20.9992 17.504 19.978C18.7069 18.9569 19.6019 17.6212 20.0889 16.1203C20.5759 14.6195 20.6356 13.0128 20.2614 11.4799C19.8872 9.94705 19.0938 8.54858 17.97 7.44098C16.8462 6.33339 15.4363 5.56037 13.8982 5.20844V5.20844Z" fill="currentColor"></path></svg> 重置</button><a href="https://codesandbox.io/api/v1/sandboxes/define?undefined&amp;environment=create-react-app" rel="noreferrer noopener" target="_blank" title="Open in CodeSandbox" class="text-sm text-primary dark:text-primary-dark inline-flex items-center hover:text-link duration-100 ease-in transition mx-1 ms-2 md:ms-1"><svg width="1em" height="1em" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="inline mx-1 relative top-[1px]"><path d="M20.5001 2H15.5001C15.3675 2 15.2403 2.05268 15.1465 2.14645C15.0528 2.24021 15.0001 2.36739 15.0001 2.5V3.5C15.0001 3.63261 15.0528 3.75979 15.1465 3.85355C15.2403 3.94732 15.3675 4 15.5001 4H18.5901L7.6501 14.94C7.60323 14.9865 7.56604 15.0418 7.54065 15.1027C7.51527 15.1636 7.5022 15.229 7.5022 15.295C7.5022 15.361 7.51527 15.4264 7.54065 15.4873C7.56604 15.5482 7.60323 15.6035 7.6501 15.65L8.3501 16.35C8.39658 16.3969 8.45188 16.4341 8.51281 16.4594C8.57374 16.4848 8.63909 16.4979 8.7051 16.4979C8.7711 16.4979 8.83646 16.4848 8.89738 16.4594C8.95831 16.4341 9.01362 16.3969 9.0601 16.35L20.0001 5.41V8.5C20.0001 8.63261 20.0528 8.75979 20.1465 8.85355C20.2403 8.94732 20.3675 9 20.5001 9H21.5001C21.6327 9 21.7599 8.94732 21.8537 8.85355C21.9474 8.75979 22.0001 8.63261 22.0001 8.5V3.5C22.0001 3.10218 21.8421 2.72064 21.5608 2.43934C21.2795 2.15804 20.8979 2 20.5001 2V2Z" fill="currentColor"></path><path d="M21.5 13H20.5C20.3674 13 20.2402 13.0527 20.1464 13.1464C20.0527 13.2402 20 13.3674 20 13.5V20H4V4H10.5C10.6326 4 10.7598 3.94732 10.8536 3.85355C10.9473 3.75979 11 3.63261 11 3.5V2.5C11 2.36739 10.9473 2.24021 10.8536 2.14645C10.7598 2.05268 10.6326 2 10.5 2H3.5C3.10218 2 2.72064 2.15804 2.43934 2.43934C2.15804 2.72064 2 3.10218 2 3.5V20.5C2 20.8978 2.15804 21.2794 2.43934 21.5607C2.72064 21.842 3.10218 22 3.5 22H20.5C20.8978 22 21.2794 21.842 21.5607 21.5607C21.842 21.2794 22 20.8978 22 20.5V13.5C22 13.3674 21.9473 13.2402 21.8536 13.1464C21.7598 13.0527 21.6326 13 21.5 13Z" fill="currentColor"></path></svg><span class="hidden md:block">Fork</span></a></div></div><div class=" sp-layout"><div class=" sp-editor sp-stack"><div class=" sp-code-editor"><div aria-autocomplete="list" aria-label="Code Editor for App.js" aria-multiline="true" class="sp-pristine sp-javascript   sp-cm" role="textbox" tabindex="0" translate="no"><pre class=" sp-pre-placeholder" style="margin-left:var(--sp-space-11)"><span class="sp-syntax-keyword">import</span> <span class="sp-syntax-punctuation">{</span> <span class="sp-syntax-plain">useState</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">useEffect</span> <span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-keyword">from</span> <span class="sp-syntax-string">&#x27;react&#x27;</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-keyword">function</span> <span class="sp-syntax-definition">Playground</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-plain">text</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">setText</span><span class="sp-syntax-punctuation">]</span> = <span class="sp-syntax-definition">useState</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-string">&#x27;a&#x27;</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>

  <span class="sp-syntax-definition">useEffect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-keyword">function</span> <span class="sp-syntax-definition">onTimeout</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
      <span class="sp-syntax-plain">console</span>.<span class="sp-syntax-property">log</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-string">&#x27;⏰ &#x27;</span> + <span class="sp-syntax-plain">text</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-punctuation">}</span>

    <span class="sp-syntax-plain">console</span>.<span class="sp-syntax-property">log</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-string">&#x27;🔵 调度 &quot;&#x27;</span> + <span class="sp-syntax-plain">text</span> + <span class="sp-syntax-string">&#x27;&quot; 日志&#x27;</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">timeoutId</span> = <span class="sp-syntax-definition">setTimeout</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">onTimeout</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-static">3000</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>

    <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
      <span class="sp-syntax-plain">console</span>.<span class="sp-syntax-property">log</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-string">&#x27;🟡 取消 &quot;&#x27;</span> + <span class="sp-syntax-plain">text</span> + <span class="sp-syntax-string">&#x27;&quot; 日志&#x27;</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
      <span class="sp-syntax-definition">clearTimeout</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">timeoutId</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-plain">text</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>

  <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-punctuation">(</span>
    <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-punctuation">&gt;</span>
      <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-tag">label</span><span class="sp-syntax-punctuation">&gt;</span>
        日志内容：<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-string">&#x27; &#x27;</span><span class="sp-syntax-punctuation">}</span>
        <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-tag">input</span>
          <span class="sp-syntax-property">value</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">text</span><span class="sp-syntax-punctuation">}</span>
          <span class="sp-syntax-property">onChange</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">e</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-definition">setText</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">target</span>.<span class="sp-syntax-property">value</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">}</span>
        <span class="sp-syntax-punctuation">/&gt;</span>
      <span class="sp-syntax-punctuation">&lt;/</span><span class="sp-syntax-tag">label</span><span class="sp-syntax-punctuation">&gt;</span>
      <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-tag">h1</span><span class="sp-syntax-punctuation">&gt;</span><span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">text</span><span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">&lt;/</span><span class="sp-syntax-tag">h1</span><span class="sp-syntax-punctuation">&gt;</span>
    <span class="sp-syntax-punctuation">&lt;/</span><span class="sp-syntax-punctuation">&gt;</span>
  <span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-punctuation">}</span>

<span class="sp-syntax-keyword">export</span> <span class="sp-syntax-keyword">default</span> <span class="sp-syntax-keyword">function</span> <span class="sp-syntax-definition">App</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-plain">show</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">setShow</span><span class="sp-syntax-punctuation">]</span> = <span class="sp-syntax-definition">useState</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-static">false</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-punctuation">(</span>
    <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-punctuation">&gt;</span>
      <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-tag">button</span> <span class="sp-syntax-property">onClick</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-definition">setShow</span><span class="sp-syntax-punctuation">(</span>!<span class="sp-syntax-plain">show</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">&gt;</span>
        <span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">show</span> ? <span class="sp-syntax-string">&#x27;卸载&#x27;</span> : <span class="sp-syntax-string">&#x27;挂载&#x27;</span><span class="sp-syntax-punctuation">}</span>组件
      <span class="sp-syntax-punctuation">&lt;/</span><span class="sp-syntax-tag">button</span><span class="sp-syntax-punctuation">&gt;</span>
      <span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">show</span> &amp;&amp; <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-tag">hr</span> <span class="sp-syntax-punctuation">/&gt;</span><span class="sp-syntax-punctuation">}</span>
      <span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">show</span> &amp;&amp; <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-definition">Playground</span> <span class="sp-syntax-punctuation">/&gt;</span><span class="sp-syntax-punctuation">}</span>
    <span class="sp-syntax-punctuation">&lt;/</span><span class="sp-syntax-punctuation">&gt;</span>
  <span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-punctuation">}</span>

</pre></div></div></div><div class=" order-last xl:order-2 sp-stack"><div class="p-0 sm:p-2 md:p-4 lg:p-8 bg-card dark:bg-wash-dark h-full relative md:rounded-b-lg lg:rounded-b-none"><div style="position:relative"><iframe class="rounded-t-none bg-white md:shadow-md sm:rounded-lg w-full max-w-full transition-opacity absolute opacity-0 pointer-events-none duration-75" title="Sandbox Preview" style="height:15px;z-index:-1"></iframe></div></div></div><button translate="yes" class="sandpack-expand flex text-base justify-between dark:border-card-dark bg-wash dark:bg-card-dark items-center z-10 p-1 w-full order-2 xl:order-last border-b-1 relative top-0"><span class="flex p-2 focus:outline-none text-primary dark:text-primary-dark leading-[20px]"><svg class="rotate-0 inline me-1.5 text-xl" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><g fill="none" fill-rule="evenodd" transform="translate(-446 -398)"><path fill="currentColor" fill-rule="nonzero" d="M95.8838835,240.366117 C95.3957281,239.877961 94.6042719,239.877961 94.1161165,240.366117 C93.6279612,240.854272 93.6279612,241.645728 94.1161165,242.133883 L98.6161165,246.633883 C99.1042719,247.122039 99.8957281,247.122039 100.383883,246.633883 L104.883883,242.133883 C105.372039,241.645728 105.372039,240.854272 104.883883,240.366117 C104.395728,239.877961 103.604272,239.877961 103.116117,240.366117 L99.5,243.982233 L95.8838835,240.366117 Z" transform="translate(356.5 164.5)"></path><polygon points="446 418 466 418 466 398 446 398"></polygon></g></svg>显示更多</span></button></div></div></div></div><!--/$--><div class="max-w-4xl ms-0 2xl:mx-auto">
<p class="whitespace-pre-wrap my-4">你首先会看到三条日志：<code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">调度 &quot;a&quot; 日志</code>，<code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">取消 &quot;a&quot; 日志</code>，再一条 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">调度 &quot;a&quot; 日志</code>。三秒后，你还会看到一条日志：<code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">a</code>。正如你先前所学，额外的调度/取消日志是因为 React 在开发环境中会重新挂载组件一次，以验证你是否正确实现了清理操作。</p>
<p class="whitespace-pre-wrap my-4">现在编辑输入框，输入 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">abc</code>。如果输入速度足够快，你会看到 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">调度 &quot;ab&quot; 日志</code>，紧接着 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">取消 &quot;ab&quot; 日志</code> 和 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">调度 &quot;abc&quot; 日志</code>。<strong class="font-bold">React 总是在执行下一轮渲染的 Effect 之前清理上一轮渲染的 Effect</strong>。这就是为什么即使你快速输入，最多也只有一个延时器被调度。试试多次编辑输入框，并观察控制台以了解 Effect 是如何被清理的。</p>
<p class="whitespace-pre-wrap my-4">在输入框中输入一些内容，然后立即按下“卸载组件”。注意卸载组件时是如何清理最后一轮渲染的 Effect 的。在这里，它会在最后一个延迟器要触发之前取消它。</p>
<p class="whitespace-pre-wrap my-4">最后，在上面的代码中注释掉清理函数，这样延时器就不会被取消。尝试快速输入 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">abcde</code>。你觉得三秒后会发生什么？延时器中的 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">console.log(text)</code> 会打印 <strong class="font-bold">最新</strong> 的 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">text</code> 值并生成五条 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">abcde</code> 日志吗？试试看吧，验证一下你的直觉！</p>
<p class="whitespace-pre-wrap my-4">三秒后，你应该会看到一系列的日志：<code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">a</code>、<code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">ab</code>、<code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">abc</code>、<code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">abcd</code> 与 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">abcde</code>，而不是五条 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">abcde</code> 日志。这是因为 <strong class="font-bold">每个 Effect 都会“捕获”它对应渲染时的 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">text</code> 值</strong>。即使 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">text</code> 的值发生了变化，渲染时 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">text = &#x27;ab&#x27;</code> 的 Effect 总是会得到 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">&#x27;ab&#x27;</code>。换句话说，每个渲染的 Effect 都是相互独立的。如果你对这种机制感兴趣，可以阅读有关 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Closures" target="_blank" rel="nofollow noopener noreferrer" class="inline text-link dark:text-link-dark border-b border-link border-opacity-0 hover:border-opacity-100 duration-100 ease-in transition leading-normal">闭包</a> 的内容。</p>
<details class="my-12 rounded-2xl shadow-inner-border dark:shadow-inner-border-dark relative dark:bg-opacity-20 dark:bg-purple-60 bg-purple-5"><summary class="list-none p-8" tabindex="-1"><h5 class="mb-4 uppercase font-bold flex items-center text-sm dark:text-purple-30 text-purple-50"><svg class="inline me-2 dark:text-purple-30 text-purple-40" width="1.5em" height="1.5em" viewBox="0 0 72 72" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M34.7409 59.7228L32.9567 58.9094C27.2672 56.3157 20.7328 56.3157 15.0433 58.9094C12.6018 60.0224 9.39163 59.0275 8.44602 56.0621C7.45647 52.9589 5.99975 46.5898 6 35.9997C6.00029 23.5648 8.00803 18.3599 9.11099 16.4196C9.67795 15.4222 10.5255 14.8455 11.2254 14.5264L12.0179 14.1651C19.6351 10.6926 28.4011 10.6738 36 14.1733C43.5989 10.6738 52.3649 10.6926 59.9821 14.1651L60.7746 14.5264C61.4745 14.8455 62.3221 15.4222 62.889 16.4196C63.992 18.3599 65.9997 23.5648 66 35.9997C66.0002 46.5898 64.5435 52.9589 63.554 56.0621C62.6084 59.0275 59.3982 60.0224 56.9567 58.9094C51.2672 56.3157 44.7328 56.3157 39.0433 58.9094L37.2591 59.7228C37.1986 59.7508 37.1373 59.7767 37.0753 59.8004C36.4484 60.0411 35.7556 60.0653 35.1102 59.8648C34.9847 59.8258 34.8613 59.7784 34.7409 59.7228ZM14.5068 19.6246C20.3733 16.9501 27.0874 16.8775 33 19.4067V52.473C26.7613 50.32 19.9378 50.471 13.7811 52.9261C13.0005 49.9843 11.9998 44.547 12 35.9998C12.0002 25.5786 13.4879 21.1893 14.1179 19.8018L14.5068 19.6246ZM39 52.473C45.2387 50.32 52.0622 50.471 58.2189 52.9261C58.9995 49.9843 60.0002 44.547 60 35.9998C59.9998 25.5786 58.5121 21.1893 57.8821 19.8018L57.4932 19.6246C51.6267 16.9501 44.9126 16.8775 39 19.4067V52.473Z" fill="currentColor"></path></svg>深入探讨</h5><div class="mb-4"><h4 id="each-render-has-its-own-effects" class="mdx-heading text-xl font-bold text-primary dark:text-primary-dark text-xl font-display font-bold leading-9 my-4">每一轮渲染都有其自己的 Effect <a href="#each-render-has-its-own-effects" aria-label="Link for 每一轮渲染都有其自己的 Effect " title="Link for 每一轮渲染都有其自己的 Effect " class="mdx-header-anchor inline-block"><svg width="1em" height="1em" viewBox="0 0 13 13" xmlns="http://www.w3.org/2000/svg" class="text-gray-70 ms-2 h-5 w-5"><g fill="currentColor" fill-rule="evenodd"><path d="M7.778 7.975a2.5 2.5 0 0 0 .347-3.837L6.017 2.03a2.498 2.498 0 0 0-3.542-.007 2.5 2.5 0 0 0 .006 3.543l1.153 1.15c.07-.29.154-.563.25-.773.036-.077.084-.16.14-.25L3.18 4.85a1.496 1.496 0 0 1 .002-2.12 1.496 1.496 0 0 1 2.12 0l2.124 2.123a1.496 1.496 0 0 1-.333 2.37c.16.246.42.504.685.752z"></path><path d="M5.657 4.557a2.5 2.5 0 0 0-.347 3.837l2.108 2.108a2.498 2.498 0 0 0 3.542.007 2.5 2.5 0 0 0-.006-3.543L9.802 5.815c-.07.29-.154.565-.25.774-.036.076-.084.16-.14.25l.842.84c.585.587.59 1.532 0 2.122-.587.585-1.532.59-2.12 0L6.008 7.68a1.496 1.496 0 0 1 .332-2.372c-.16-.245-.42-.503-.685-.75z"></path></g></svg></a></h4></div><button class="bg-purple-50 border-purple-50 hover:bg-purple-40 focus:bg-purple-50 active:bg-purple-50 text-base leading-tight font-bold rounded-full py-2 px-4 focus:outline focus:outline-offset-2 focus:outline-link dark:focus:outline-link-dark inline-flex items-center my-1 bg-link border-link text-white hover:bg-link focus:bg-link active:bg-link"><span class="me-1"><svg class="rotate-0" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><g fill="none" fill-rule="evenodd" transform="translate(-446 -398)"><path fill="currentColor" fill-rule="nonzero" d="M95.8838835,240.366117 C95.3957281,239.877961 94.6042719,239.877961 94.1161165,240.366117 C93.6279612,240.854272 93.6279612,241.645728 94.1161165,242.133883 L98.6161165,246.633883 C99.1042719,247.122039 99.8957281,247.122039 100.383883,246.633883 L104.883883,242.133883 C105.372039,241.645728 105.372039,240.854272 104.883883,240.366117 C104.395728,239.877961 103.604272,239.877961 103.116117,240.366117 L99.5,243.982233 L95.8838835,240.366117 Z" transform="translate(356.5 164.5)"></path><polygon points="446 418 466 418 466 398 446 398"></polygon></g></svg></span>显示更多</button></summary><div class="p-8 border-t dark:border-purple-60 border-purple-10 "><p class="whitespace-pre-wrap my-4">你可以将 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">useEffect</code> 理解为“附加”一段行为到渲染输出中。考虑下面这个 Effect：</p><!--$--><div dir="ltr" class="sandpack sandpack--codeblock rounded-2xl h-full w-full overflow-x-auto flex items-center bg-wash dark:bg-gray-95 shadow-lg my-8" style="contain:content"><div class="sp-wrapper"><div class="sp-stack"><div class="sp-code-editor"><pre class="sp-cm sp-pristine sp-javascript flex align-start"><code class="sp-pre-placeholder grow-[2]"><div class="cm-line "><span class="sp-syntax-keyword">export</span> <span class="sp-syntax-keyword">default</span> <span class="sp-syntax-keyword">function</span> <span class="sp-syntax-definition">ChatRoom</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">{</span> <span class="sp-syntax-property">roomId</span> <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line ">  <span class="sp-syntax-definition">useEffect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line ">    <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">connection</span> = <span class="sp-syntax-definition">createConnection</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">roomId</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line ">    <span class="sp-syntax-plain">connection</span>.<span class="sp-syntax-property">connect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line ">    <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-plain">connection</span>.<span class="sp-syntax-property">disconnect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line ">  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-plain">roomId</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line "><br/></div><div class="cm-line ">  <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-tag">h1</span><span class="sp-syntax-punctuation">&gt;</span>欢迎来到 <span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">roomId</span><span class="sp-syntax-punctuation">}</span>！<span class="sp-syntax-punctuation">&lt;/</span><span class="sp-syntax-tag">h1</span><span class="sp-syntax-punctuation">&gt;</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line "><span class="sp-syntax-punctuation">}</span></div></code></pre></div></div></div></div><!--/$--><p class="whitespace-pre-wrap my-4">让我们看看当用户在应用程序中切换页面时到底发生了什么。</p><h4 id="initial-render" class="mdx-heading text-xl font-display font-bold leading-9 my-4">初次渲染 <a href="#initial-render" aria-label="Link for 初次渲染 " title="Link for 初次渲染 " class="mdx-header-anchor inline-block"><svg width="1em" height="1em" viewBox="0 0 13 13" xmlns="http://www.w3.org/2000/svg" class="text-gray-70 ms-2 h-5 w-5"><g fill="currentColor" fill-rule="evenodd"><path d="M7.778 7.975a2.5 2.5 0 0 0 .347-3.837L6.017 2.03a2.498 2.498 0 0 0-3.542-.007 2.5 2.5 0 0 0 .006 3.543l1.153 1.15c.07-.29.154-.563.25-.773.036-.077.084-.16.14-.25L3.18 4.85a1.496 1.496 0 0 1 .002-2.12 1.496 1.496 0 0 1 2.12 0l2.124 2.123a1.496 1.496 0 0 1-.333 2.37c.16.246.42.504.685.752z"></path><path d="M5.657 4.557a2.5 2.5 0 0 0-.347 3.837l2.108 2.108a2.498 2.498 0 0 0 3.542.007 2.5 2.5 0 0 0-.006-3.543L9.802 5.815c-.07.29-.154.565-.25.774-.036.076-.084.16-.14.25l.842.84c.585.587.59 1.532 0 2.122-.587.585-1.532.59-2.12 0L6.008 7.68a1.496 1.496 0 0 1 .332-2.372c-.16-.245-.42-.503-.685-.75z"></path></g></svg></a></h4><p class="whitespace-pre-wrap my-4">用户访问 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">&lt;ChatRoom roomId=&quot;general&quot; /&gt;</code>。我们 <a class="inline text-link dark:text-link-dark border-b border-link border-opacity-0 hover:border-opacity-100 duration-100 ease-in transition leading-normal" href="/learn/state-as-a-snapshot#rendering-takes-a-snapshot-in-time">假设</a> <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">roomId</code> 的值为 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">&#x27;general&#x27;</code> ：</p><!--$--><div dir="ltr" class="sandpack sandpack--codeblock rounded-2xl h-full w-full overflow-x-auto flex items-center bg-wash dark:bg-gray-95 shadow-lg my-8" style="contain:content"><div class="sp-wrapper"><div class="sp-stack"><div class="sp-code-editor"><pre class="sp-cm sp-pristine sp-javascript flex align-start"><code class="sp-pre-placeholder grow-[2]"><div class="cm-line ">  <span class="sp-syntax-comment">// 首次渲染时的 JSX（roomId 为 &quot;general&quot;）</span><br/></div><div class="cm-line ">  <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-tag">h1</span><span class="sp-syntax-punctuation">&gt;</span>欢迎来到 general！<span class="sp-syntax-punctuation">&lt;/</span><span class="sp-syntax-tag">h1</span><span class="sp-syntax-punctuation">&gt;</span><span class="sp-syntax-punctuation">;</span></div></code></pre></div></div></div></div><!--/$--><p class="whitespace-pre-wrap my-4"><strong class="font-bold">Effect 也是渲染输出的一部分</strong>。首次渲染的 Effect 变为：</p><!--$--><div dir="ltr" class="sandpack sandpack--codeblock rounded-2xl h-full w-full overflow-x-auto flex items-center bg-wash dark:bg-gray-95 shadow-lg my-8" style="contain:content"><div class="sp-wrapper"><div class="sp-stack"><div class="sp-code-editor"><pre class="sp-cm sp-pristine sp-javascript flex align-start"><code class="sp-pre-placeholder grow-[2]"><div class="cm-line ">  <span class="sp-syntax-comment">//首先渲染时的 Effect（roomId 为 &quot;general&quot;）</span><br/></div><div class="cm-line ">  <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line ">    <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">connection</span> = <span class="sp-syntax-definition">createConnection</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-string">&#x27;general&#x27;</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line ">    <span class="sp-syntax-plain">connection</span>.<span class="sp-syntax-property">connect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line ">    <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-plain">connection</span>.<span class="sp-syntax-property">disconnect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line ">  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">,</span><br/></div><div class="cm-line ">  <span class="sp-syntax-comment">// 首次渲染时的依赖项（roomId 为 &quot;general&quot;）</span><br/></div><div class="cm-line ">  <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-string">&#x27;general&#x27;</span><span class="sp-syntax-punctuation">]</span></div></code></pre></div></div></div></div><!--/$--><p class="whitespace-pre-wrap my-4">React 运行这个 Effect 来连接到 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">&#x27;general&#x27;</code> 聊天室。</p><h4 id="re-render-with-same-dependencies" class="mdx-heading text-xl font-display font-bold leading-9 my-4">依赖项相同时的重新渲染 <a href="#re-render-with-same-dependencies" aria-label="Link for 依赖项相同时的重新渲染 " title="Link for 依赖项相同时的重新渲染 " class="mdx-header-anchor inline-block"><svg width="1em" height="1em" viewBox="0 0 13 13" xmlns="http://www.w3.org/2000/svg" class="text-gray-70 ms-2 h-5 w-5"><g fill="currentColor" fill-rule="evenodd"><path d="M7.778 7.975a2.5 2.5 0 0 0 .347-3.837L6.017 2.03a2.498 2.498 0 0 0-3.542-.007 2.5 2.5 0 0 0 .006 3.543l1.153 1.15c.07-.29.154-.563.25-.773.036-.077.084-.16.14-.25L3.18 4.85a1.496 1.496 0 0 1 .002-2.12 1.496 1.496 0 0 1 2.12 0l2.124 2.123a1.496 1.496 0 0 1-.333 2.37c.16.246.42.504.685.752z"></path><path d="M5.657 4.557a2.5 2.5 0 0 0-.347 3.837l2.108 2.108a2.498 2.498 0 0 0 3.542.007 2.5 2.5 0 0 0-.006-3.543L9.802 5.815c-.07.29-.154.565-.25.774-.036.076-.084.16-.14.25l.842.84c.585.587.59 1.532 0 2.122-.587.585-1.532.59-2.12 0L6.008 7.68a1.496 1.496 0 0 1 .332-2.372c-.16-.245-.42-.503-.685-.75z"></path></g></svg></a></h4><p class="whitespace-pre-wrap my-4">假设 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">&lt;ChatRoom roomId=&quot;general&quot; /&gt;</code> 重新渲染。输出的 JSX 不变：</p><!--$--><div dir="ltr" class="sandpack sandpack--codeblock rounded-2xl h-full w-full overflow-x-auto flex items-center bg-wash dark:bg-gray-95 shadow-lg my-8" style="contain:content"><div class="sp-wrapper"><div class="sp-stack"><div class="sp-code-editor"><pre class="sp-cm sp-pristine sp-javascript flex align-start"><code class="sp-pre-placeholder grow-[2]"><div class="cm-line ">  <span class="sp-syntax-comment">// 第二次渲染时的 JSX（roomId 为 &quot;general&quot;）</span><br/></div><div class="cm-line ">  <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-tag">h1</span><span class="sp-syntax-punctuation">&gt;</span>Welcome to general!<span class="sp-syntax-punctuation">&lt;/</span><span class="sp-syntax-tag">h1</span><span class="sp-syntax-punctuation">&gt;</span><span class="sp-syntax-punctuation">;</span></div></code></pre></div></div></div></div><!--/$--><p class="whitespace-pre-wrap my-4">React 看到渲染输出没有改变，所以不更新 DOM 。</p><p class="whitespace-pre-wrap my-4">第二次渲染的 Effect 如下所示：</p><!--$--><div dir="ltr" class="sandpack sandpack--codeblock rounded-2xl h-full w-full overflow-x-auto flex items-center bg-wash dark:bg-gray-95 shadow-lg my-8" style="contain:content"><div class="sp-wrapper"><div class="sp-stack"><div class="sp-code-editor"><pre class="sp-cm sp-pristine sp-javascript flex align-start"><code class="sp-pre-placeholder grow-[2]"><div class="cm-line ">  <span class="sp-syntax-comment">// 第二次渲染时的 Effect（roomId 为 &quot;general&quot;）</span><br/></div><div class="cm-line ">  <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line ">    <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">connection</span> = <span class="sp-syntax-definition">createConnection</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-string">&#x27;general&#x27;</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line ">    <span class="sp-syntax-plain">connection</span>.<span class="sp-syntax-property">connect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line ">    <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-plain">connection</span>.<span class="sp-syntax-property">disconnect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line ">  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">,</span><br/></div><div class="cm-line ">  <span class="sp-syntax-comment">// 第二次渲染时的依赖项（roomId 为 &quot;general&quot;）</span><br/></div><div class="cm-line ">  <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-string">&#x27;general&#x27;</span><span class="sp-syntax-punctuation">]</span></div></code></pre></div></div></div></div><!--/$--><p class="whitespace-pre-wrap my-4">React 将第二次渲染时的 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">[&#x27;general&#x27;]</code> 与第一次渲染时的 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">[&#x27;general&#x27;]</code> 进行比较。<strong class="font-bold">因为所有的依赖项都相同，React 忽略第二次渲染时的 Effect</strong>。Effect 不会被调用。</p><h4 id="re-render-with-different-dependencies" class="mdx-heading text-xl font-display font-bold leading-9 my-4">依赖项不同时的重新渲染 <a href="#re-render-with-different-dependencies" aria-label="Link for 依赖项不同时的重新渲染 " title="Link for 依赖项不同时的重新渲染 " class="mdx-header-anchor inline-block"><svg width="1em" height="1em" viewBox="0 0 13 13" xmlns="http://www.w3.org/2000/svg" class="text-gray-70 ms-2 h-5 w-5"><g fill="currentColor" fill-rule="evenodd"><path d="M7.778 7.975a2.5 2.5 0 0 0 .347-3.837L6.017 2.03a2.498 2.498 0 0 0-3.542-.007 2.5 2.5 0 0 0 .006 3.543l1.153 1.15c.07-.29.154-.563.25-.773.036-.077.084-.16.14-.25L3.18 4.85a1.496 1.496 0 0 1 .002-2.12 1.496 1.496 0 0 1 2.12 0l2.124 2.123a1.496 1.496 0 0 1-.333 2.37c.16.246.42.504.685.752z"></path><path d="M5.657 4.557a2.5 2.5 0 0 0-.347 3.837l2.108 2.108a2.498 2.498 0 0 0 3.542.007 2.5 2.5 0 0 0-.006-3.543L9.802 5.815c-.07.29-.154.565-.25.774-.036.076-.084.16-.14.25l.842.84c.585.587.59 1.532 0 2.122-.587.585-1.532.59-2.12 0L6.008 7.68a1.496 1.496 0 0 1 .332-2.372c-.16-.245-.42-.503-.685-.75z"></path></g></svg></a></h4><p class="whitespace-pre-wrap my-4">接着，用户访问了 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">&lt;ChatRoom roomId=&quot;travel&quot; /&gt;</code>。这一次，组件返回了不同的 JSX：</p><!--$--><div dir="ltr" class="sandpack sandpack--codeblock rounded-2xl h-full w-full overflow-x-auto flex items-center bg-wash dark:bg-gray-95 shadow-lg my-8" style="contain:content"><div class="sp-wrapper"><div class="sp-stack"><div class="sp-code-editor"><pre class="sp-cm sp-pristine sp-javascript flex align-start"><code class="sp-pre-placeholder grow-[2]"><div class="cm-line ">  <span class="sp-syntax-comment">// 第三次渲染时的 JSX（roomId 为 &quot;travel&quot;）</span><br/></div><div class="cm-line ">  <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-tag">h1</span><span class="sp-syntax-punctuation">&gt;</span>欢迎来到 travel！<span class="sp-syntax-punctuation">&lt;/</span><span class="sp-syntax-tag">h1</span><span class="sp-syntax-punctuation">&gt;</span><span class="sp-syntax-punctuation">;</span></div></code></pre></div></div></div></div><!--/$--><p class="whitespace-pre-wrap my-4">React 更新 DOM ，将 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">&quot;欢迎来到 general&quot;</code> 改为 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">&quot;欢迎来到 travel&quot;</code>。</p><p class="whitespace-pre-wrap my-4">第三次渲染的 Effect 如下所示：</p><!--$--><div dir="ltr" class="sandpack sandpack--codeblock rounded-2xl h-full w-full overflow-x-auto flex items-center bg-wash dark:bg-gray-95 shadow-lg my-8" style="contain:content"><div class="sp-wrapper"><div class="sp-stack"><div class="sp-code-editor"><pre class="sp-cm sp-pristine sp-javascript flex align-start"><code class="sp-pre-placeholder grow-[2]"><div class="cm-line ">  <span class="sp-syntax-comment">// 第三次渲染时的 Effect（roomId 为 &quot;travel&quot;）</span><br/></div><div class="cm-line ">  <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span><br/></div><div class="cm-line ">    <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">connection</span> = <span class="sp-syntax-definition">createConnection</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-string">&#x27;travel&#x27;</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line ">    <span class="sp-syntax-plain">connection</span>.<span class="sp-syntax-property">connect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line ">    <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-plain">connection</span>.<span class="sp-syntax-property">disconnect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span><br/></div><div class="cm-line ">  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">,</span><br/></div><div class="cm-line ">  <span class="sp-syntax-comment">// 第三次渲染时的依赖项（roomId 为 &quot;travel&quot;）</span><br/></div><div class="cm-line ">  <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-string">&#x27;travel&#x27;</span><span class="sp-syntax-punctuation">]</span></div></code></pre></div></div></div></div><!--/$--><p class="whitespace-pre-wrap my-4">React 将第三次渲染时的 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">[&#x27;travel&#x27;]</code> 与第二次渲染时的 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">[&#x27;general&#x27;]</code> 相比较。发现依赖项不同：<code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">Object.is(&#x27;travel&#x27;, &#x27;general&#x27;)</code> 为 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">false</code>。因此 Effect 不能被跳过。</p><p class="whitespace-pre-wrap my-4"><strong class="font-bold">在 React 执行第三次渲染的 Effect 之前，它需要清理上一个运行的 Effect</strong>。第二次渲染的 Effect 被跳过了。所以 React 需要清理第一次渲染时的 Effect。如果你回看第一次渲染，你会发现第一次渲染时的清理函数所做的事，是在 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">createConnection(&#x27;general&#x27;)</code> 所创建的连接上调用 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">disconnect()</code>。也就是从 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">&#x27;general&#x27;</code> 聊天室断开连接。</p><p class="whitespace-pre-wrap my-4">之后，React 执行第三次渲染的 Effect。它连接到 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">&#x27;travel&#x27;</code> 聊天室。</p><h4 id="unmount" class="mdx-heading text-xl font-display font-bold leading-9 my-4">组件卸载 <a href="#unmount" aria-label="Link for 组件卸载 " title="Link for 组件卸载 " class="mdx-header-anchor inline-block"><svg width="1em" height="1em" viewBox="0 0 13 13" xmlns="http://www.w3.org/2000/svg" class="text-gray-70 ms-2 h-5 w-5"><g fill="currentColor" fill-rule="evenodd"><path d="M7.778 7.975a2.5 2.5 0 0 0 .347-3.837L6.017 2.03a2.498 2.498 0 0 0-3.542-.007 2.5 2.5 0 0 0 .006 3.543l1.153 1.15c.07-.29.154-.563.25-.773.036-.077.084-.16.14-.25L3.18 4.85a1.496 1.496 0 0 1 .002-2.12 1.496 1.496 0 0 1 2.12 0l2.124 2.123a1.496 1.496 0 0 1-.333 2.37c.16.246.42.504.685.752z"></path><path d="M5.657 4.557a2.5 2.5 0 0 0-.347 3.837l2.108 2.108a2.498 2.498 0 0 0 3.542.007 2.5 2.5 0 0 0-.006-3.543L9.802 5.815c-.07.29-.154.565-.25.774-.036.076-.084.16-.14.25l.842.84c.585.587.59 1.532 0 2.122-.587.585-1.532.59-2.12 0L6.008 7.68a1.496 1.496 0 0 1 .332-2.372c-.16-.245-.42-.503-.685-.75z"></path></g></svg></a></h4><p class="whitespace-pre-wrap my-4">最后，假设用户离开了当前页面，<code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">ChatRoom</code> 组件被卸载。React 执行上一个运行的 Effect 的清理函数，也就是第三次渲染时的 Effect。这个清理函数会销毁 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">createConnection(&#x27;travel&#x27;)</code> 所创建的连接。这样，应用与 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">travel</code> 房间断开了连接。</p><h4 id="development-only-behaviors" class="mdx-heading text-xl font-display font-bold leading-9 my-4">仅开发环境下的行为 <a href="#development-only-behaviors" aria-label="Link for 仅开发环境下的行为 " title="Link for 仅开发环境下的行为 " class="mdx-header-anchor inline-block"><svg width="1em" height="1em" viewBox="0 0 13 13" xmlns="http://www.w3.org/2000/svg" class="text-gray-70 ms-2 h-5 w-5"><g fill="currentColor" fill-rule="evenodd"><path d="M7.778 7.975a2.5 2.5 0 0 0 .347-3.837L6.017 2.03a2.498 2.498 0 0 0-3.542-.007 2.5 2.5 0 0 0 .006 3.543l1.153 1.15c.07-.29.154-.563.25-.773.036-.077.084-.16.14-.25L3.18 4.85a1.496 1.496 0 0 1 .002-2.12 1.496 1.496 0 0 1 2.12 0l2.124 2.123a1.496 1.496 0 0 1-.333 2.37c.16.246.42.504.685.752z"></path><path d="M5.657 4.557a2.5 2.5 0 0 0-.347 3.837l2.108 2.108a2.498 2.498 0 0 0 3.542.007 2.5 2.5 0 0 0-.006-3.543L9.802 5.815c-.07.29-.154.565-.25.774-.036.076-.084.16-.14.25l.842.84c.585.587.59 1.532 0 2.122-.587.585-1.532.59-2.12 0L6.008 7.68a1.496 1.496 0 0 1 .332-2.372c-.16-.245-.42-.503-.685-.75z"></path></g></svg></a></h4><p class="whitespace-pre-wrap my-4">开启 <a class="inline text-link dark:text-link-dark border-b border-link border-opacity-0 hover:border-opacity-100 duration-100 ease-in transition leading-normal" href="/reference/react/StrictMode">严格模式</a> 时，React 在每次挂载组件后都会重新挂载组件（组件的 state 与 创建的 DOM 都会被保留）。<a class="inline text-link dark:text-link-dark border-b border-link border-opacity-0 hover:border-opacity-100 duration-100 ease-in transition leading-normal" href="#step-3-add-cleanup-if-needed">它可以帮助你找出需要添加清理函数的 Effect</a>，并在早期暴露类似竞态条件这样的 bug。此外，每当你在开发环境中保存文件时，React 也会重新挂载 Effect。这些行为都仅限于开发环境。</p></div></details>
<section><h2 id="recap" class="mdx-heading text-3xl font-display leading-10 text-primary dark:text-primary-dark font-bold my-6">摘要<a href="#recap" aria-label="Link for 摘要" title="Link for 摘要" class="mdx-header-anchor inline-block"><svg width="1em" height="1em" viewBox="0 0 13 13" xmlns="http://www.w3.org/2000/svg" class="text-gray-70 ms-2 h-5 w-5"><g fill="currentColor" fill-rule="evenodd"><path d="M7.778 7.975a2.5 2.5 0 0 0 .347-3.837L6.017 2.03a2.498 2.498 0 0 0-3.542-.007 2.5 2.5 0 0 0 .006 3.543l1.153 1.15c.07-.29.154-.563.25-.773.036-.077.084-.16.14-.25L3.18 4.85a1.496 1.496 0 0 1 .002-2.12 1.496 1.496 0 0 1 2.12 0l2.124 2.123a1.496 1.496 0 0 1-.333 2.37c.16.246.42.504.685.752z"></path><path d="M5.657 4.557a2.5 2.5 0 0 0-.347 3.837l2.108 2.108a2.498 2.498 0 0 0 3.542.007 2.5 2.5 0 0 0-.006-3.543L9.802 5.815c-.07.29-.154.565-.25.774-.036.076-.084.16-.14.25l.842.84c.585.587.59 1.532 0 2.122-.587.585-1.532.59-2.12 0L6.008 7.68a1.496 1.496 0 0 1 .332-2.372c-.16-.245-.42-.503-.685-.75z"></path></g></svg></a></h2><ul class="ms-6 my-3 list-disc">
<li class="leading-relaxed mb-1">与事件不同，Effect 由渲染本身引起，而非特定的交互。</li>
<li class="leading-relaxed mb-1">Effect 允许你将组件与某些外部系统（第三方 API、网络等）同步。</li>
<li class="leading-relaxed mb-1">默认情况下，Effect 在每次渲染（包括初始渲染）后运行。</li>
<li class="leading-relaxed mb-1">如果所有依赖项都与上一次渲染时相同，React 会跳过本次 Effect。</li>
<li class="leading-relaxed mb-1">你不能“选择”依赖项，它们是由 Effect 内部的代码所决定的。</li>
<li class="leading-relaxed mb-1">空的依赖数组（<code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">[]</code>）对应于组件的“挂载”，即组件被添加到页面上时。</li>
<li class="leading-relaxed mb-1">仅在严格模式下的开发环境中，React 会挂载两次组件，以对 Effect 进行压力测试。</li>
<li class="leading-relaxed mb-1">如果你的 Effect 因为重新挂载而出现问题，那么你需要实现一个清理函数。</li>
<li class="leading-relaxed mb-1">React 会在 Effect 再次运行之前和在组件卸载时调用你的清理函数。</li>
</ul></section>
</div><div class="max-w-7xl mx-auto py-4 w-full"><div class="border-gray-10 bg-card dark:bg-card-dark shadow-inner rounded-none -mx-5 sm:mx-auto sm:rounded-2xl"><div class="py-2 px-5 sm:px-8 pb-0 md:pb-0"><h2 id="challenges" class="mdx-heading text-3xl font-display leading-10 text-primary dark:text-primary-dark font-bold my-6 mb-2 leading-10 relative text-3xl text-link">尝试一些挑战<a href="#challenges" aria-label="Link for 尝试一些挑战" title="Link for 尝试一些挑战" class="mdx-header-anchor inline-block"><svg width="1em" height="1em" viewBox="0 0 13 13" xmlns="http://www.w3.org/2000/svg" class="text-gray-70 ms-2 h-5 w-5"><g fill="currentColor" fill-rule="evenodd"><path d="M7.778 7.975a2.5 2.5 0 0 0 .347-3.837L6.017 2.03a2.498 2.498 0 0 0-3.542-.007 2.5 2.5 0 0 0 .006 3.543l1.153 1.15c.07-.29.154-.563.25-.773.036-.077.084-.16.14-.25L3.18 4.85a1.496 1.496 0 0 1 .002-2.12 1.496 1.496 0 0 1 2.12 0l2.124 2.123a1.496 1.496 0 0 1-.333 2.37c.16.246.42.504.685.752z"></path><path d="M5.657 4.557a2.5 2.5 0 0 0-.347 3.837l2.108 2.108a2.498 2.498 0 0 0 3.542.007 2.5 2.5 0 0 0-.006-3.543L9.802 5.815c-.07.29-.154.565-.25.774-.036.076-.084.16-.14.25l.842.84c.585.587.59 1.532 0 2.122-.587.585-1.532.59-2.12 0L6.008 7.68a1.496 1.496 0 0 1 .332-2.372c-.16-.245-.42-.503-.685-.75z"></path></g></svg></a></h2><div class="flex items-center justify-between"><div class="overflow-hidden"><div class="flex relative transition-transform content-box overflow-x-auto"><button class="py-2 me-4 text-base border-b-4 duration-100 ease-in transition whitespace-nowrap text-ellipsis text-link border-link hover:text-link dark:text-link-dark dark:border-link-dark dark:hover:text-link-dark">1<!-- -->. <!-- -->挂载后聚焦于表单字段 </button><button class="py-2 me-4 text-base border-b-4 duration-100 ease-in transition whitespace-nowrap text-ellipsis">2<!-- -->. <!-- -->有条件地聚焦于表单字段 </button><button class="py-2 me-4 text-base border-b-4 duration-100 ease-in transition whitespace-nowrap text-ellipsis">3<!-- -->. <!-- -->修复会触发两次的定时器 </button><button class="py-2 me-4 text-base border-b-4 duration-100 ease-in transition whitespace-nowrap text-ellipsis">4<!-- -->. <!-- -->解决在 Effect 中获取数据的问题 </button></div></div><div class="flex z-10 pb-2 ps-2"><button aria-label="Scroll left" class="bg-secondary-button dark:bg-secondary-button-dark h-8 px-2 rounded-l border-gray-20 border-r rtl:rotate-180 text-gray-30"><svg class="rotate-90 rtl:-rotate-90" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><g fill="none" fill-rule="evenodd" transform="translate(-446 -398)"><path fill="currentColor" fill-rule="nonzero" d="M95.8838835,240.366117 C95.3957281,239.877961 94.6042719,239.877961 94.1161165,240.366117 C93.6279612,240.854272 93.6279612,241.645728 94.1161165,242.133883 L98.6161165,246.633883 C99.1042719,247.122039 99.8957281,247.122039 100.383883,246.633883 L104.883883,242.133883 C105.372039,241.645728 105.372039,240.854272 104.883883,240.366117 C104.395728,239.877961 103.604272,239.877961 103.116117,240.366117 L99.5,243.982233 L95.8838835,240.366117 Z" transform="translate(356.5 164.5)"></path><polygon points="446 418 466 418 466 398 446 398"></polygon></g></svg></button><button aria-label="Scroll right" class="bg-secondary-button dark:bg-secondary-button-dark h-8 px-2 rounded-e rtl:rotate-180 text-primary dark:text-primary-dark"><svg class="-rotate-90 rtl:rotate-90" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><g fill="none" fill-rule="evenodd" transform="translate(-446 -398)"><path fill="currentColor" fill-rule="nonzero" d="M95.8838835,240.366117 C95.3957281,239.877961 94.6042719,239.877961 94.1161165,240.366117 C93.6279612,240.854272 93.6279612,241.645728 94.1161165,242.133883 L98.6161165,246.633883 C99.1042719,247.122039 99.8957281,247.122039 100.383883,246.633883 L104.883883,242.133883 C105.372039,241.645728 105.372039,240.854272 104.883883,240.366117 C104.395728,239.877961 103.604272,239.877961 103.116117,240.366117 L99.5,243.982233 L95.8838835,240.366117 Z" transform="translate(356.5 164.5)"></path><polygon points="446 418 466 418 466 398 446 398"></polygon></g></svg></button></div></div></div><div class="p-5 sm:py-8 sm:px-8"><div><h4 id="focus-a-field-on-mount" class="mdx-heading text-xl text-primary dark:text-primary-dark mb-2 mt-0 font-medium text-xl font-display font-bold leading-9 my-4"><div class="font-bold block md:inline">第 <!-- -->1<!-- --> 个<!-- -->挑战<!-- --> 共<!-- --> <!-- -->4<!-- --> 个挑战<span class="text-primary dark:text-primary-dark">: </span></div>挂载后聚焦于表单字段 <a href="#focus-a-field-on-mount" aria-label="Link for this heading" title="Link for this heading" class="mdx-header-anchor inline-block"><svg width="1em" height="1em" viewBox="0 0 13 13" xmlns="http://www.w3.org/2000/svg" class="text-gray-70 ms-2 h-5 w-5"><g fill="currentColor" fill-rule="evenodd"><path d="M7.778 7.975a2.5 2.5 0 0 0 .347-3.837L6.017 2.03a2.498 2.498 0 0 0-3.542-.007 2.5 2.5 0 0 0 .006 3.543l1.153 1.15c.07-.29.154-.563.25-.773.036-.077.084-.16.14-.25L3.18 4.85a1.496 1.496 0 0 1 .002-2.12 1.496 1.496 0 0 1 2.12 0l2.124 2.123a1.496 1.496 0 0 1-.333 2.37c.16.246.42.504.685.752z"></path><path d="M5.657 4.557a2.5 2.5 0 0 0-.347 3.837l2.108 2.108a2.498 2.498 0 0 0 3.542.007 2.5 2.5 0 0 0-.006-3.543L9.802 5.815c-.07.29-.154.565-.25.774-.036.076-.084.16-.14.25l.842.84c.585.587.59 1.532 0 2.122-.587.585-1.532.59-2.12 0L6.008 7.68a1.496 1.496 0 0 1 .332-2.372c-.16-.245-.42-.503-.685-.75z"></path></g></svg></a></h4><p class="whitespace-pre-wrap my-4">在下面的例子中，表单中渲染了一个 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">&lt;MyInput /&gt;</code> 组件。</p><p class="whitespace-pre-wrap my-4">使用输入框的 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLElement/focus" target="_blank" rel="nofollow noopener noreferrer" class="inline text-link dark:text-link-dark border-b border-link border-opacity-0 hover:border-opacity-100 duration-100 ease-in transition leading-normal"><code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">focus()</code></a> 方法，让 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">MyInput</code> 在页面上出现时自动聚焦。已经有一个被注释掉的实现，但它并不能正常工作。找出它为什么不起作用，并修复它。如果你熟悉 <code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">autoFocus</code> 属性，请假装它不存在：我们正在从头开始实现相同的功能。</p><!--$--><div class="sandpack sandpack--playground w-full my-8" dir="ltr"><div class="sp-wrapper"><div class="shadow-lg dark:shadow-lg-dark rounded-lg" style="contain:content"><div class="bg-wash dark:bg-card-dark flex justify-between items-center relative z-10 border-b border-border dark:border-border-dark rounded-t-lg text-lg"><div class="flex-1 grow min-w-0 px-4 lg:px-6"><div><div class="relative overflow-hidden"><div class="w-[fit-content] invisible"><div class=" sp-tabs" translate="no"><div aria-label="Select active file" class=" sp-tabs-scrollable-container" role="tablist"><button aria-selected="true" class="  sp-tab-button" data-active="true" role="tab" title="/src/MyInput.js" type="button">MyInput.js</button></div></div></div><button class="absolute top-0 start-[2px]" id="headlessui-listbox-button-:Rj5e6icq6:" aria-haspopup="true" aria-expanded="false" data-headlessui-state=""><span class="h-full py-2 px-1 mt-px -mb-px flex border-b text-link dark:text-link-dark border-link dark:border-link-dark items-center text-md leading-tight truncate" style="max-width:160px">MyInput.js</span></button></div></div></div><div class="px-3 flex items-center justify-end text-start" translate="yes"><button class="text-sm text-primary dark:text-primary-dark inline-flex items-center hover:text-link duration-100 ease-in transition mx-1" title="Reset Sandbox" type="button"><svg width="1em" height="1em" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="inline mx-1 relative"><path d="M13.8982 5.20844C12.4626 4.88688 10.9686 4.93769 9.55821 5.35604L11.8524 3.06184C11.8989 3.0154 11.9357 2.96028 11.9608 2.89961C11.986 2.83894 11.9989 2.77391 11.9989 2.70824C11.9989 2.64256 11.986 2.57754 11.9608 2.51686C11.9357 2.45619 11.8989 2.40107 11.8524 2.35464L11.1456 1.64784C11.0992 1.60139 11.0441 1.56455 10.9834 1.53942C10.9227 1.51428 10.8577 1.50134 10.792 1.50134C10.7263 1.50134 10.6613 1.51428 10.6006 1.53942C10.54 1.56455 10.4848 1.60139 10.4384 1.64784L6.14571 5.94054C6.00654 6.07969 5.89615 6.2449 5.82083 6.42673C5.74551 6.60855 5.70675 6.80343 5.70675 7.00024C5.70675 7.19704 5.74551 7.39192 5.82083 7.57374C5.89615 7.75557 6.00654 7.92078 6.14571 8.05994L10.4387 12.3529C10.5325 12.4465 10.6595 12.4991 10.792 12.4991C10.9245 12.4991 11.0516 12.4465 11.1453 12.3529L11.8527 11.6455C11.9463 11.5518 11.9989 11.4247 11.9989 11.2922C11.9989 11.1598 11.9463 11.0327 11.8527 10.9389L8.77481 7.86104C9.99795 7.16236 11.415 6.8801 12.8125 7.05678C14.21 7.23347 15.5122 7.85953 16.523 8.84064C17.5338 9.82176 18.1983 11.1048 18.4165 12.4964C18.6347 13.888 18.3947 15.3129 17.7328 16.5562C17.0708 17.7996 16.0227 18.7942 14.7463 19.3902C13.47 19.9861 12.0345 20.1511 10.6563 19.8603C9.27798 19.5695 8.03152 18.8387 7.10469 17.778C6.17786 16.7172 5.62086 15.384 5.51761 13.9791C5.51156 13.8512 5.45689 13.7303 5.36477 13.6413C5.27265 13.5522 5.15001 13.5017 5.02191 13.5H4.02081C3.95297 13.4996 3.88574 13.5129 3.8232 13.5392C3.76065 13.5655 3.70408 13.6042 3.6569 13.6529C3.60972 13.7017 3.57291 13.7595 3.54869 13.8228C3.52448 13.8862 3.51336 13.9538 3.51601 14.0216C3.61349 15.5965 4.1473 17.1132 5.0577 18.4019C5.9681 19.6906 7.21917 20.7006 8.6709 21.3188C10.1226 21.937 11.7178 22.139 13.2778 21.9022C14.8378 21.6654 16.3011 20.9992 17.504 19.978C18.7069 18.9569 19.6019 17.6212 20.0889 16.1203C20.5759 14.6195 20.6356 13.0128 20.2614 11.4799C19.8872 9.94705 19.0938 8.54858 17.97 7.44098C16.8462 6.33339 15.4363 5.56037 13.8982 5.20844V5.20844Z" fill="currentColor"></path></svg> 重置</button><a href="https://codesandbox.io/api/v1/sandboxes/define?undefined&amp;environment=create-react-app" rel="noreferrer noopener" target="_blank" title="Open in CodeSandbox" class="text-sm text-primary dark:text-primary-dark inline-flex items-center hover:text-link duration-100 ease-in transition mx-1 ms-2 md:ms-1"><svg width="1em" height="1em" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="inline mx-1 relative top-[1px]"><path d="M20.5001 2H15.5001C15.3675 2 15.2403 2.05268 15.1465 2.14645C15.0528 2.24021 15.0001 2.36739 15.0001 2.5V3.5C15.0001 3.63261 15.0528 3.75979 15.1465 3.85355C15.2403 3.94732 15.3675 4 15.5001 4H18.5901L7.6501 14.94C7.60323 14.9865 7.56604 15.0418 7.54065 15.1027C7.51527 15.1636 7.5022 15.229 7.5022 15.295C7.5022 15.361 7.51527 15.4264 7.54065 15.4873C7.56604 15.5482 7.60323 15.6035 7.6501 15.65L8.3501 16.35C8.39658 16.3969 8.45188 16.4341 8.51281 16.4594C8.57374 16.4848 8.63909 16.4979 8.7051 16.4979C8.7711 16.4979 8.83646 16.4848 8.89738 16.4594C8.95831 16.4341 9.01362 16.3969 9.0601 16.35L20.0001 5.41V8.5C20.0001 8.63261 20.0528 8.75979 20.1465 8.85355C20.2403 8.94732 20.3675 9 20.5001 9H21.5001C21.6327 9 21.7599 8.94732 21.8537 8.85355C21.9474 8.75979 22.0001 8.63261 22.0001 8.5V3.5C22.0001 3.10218 21.8421 2.72064 21.5608 2.43934C21.2795 2.15804 20.8979 2 20.5001 2V2Z" fill="currentColor"></path><path d="M21.5 13H20.5C20.3674 13 20.2402 13.0527 20.1464 13.1464C20.0527 13.2402 20 13.3674 20 13.5V20H4V4H10.5C10.6326 4 10.7598 3.94732 10.8536 3.85355C10.9473 3.75979 11 3.63261 11 3.5V2.5C11 2.36739 10.9473 2.24021 10.8536 2.14645C10.7598 2.05268 10.6326 2 10.5 2H3.5C3.10218 2 2.72064 2.15804 2.43934 2.43934C2.15804 2.72064 2 3.10218 2 3.5V20.5C2 20.8978 2.15804 21.2794 2.43934 21.5607C2.72064 21.842 3.10218 22 3.5 22H20.5C20.8978 22 21.2794 21.842 21.5607 21.5607C21.842 21.2794 22 20.8978 22 20.5V13.5C22 13.3674 21.9473 13.2402 21.8536 13.1464C21.7598 13.0527 21.6326 13 21.5 13Z" fill="currentColor"></path></svg><span class="hidden md:block">Fork</span></a></div></div><div class=" sp-layout"><div class=" sp-editor sp-stack"><div class=" sp-code-editor"><div aria-autocomplete="list" aria-label="Code Editor for MyInput.js" aria-multiline="true" class="sp-pristine sp-javascript   sp-cm" role="textbox" tabindex="0" translate="no"><pre class=" sp-pre-placeholder" style="margin-left:var(--sp-space-11)"><span class="sp-syntax-keyword">import</span> <span class="sp-syntax-punctuation">{</span> <span class="sp-syntax-plain">useEffect</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">useRef</span> <span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-keyword">from</span> <span class="sp-syntax-string">&#x27;react&#x27;</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-keyword">export</span> <span class="sp-syntax-keyword">default</span> <span class="sp-syntax-keyword">function</span> <span class="sp-syntax-definition">MyInput</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">{</span> <span class="sp-syntax-property">value</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-property">onChange</span> <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">ref</span> = <span class="sp-syntax-definition">useRef</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-keyword">null</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>

  <span class="sp-syntax-comment">// TODO：下面的这种做法不会生效，请修复。</span>
  <span class="sp-syntax-comment">// ref.current.focus()    </span>

  <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-punctuation">(</span>
    <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-tag">input</span>
      <span class="sp-syntax-property">ref</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">ref</span><span class="sp-syntax-punctuation">}</span>
      <span class="sp-syntax-property">value</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">value</span><span class="sp-syntax-punctuation">}</span>
      <span class="sp-syntax-property">onChange</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">onChange</span><span class="sp-syntax-punctuation">}</span>
    <span class="sp-syntax-punctuation">/&gt;</span>
  <span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-punctuation">}</span>

</pre></div></div></div><div class=" order-last xl:order-2 sp-stack"><div class="p-0 sm:p-2 md:p-4 lg:p-8 bg-card dark:bg-wash-dark h-full relative md:rounded-b-lg lg:rounded-b-none"><div style="position:relative"><iframe class="rounded-t-none bg-white md:shadow-md sm:rounded-lg w-full max-w-full transition-opacity absolute opacity-0 pointer-events-none duration-75" title="Sandbox Preview" style="height:15px;z-index:-1"></iframe></div></div></div><button translate="yes" class="sandpack-expand flex text-base justify-between dark:border-card-dark bg-wash dark:bg-card-dark items-center z-10 p-1 w-full order-2 xl:order-last border-b-1 relative top-0"><span class="flex p-2 focus:outline-none text-primary dark:text-primary-dark leading-[20px]"><svg class="rotate-0 inline me-1.5 text-xl" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><g fill="none" fill-rule="evenodd" transform="translate(-446 -398)"><path fill="currentColor" fill-rule="nonzero" d="M95.8838835,240.366117 C95.3957281,239.877961 94.6042719,239.877961 94.1161165,240.366117 C93.6279612,240.854272 93.6279612,241.645728 94.1161165,242.133883 L98.6161165,246.633883 C99.1042719,247.122039 99.8957281,247.122039 100.383883,246.633883 L104.883883,242.133883 C105.372039,241.645728 105.372039,240.854272 104.883883,240.366117 C104.395728,239.877961 103.604272,239.877961 103.116117,240.366117 L99.5,243.982233 L95.8838835,240.366117 Z" transform="translate(356.5 164.5)"></path><polygon points="446 418 466 418 466 398 446 398"></polygon></g></svg>显示更多</span></button></div></div></div></div><!--/$--><p class="whitespace-pre-wrap my-4">要验证你的方法是否奏效，请点击“展示表单”，并确认输入框获得焦点（高亮显示并且光标位于内部）；再次点击“隐藏表单”和“展示表单”，确认输入框是否再次被高亮显示。</p><p class="whitespace-pre-wrap my-4"><code dir="ltr" class="inline text-code text-secondary dark:text-secondary-dark px-1 rounded-md no-underline bg-gray-30 bg-opacity-10 py-px">MyInput</code> 组件应该只在 <strong class="font-bold">挂载</strong> 时获得焦点，而非每次渲染后。为了验证这一行为是否正确，点击“展示表单”，然后反复点击“大写”的复选框。点击复选框时，上方的输入框不应该获得焦点。</p></div><div class="flex justify-between items-center mt-4"><button class="me-2 text-base leading-tight font-bold rounded-full py-2 px-4 focus:outline focus:outline-offset-2 focus:outline-link dark:focus:outline-link-dark inline-flex items-center my-1 bg-transparent text-primary dark:text-primary-dark active:text-primary shadow-secondary-button-stroke dark:shadow-secondary-button-stroke-dark hover:bg-gray-40/5 active:bg-gray-40/10  hover:dark:bg-gray-60/5 active:dark:bg-gray-60/10"><svg class="inline me-1.5" width="0.75em" height="0.75em" viewBox="0 0 13 13" xmlns="http://www.w3.org/2000/svg"><path d="M2.21908 8.74479V12.7448H0.885742V0.078125H7.14041C7.26418 0.0781911 7.3855 0.112714 7.49076 0.177827C7.59602 0.242939 7.68108 0.336071 7.73641 0.446792L8.21908 1.41146H12.2191C12.3959 1.41146 12.5655 1.4817 12.6905 1.60672C12.8155 1.73174 12.8857 1.90131 12.8857 2.07812V9.41146C12.8857 9.58827 12.8155 9.75784 12.6905 9.88286C12.5655 10.0079 12.3959 10.0781 12.2191 10.0781H7.96441C7.84063 10.0781 7.71932 10.0435 7.61406 9.97842C7.50879 9.91331 7.42374 9.82018 7.36841 9.70946L6.88574 8.74479H2.21908ZM2.21908 1.41146V7.41146H7.70974L8.37641 8.74479H11.5524V2.74479H7.39508L6.72841 1.41146H2.21908Z" fill="currentColor"></path></svg> <!-- -->展示答案</button><button class="bg-link dark:bg-link-dark text-base leading-tight font-bold rounded-full py-2 px-4 focus:outline focus:outline-offset-2 focus:outline-link dark:focus:outline-link-dark inline-flex items-center my-1 bg-link border-link text-white hover:bg-link focus:bg-link active:bg-link">下一个<!-- -->挑战<svg width="1em" height="1em" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" class="block ms-1.5"><path d="M6.86612 13.6161C6.37796 14.1043 6.37796 14.8957 6.86612 15.3839C7.35427 15.872 8.14572 15.872 8.63388 15.3839L13.1339 10.8839C13.622 10.3957 13.622 9.60428 13.1339 9.11612L8.63388 4.61612C8.14572 4.12797 7.35427 4.12797 6.86612 4.61612C6.37796 5.10428 6.37796 5.89573 6.86612 6.38388L10.4822 10L6.86612 13.6161Z" fill="currentColor"></path></svg></button></div></div></div></div></div><div class="grid grid-cols-1 gap-4 py-4 mx-auto max-w-7xl md:grid-cols-2 md:py-12"><a class="flex gap-x-4 md:gap-x-6 items-center w-full md:min-w-80 md:w-fit md:max-w-md px-4 md:px-5 py-6 border-2 border-transparent text-base leading-base text-link dark:text-link-dark rounded-lg group focus:text-link dark:focus:text-link-dark focus:bg-highlight focus:border-link dark:focus:bg-highlight-dark dark:focus:border-link-dark focus:border-opacity-100 focus:border-2 focus:ring-1 focus:ring-offset-4 focus:ring-blue-40 active:ring-0 active:ring-offset-0 hover:bg-gray-5 dark:hover:bg-gray-80" href="/learn/manipulating-the-dom-with-refs"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" class="duration-100 ease-in transition rotate-90 rtl:-rotate-90 inline text-tertiary dark:text-tertiary-dark group-focus:text-link dark:group-focus:text-link-dark" style="min-width:20px;min-height:20px"><g fill="none" fill-rule="evenodd" transform="translate(-446 -398)"><path fill="currentColor" fill-rule="nonzero" d="M95.8838835,240.366117 C95.3957281,239.877961 94.6042719,239.877961 94.1161165,240.366117 C93.6279612,240.854272 93.6279612,241.645728 94.1161165,242.133883 L98.6161165,246.633883 C99.1042719,247.122039 99.8957281,247.122039 100.383883,246.633883 L104.883883,242.133883 C105.372039,241.645728 105.372039,240.854272 104.883883,240.366117 C104.395728,239.877961 103.604272,239.877961 103.116117,240.366117 L99.5,243.982233 L95.8838835,240.366117 Z" transform="translate(356.5 164.5)"></path><polygon points="446 418 466 418 466 398 446 398"></polygon></g></svg><div class="flex flex-col overflow-hidden"><span class="text-sm font-bold tracking-wide no-underline uppercase text-secondary dark:text-secondary-dark group-focus:text-link dark:group-focus:text-link-dark group-focus:text-opacity-100">上一页</span><span class="text-lg break-words group-hover:underline">使用 ref 操作 DOM</span></div></a><a class="flex gap-x-4 md:gap-x-6 items-center w-full md:min-w-80 md:w-fit md:max-w-md px-4 md:px-5 py-6 border-2 border-transparent text-base leading-base text-link dark:text-link-dark rounded-lg group focus:text-link dark:focus:text-link-dark focus:bg-highlight focus:border-link dark:focus:bg-highlight-dark dark:focus:border-link-dark focus:border-opacity-100 focus:border-2 focus:ring-1 focus:ring-offset-4 focus:ring-blue-40 active:ring-0 active:ring-offset-0 hover:bg-gray-5 dark:hover:bg-gray-80 flex-row-reverse justify-self-end text-end" href="/learn/you-might-not-need-an-effect"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" class="duration-100 ease-in transition -rotate-90 rtl:rotate-90 inline text-tertiary dark:text-tertiary-dark group-focus:text-link dark:group-focus:text-link-dark" style="min-width:20px;min-height:20px"><g fill="none" fill-rule="evenodd" transform="translate(-446 -398)"><path fill="currentColor" fill-rule="nonzero" d="M95.8838835,240.366117 C95.3957281,239.877961 94.6042719,239.877961 94.1161165,240.366117 C93.6279612,240.854272 93.6279612,241.645728 94.1161165,242.133883 L98.6161165,246.633883 C99.1042719,247.122039 99.8957281,247.122039 100.383883,246.633883 L104.883883,242.133883 C105.372039,241.645728 105.372039,240.854272 104.883883,240.366117 C104.395728,239.877961 103.604272,239.877961 103.116117,240.366117 L99.5,243.982233 L95.8838835,240.366117 Z" transform="translate(356.5 164.5)"></path><polygon points="446 418 466 418 466 398 446 398"></polygon></g></svg><div class="flex flex-col overflow-hidden"><span class="text-sm font-bold tracking-wide no-underline uppercase text-secondary dark:text-secondary-dark group-focus:text-link dark:group-focus:text-link-dark group-focus:text-opacity-100">下一页</span><span class="text-lg break-words group-hover:underline">你可能不需要 Effect</span></div></a></div></div></div></article><div class="self-stretch w-full"><div class="w-full px-5 pt-10 mx-auto sm:px-12 md:px-12 md:pt-12 lg:pt-10"><hr class="mx-auto max-w-7xl border-border dark:border-border-dark"/></div><div class="py-12 px-5 sm:px-12 md:px-12 sm:py-12 md:py-16 lg:py-14"></div></div></main><!--/$--><div class="hidden -mt-16 lg:max-w-custom-xs 2xl:block"><nav role="navigation" class="pt-20 sticky top-0 end-0"><h2 class="mb-3 lg:mb-3 uppercase tracking-wide font-bold text-sm text-secondary dark:text-secondary-dark px-4 w-full">目录</h2><div class="h-full overflow-y-auto ps-4 max-h-[calc(100vh-7.5rem)]" style="overscroll-behavior:contain"><ul class="space-y-2 pb-16"><li class="text-sm px-2 rounded-s-xl bg-highlight dark:bg-highlight-dark"><a class="text-link dark:text-link-dark font-bold block hover:text-link dark:hover:text-link-dark leading-normal py-2" href="#">概览</a></li><li class="text-sm px-2 rounded-s-xl"><a class="text-secondary dark:text-secondary-dark block hover:text-link dark:hover:text-link-dark leading-normal py-2" href="#what-are-effects-and-how-are-they-different-from-events">什么是 Effect，它与事件（event）有何不同？ </a></li><li class="text-sm px-2 rounded-s-xl"><a class="text-secondary dark:text-secondary-dark block hover:text-link dark:hover:text-link-dark leading-normal py-2" href="#you-might-not-need-an-effect">你可能不需要 Effect </a></li><li class="text-sm px-2 rounded-s-xl"><a class="text-secondary dark:text-secondary-dark block hover:text-link dark:hover:text-link-dark leading-normal py-2" href="#how-to-write-an-effect">如何编写 Effect </a></li><li class="text-sm px-2 rounded-s-xl ps-4"><a class="text-secondary dark:text-secondary-dark block hover:text-link dark:hover:text-link-dark leading-normal py-2" href="#step-1-declare-an-effect">第一步：声明 Effect </a></li><li class="text-sm px-2 rounded-s-xl ps-4"><a class="text-secondary dark:text-secondary-dark block hover:text-link dark:hover:text-link-dark leading-normal py-2" href="#step-2-specify-the-effect-dependencies">第二步：指定 Effect 的依赖项 </a></li><li class="text-sm px-2 rounded-s-xl ps-4"><a class="text-secondary dark:text-secondary-dark block hover:text-link dark:hover:text-link-dark leading-normal py-2" href="#step-3-add-cleanup-if-needed">第三步：按需添加清理（cleanup）函数 </a></li><li class="text-sm px-2 rounded-s-xl"><a class="text-secondary dark:text-secondary-dark block hover:text-link dark:hover:text-link-dark leading-normal py-2" href="#how-to-handle-the-effect-firing-twice-in-development">如何处理在开发环境下 Effect 运行了两次？ </a></li><li class="text-sm px-2 rounded-s-xl ps-4"><a class="text-secondary dark:text-secondary-dark block hover:text-link dark:hover:text-link-dark leading-normal py-2" href="#controlling-non-react-widgets">管理非 React 小部件 </a></li><li class="text-sm px-2 rounded-s-xl ps-4"><a class="text-secondary dark:text-secondary-dark block hover:text-link dark:hover:text-link-dark leading-normal py-2" href="#subscribing-to-events">订阅事件 </a></li><li class="text-sm px-2 rounded-s-xl ps-4"><a class="text-secondary dark:text-secondary-dark block hover:text-link dark:hover:text-link-dark leading-normal py-2" href="#triggering-animations">触发动画 </a></li><li class="text-sm px-2 rounded-s-xl ps-4"><a class="text-secondary dark:text-secondary-dark block hover:text-link dark:hover:text-link-dark leading-normal py-2" href="#fetching-data">获取数据 </a></li><li class="text-sm px-2 rounded-s-xl ps-4"><a class="text-secondary dark:text-secondary-dark block hover:text-link dark:hover:text-link-dark leading-normal py-2" href="#sending-analytics">发送分析报告 </a></li><li class="text-sm px-2 rounded-s-xl ps-4"><a class="text-secondary dark:text-secondary-dark block hover:text-link dark:hover:text-link-dark leading-normal py-2" href="#not-an-effect-initializing-the-application">不适用于 Effect：初始化应用 </a></li><li class="text-sm px-2 rounded-s-xl ps-4"><a class="text-secondary dark:text-secondary-dark block hover:text-link dark:hover:text-link-dark leading-normal py-2" href="#not-an-effect-buying-a-product">不适用于 Effect：购买商品 </a></li><li class="text-sm px-2 rounded-s-xl"><a class="text-secondary dark:text-secondary-dark block hover:text-link dark:hover:text-link-dark leading-normal py-2" href="#putting-it-all-together">综合以上内容 </a></li><li class="text-sm px-2 rounded-s-xl"><a class="text-secondary dark:text-secondary-dark block hover:text-link dark:hover:text-link-dark leading-normal py-2" href="#recap">Recap</a></li><li class="text-sm px-2 rounded-s-xl"><a class="text-secondary dark:text-secondary-dark block hover:text-link dark:hover:text-link-dark leading-normal py-2" href="#challenges">Challenges</a></li></ul></div></nav></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"toc":"[{\"url\":\"#\",\"text\":\"概览\",\"depth\":2},{\"url\":\"#what-are-effects-and-how-are-they-different-from-events\",\"depth\":2,\"text\":\"什么是 Effect，它与事件（event）有何不同？ \"},{\"url\":\"#you-might-not-need-an-effect\",\"depth\":2,\"text\":\"你可能不需要 Effect \"},{\"url\":\"#how-to-write-an-effect\",\"depth\":2,\"text\":\"如何编写 Effect \"},{\"url\":\"#step-1-declare-an-effect\",\"depth\":3,\"text\":\"第一步：声明 Effect \"},{\"url\":\"#step-2-specify-the-effect-dependencies\",\"depth\":3,\"text\":\"第二步：指定 Effect 的依赖项 \"},{\"url\":\"#step-3-add-cleanup-if-needed\",\"depth\":3,\"text\":\"第三步：按需添加清理（cleanup）函数 \"},{\"url\":\"#how-to-handle-the-effect-firing-twice-in-development\",\"depth\":2,\"text\":\"如何处理在开发环境下 Effect 运行了两次？ \"},{\"url\":\"#controlling-non-react-widgets\",\"depth\":3,\"text\":\"管理非 React 小部件 \"},{\"url\":\"#subscribing-to-events\",\"depth\":3,\"text\":\"订阅事件 \"},{\"url\":\"#triggering-animations\",\"depth\":3,\"text\":\"触发动画 \"},{\"url\":\"#fetching-data\",\"depth\":3,\"text\":\"获取数据 \"},{\"url\":\"#sending-analytics\",\"depth\":3,\"text\":\"发送分析报告 \"},{\"url\":\"#not-an-effect-initializing-the-application\",\"depth\":3,\"text\":\"不适用于 Effect：初始化应用 \"},{\"url\":\"#not-an-effect-buying-a-product\",\"depth\":3,\"text\":\"不适用于 Effect：购买商品 \"},{\"url\":\"#putting-it-all-together\",\"depth\":2,\"text\":\"综合以上内容 \"},{\"url\":\"#recap\",\"depth\":2,\"text\":\"Recap\"},{\"url\":\"#challenges\",\"depth\":2,\"text\":\"Challenges\"}]","content":"[[\"$r\",\"MaxWidth\",\"54\",{\"children\":[[\"$r\",\"Intro\",null,{\"children\":[\"$r\",\"p\",null,{\"children\":\"有些组件需要与外部系统同步。例如，你可能希望根据 React state 控制非 React 组件、建立服务器连接或当组件在页面显示时发送分析日志。Effect 允许你在渲染结束后执行一些代码，以便将组件与 React 外部的某个系统相同步。\"}]}],\"\\n\",[\"$r\",\"YouWillLearn\",null,{\"children\":[\"$r\",\"ul\",null,{\"children\":[\"\\n\",[\"$r\",\"li\",null,{\"children\":\"什么是 Effect\"}],\"\\n\",[\"$r\",\"li\",null,{\"children\":\"Effect 与事件（event）有何不同\"}],\"\\n\",[\"$r\",\"li\",null,{\"children\":\"如何在组件中声明 Effect\"}],\"\\n\",[\"$r\",\"li\",null,{\"children\":\"如何避免不必要地重新运行 Effect\"}],\"\\n\",[\"$r\",\"li\",null,{\"children\":\"为什么 Effect 在开发环境中会运行两次以及如何解决这个问题\"}],\"\\n\"]}]}],\"\\n\",[\"$r\",\"h2\",null,{\"id\":\"what-are-effects-and-how-are-they-different-from-events\",\"children\":\"什么是 Effect，它与事件（event）有何不同？ \"}],\"\\n\",[\"$r\",\"p\",null,{\"children\":\"在接触 Effect 之前，你需要熟悉 React 组件中的两种逻辑类型：\"}],\"\\n\",[\"$r\",\"ul\",null,{\"children\":[\"\\n\",[\"$r\",\"li\",null,{\"children\":[\"\\n\",[\"$r\",\"p\",null,{\"children\":[[\"$r\",\"strong\",null,{\"children\":\"渲染代码\"}],\"（在 \",[\"$r\",\"a\",null,{\"href\":\"/learn/describing-the-ui\",\"children\":\"描述 UI\"}],\" 中有介绍）位于组件的顶层。你在这里处理 props 和 state，对它们进行转换，并返回希望在页面上显示的 JSX。\",[\"$r\",\"a\",null,{\"href\":\"/learn/keeping-components-pure\",\"children\":\"渲染代码必须是纯粹的\"}],\"——就像数学公式一样，它只应该“计算”结果，而不做其他任何事情。\"]}],\"\\n\"]}],\"\\n\",[\"$r\",\"li\",null,{\"children\":[\"\\n\",[\"$r\",\"p\",null,{\"children\":[[\"$r\",\"strong\",null,{\"children\":\"事件处理程序\"}],\"（在 \",[\"$r\",\"a\",null,{\"href\":\"/learn/adding-interactivity\",\"children\":\"添加交互性\"}],\" 中有介绍）是组件内部的嵌套函数，它们不光进行计算, 还会执行一些操作。事件处理程序可能会更新输入字段、提交 HTTP POST 请求来购买产品，或者将用户导航到另一个页面。事件处理程序包含由特定用户操作（例如按钮点击或输入）引起的“副作用”（它们改变了程序的状态）。\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"有时这还不够。考虑一个 \",[\"$r\",\"code\",null,{\"children\":\"ChatRoom\"}],\" 组件，它在页面上显示时必须连接到聊天服务器。连接到服务器并不是纯粹的计算（它是一个副作用），因此它不能在渲染期间发生。然而，并没有一个特定的事件（比如点击）能让 \",[\"$r\",\"code\",null,{\"children\":\"ChatRoom\"}],\" 被显示。\"]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[[\"$r\",\"strong\",null,{\"children\":\"Effect 允许你指定由渲染自身，而不是特定事件引起的副作用\"}],\"。在聊天中发送消息是一个“事件”，因为它直接由用户点击特定按钮引起。然而，建立服务器连接是一个 Effect，因为无论哪种交互致使组件出现，它都应该发生。Effect 在 \",[\"$r\",\"a\",null,{\"href\":\"/learn/render-and-commit\",\"children\":\"提交\"}],\" 结束后、页面更新后运行。此时是将 React 组件与外部系统（如网络或第三方库）同步的最佳时机。\"]}],\"\\n\",[\"$r\",\"Note\",null,{\"children\":[\"$r\",\"p\",null,{\"children\":[\"在本文此处和后续文本中，大写的 \",[\"$r\",\"code\",null,{\"children\":\"Effect\"}],\" 是 React 中的专有定义——由渲染引起的副作用。至于更广泛的编程概念(任何改变程序状态或外部系统的行为)，我们则使用“副作用（side effect）” 来指代。\"]}]}],\"\\n\",[\"$r\",\"h2\",null,{\"id\":\"you-might-not-need-an-effect\",\"children\":\"你可能不需要 Effect \"}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[[\"$r\",\"strong\",null,{\"children\":\"不要急着在你的组件中使用 Effect\"}],\"。记住，Effect 通常用于暂时“跳出” React 并与一些 \",[\"$r\",\"strong\",null,{\"children\":\"外部\"}],\" 系统进行同步。这包括浏览器 API、第三方小部件，以及网络等等。如果你的 Effect 只是根据其他状态来调整某些状态，那么 \",[\"$r\",\"a\",null,{\"href\":\"/learn/you-might-not-need-an-effect\",\"children\":\"你可能并不需要一个 Effect\"}],\"。\"]}],\"\\n\",[\"$r\",\"h2\",null,{\"id\":\"how-to-write-an-effect\",\"children\":\"如何编写 Effect \"}],\"\\n\",[\"$r\",\"p\",null,{\"children\":\"要编写一个 Effect, 请遵循以下三个步骤：\"}],\"\\n\",[\"$r\",\"ol\",null,{\"children\":[\"\\n\",[\"$r\",\"li\",null,{\"children\":[[\"$r\",\"strong\",null,{\"children\":\"声明 Effect\"}],\"。通常 Effect 会在每次 \",[\"$r\",\"a\",null,{\"href\":\"/learn/render-and-commit\",\"children\":\"提交\"}],\" 后运行。\"]}],\"\\n\",[\"$r\",\"li\",null,{\"children\":[[\"$r\",\"strong\",null,{\"children\":\"指定 Effect 依赖\"}],\"。大多数 Effect 应该按需运行，而不是在每次渲染后都运行。例如，淡入动画应该只在组件出现时触发。连接和断开服务器的操作只应在组件出现和消失时，或者切换聊天室时执行。你将通过指定 \",[\"$r\",\"strong\",null,{\"children\":\"依赖项\"}],\" 来学习如何控制这一点。\"]}],\"\\n\",[\"$r\",\"li\",null,{\"children\":[[\"$r\",\"strong\",null,{\"children\":\"必要时添加清理操作\"}],\"。一些 Effect 需要指定如何停止、撤销，或者清除它们所执行的操作。例如，“连接”需要“断开”，“订阅”需要“退订”，而“获取数据”需要“取消”或者“忽略”。你将学习如何通过返回一个 \",[\"$r\",\"strong\",null,{\"children\":\"清理函数\"}],\" 来实现这些。\"]}],\"\\n\"]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":\"让我们详细看看每一步。\"}],\"\\n\",[\"$r\",\"h3\",null,{\"id\":\"step-1-declare-an-effect\",\"children\":\"第一步：声明 Effect \"}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"先从 React 中导入 \",[\"$r\",\"a\",null,{\"href\":\"/reference/react/useEffect\",\"children\":[[\"$r\",\"code\",null,{\"children\":\"useEffect\"}],\" Hook\"]}],\"：\"]}],\"\\n\",[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"children\":\"import { useEffect } from 'react';\\n\"}]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":\"再在组件顶部调用, 并在其中加入一些代码：\"}],\"\\n\",[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"meta\":\"{2-4}\",\"children\":\"function MyComponent() {\\r\\n  useEffect(() =\u003e {\\r\\n    // 每次渲染后都会执行此处的代码\\r\\n  });\\r\\n  return \u003cdiv /\u003e;\\r\\n}\\n\"}]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"每当你的组件渲染时，React 会先更新页面，然后再运行 \",[\"$r\",\"code\",null,{\"children\":\"useEffect\"}],\" 中的代码。换句话说，\",[\"$r\",\"strong\",null,{\"children\":[[\"$r\",\"code\",null,{\"children\":\"useEffect\"}],\" 会“延迟”一段代码的运行，直到渲染结果反映在页面上\"]}],\"。\"]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"接下来，让我们看看如何使用 Effect 来与外部系统同步。考虑一个 \",[\"$r\",\"code\",null,{\"children\":\"\u003cVideoPlayer\u003e\"}],\" React 组件。我们想要通过传递一个 \",[\"$r\",\"code\",null,{\"children\":\"isPlaying\"}],\" prop 来控制它播放或者暂停：\"]}],\"\\n\",[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"children\":\"\u003cVideoPlayer isPlaying={isPlaying} /\u003e;\\n\"}]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"这个 \",[\"$r\",\"code\",null,{\"children\":\"VideoPlayer\"}],\" 组件渲染了浏览器内置的 \",[\"$r\",\"a\",null,{\"href\":\"https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/video\",\"target\":\"_blank\",\"rel\":\"nofollow noopener noreferrer\",\"children\":[\"$r\",\"code\",null,{\"children\":\"\u003cvideo\u003e\"}]}],\" 标签：\"]}],\"\\n\",[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"children\":\"function VideoPlayer({ src, isPlaying }) {\\r\\n  // TODO：使用 isPlaying 做一些事情\\r\\n  return \u003cvideo src={src} /\u003e;\\r\\n}\\n\"}]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"但是，浏览器的 \",[\"$r\",\"code\",null,{\"children\":\"\u003cvideo\u003e\"}],\" 标签没有 \",[\"$r\",\"code\",null,{\"children\":\"isPlaying\"}],\" 属性。控制它的唯一方式是在 DOM 元素上调用 \",[\"$r\",\"a\",null,{\"href\":\"https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLMediaElement/play\",\"target\":\"_blank\",\"rel\":\"nofollow noopener noreferrer\",\"children\":[\"$r\",\"code\",null,{\"children\":\"play()\"}]}],\" 和 \",[\"$r\",\"a\",null,{\"href\":\"https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLMediaElement/pause\",\"target\":\"_blank\",\"rel\":\"nofollow noopener noreferrer\",\"children\":[\"$r\",\"code\",null,{\"children\":\"pause()\"}]}],\" 方法。因此，\",[\"$r\",\"strong\",null,{\"children\":[\"你需要将 \",[\"$r\",\"code\",null,{\"children\":\"isPlaying\"}],\" prop 的值（表示视频当前是否应该播放）与 \",[\"$r\",\"code\",null,{\"children\":\"play()\"}],\" 和 \",[\"$r\",\"code\",null,{\"children\":\"pause()\"}],\" 等函数的调用进行同步\"]}],\"。\"]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"我们首先需要获取 \",[\"$r\",\"code\",null,{\"children\":\"\u003cvideo\u003e\"}],\" DOM 节点的 \",[\"$r\",\"a\",null,{\"href\":\"/learn/manipulating-the-dom-with-refs\",\"children\":\"对象引用\"}],\"。\"]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"你可能会尝试在渲染期间调用 \",[\"$r\",\"code\",null,{\"children\":\"play()\"}],\" 或 \",[\"$r\",\"code\",null,{\"children\":\"pause()\"}],\"，但这样做是不对的：\"]}],\"\\n\"]}],[\"$r\",\"Sandpack\",null,{\"children\":[[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"children\":\"import { useState, useRef, useEffect } from 'react';\\r\\n\\r\\nfunction VideoPlayer({ src, isPlaying }) {\\r\\n  const ref = useRef(null);\\r\\n\\r\\n  if (isPlaying) {\\r\\n    ref.current.play();  // 渲染期间不能调用 `play()`。 \\r\\n  } else {\\r\\n    ref.current.pause(); // 同样，调用 `pause()` 也不行。\\r\\n  }\\r\\n\\r\\n  return \u003cvideo ref={ref} src={src} loop playsInline /\u003e;\\r\\n}\\r\\n\\r\\nexport default function App() {\\r\\n  const [isPlaying, setIsPlaying] = useState(false);\\r\\n  return (\\r\\n    \u003c\u003e\\r\\n      \u003cbutton onClick={() =\u003e setIsPlaying(!isPlaying)}\u003e\\r\\n        {isPlaying ? '暂停' : '播放'}\\r\\n      \u003c/button\u003e\\r\\n      \u003cVideoPlayer\\r\\n        isPlaying={isPlaying}\\r\\n        src=\\\"https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4\\\"\\r\\n      /\u003e\\r\\n    \u003c/\u003e\\r\\n  );\\r\\n}\\n\"}]}],[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-css\",\"children\":\"button { display: block; margin-bottom: 20px; }\\r\\nvideo { width: 250px; }\\n\"}]}]]}],[\"$r\",\"MaxWidth\",\"70\",{\"children\":[\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"这段代码之所以不对，是因为它试图在渲染期间对 DOM 节点进行操作。在 React 中，\",[\"$r\",\"a\",null,{\"href\":\"/learn/keeping-components-pure\",\"children\":\"渲染应该是纯粹的计算\"}],\" JSX，不应该包含任何像修改 DOM 这样的副作用。\"]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"而且，当第一次调用 \",[\"$r\",\"code\",null,{\"children\":\"VideoPlayer\"}],\" 时，对应的 DOM 节点还不存在！因为 React 在你返回 JSX 之前不知道要创建什么样的 DOM，所以没有 DOM 节点可以调用 \",[\"$r\",\"code\",null,{\"children\":\"play()\"}],\" 或 \",[\"$r\",\"code\",null,{\"children\":\"pause()\"}],\" 方法。\"]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"解决办法是 \",[\"$r\",\"strong\",null,{\"children\":[\"使用 \",[\"$r\",\"code\",null,{\"children\":\"useEffect\"}],\" 包裹副作用，把它分离到渲染逻辑的计算过程之外\"]}],\"：\"]}],\"\\n\",[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"meta\":\"{6,12}\",\"children\":\"import { useEffect, useRef } from 'react';\\r\\n\\r\\nfunction VideoPlayer({ src, isPlaying }) {\\r\\n  const ref = useRef(null);\\r\\n\\r\\n  useEffect(() =\u003e {\\r\\n    if (isPlaying) {\\r\\n      ref.current.play();\\r\\n    } else {\\r\\n      ref.current.pause();\\r\\n    }\\r\\n  });\\r\\n\\r\\n  return \u003cvideo ref={ref} src={src} loop playsInline /\u003e;\\r\\n}\\n\"}]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":\"通过将 DOM 更新封装在 Effect 中，你可以让 React 先更新页面，然后再运行 Effect。\"}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"当 \",[\"$r\",\"code\",null,{\"children\":\"VideoPlayer\"}],\" 组件渲染时（无论是否为首次渲染），会发生以下几件事：首先 React 会更新页面，确保 \",[\"$r\",\"code\",null,{\"children\":\"\u003cvideo\u003e\"}],\" 标签带着正确的 props 出现在 DOM 中；接着 React 将运行 Effect；最后 Effect 将根据 \",[\"$r\",\"code\",null,{\"children\":\"isPlaying\"}],\" 的值调用 \",[\"$r\",\"code\",null,{\"children\":\"play()\"}],\" 或 \",[\"$r\",\"code\",null,{\"children\":\"pause()\"}],\"。\"]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"试试点击几次播放和暂停按钮，观察视频播放器的行为是如何与 \",[\"$r\",\"code\",null,{\"children\":\"isPlaying\"}],\" 的值相同步的：\"]}],\"\\n\"]}],[\"$r\",\"Sandpack\",null,{\"children\":[[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"children\":\"import { useState, useRef, useEffect } from 'react';\\r\\n\\r\\nfunction VideoPlayer({ src, isPlaying }) {\\r\\n  const ref = useRef(null);\\r\\n\\r\\n  useEffect(() =\u003e {\\r\\n    if (isPlaying) {\\r\\n      ref.current.play();\\r\\n    } else {\\r\\n      ref.current.pause();\\r\\n    }\\r\\n  });\\r\\n\\r\\n  return \u003cvideo ref={ref} src={src} loop playsInline /\u003e;\\r\\n}\\r\\n\\r\\nexport default function App() {\\r\\n  const [isPlaying, setIsPlaying] = useState(false);\\r\\n  return (\\r\\n    \u003c\u003e\\r\\n      \u003cbutton onClick={() =\u003e setIsPlaying(!isPlaying)}\u003e\\r\\n        {isPlaying ? '暂停' : '播放'}\\r\\n      \u003c/button\u003e\\r\\n      \u003cVideoPlayer\\r\\n        isPlaying={isPlaying}\\r\\n        src=\\\"https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4\\\"\\r\\n      /\u003e\\r\\n    \u003c/\u003e\\r\\n  );\\r\\n}\\n\"}]}],[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-css\",\"children\":\"button { display: block; margin-bottom: 20px; }\\r\\nvideo { width: 250px; }\\n\"}]}]]}],[\"$r\",\"MaxWidth\",\"86\",{\"children\":[\"\\n\",[\"$r\",\"p\",null,{\"children\":\"在这个示例中，你同步到 React state 的“外部系统”是浏览器媒体 API。你也可以使用类似的方法将传统的非 React 代码（如 jQuery 插件）封装成声明式的 React 组件。\"}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"需要注意的是，控制视频播放器在实际应用中要复杂得多：比如调用 \",[\"$r\",\"code\",null,{\"children\":\"play()\"}],\" 可能会失败、用户可能会使用内置的浏览器控件来进行播放或暂停等操作。本例子是一个非常简化且不完整的示例。\"]}],\"\\n\",[\"$r\",\"Pitfall\",null,{\"children\":[[\"$r\",\"p\",null,{\"children\":[\"默认情况下，Effect 会在 \",[\"$r\",\"strong\",null,{\"children\":\"每次\"}],\" 渲染后运行。\",[\"$r\",\"strong\",null,{\"children\":\"正因如此，以下代码会陷入死循环\"}],\"：\"]}],[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"children\":\"const [count, setCount] = useState(0);\\r\\nuseEffect(() =\u003e {\\r\\n  setCount(count + 1);\\r\\n});\\n\"}]}],[\"$r\",\"p\",null,{\"children\":\"Effect 在渲染结束后运行。更新 state 会触发重新渲染。在 Effect 中直接更新 state 就像是把电源插座的插头插回自身：Effect 运行、更新 state、触发重新渲染、于是又触发 Effect 运行、再次更新 state，继而再次触发重新渲染。如此反复，从而陷入死循环。\"}],[\"$r\",\"p\",null,{\"children\":[\"Effect 应该用于将你的组件与一个 \",[\"$r\",\"strong\",null,{\"children\":\"外部\"}],\" 的系统保持同步。如果没有外部系统，你只是想根据其他状态调整一些状态，那么 \",[\"$r\",\"a\",null,{\"href\":\"/learn/you-might-not-need-an-effect\",\"children\":\"你也许不需要 Effect\"}],\"。\"]}]]}],\"\\n\",[\"$r\",\"h3\",null,{\"id\":\"step-2-specify-the-effect-dependencies\",\"children\":\"第二步：指定 Effect 的依赖项 \"}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"默认情况下，Effect 会在 \",[\"$r\",\"strong\",null,{\"children\":\"每次\"}],\" 渲染后运行。但往往 \",[\"$r\",\"strong\",null,{\"children\":\"这并不是你想要的\"}],\"：\"]}],\"\\n\",[\"$r\",\"ul\",null,{\"children\":[\"\\n\",[\"$r\",\"li\",null,{\"children\":\"有时，它可能会很慢。与外部系统的同步并不总是即时的，所以你可能希望在不必要时跳过它。例如，你不会想在每次打字时都得重新连接聊天服务器。\"}],\"\\n\",[\"$r\",\"li\",null,{\"children\":\"有时，它可能会出错。例如，你不会想在每次按键时都触发组件的淡入动画。动画应该只在组件首次出现时播放。\"}],\"\\n\"]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"为了演示这个问题，以下是在之前的示例中加入了一些 \",[\"$r\",\"code\",null,{\"children\":\"console.log\"}],\" 调用和一个更新父组件 state 的文本输入框。注意在输入时是如何触发 Effect 重新运行的：\"]}],\"\\n\"]}],[\"$r\",\"Sandpack\",null,{\"children\":[[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"children\":\"import { useState, useRef, useEffect } from 'react';\\r\\n\\r\\nfunction VideoPlayer({ src, isPlaying }) {\\r\\n  const ref = useRef(null);\\r\\n\\r\\n  useEffect(() =\u003e {\\r\\n    if (isPlaying) {\\r\\n      console.log('调用 video.play()');\\r\\n      ref.current.play();\\r\\n    } else {\\r\\n      console.log('调用 video.pause()');\\r\\n      ref.current.pause();\\r\\n    }\\r\\n  });\\r\\n\\r\\n  return \u003cvideo ref={ref} src={src} loop playsInline /\u003e;\\r\\n}\\r\\n\\r\\nexport default function App() {\\r\\n  const [isPlaying, setIsPlaying] = useState(false);\\r\\n  const [text, setText] = useState('');\\r\\n  return (\\r\\n    \u003c\u003e\\r\\n      \u003cinput value={text} onChange={e =\u003e setText(e.target.value)} /\u003e\\r\\n      \u003cbutton onClick={() =\u003e setIsPlaying(!isPlaying)}\u003e\\r\\n        {isPlaying ? '暂停' : '播放'}\\r\\n      \u003c/button\u003e\\r\\n      \u003cVideoPlayer\\r\\n        isPlaying={isPlaying}\\r\\n        src=\\\"https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4\\\"\\r\\n      /\u003e\\r\\n    \u003c/\u003e\\r\\n  );\\r\\n}\\n\"}]}],[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-css\",\"children\":\"input, button { display: block; margin-bottom: 20px; }\\r\\nvideo { width: 250px; }\\n\"}]}]]}],[\"$r\",\"MaxWidth\",\"94\",{\"children\":[\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"通过在调用 \",[\"$r\",\"code\",null,{\"children\":\"useEffect\"}],\" 时指定一个 \",[\"$r\",\"strong\",null,{\"children\":\"依赖数组\"}],\" 作为第二个参数，你可以让 React \",[\"$r\",\"strong\",null,{\"children\":\"跳过不必要地重新运行 Effect\"}],\"。首先，在上面示例的第 14 行中传入一个空数组 \",[\"$r\",\"code\",null,{\"children\":\"[]\"}],\"：\"]}],\"\\n\",[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"meta\":\"{3}\",\"children\":\"  useEffect(() =\u003e {\\r\\n    // ...\\r\\n  }, []);\\n\"}]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"你会看到一个错误提示：\",[\"$r\",\"code\",null,{\"children\":\"React Hook useEffect has a missing dependency: 'isPlaying'\"}],\"：\"]}],\"\\n\"]}],[\"$r\",\"Sandpack\",null,{\"children\":[[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"children\":\"import { useState, useRef, useEffect } from 'react';\\r\\n\\r\\nfunction VideoPlayer({ src, isPlaying }) {\\r\\n  const ref = useRef(null);\\r\\n\\r\\n  useEffect(() =\u003e {\\r\\n    if (isPlaying) {\\r\\n      console.log('调用 video.play()');\\r\\n      ref.current.play();\\r\\n    } else {\\r\\n      console.log('调用 video.pause()');\\r\\n      ref.current.pause();\\r\\n    }\\r\\n  }, []); // 这将产生错误\\r\\n\\r\\n  return \u003cvideo ref={ref} src={src} loop playsInline /\u003e;\\r\\n}\\r\\n\\r\\nexport default function App() {\\r\\n  const [isPlaying, setIsPlaying] = useState(false);\\r\\n  const [text, setText] = useState('');\\r\\n  return (\\r\\n    \u003c\u003e\\r\\n      \u003cinput value={text} onChange={e =\u003e setText(e.target.value)} /\u003e\\r\\n      \u003cbutton onClick={() =\u003e setIsPlaying(!isPlaying)}\u003e\\r\\n        {isPlaying ? '暂停' : '播放'}\\r\\n      \u003c/button\u003e\\r\\n      \u003cVideoPlayer\\r\\n        isPlaying={isPlaying}\\r\\n        src=\\\"https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4\\\"\\r\\n      /\u003e\\r\\n    \u003c/\u003e\\r\\n  );\\r\\n}\\n\"}]}],[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-css\",\"children\":\"input, button { display: block; margin-bottom: 20px; }\\r\\nvideo { width: 250px; }\\n\"}]}]]}],[\"$r\",\"MaxWidth\",\"102\",{\"children\":[\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"原因在于，你的 Effect 内部代码依赖于 \",[\"$r\",\"code\",null,{\"children\":\"isPlaying\"}],\" prop 来决定该做什么，但你并没有显式声明这个依赖关系。为了解决这个问题，将 \",[\"$r\",\"code\",null,{\"children\":\"isPlaying\"}],\" 添加至依赖数组中：\"]}],\"\\n\",[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"meta\":\"{2,7}\",\"children\":\"  useEffect(() =\u003e {\\r\\n    if (isPlaying) { // isPlaying 在此处使用……\\r\\n      // ...\\r\\n    } else {\\r\\n      // ...\\r\\n    }\\r\\n  }, [isPlaying]); // ……所以它必须在此处声明！\\n\"}]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"现在所有的依赖都已经声明，所以没有错误了。指定 \",[\"$r\",\"code\",null,{\"children\":\"[isPlaying]\"}],\" 作为依赖数组会告诉 React：如果 \",[\"$r\",\"code\",null,{\"children\":\"isPlaying\"}],\" 与上次渲染时相同，就跳过重新运行 Effect。这样一来，输入框的输入不会触发 Effect 重新运行，只有按下播放/暂停按钮会触发。\"]}],\"\\n\"]}],[\"$r\",\"Sandpack\",null,{\"children\":[[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"children\":\"import { useState, useRef, useEffect } from 'react';\\r\\n\\r\\nfunction VideoPlayer({ src, isPlaying }) {\\r\\n  const ref = useRef(null);\\r\\n\\r\\n  useEffect(() =\u003e {\\r\\n    if (isPlaying) {\\r\\n      console.log('调用 video.play()');\\r\\n      ref.current.play();\\r\\n    } else {\\r\\n      console.log('调用 video.pause()');\\r\\n      ref.current.pause();\\r\\n    }\\r\\n  }, [isPlaying]);\\r\\n\\r\\n  return \u003cvideo ref={ref} src={src} loop playsInline /\u003e;\\r\\n}\\r\\n\\r\\nexport default function App() {\\r\\n  const [isPlaying, setIsPlaying] = useState(false);\\r\\n  const [text, setText] = useState('');\\r\\n  return (\\r\\n    \u003c\u003e\\r\\n      \u003cinput value={text} onChange={e =\u003e setText(e.target.value)} /\u003e\\r\\n      \u003cbutton onClick={() =\u003e setIsPlaying(!isPlaying)}\u003e\\r\\n        {isPlaying ? '暂停' : '播放'}\\r\\n      \u003c/button\u003e\\r\\n      \u003cVideoPlayer\\r\\n        isPlaying={isPlaying}\\r\\n        src=\\\"https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4\\\"\\r\\n      /\u003e\\r\\n    \u003c/\u003e\\r\\n  );\\r\\n}\\n\"}]}],[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-css\",\"children\":\"input, button { display: block; margin-bottom: 20px; }\\r\\nvideo { width: 250px; }\\n\"}]}]]}],[\"$r\",\"MaxWidth\",\"128\",{\"children\":[\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"依赖数组可以包含多个依赖项。只有当你指定的 \",[\"$r\",\"strong\",null,{\"children\":\"所有\"}],\" 依赖项的值都与上一次渲染时完全相同，React 才会跳过重新运行该 Effect。React 使用 \",[\"$r\",\"a\",null,{\"href\":\"https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/is\",\"target\":\"_blank\",\"rel\":\"nofollow noopener noreferrer\",\"children\":[\"$r\",\"code\",null,{\"children\":\"Object.is\"}]}],\" 来比较依赖项的值。有关详细信息，请参阅 \",[\"$r\",\"a\",null,{\"href\":\"/reference/react/useEffect#reference\",\"children\":[[\"$r\",\"code\",null,{\"children\":\"useEffect\"}],\" 参考文档\"]}],\"。\"]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[[\"$r\",\"strong\",null,{\"children\":\"请注意，你不能随意“选择”依赖项\"}],\"。如果你指定的依赖项与 React 根据 Effect 内部代码所推断出的依赖项不匹配，你将收到来自 lint 的错误提示。这有助于捕捉代码中的许多 bug。如果你不希望某些代码重新运行，\",[\"$r\",\"a\",null,{\"href\":\"/learn/lifecycle-of-reactive-effects#what-to-do-when-you-dont-want-to-re-synchronize\",\"children\":[\"那么你应当 \",[\"$r\",\"strong\",null,{\"children\":\"修改 Effect 代码本身\"}],\"，使其不再“需要”该依赖项\"]}],\"。\"]}],\"\\n\",[\"$r\",\"Pitfall\",null,{\"children\":[[\"$r\",\"p\",null,{\"children\":[\"没有依赖数组和使用空数组 \",[\"$r\",\"code\",null,{\"children\":\"[]\"}],\" 作为依赖数组，行为是不同的：\"]}],[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"meta\":\"{3,7,11}\",\"children\":\"useEffect(() =\u003e {\\r\\n  // 这里的代码会在每次渲染后运行\\r\\n});\\r\\n\\r\\nuseEffect(() =\u003e {\\r\\n  // 这里的代码只会在组件挂载（首次出现）时运行\\r\\n}, []);\\r\\n\\r\\nuseEffect(() =\u003e {\\r\\n  // 这里的代码不但会在组件挂载时运行，而且当 a 或 b 的值自上次渲染后发生变化后也会运行\\r\\n}, [a, b]);\\n\"}]}],[\"$r\",\"p\",null,{\"children\":[\"我们会在下一步详细了解什么是 \",[\"$r\",\"strong\",null,{\"children\":\"挂载（mount）\"}],\"。\"]}]]}],\"\\n\",[\"$r\",\"DeepDive\",null,{\"children\":[[\"$r\",\"h4\",null,{\"id\":\"why-was-the-ref-omitted-from-the-dependency-array\",\"children\":\"为什么依赖数组中可以省略 ref? \"}],[\"$r\",\"p\",null,{\"children\":[\"下面的 Effect 同时使用了 \",[\"$r\",\"code\",null,{\"children\":\"ref\"}],\" 与 \",[\"$r\",\"code\",null,{\"children\":\"isPlaying\"}],\" prop，但是只有 \",[\"$r\",\"code\",null,{\"children\":\"isPlaying\"}],\" 被声明为依赖项：\"]}],[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"meta\":\"{9}\",\"children\":\"function VideoPlayer({ src, isPlaying }) {\\r\\n  const ref = useRef(null);\\r\\n  useEffect(() =\u003e {\\r\\n    if (isPlaying) {\\r\\n      ref.current.play();\\r\\n    } else {\\r\\n      ref.current.pause();\\r\\n    }\\r\\n  }, [isPlaying]);\\n\"}]}],[\"$r\",\"p\",null,{\"children\":[\"这是因为 \",[\"$r\",\"code\",null,{\"children\":\"ref\"}],\" 具有 \",[\"$r\",\"strong\",null,{\"children\":\"稳定\"}],\" 的标识：React 确保你在 \",[\"$r\",\"a\",null,{\"href\":\"/reference/react/useRef#returns\",\"children\":[\"每轮渲染中调用同一个 \",[\"$r\",\"code\",null,{\"children\":\"useRef\"}],\" 时，总能获得相同的对象\"]}],\"。ref 不会改变，所以它不会导致重新运行 Effect。因此，在依赖数组中它可有可无。把它加进去也可以：\"]}],[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"meta\":\"{9}\",\"children\":\"function VideoPlayer({ src, isPlaying }) {\\r\\n  const ref = useRef(null);\\r\\n  useEffect(() =\u003e {\\r\\n    if (isPlaying) {\\r\\n      ref.current.play();\\r\\n    } else {\\r\\n      ref.current.pause();\\r\\n    }\\r\\n  }, [isPlaying, ref]);\\n\"}]}],[\"$r\",\"p\",null,{\"children\":[[\"$r\",\"code\",null,{\"children\":\"useState\"}],\" 返回的 \",[\"$r\",\"a\",null,{\"href\":\"/reference/react/useState#setstate\",\"children\":[[\"$r\",\"code\",null,{\"children\":\"set\"}],\" 函数\"]}],\" 也具有稳定的标识，因此它们通常也会被省略。如果在省略某个依赖项时 linter 不会报错，那么这么做就是安全的。\"]}],[\"$r\",\"p\",null,{\"children\":[\"省略始终稳定的依赖项仅在 linter 能“看到”对象是稳定的时候才有效。例如，如果 \",[\"$r\",\"code\",null,{\"children\":\"ref\"}],\" 是从父组件传递过来的，则必须在依赖数组中指定它。这很有必要，因为你无法确定父组件是一直传递相同的 ref，还是根据条件传递不同的 ref。所以，你的 Effect 会依赖于被传递的是哪个 ref。\"]}]]}],\"\\n\",[\"$r\",\"h3\",null,{\"id\":\"step-3-add-cleanup-if-needed\",\"children\":\"第三步：按需添加清理（cleanup）函数 \"}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"考虑一个不同的例子。假如你正在编写一个 \",[\"$r\",\"code\",null,{\"children\":\"ChatRoom\"}],\" 组件，该组件在显示时需要连接到聊天服务器。现在为你提供了 \",[\"$r\",\"code\",null,{\"children\":\"createConnection()\"}],\" API，该 API 返回一个包含 \",[\"$r\",\"code\",null,{\"children\":\"connect()\"}],\" 与 \",[\"$r\",\"code\",null,{\"children\":\"disconnection()\"}],\" 方法的对象。如何确保组件在显示时始终保持连接？\"]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":\"从编写 Effect 的逻辑开始：\"}],\"\\n\",[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"children\":\"useEffect(() =\u003e {\\r\\n  const connection = createConnection();\\r\\n  connection.connect();\\r\\n});\\n\"}]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":\"如果每次重新渲染后都得进行连接，这会很慢，所以你需要添加依赖数组：\"}],\"\\n\",[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"meta\":\"{4}\",\"children\":\"useEffect(() =\u003e {\\r\\n  const connection = createConnection();\\r\\n  connection.connect();\\r\\n}, []);\\n\"}]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[[\"$r\",\"strong\",null,{\"children\":[\"由于 Effect 中的代码没有使用任何 props 或 state，所以依赖数组为空数组 \",[\"$r\",\"code\",null,{\"children\":\"[]\"}],\"。这告诉 React 仅在组件“挂载”（即首次显示在页面上）时运行此代码\"]}],\"。\"]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":\"试试运行下面的代码：\"}],\"\\n\"]}],[\"$r\",\"Sandpack\",null,{\"children\":[[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"children\":\"import { useEffect } from 'react';\\r\\nimport { createConnection } from './chat.js';\\r\\n\\r\\nexport default function ChatRoom() {\\r\\n  useEffect(() =\u003e {\\r\\n    const connection = createConnection();\\r\\n    connection.connect();\\r\\n  }, []);\\r\\n  return \u003ch1\u003e欢迎来到聊天室！\u003c/h1\u003e;\\r\\n}\\n\"}]}],[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"meta\":\"src/chat.js\",\"children\":\"export function createConnection() {\\r\\n  // 真正的实现实际上会连接到服务器\\r\\n  return {\\r\\n    connect() {\\r\\n      console.log('✅ 连接中……');\\r\\n    },\\r\\n    disconnect() {\\r\\n      console.log('❌ 连接断开。');\\r\\n    }\\r\\n  };\\r\\n}\\n\"}]}],[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-css\",\"children\":\"input { display: block; margin-bottom: 20px; }\\n\"}]}]]}],[\"$r\",\"MaxWidth\",\"144\",{\"children\":[\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"这里的 Effect 仅在组件挂载时运行，所以你可能以为 \",[\"$r\",\"code\",null,{\"children\":\"\\\"✅ 连接中……\\\"\"}],\" 只会在控制台中被打印一次。\",[\"$r\",\"strong\",null,{\"children\":[\"然而实际情况是 \",[\"$r\",\"code\",null,{\"children\":\"\\\"✅ 连接中……\\\"\"}],\" 被打印了两次！为什么会这样\"]}],\"？\"]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"假设 \",[\"$r\",\"code\",null,{\"children\":\"ChatRoom\"}],\" 组件是一个大型多页面应用中的一部分。用户最初在 \",[\"$r\",\"code\",null,{\"children\":\"ChatRoom\"}],\" 页面上。组件挂载并调用 \",[\"$r\",\"code\",null,{\"children\":\"connection.connect()\"}],\" 。接着用户可能会导航到另一个页面，比如切换到“设置”页面，于是 \",[\"$r\",\"code\",null,{\"children\":\"ChatRoom\"}],\" 组件被卸载。最后，当用户点击“返回”时，\",[\"$r\",\"code\",null,{\"children\":\"ChatRoom\"}],\" 组件再次挂载。这将建立第二个连接——但第一个连接从未被销毁！随着用户在应用中来回切换，连接将会不断累积。\"]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":\"这类 bug 在没有大量手动测试的情况下很容易被忽略。为了帮助你快速发现它们，在开发环境中，React 会在组件首次挂载后立即重新挂载一次。\"}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"两次出现 \",[\"$r\",\"code\",null,{\"children\":\"\\\"✅ 连接中……\\\"\"}],\" 能够帮助你注意到真正的问题：在代码中，组件被卸载时没有关闭连接。\"]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"为了解决这个问题，可以在 Effect 中返回一个 \",[\"$r\",\"strong\",null,{\"children\":\"清理（cleanup）函数\"}],\" 。\"]}],\"\\n\",[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"meta\":\"{4-6}\",\"children\":\"  useEffect(() =\u003e {\\r\\n    const connection = createConnection();\\r\\n    connection.connect();\\r\\n    return () =\u003e {\\r\\n      connection.disconnect();\\r\\n    };\\r\\n  }, []);\\n\"}]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":\"React 会在每次 Effect 重新运行之前调用清理函数，并在组件卸载（被移除）时最后一次调用清理函数。让我们看看实现清理函数后会发生什么：\"}],\"\\n\"]}],[\"$r\",\"Sandpack\",null,{\"children\":[[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"children\":\"import { useState, useEffect } from 'react';\\r\\nimport { createConnection } from './chat.js';\\r\\n\\r\\nexport default function ChatRoom() {\\r\\n  useEffect(() =\u003e {\\r\\n    const connection = createConnection();\\r\\n    connection.connect();\\r\\n    return () =\u003e connection.disconnect();\\r\\n  }, []);\\r\\n  return \u003ch1\u003e欢迎来到聊天室！\u003c/h1\u003e;\\r\\n}\\n\"}]}],[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"meta\":\"src/chat.js\",\"children\":\"export function createConnection() {\\r\\n  // 真正的实现实际上会连接到服务器\\r\\n  return {\\r\\n    connect() {\\r\\n      console.log('✅ 连接中……');\\r\\n    },\\r\\n    disconnect() {\\r\\n      console.log('❌ 连接断开。');\\r\\n    }\\r\\n  };\\r\\n}\\n\"}]}],[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-css\",\"children\":\"input { display: block; margin-bottom: 20px; }\\n\"}]}]]}],[\"$r\",\"MaxWidth\",\"252\",{\"children\":[\"\\n\",[\"$r\",\"p\",null,{\"children\":\"现在在开发环境下，你会看到三条控制台日志：\"}],\"\\n\",[\"$r\",\"ol\",null,{\"children\":[\"\\n\",[\"$r\",\"li\",null,{\"children\":[\"$r\",\"code\",null,{\"children\":\"\\\"✅ 连接中……\\\"\"}]}],\"\\n\",[\"$r\",\"li\",null,{\"children\":[\"$r\",\"code\",null,{\"children\":\"\\\"❌ 连接断开。\\\"\"}]}],\"\\n\",[\"$r\",\"li\",null,{\"children\":[\"$r\",\"code\",null,{\"children\":\"\\\"✅ 连接中……\\\"\"}]}],\"\\n\"]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[[\"$r\",\"strong\",null,{\"children\":\"在开发环境下，这是正确的行为\"}],\"。通过重新挂载你的组件，React 验证了离开页面再返回不会导致代码出错。因为本就应该先断开然后再重新连接！如果你很好地实现了清理函数，那么无论是只执行一次 Effect ，还是执行、清理、再执行，都应该没有用户可见的区别。之所以会有额外的一次 connect/disconnect 调用，是因为在开发环境下 React 在检测你代码中的 bug。因此这是正常现象，不要去试图消除它！\"]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[[\"$r\",\"strong\",null,{\"children\":[\"在生产环境下，你只会看到 \",[\"$r\",\"code\",null,{\"children\":\"\\\"✅ 连接中……\\\"\"}],\" 打印一次\"]}],\"。这是因为重新挂载组件只会在开发环境下发生，以此帮助你找到需要清理的 Effect。你可以通过关闭 \",[\"$r\",\"a\",null,{\"href\":\"/reference/react/StrictMode\",\"children\":\"严格模式\"}],\" 来禁用这个行为，但我们建议保留它。它可以帮助你发现许多类似上述的 bug。\"]}],\"\\n\",[\"$r\",\"h2\",null,{\"id\":\"how-to-handle-the-effect-firing-twice-in-development\",\"children\":\"如何处理在开发环境下 Effect 运行了两次？ \"}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"React 有意在开发环境下重新挂载你的组件，来找到类似上例中的 bug。\",[\"$r\",\"strong\",null,{\"children\":\"你需要思考的不是“如何只运行一次 Effect”，而是“如何修复我的 Effect 来让它在重新挂载后正常运行”\"}],\"。\"]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":\"通常，答案是实现清理函数。清理函数应该停止或撤销 Effect 所做的一切。原则是用户不应该感受到 Effect 只执行一次（在生产环境中）和连续执行“挂载 → 清理 → 挂载”（在开发环境中）之间的区别。\"}],\"\\n\",[\"$r\",\"p\",null,{\"children\":\"你将编写的大多数 Effect 都会符合下列的常见模式之一。\"}],\"\\n\",[\"$r\",\"Pitfall\",null,{\"children\":[[\"$r\",\"h4\",null,{\"id\":\"dont-use-refs-to-prevent-effects-from-firing\",\"children\":\"不要使用 ref 来防止触发 Effect \"}],[\"$r\",\"p\",null,{\"children\":[\"为了防止 Effect 在开发环境中触发两次，一个常见错误是使用 \",[\"$r\",\"code\",null,{\"children\":\"ref\"}],\" 来让 Effect 只运行一次。例如，你可能会用 \",[\"$r\",\"code\",null,{\"children\":\"useRef\"}],\" “修复”上述的 bug：\"]}],[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"meta\":\"{1,3-4}\",\"children\":\"  const connectionRef = useRef(null);\\r\\n  useEffect(() =\u003e {\\r\\n    // 🚩 这并不能修复这个 bug！！！\\r\\n    if (!connectionRef.current) {\\r\\n      connectionRef.current = createConnection();\\r\\n      connectionRef.current.connect();\\r\\n    }\\r\\n  }, []);\\n\"}]}],[\"$r\",\"p\",null,{\"children\":[\"它虽然使你在开发环境下只看到一次 \",[\"$r\",\"code\",null,{\"children\":\"“✅ 正在连接...”\"}],\"，但并没有修复这个 bug。\"]}],[\"$r\",\"p\",null,{\"children\":\"当用户离开时，连接没有被关闭，当用户返回时，又会创建一个新的连接。随着用户浏览应用，连接会不断累积，就像“修复”之前一样。\"}],[\"$r\",\"p\",null,{\"children\":\"要修复这个 bug，仅仅让 Effect 只运行一次是不够的。想要 Effect 在重新挂载后正常运行，就得按照之前的方法清除连接。\"}],[\"$r\",\"p\",null,{\"children\":\"请看下面的示例，了解如何处理常见模式。\"}]]}],\"\\n\",[\"$r\",\"h3\",null,{\"id\":\"controlling-non-react-widgets\",\"children\":\"管理非 React 小部件 \"}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"有时你需要添加不是用 React 实现的 UI 小部件。比如说你想在你的页面添加一个地图组件。它有一个 \",[\"$r\",\"code\",null,{\"children\":\"setZoomLevel()\"}],\" 方法，然后你希望地图的缩放比例和代码中的 \",[\"$r\",\"code\",null,{\"children\":\"zoomLevel\"}],\" state 保持同步。你的 Effect 应该类似于：\"]}],\"\\n\",[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"children\":\"useEffect(() =\u003e {\\r\\n  const map = mapRef.current;\\r\\n  map.setZoomLevel(zoomLevel);\\r\\n}, [zoomLevel]);\\n\"}]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"请注意，这种情况下不需要清理操作。在开发环境中，虽然 React 会调用 Effect 两次，但这没关系，因为用相同的值调用 \",[\"$r\",\"code\",null,{\"children\":\"setZoomLevel\"}],\" 两次不会造成任何影响。虽然在开发环境下它可能会稍微慢一些，但问题不大，因为在生产环境下它不会多余地重新挂载。\"]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"有些 API 可能不允许你连续调用两次。例如，内置的 \",[\"$r\",\"a\",null,{\"href\":\"https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLDialogElement\",\"target\":\"_blank\",\"rel\":\"nofollow noopener noreferrer\",\"children\":[\"$r\",\"code\",null,{\"children\":\"\u003cdialog\u003e\"}]}],\" 元素的 \",[\"$r\",\"a\",null,{\"href\":\"https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLDialogElement/showModal\",\"target\":\"_blank\",\"rel\":\"nofollow noopener noreferrer\",\"children\":[\"$r\",\"code\",null,{\"children\":\"showModal\"}]}],\" 方法在连续被调用两次时会抛出异常。此时可以通过实现清理函数来使其关闭对话框：\"]}],\"\\n\",[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"meta\":\"{4}\",\"children\":\"useEffect(() =\u003e {\\r\\n  const dialog = dialogRef.current;\\r\\n  dialog.showModal();\\r\\n  return () =\u003e dialog.close();\\r\\n}, []);\\n\"}]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"在开发环境中，你的 Effect 会先调用 \",[\"$r\",\"code\",null,{\"children\":\"showModal()\"}],\"，然后立即调用 \",[\"$r\",\"code\",null,{\"children\":\"close()\"}],\"，之后再次调用 \",[\"$r\",\"code\",null,{\"children\":\"showModal()\"}],\"。这与在生产环境中只调用一次 \",[\"$r\",\"code\",null,{\"children\":\"showModal()\"}],\" 的用户可见行为是相同的。\"]}],\"\\n\",[\"$r\",\"h3\",null,{\"id\":\"subscribing-to-events\",\"children\":\"订阅事件 \"}],\"\\n\",[\"$r\",\"p\",null,{\"children\":\"如果你的 Effect 订阅了某些事件，清理函数应退订这些事件：\"}],\"\\n\",[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"meta\":\"{6}\",\"children\":\"useEffect(() =\u003e {\\r\\n  function handleScroll(e) {\\r\\n    console.log(window.scrollX, window.scrollY);\\r\\n  }\\r\\n  window.addEventListener('scroll', handleScroll);\\r\\n  return () =\u003e window.removeEventListener('scroll', handleScroll);\\r\\n}, []);\\n\"}]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"在开发环境中，你的 Effect 会先调用 \",[\"$r\",\"code\",null,{\"children\":\"addEventListener()\"}],\"，然后立即调用 \",[\"$r\",\"code\",null,{\"children\":\"removeEventListener()\"}],\"，接着再次使用相同的处理函数调用 \",[\"$r\",\"code\",null,{\"children\":\"addEventListener()\"}],\"。因此，每次只会有一个有效订阅。这与在生产环境中只调用一次 \",[\"$r\",\"code\",null,{\"children\":\"addEventListener()\"}],\" 所产生的用户可见行为是相同的。\"]}],\"\\n\",[\"$r\",\"h3\",null,{\"id\":\"triggering-animations\",\"children\":\"触发动画 \"}],\"\\n\",[\"$r\",\"p\",null,{\"children\":\"如果你的 Effect 触发了一些动画，清理函数应将动画重置为初始状态：\"}],\"\\n\",[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"meta\":\"{4-6}\",\"children\":\"useEffect(() =\u003e {\\r\\n  const node = ref.current;\\r\\n  node.style.opacity = 1; // 触发动画\\r\\n  return () =\u003e {\\r\\n    node.style.opacity = 0; // 重置为初始值\\r\\n  };\\r\\n}, []);\\n\"}]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"在开发环境中，透明度由 \",[\"$r\",\"code\",null,{\"children\":\"1\"}],\" 变为 \",[\"$r\",\"code\",null,{\"children\":\"0\"}],\"，再变为 \",[\"$r\",\"code\",null,{\"children\":\"1\"}],\"。这与在生产环境中，直接将其设置为 \",[\"$r\",\"code\",null,{\"children\":\"1\"}],\" 具有相同的用户可见行为。如果你使用了支持补间动画的第三方动画库，你的清理函数应将时间轴重置为初始状态。\"]}],\"\\n\",[\"$r\",\"h3\",null,{\"id\":\"fetching-data\",\"children\":\"获取数据 \"}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"如果你的 Effect 需要获取数据，清理函数应 \",[\"$r\",\"a\",null,{\"href\":\"https://developer.mozilla.org/zh-CN/docs/Web/API/AbortController\",\"target\":\"_blank\",\"rel\":\"nofollow noopener noreferrer\",\"children\":\"中止请求\"}],\" 或忽略其结果：\"]}],\"\\n\",[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"meta\":\"{2,6,13-15}\",\"children\":\"useEffect(() =\u003e {\\r\\n  let ignore = false;\\r\\n\\r\\n  async function startFetching() {\\r\\n    const json = await fetchTodos(userId);\\r\\n    if (!ignore) {\\r\\n      setTodos(json);\\r\\n    }\\r\\n  }\\r\\n\\r\\n  startFetching();\\r\\n\\r\\n  return () =\u003e {\\r\\n    ignore = true;\\r\\n  };\\r\\n}, [userId]);\\n\"}]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"你无法“撤销”已经发生的网络请求，但是你的清理函数应当确保那些不再相关的请求不会继续影响你的应用。如果 \",[\"$r\",\"code\",null,{\"children\":\"userId\"}],\" 从 \",[\"$r\",\"code\",null,{\"children\":\"'Alice'\"}],\" 变为 \",[\"$r\",\"code\",null,{\"children\":\"'Bob'\"}],\"，那么请确保 \",[\"$r\",\"code\",null,{\"children\":\"'Alice'\"}],\" 的响应数据被忽略，即使它在 \",[\"$r\",\"code\",null,{\"children\":\"'Bob'\"}],\" 之后到达。\"]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[[\"$r\",\"strong\",null,{\"children\":\"在开发环境中，你会在浏览器调试工具的“网络”选项卡中看到两条请求\"}],\"。这是正常的。使用上述方法，第一个 Effect 将立即被清理，所以它的 \",[\"$r\",\"code\",null,{\"children\":\"ignore\"}],\" 变量会被设置为 \",[\"$r\",\"code\",null,{\"children\":\"true\"}],\"。因此，即使有额外的请求，由于有 \",[\"$r\",\"code\",null,{\"children\":\"if (!ignore)\"}],\" 的检查，也不会影响 state。\"]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[[\"$r\",\"strong\",null,{\"children\":\"在生产环境中，只会有一条请求\"}],\"。如果开发环境中的第二次请求给你造成了困扰，最好的办法是使用一个能够对请求去重并缓存响应的方案：\"]}],\"\\n\",[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"children\":\"function TodoList() {\\r\\n  const todos = useSomeDataLibrary(`/api/user/${userId}/todos`);\\r\\n  // ...\\n\"}]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":\"这不仅可以提高开发体验，还可以让你的应用程序响应更快。例如，当用户点击返回按钮时，不用再等待数据重新加载，因为它已经被缓存。你可以自己构建这样的缓存机制，也可以使用很多在 Effect 中手动获取数据的替代方法。\"}],\"\\n\",[\"$r\",\"DeepDive\",null,{\"children\":[[\"$r\",\"h4\",null,{\"id\":\"what-are-good-alternatives-to-data-fetching-in-effects\",\"children\":\"在 Effect 中进行数据请求的替代方案 \"}],[\"$r\",\"p\",null,{\"children\":[\"在 Effect 中直接编写 \",[\"$r\",\"code\",null,{\"children\":\"fetch\"}],\" 请求 \",[\"$r\",\"a\",null,{\"href\":\"https://www.robinwieruch.de/react-hooks-fetch-data/\",\"target\":\"_blank\",\"rel\":\"nofollow noopener noreferrer\",\"children\":\"是一种常见的数据获取方式\"}],\"，特别是在完全客户端渲染的应用中。然而，这种方法非常手动化，并且有明显的弊端：\"]}],[\"$r\",\"ul\",null,{\"children\":[\"\\n\",[\"$r\",\"li\",null,{\"children\":[[\"$r\",\"strong\",null,{\"children\":\"Effect 不会在服务端运行\"}],\"。这意味着最初由服务器渲染的 HTML 只会包含加载状态，而没有实际数据。客户端必须先下载所有的 JavaScript 并渲染应用，才会发现它需要加载数据——这并不高效。\"]}],\"\\n\",[\"$r\",\"li\",null,{\"children\":[[\"$r\",\"strong\",null,{\"children\":\"直接在 Effect 中进行数据请求，容易产生“网络瀑布（network waterfall）”\"}],\"。首先父组件渲染时请求一些数据，随后渲染子组件，接着子组件开始请求它们的数据。如果网络速度不快，这种方式会比并行获取所有数据慢得多。\"]}],\"\\n\",[\"$r\",\"li\",null,{\"children\":[[\"$r\",\"strong\",null,{\"children\":\"直接在 Effect 中进行数据请求往往无法预加载或缓存数据\"}],\"。例如，如果组件卸载后重新挂载，它必须重新获取数据。\"]}],\"\\n\",[\"$r\",\"li\",null,{\"children\":[[\"$r\",\"strong\",null,{\"children\":\"不够简洁\"}],\"。编写 fecth 请求时为了避免 \",[\"$r\",\"a\",null,{\"href\":\"https://maxrozen.com/race-conditions-fetching-data-react-with-useeffect\",\"target\":\"_blank\",\"rel\":\"nofollow noopener noreferrer\",\"children\":\"竞态条件（race condition）\"}],\" 等问题，会需要很多样板代码。\"]}],\"\\n\"]}],[\"$r\",\"p\",null,{\"children\":\"这些弊端并不仅限于 React。任何库在组件挂载时进行数据获取都会遇到这些问题。与路由处理一样，要做好数据获取并非易事，因此我们推荐以下方法：\"}],[\"$r\",\"ul\",null,{\"children\":[\"\\n\",[\"$r\",\"li\",null,{\"children\":[[\"$r\",\"strong\",null,{\"children\":[\"如果你正在使用 \",[\"$r\",\"a\",null,{\"href\":\"/learn/start-a-new-react-project#production-grade-react-frameworks\",\"children\":\"框架\"}],\" ，请使用其内置的数据获取机制\"]}],\"。现代 React 框架集成了高效的数据获取机制，不会出现上述问题。\"]}],\"\\n\",[\"$r\",\"li\",null,{\"children\":[[\"$r\",\"strong\",null,{\"children\":\"否则，请考虑使用或构建客户端缓存\"}],\"。流行的开源解决方案包括 \",[\"$r\",\"a\",null,{\"href\":\"https://tanstack.com/query/latest\",\"target\":\"_blank\",\"rel\":\"nofollow noopener noreferrer\",\"children\":\"React Query\"}],\"、\",[\"$r\",\"a\",null,{\"href\":\"https://swr.vercel.app/\",\"target\":\"_blank\",\"rel\":\"nofollow noopener noreferrer\",\"children\":\"useSWR\"}],\" 和 \",[\"$r\",\"a\",null,{\"href\":\"https://beta.reactrouter.com/en/main/start/overview\",\"target\":\"_blank\",\"rel\":\"nofollow noopener noreferrer\",\"children\":\"React Router v6.4+\"}],\"。你也可以自己构建解决方案：在底层使用 Effect，但添加对请求的去重、缓存响应以及避免网络瀑布（通过预加载数据或将数据请求提升到路由层次）的逻辑。\"]}],\"\\n\"]}],[\"$r\",\"p\",null,{\"children\":\"如果这些方法都不适合你，你可以继续直接在 Effect 中获取数据。\"}]]}],\"\\n\",[\"$r\",\"h3\",null,{\"id\":\"sending-analytics\",\"children\":\"发送分析报告 \"}],\"\\n\",[\"$r\",\"p\",null,{\"children\":\"考虑以下代码，它在页面访问时发送一个分析事件：\"}],\"\\n\",[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"children\":\"useEffect(() =\u003e {\\r\\n  logVisit(url); // 发送 POST 请求\\r\\n}, [url]);\\n\"}]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"在开发环境中，对于每个 URL，\",[\"$r\",\"code\",null,{\"children\":\"logVisit\"}],\" 都会被调用两次，因此你可能会尝试修复这个问题。\",[\"$r\",\"strong\",null,{\"children\":\"我们建议保持不动\"}],\"。与之前示例类似，运行一次还是运行两次，在用户可见的行为上没有区别。从实际角度来看，\",[\"$r\",\"code\",null,{\"children\":\"logVisit\"}],\" 不应该在开发环境中执行任何操作，因为你不会想让开发设备的日志影响生产环境的统计数据。每次保存文件时组件都会重新挂载，因此在开发环境中会记录额外的访问日志。\"]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[[\"$r\",\"strong\",null,{\"children\":\"在生产环境中，不会有重复的访问日志\"}],\"。\"]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"为了调试发送的分析事件，你可以将应用部署到一个运行在生产模式下的暂存环境，或者暂时禁用 \",[\"$r\",\"a\",null,{\"href\":\"/reference/react/StrictMode\",\"children\":\"严格模式\"}],\" 及其仅在开发环境中的重新挂载检查。你还可以在路由更改的事件处理程序中发送分析数据，而不是在 Effect 中发送。对于更精确的分析，可以使用\",[\"$r\",\"a\",null,{\"href\":\"https://developer.mozilla.org/zh-CN/docs/Web/API/Intersection_Observer_API\",\"target\":\"_blank\",\"rel\":\"nofollow noopener noreferrer\",\"children\":\"交叉观察器\"}],\" 来跟踪哪些组件位于视口中以及它们保持可见的时间。\"]}],\"\\n\",[\"$r\",\"h3\",null,{\"id\":\"not-an-effect-initializing-the-application\",\"children\":\"不适用于 Effect：初始化应用 \"}],\"\\n\",[\"$r\",\"p\",null,{\"children\":\"某些逻辑应该只在应用启动时运行一次。你可以将它放在组件外部：\"}],\"\\n\",[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"meta\":\"{2-3}\",\"children\":\"if (typeof window !== 'undefined') { // 检查是否在浏览器中运行\\r\\n  checkAuthToken();\\r\\n  loadDataFromLocalStorage();\\r\\n}\\r\\n\\r\\nfunction App() {\\r\\n  // ……\\r\\n}\\n\"}]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":\"这可以确保此类逻辑只在浏览器加载页面后运行一次。\"}],\"\\n\",[\"$r\",\"h3\",null,{\"id\":\"not-an-effect-buying-a-product\",\"children\":\"不适用于 Effect：购买商品 \"}],\"\\n\",[\"$r\",\"p\",null,{\"children\":\"有时，即使你编写了清理函数，也无法避免用户观察到 Effect 运行了两次。比如你的 Effect 发送了一个像购买商品这样的 POST 请求：\"}],\"\\n\",[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"meta\":\"{2-3}\",\"children\":\"useEffect(() =\u003e {\\r\\n  // 🔴 错误：此处的 Effect 在开发环境中会触发两次，暴露出代码中的问题。\\r\\n  fetch('/api/buy', { method: 'POST' });\\r\\n}, []);\\n\"}]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":\"你肯定不希望购买两次商品。这也是为什么你不应该把这种逻辑放在 Effect 中。如果用户跳转到另一个页面，然后按下“返回”按钮，你的 Effect 就会再次运行。你不希望用户在访问页面时就购买产品，而是在他们点击“购买”按钮时才购买。\"}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"购买操作并不是由渲染引起的，而是由特定的交互引起的。它应该只在用户按下按钮时执行。因此，\",[\"$r\",\"strong\",null,{\"children\":[\"它不应该写在 Effect 中，应当把 \",[\"$r\",\"code\",null,{\"children\":\"/api/buy\"}],\" 请求移动到“购买”按钮的事件处理程序中\"]}],\"：\"]}],\"\\n\",[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"meta\":\"{2-3}\",\"children\":\"  function handleClick() {\\r\\n    // ✅ 购买行为是一个事件，因为它是由特定的交互引起的。\\r\\n    fetch('/api/buy', { method: 'POST' });\\r\\n  }\\n\"}]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[[\"$r\",\"strong\",null,{\"children\":\"这说明了如果重新挂载破坏了应用的逻辑，通常便暴露了存在的 bug\"}],\"。对用户而言，访问一个页面不应该与访问页面后点击链接、再按下“返回”按钮查看页面有区别。React 通过在开发环境中重新挂载组件来验证你的组件是否遵守这一原则。\"]}],\"\\n\",[\"$r\",\"h2\",null,{\"id\":\"putting-it-all-together\",\"children\":\"综合以上内容 \"}],\"\\n\",[\"$r\",\"p\",null,{\"children\":\"这个演练场可以帮助你“感受” Effect 在实际中的工作方式。\"}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"这个例子使用 \",[\"$r\",\"a\",null,{\"href\":\"https://developer.mozilla.org/zh-CN/docs/Web/API/setTimeout\",\"target\":\"_blank\",\"rel\":\"nofollow noopener noreferrer\",\"children\":[\"$r\",\"code\",null,{\"children\":\"setTimeout\"}]}],\" 调度一个日志记录，日志会在 Effect 运行三秒后显示输入的文本。清理函数会取消挂起的延时器。从按下“挂载组件”开始：\"]}],\"\\n\"]}],[\"$r\",\"Sandpack\",null,{\"children\":[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"children\":\"import { useState, useEffect } from 'react';\\r\\n\\r\\nfunction Playground() {\\r\\n  const [text, setText] = useState('a');\\r\\n\\r\\n  useEffect(() =\u003e {\\r\\n    function onTimeout() {\\r\\n      console.log('⏰ ' + text);\\r\\n    }\\r\\n\\r\\n    console.log('🔵 调度 \\\"' + text + '\\\" 日志');\\r\\n    const timeoutId = setTimeout(onTimeout, 3000);\\r\\n\\r\\n    return () =\u003e {\\r\\n      console.log('🟡 取消 \\\"' + text + '\\\" 日志');\\r\\n      clearTimeout(timeoutId);\\r\\n    };\\r\\n  }, [text]);\\r\\n\\r\\n  return (\\r\\n    \u003c\u003e\\r\\n      \u003clabel\u003e\\r\\n        日志内容：{' '}\\r\\n        \u003cinput\\r\\n          value={text}\\r\\n          onChange={e =\u003e setText(e.target.value)}\\r\\n        /\u003e\\r\\n      \u003c/label\u003e\\r\\n      \u003ch1\u003e{text}\u003c/h1\u003e\\r\\n    \u003c/\u003e\\r\\n  );\\r\\n}\\r\\n\\r\\nexport default function App() {\\r\\n  const [show, setShow] = useState(false);\\r\\n  return (\\r\\n    \u003c\u003e\\r\\n      \u003cbutton onClick={() =\u003e setShow(!show)}\u003e\\r\\n        {show ? '卸载' : '挂载'}组件\\r\\n      \u003c/button\u003e\\r\\n      {show \u0026\u0026 \u003chr /\u003e}\\r\\n      {show \u0026\u0026 \u003cPlayground /\u003e}\\r\\n    \u003c/\u003e\\r\\n  );\\r\\n}\\n\"}]}]}],[\"$r\",\"MaxWidth\",\"268\",{\"children\":[\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"你首先会看到三条日志：\",[\"$r\",\"code\",null,{\"children\":\"调度 \\\"a\\\" 日志\"}],\"，\",[\"$r\",\"code\",null,{\"children\":\"取消 \\\"a\\\" 日志\"}],\"，再一条 \",[\"$r\",\"code\",null,{\"children\":\"调度 \\\"a\\\" 日志\"}],\"。三秒后，你还会看到一条日志：\",[\"$r\",\"code\",null,{\"children\":\"a\"}],\"。正如你先前所学，额外的调度/取消日志是因为 React 在开发环境中会重新挂载组件一次，以验证你是否正确实现了清理操作。\"]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"现在编辑输入框，输入 \",[\"$r\",\"code\",null,{\"children\":\"abc\"}],\"。如果输入速度足够快，你会看到 \",[\"$r\",\"code\",null,{\"children\":\"调度 \\\"ab\\\" 日志\"}],\"，紧接着 \",[\"$r\",\"code\",null,{\"children\":\"取消 \\\"ab\\\" 日志\"}],\" 和 \",[\"$r\",\"code\",null,{\"children\":\"调度 \\\"abc\\\" 日志\"}],\"。\",[\"$r\",\"strong\",null,{\"children\":\"React 总是在执行下一轮渲染的 Effect 之前清理上一轮渲染的 Effect\"}],\"。这就是为什么即使你快速输入，最多也只有一个延时器被调度。试试多次编辑输入框，并观察控制台以了解 Effect 是如何被清理的。\"]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":\"在输入框中输入一些内容，然后立即按下“卸载组件”。注意卸载组件时是如何清理最后一轮渲染的 Effect 的。在这里，它会在最后一个延迟器要触发之前取消它。\"}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"最后，在上面的代码中注释掉清理函数，这样延时器就不会被取消。尝试快速输入 \",[\"$r\",\"code\",null,{\"children\":\"abcde\"}],\"。你觉得三秒后会发生什么？延时器中的 \",[\"$r\",\"code\",null,{\"children\":\"console.log(text)\"}],\" 会打印 \",[\"$r\",\"strong\",null,{\"children\":\"最新\"}],\" 的 \",[\"$r\",\"code\",null,{\"children\":\"text\"}],\" 值并生成五条 \",[\"$r\",\"code\",null,{\"children\":\"abcde\"}],\" 日志吗？试试看吧，验证一下你的直觉！\"]}],\"\\n\",[\"$r\",\"p\",null,{\"children\":[\"三秒后，你应该会看到一系列的日志：\",[\"$r\",\"code\",null,{\"children\":\"a\"}],\"、\",[\"$r\",\"code\",null,{\"children\":\"ab\"}],\"、\",[\"$r\",\"code\",null,{\"children\":\"abc\"}],\"、\",[\"$r\",\"code\",null,{\"children\":\"abcd\"}],\" 与 \",[\"$r\",\"code\",null,{\"children\":\"abcde\"}],\"，而不是五条 \",[\"$r\",\"code\",null,{\"children\":\"abcde\"}],\" 日志。这是因为 \",[\"$r\",\"strong\",null,{\"children\":[\"每个 Effect 都会“捕获”它对应渲染时的 \",[\"$r\",\"code\",null,{\"children\":\"text\"}],\" 值\"]}],\"。即使 \",[\"$r\",\"code\",null,{\"children\":\"text\"}],\" 的值发生了变化，渲染时 \",[\"$r\",\"code\",null,{\"children\":\"text = 'ab'\"}],\" 的 Effect 总是会得到 \",[\"$r\",\"code\",null,{\"children\":\"'ab'\"}],\"。换句话说，每个渲染的 Effect 都是相互独立的。如果你对这种机制感兴趣，可以阅读有关 \",[\"$r\",\"a\",null,{\"href\":\"https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Closures\",\"target\":\"_blank\",\"rel\":\"nofollow noopener noreferrer\",\"children\":\"闭包\"}],\" 的内容。\"]}],\"\\n\",[\"$r\",\"DeepDive\",null,{\"children\":[[\"$r\",\"h4\",null,{\"id\":\"each-render-has-its-own-effects\",\"children\":\"每一轮渲染都有其自己的 Effect \"}],[\"$r\",\"p\",null,{\"children\":[\"你可以将 \",[\"$r\",\"code\",null,{\"children\":\"useEffect\"}],\" 理解为“附加”一段行为到渲染输出中。考虑下面这个 Effect：\"]}],[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"children\":\"export default function ChatRoom({ roomId }) {\\r\\n  useEffect(() =\u003e {\\r\\n    const connection = createConnection(roomId);\\r\\n    connection.connect();\\r\\n    return () =\u003e connection.disconnect();\\r\\n  }, [roomId]);\\r\\n\\r\\n  return \u003ch1\u003e欢迎来到 {roomId}！\u003c/h1\u003e;\\r\\n}\\n\"}]}],[\"$r\",\"p\",null,{\"children\":\"让我们看看当用户在应用程序中切换页面时到底发生了什么。\"}],[\"$r\",\"h4\",null,{\"id\":\"initial-render\",\"children\":\"初次渲染 \"}],[\"$r\",\"p\",null,{\"children\":[\"用户访问 \",[\"$r\",\"code\",null,{\"children\":\"\u003cChatRoom roomId=\\\"general\\\" /\u003e\"}],\"。我们 \",[\"$r\",\"a\",null,{\"href\":\"/learn/state-as-a-snapshot#rendering-takes-a-snapshot-in-time\",\"children\":\"假设\"}],\" \",[\"$r\",\"code\",null,{\"children\":\"roomId\"}],\" 的值为 \",[\"$r\",\"code\",null,{\"children\":\"'general'\"}],\" ：\"]}],[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"children\":\"  // 首次渲染时的 JSX（roomId 为 \\\"general\\\"）\\r\\n  return \u003ch1\u003e欢迎来到 general！\u003c/h1\u003e;\\n\"}]}],[\"$r\",\"p\",null,{\"children\":[[\"$r\",\"strong\",null,{\"children\":\"Effect 也是渲染输出的一部分\"}],\"。首次渲染的 Effect 变为：\"]}],[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"children\":\"  //首先渲染时的 Effect（roomId 为 \\\"general\\\"）\\r\\n  () =\u003e {\\r\\n    const connection = createConnection('general');\\r\\n    connection.connect();\\r\\n    return () =\u003e connection.disconnect();\\r\\n  },\\r\\n  // 首次渲染时的依赖项（roomId 为 \\\"general\\\"）\\r\\n  ['general']\\n\"}]}],[\"$r\",\"p\",null,{\"children\":[\"React 运行这个 Effect 来连接到 \",[\"$r\",\"code\",null,{\"children\":\"'general'\"}],\" 聊天室。\"]}],[\"$r\",\"h4\",null,{\"id\":\"re-render-with-same-dependencies\",\"children\":\"依赖项相同时的重新渲染 \"}],[\"$r\",\"p\",null,{\"children\":[\"假设 \",[\"$r\",\"code\",null,{\"children\":\"\u003cChatRoom roomId=\\\"general\\\" /\u003e\"}],\" 重新渲染。输出的 JSX 不变：\"]}],[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"children\":\"  // 第二次渲染时的 JSX（roomId 为 \\\"general\\\"）\\r\\n  return \u003ch1\u003eWelcome to general!\u003c/h1\u003e;\\n\"}]}],[\"$r\",\"p\",null,{\"children\":\"React 看到渲染输出没有改变，所以不更新 DOM 。\"}],[\"$r\",\"p\",null,{\"children\":\"第二次渲染的 Effect 如下所示：\"}],[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"children\":\"  // 第二次渲染时的 Effect（roomId 为 \\\"general\\\"）\\r\\n  () =\u003e {\\r\\n    const connection = createConnection('general');\\r\\n    connection.connect();\\r\\n    return () =\u003e connection.disconnect();\\r\\n  },\\r\\n  // 第二次渲染时的依赖项（roomId 为 \\\"general\\\"）\\r\\n  ['general']\\n\"}]}],[\"$r\",\"p\",null,{\"children\":[\"React 将第二次渲染时的 \",[\"$r\",\"code\",null,{\"children\":\"['general']\"}],\" 与第一次渲染时的 \",[\"$r\",\"code\",null,{\"children\":\"['general']\"}],\" 进行比较。\",[\"$r\",\"strong\",null,{\"children\":\"因为所有的依赖项都相同，React 忽略第二次渲染时的 Effect\"}],\"。Effect 不会被调用。\"]}],[\"$r\",\"h4\",null,{\"id\":\"re-render-with-different-dependencies\",\"children\":\"依赖项不同时的重新渲染 \"}],[\"$r\",\"p\",null,{\"children\":[\"接着，用户访问了 \",[\"$r\",\"code\",null,{\"children\":\"\u003cChatRoom roomId=\\\"travel\\\" /\u003e\"}],\"。这一次，组件返回了不同的 JSX：\"]}],[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"children\":\"  // 第三次渲染时的 JSX（roomId 为 \\\"travel\\\"）\\r\\n  return \u003ch1\u003e欢迎来到 travel！\u003c/h1\u003e;\\n\"}]}],[\"$r\",\"p\",null,{\"children\":[\"React 更新 DOM ，将 \",[\"$r\",\"code\",null,{\"children\":\"\\\"欢迎来到 general\\\"\"}],\" 改为 \",[\"$r\",\"code\",null,{\"children\":\"\\\"欢迎来到 travel\\\"\"}],\"。\"]}],[\"$r\",\"p\",null,{\"children\":\"第三次渲染的 Effect 如下所示：\"}],[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"children\":\"  // 第三次渲染时的 Effect（roomId 为 \\\"travel\\\"）\\r\\n  () =\u003e {\\r\\n    const connection = createConnection('travel');\\r\\n    connection.connect();\\r\\n    return () =\u003e connection.disconnect();\\r\\n  },\\r\\n  // 第三次渲染时的依赖项（roomId 为 \\\"travel\\\"）\\r\\n  ['travel']\\n\"}]}],[\"$r\",\"p\",null,{\"children\":[\"React 将第三次渲染时的 \",[\"$r\",\"code\",null,{\"children\":\"['travel']\"}],\" 与第二次渲染时的 \",[\"$r\",\"code\",null,{\"children\":\"['general']\"}],\" 相比较。发现依赖项不同：\",[\"$r\",\"code\",null,{\"children\":\"Object.is('travel', 'general')\"}],\" 为 \",[\"$r\",\"code\",null,{\"children\":\"false\"}],\"。因此 Effect 不能被跳过。\"]}],[\"$r\",\"p\",null,{\"children\":[[\"$r\",\"strong\",null,{\"children\":\"在 React 执行第三次渲染的 Effect 之前，它需要清理上一个运行的 Effect\"}],\"。第二次渲染的 Effect 被跳过了。所以 React 需要清理第一次渲染时的 Effect。如果你回看第一次渲染，你会发现第一次渲染时的清理函数所做的事，是在 \",[\"$r\",\"code\",null,{\"children\":\"createConnection('general')\"}],\" 所创建的连接上调用 \",[\"$r\",\"code\",null,{\"children\":\"disconnect()\"}],\"。也就是从 \",[\"$r\",\"code\",null,{\"children\":\"'general'\"}],\" 聊天室断开连接。\"]}],[\"$r\",\"p\",null,{\"children\":[\"之后，React 执行第三次渲染的 Effect。它连接到 \",[\"$r\",\"code\",null,{\"children\":\"'travel'\"}],\" 聊天室。\"]}],[\"$r\",\"h4\",null,{\"id\":\"unmount\",\"children\":\"组件卸载 \"}],[\"$r\",\"p\",null,{\"children\":[\"最后，假设用户离开了当前页面，\",[\"$r\",\"code\",null,{\"children\":\"ChatRoom\"}],\" 组件被卸载。React 执行上一个运行的 Effect 的清理函数，也就是第三次渲染时的 Effect。这个清理函数会销毁 \",[\"$r\",\"code\",null,{\"children\":\"createConnection('travel')\"}],\" 所创建的连接。这样，应用与 \",[\"$r\",\"code\",null,{\"children\":\"travel\"}],\" 房间断开了连接。\"]}],[\"$r\",\"h4\",null,{\"id\":\"development-only-behaviors\",\"children\":\"仅开发环境下的行为 \"}],[\"$r\",\"p\",null,{\"children\":[\"开启 \",[\"$r\",\"a\",null,{\"href\":\"/reference/react/StrictMode\",\"children\":\"严格模式\"}],\" 时，React 在每次挂载组件后都会重新挂载组件（组件的 state 与 创建的 DOM 都会被保留）。\",[\"$r\",\"a\",null,{\"href\":\"#step-3-add-cleanup-if-needed\",\"children\":\"它可以帮助你找出需要添加清理函数的 Effect\"}],\"，并在早期暴露类似竞态条件这样的 bug。此外，每当你在开发环境中保存文件时，React 也会重新挂载 Effect。这些行为都仅限于开发环境。\"]}]]}],\"\\n\",[\"$r\",\"Recap\",null,{\"children\":[\"$r\",\"ul\",null,{\"children\":[\"\\n\",[\"$r\",\"li\",null,{\"children\":\"与事件不同，Effect 由渲染本身引起，而非特定的交互。\"}],\"\\n\",[\"$r\",\"li\",null,{\"children\":\"Effect 允许你将组件与某些外部系统（第三方 API、网络等）同步。\"}],\"\\n\",[\"$r\",\"li\",null,{\"children\":\"默认情况下，Effect 在每次渲染（包括初始渲染）后运行。\"}],\"\\n\",[\"$r\",\"li\",null,{\"children\":\"如果所有依赖项都与上一次渲染时相同，React 会跳过本次 Effect。\"}],\"\\n\",[\"$r\",\"li\",null,{\"children\":\"你不能“选择”依赖项，它们是由 Effect 内部的代码所决定的。\"}],\"\\n\",[\"$r\",\"li\",null,{\"children\":[\"空的依赖数组（\",[\"$r\",\"code\",null,{\"children\":\"[]\"}],\"）对应于组件的“挂载”，即组件被添加到页面上时。\"]}],\"\\n\",[\"$r\",\"li\",null,{\"children\":\"仅在严格模式下的开发环境中，React 会挂载两次组件，以对 Effect 进行压力测试。\"}],\"\\n\",[\"$r\",\"li\",null,{\"children\":\"如果你的 Effect 因为重新挂载而出现问题，那么你需要实现一个清理函数。\"}],\"\\n\",[\"$r\",\"li\",null,{\"children\":\"React 会在 Effect 再次运行之前和在组件卸载时调用你的清理函数。\"}],\"\\n\"]}]}],\"\\n\"]}],[\"$r\",\"Challenges\",null,{\"children\":[[\"$r\",\"h4\",null,{\"id\":\"focus-a-field-on-mount\",\"children\":\"挂载后聚焦于表单字段 \"}],[\"$r\",\"p\",null,{\"children\":[\"在下面的例子中，表单中渲染了一个 \",[\"$r\",\"code\",null,{\"children\":\"\u003cMyInput /\u003e\"}],\" 组件。\"]}],[\"$r\",\"p\",null,{\"children\":[\"使用输入框的 \",[\"$r\",\"a\",null,{\"href\":\"https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLElement/focus\",\"target\":\"_blank\",\"rel\":\"nofollow noopener noreferrer\",\"children\":[\"$r\",\"code\",null,{\"children\":\"focus()\"}]}],\" 方法，让 \",[\"$r\",\"code\",null,{\"children\":\"MyInput\"}],\" 在页面上出现时自动聚焦。已经有一个被注释掉的实现，但它并不能正常工作。找出它为什么不起作用，并修复它。如果你熟悉 \",[\"$r\",\"code\",null,{\"children\":\"autoFocus\"}],\" 属性，请假装它不存在：我们正在从头开始实现相同的功能。\"]}],[\"$r\",\"Sandpack\",null,{\"children\":[[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"meta\":\"src/MyInput.js active\",\"children\":\"import { useEffect, useRef } from 'react';\\r\\n\\r\\nexport default function MyInput({ value, onChange }) {\\r\\n  const ref = useRef(null);\\r\\n\\r\\n  // TODO：下面的这种做法不会生效，请修复。\\r\\n  // ref.current.focus()    \\r\\n\\r\\n  return (\\r\\n    \u003cinput\\r\\n      ref={ref}\\r\\n      value={value}\\r\\n      onChange={onChange}\\r\\n    /\u003e\\r\\n  );\\r\\n}\\n\"}]}],[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"meta\":\"src/App.js hidden\",\"children\":\"import { useState } from 'react';\\r\\nimport MyInput from './MyInput.js';\\r\\n\\r\\nexport default function Form() {\\r\\n  const [show, setShow] = useState(false);\\r\\n  const [name, setName] = useState('Taylor');\\r\\n  const [upper, setUpper] = useState(false);\\r\\n  return (\\r\\n    \u003c\u003e\\r\\n      \u003cbutton onClick={() =\u003e setShow(s =\u003e !s)}\u003e{show ? '隐藏' : '展示'}表单\u003c/button\u003e\\r\\n      \u003cbr /\u003e\\r\\n      \u003chr /\u003e\\r\\n      {show \u0026\u0026 (\\r\\n        \u003c\u003e\\r\\n          \u003clabel\u003e\\r\\n            输入你的姓名：\\r\\n            \u003cMyInput\\r\\n              value={name}\\r\\n              onChange={e =\u003e setName(e.target.value)}\\r\\n            /\u003e\\r\\n          \u003c/label\u003e\\r\\n          \u003clabel\u003e\\r\\n            \u003cinput\\r\\n              type=\\\"checkbox\\\"\\r\\n              checked={upper}\\r\\n              onChange={e =\u003e setUpper(e.target.checked)}\\r\\n            /\u003e\\r\\n            大写\\r\\n          \u003c/label\u003e\\r\\n          \u003cp\u003e你好， \u003cb\u003e{upper ? name.toUpperCase() : name}\u003c/b\u003e\u003c/p\u003e\\r\\n        \u003c/\u003e\\r\\n      )}\\r\\n    \u003c/\u003e\\r\\n  );\\r\\n}\\n\"}]}],[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-css\",\"children\":\"label {\\r\\n  display: block;\\r\\n  margin-top: 20px;\\r\\n  margin-bottom: 20px;\\r\\n}\\r\\n\\r\\nbody {\\r\\n  min-height: 150px;\\r\\n}\\n\"}]}]]}],[\"$r\",\"p\",null,{\"children\":\"要验证你的方法是否奏效，请点击“展示表单”，并确认输入框获得焦点（高亮显示并且光标位于内部）；再次点击“隐藏表单”和“展示表单”，确认输入框是否再次被高亮显示。\"}],[\"$r\",\"p\",null,{\"children\":[[\"$r\",\"code\",null,{\"children\":\"MyInput\"}],\" 组件应该只在 \",[\"$r\",\"strong\",null,{\"children\":\"挂载\"}],\" 时获得焦点，而非每次渲染后。为了验证这一行为是否正确，点击“展示表单”，然后反复点击“大写”的复选框。点击复选框时，上方的输入框不应该获得焦点。\"]}],[\"$r\",\"Solution\",null,{\"children\":[[\"$r\",\"p\",null,{\"children\":[\"在渲染期间调用 \",[\"$r\",\"code\",null,{\"children\":\"ref.current.focus()\"}],\" 是错误的。因为它是一个“副作用”。副作用应该放在事件处理程序中或通过 \",[\"$r\",\"code\",null,{\"children\":\"useEffect\"}],\" 来声明。在这里，这个副作用是由组件渲染引起的，而不是任何特定的交互引起的，因此应该将它放在 Effect 中。\"]}],[\"$r\",\"p\",null,{\"children\":[\"要修复这个错误，需要将 \",[\"$r\",\"code\",null,{\"children\":\"ref.current.focus()\"}],\" 调用包裹在 Effect 中。然后，为了确保这个 Effect 只在组件挂载时运行，而不是每一轮渲染后都运行，再添加一个空的依赖数组 \",[\"$r\",\"code\",null,{\"children\":\"[]\"}],\"。\"]}],[\"$r\",\"Sandpack\",null,{\"children\":[[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"meta\":\"src/MyInput.js active\",\"children\":\"import { useEffect, useRef } from 'react';\\r\\n\\r\\nexport default function MyInput({ value, onChange }) {\\r\\n  const ref = useRef(null);\\r\\n\\r\\n  useEffect(() =\u003e {\\r\\n    ref.current.focus();\\r\\n  }, []);\\r\\n\\r\\n  return (\\r\\n    \u003cinput\\r\\n      ref={ref}\\r\\n      value={value}\\r\\n      onChange={onChange}\\r\\n    /\u003e\\r\\n  );\\r\\n}\\n\"}]}],[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"meta\":\"src/App.js hidden\",\"children\":\"import { useState } from 'react';\\r\\nimport MyInput from './MyInput.js';\\r\\n\\r\\nexport default function Form() {\\r\\n  const [show, setShow] = useState(false);\\r\\n  const [name, setName] = useState('Taylor');\\r\\n  const [upper, setUpper] = useState(false);\\r\\n  return (\\r\\n    \u003c\u003e\\r\\n      \u003cbutton onClick={() =\u003e setShow(s =\u003e !s)}\u003e{show ? '隐藏' : '展示'}表单\u003c/button\u003e\\r\\n      \u003cbr /\u003e\\r\\n      \u003chr /\u003e\\r\\n      {show \u0026\u0026 (\\r\\n        \u003c\u003e\\r\\n          \u003clabel\u003e\\r\\n            输入你的姓名：\\r\\n            \u003cMyInput\\r\\n              value={name}\\r\\n              onChange={e =\u003e setName(e.target.value)}\\r\\n            /\u003e\\r\\n          \u003c/label\u003e\\r\\n          \u003clabel\u003e\\r\\n            \u003cinput\\r\\n              type=\\\"checkbox\\\"\\r\\n              checked={upper}\\r\\n              onChange={e =\u003e setUpper(e.target.checked)}\\r\\n            /\u003e\\r\\n            大写\\r\\n          \u003c/label\u003e\\r\\n          \u003cp\u003e你好，\u003cb\u003e{upper ? name.toUpperCase() : name}\u003c/b\u003e\u003c/p\u003e\\r\\n        \u003c/\u003e\\r\\n      )}\\r\\n    \u003c/\u003e\\r\\n  );\\r\\n}\\n\"}]}],[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-css\",\"children\":\"label {\\r\\n  display: block;\\r\\n  margin-top: 20px;\\r\\n  margin-bottom: 20px;\\r\\n}\\r\\n\\r\\nbody {\\r\\n  min-height: 150px;\\r\\n}\\n\"}]}]]}]]}],[\"$r\",\"h4\",null,{\"id\":\"focus-a-field-conditionally\",\"children\":\"有条件地聚焦于表单字段 \"}],[\"$r\",\"p\",null,{\"children\":[\"下面的表单渲染两个 \",[\"$r\",\"code\",null,{\"children\":\"\u003cMyInput /\u003e\"}],\" 组件。\"]}],[\"$r\",\"p\",null,{\"children\":[\"点击“展示表单”后，注意第二个输入框会自动获取焦点。这是因为两个 \",[\"$r\",\"code\",null,{\"children\":\"\u003cMyInput /\u003e\"}],\" 组件在内部抢占焦点。当你连续为两个输入框调用 \",[\"$r\",\"code\",null,{\"children\":\"focus()\"}],\" 时，最后一个总会“获胜”。\"]}],[\"$r\",\"p\",null,{\"children\":[\"假设你希望聚焦于第一个输入框。现在，第一个 \",[\"$r\",\"code\",null,{\"children\":\"MyInput\"}],\" 组件接收一个布尔类型的 \",[\"$r\",\"code\",null,{\"children\":\"shouldFocus\"}],\" 属性，且值设置为 \",[\"$r\",\"code\",null,{\"children\":\"true\"}],\"。请修改程序逻辑，使得仅当 \",[\"$r\",\"code\",null,{\"children\":\"MyInput\"}],\" 接收到的 \",[\"$r\",\"code\",null,{\"children\":\"shouldFocus\"}],\" 属性为 \",[\"$r\",\"code\",null,{\"children\":\"true\"}],\" 时才调用 \",[\"$r\",\"code\",null,{\"children\":\"focus()\"}],\" 。\"]}],[\"$r\",\"Sandpack\",null,{\"children\":[[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"meta\":\"src/MyInput.js active\",\"children\":\"import { useEffect, useRef } from 'react';\\r\\n\\r\\nexport default function MyInput({ shouldFocus, value, onChange }) {\\r\\n  const ref = useRef(null);\\r\\n\\r\\n  // TODO：只在 shouldFocus 为 true 时才调用 focus()\\r\\n  useEffect(() =\u003e {\\r\\n    ref.current.focus();\\r\\n  }, []);\\r\\n\\r\\n  return (\\r\\n    \u003cinput\\r\\n      ref={ref}\\r\\n      value={value}\\r\\n      onChange={onChange}\\r\\n    /\u003e\\r\\n  );\\r\\n}\\n\"}]}],[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"meta\":\"src/App.js hidden\",\"children\":\"import { useState } from 'react';\\r\\nimport MyInput from './MyInput.js';\\r\\n\\r\\nexport default function Form() {\\r\\n  const [show, setShow] = useState(false);\\r\\n  const [firstName, setFirstName] = useState('Taylor');\\r\\n  const [lastName, setLastName] = useState('Swift');\\r\\n  const [upper, setUpper] = useState(false);\\r\\n  const name = firstName + ' ' + lastName;\\r\\n  return (\\r\\n    \u003c\u003e\\r\\n      \u003cbutton onClick={() =\u003e setShow(s =\u003e !s)}\u003e{show ? '隐藏' : '展示'}表单\u003c/button\u003e\\r\\n      \u003cbr /\u003e\\r\\n      \u003chr /\u003e\\r\\n      {show \u0026\u0026 (\\r\\n        \u003c\u003e\\r\\n          \u003clabel\u003e\\r\\n            输入你的名：\\r\\n            \u003cMyInput\\r\\n              value={firstName}\\r\\n              onChange={e =\u003e setFirstName(e.target.value)}\\r\\n              shouldFocus={true}\\r\\n            /\u003e\\r\\n          \u003c/label\u003e\\r\\n          \u003clabel\u003e\\r\\n            输入你的姓：\\r\\n            \u003cMyInput\\r\\n              value={lastName}\\r\\n              onChange={e =\u003e setLastName(e.target.value)}\\r\\n              shouldFocus={false}\\r\\n            /\u003e\\r\\n          \u003c/label\u003e\\r\\n          \u003cp\u003e你好，\u003cb\u003e{upper ? name.toUpperCase() : name}\u003c/b\u003e\u003c/p\u003e\\r\\n        \u003c/\u003e\\r\\n      )}\\r\\n    \u003c/\u003e\\r\\n  );\\r\\n}\\n\"}]}],[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-css\",\"children\":\"label {\\r\\n  display: block;\\r\\n  margin-top: 20px;\\r\\n  margin-bottom: 20px;\\r\\n}\\r\\n\\r\\nbody {\\r\\n  min-height: 150px;\\r\\n}\\n\"}]}]]}],[\"$r\",\"p\",null,{\"children\":[\"要验证你的方法是否奏效，请重复点击“展示表单”和“隐藏表单”。当表单显示时，只有第一个输入框该获得焦点。因为父组件在渲染第一个输入框时传入了 \",[\"$r\",\"code\",null,{\"children\":\"shouldFocus={true}\"}],\"，而渲染第二个输入框时传入了 \",[\"$r\",\"code\",null,{\"children\":\"shouldFocus={false}\"}],\"。同时，请确认两个输入框都能正常工作并且你都能在其中输入。\"]}],[\"$r\",\"Hint\",null,{\"children\":[\"$r\",\"p\",null,{\"children\":\"你不能有条件地声明 Effect，但你的 Effect 中可以包含条件逻辑。\"}]}],[\"$r\",\"Solution\",null,{\"children\":[[\"$r\",\"p\",null,{\"children\":[\"在 Effect 中加入条件逻辑。由于你在 Effect 中使用了 \",[\"$r\",\"code\",null,{\"children\":\"shouldFocus\"}],\"，因此需要将它指定为依赖项。这意味着如果某个输入框的 \",[\"$r\",\"code\",null,{\"children\":\"shouldFocus\"}],\" 由 \",[\"$r\",\"code\",null,{\"children\":\"false\"}],\" 变为 \",[\"$r\",\"code\",null,{\"children\":\"true\"}],\"，它将在挂载后获得焦点。\"]}],[\"$r\",\"Sandpack\",null,{\"children\":[[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"meta\":\"src/MyInput.js active\",\"children\":\"import { useEffect, useRef } from 'react';\\r\\n\\r\\nexport default function MyInput({ shouldFocus, value, onChange }) {\\r\\n  const ref = useRef(null);\\r\\n\\r\\n  useEffect(() =\u003e {\\r\\n    if (shouldFocus) {\\r\\n      ref.current.focus();\\r\\n    }\\r\\n  }, [shouldFocus]);\\r\\n\\r\\n  return (\\r\\n    \u003cinput\\r\\n      ref={ref}\\r\\n      value={value}\\r\\n      onChange={onChange}\\r\\n    /\u003e\\r\\n  );\\r\\n}\\n\"}]}],[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"meta\":\"src/App.js hidden\",\"children\":\"import { useState } from 'react';\\r\\nimport MyInput from './MyInput.js';\\r\\n\\r\\nexport default function Form() {\\r\\n  const [show, setShow] = useState(false);\\r\\n  const [firstName, setFirstName] = useState('Taylor');\\r\\n  const [lastName, setLastName] = useState('Swift');\\r\\n  const [upper, setUpper] = useState(false);\\r\\n  const name = firstName + ' ' + lastName;\\r\\n  return (\\r\\n    \u003c\u003e\\r\\n      \u003cbutton onClick={() =\u003e setShow(s =\u003e !s)}\u003e{show ? '隐藏' : '展示'}表单\u003c/button\u003e\\r\\n      \u003cbr /\u003e\\r\\n      \u003chr /\u003e\\r\\n      {show \u0026\u0026 (\\r\\n        \u003c\u003e\\r\\n          \u003clabel\u003e\\r\\n            输入你的名：\\r\\n            \u003cMyInput\\r\\n              value={firstName}\\r\\n              onChange={e =\u003e setFirstName(e.target.value)}\\r\\n              shouldFocus={true}\\r\\n            /\u003e\\r\\n          \u003c/label\u003e\\r\\n          \u003clabel\u003e\\r\\n            输入你的姓：\\r\\n            \u003cMyInput\\r\\n              value={lastName}\\r\\n              onChange={e =\u003e setLastName(e.target.value)}\\r\\n              shouldFocus={false}\\r\\n            /\u003e\\r\\n          \u003c/label\u003e\\r\\n          \u003cp\u003e你好，\u003cb\u003e{upper ? name.toUpperCase() : name}\u003c/b\u003e\u003c/p\u003e\\r\\n        \u003c/\u003e\\r\\n      )}\\r\\n    \u003c/\u003e\\r\\n  );\\r\\n}\\n\"}]}],[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-css\",\"children\":\"label {\\r\\n  display: block;\\r\\n  margin-top: 20px;\\r\\n  margin-bottom: 20px;\\r\\n}\\r\\n\\r\\nbody {\\r\\n  min-height: 150px;\\r\\n}\\n\"}]}]]}]]}],[\"$r\",\"h4\",null,{\"id\":\"fix-an-interval-that-fires-twice\",\"children\":\"修复会触发两次的定时器 \"}],[\"$r\",\"p\",null,{\"children\":[\"这个 \",[\"$r\",\"code\",null,{\"children\":\"Counter\"}],\" 组件展示了一个每秒递增的计数器。在组件挂载时，它调用了 \",[\"$r\",\"a\",null,{\"href\":\"https://developer.mozilla.org/zh-CN/docs/Web/API/setInterval\",\"target\":\"_blank\",\"rel\":\"nofollow noopener noreferrer\",\"children\":[\"$r\",\"code\",null,{\"children\":\"setInterval\"}]}],\"。这使得 \",[\"$r\",\"code\",null,{\"children\":\"onTick\"}],\" 每秒运行一次。\",[\"$r\",\"code\",null,{\"children\":\"onTick\"}],\" 函数会递增计数器。\"]}],[\"$r\",\"p\",null,{\"children\":\"然而，计数器不是每秒递增一次，而是两次。这是为什么呢？找出 bug 的原因并修复它。\"}],[\"$r\",\"Hint\",null,{\"children\":[\"$r\",\"p\",null,{\"children\":[\"请记住，\",[\"$r\",\"code\",null,{\"children\":\"setInterval\"}],\" 返回一个 interval ID，你可以将它传递给 \",[\"$r\",\"a\",null,{\"href\":\"https://developer.mozilla.org/zh-CN/docs/Web/API/clearInterval\",\"target\":\"_blank\",\"rel\":\"nofollow noopener noreferrer\",\"children\":[\"$r\",\"code\",null,{\"children\":\"clearInterval\"}]}],\" 来停止这个定时器。\"]}]}],[\"$r\",\"Sandpack\",null,{\"children\":[[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"meta\":\"src/Counter.js active\",\"children\":\"import { useState, useEffect } from 'react';\\r\\n\\r\\nexport default function Counter() {\\r\\n  const [count, setCount] = useState(0);\\r\\n\\r\\n  useEffect(() =\u003e {\\r\\n    function onTick() {\\r\\n      setCount(c =\u003e c + 1);\\r\\n    }\\r\\n\\r\\n    setInterval(onTick, 1000);\\r\\n  }, []);\\r\\n\\r\\n  return \u003ch1\u003e{count}\u003c/h1\u003e;\\r\\n}\\n\"}]}],[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"meta\":\"src/App.js hidden\",\"children\":\"import { useState } from 'react';\\r\\nimport Counter from './Counter.js';\\r\\n\\r\\nexport default function Form() {\\r\\n  const [show, setShow] = useState(false);\\r\\n  return (\\r\\n    \u003c\u003e\\r\\n      \u003cbutton onClick={() =\u003e setShow(s =\u003e !s)}\u003e{show ? '隐藏' : '展示'}计数器\u003c/button\u003e\\r\\n      \u003cbr /\u003e\\r\\n      \u003chr /\u003e\\r\\n      {show \u0026\u0026 \u003cCounter /\u003e}\\r\\n    \u003c/\u003e\\r\\n  );\\r\\n}\\n\"}]}],[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-css\",\"children\":\"label {\\r\\n  display: block;\\r\\n  margin-top: 20px;\\r\\n  margin-bottom: 20px;\\r\\n}\\r\\n\\r\\nbody {\\r\\n  min-height: 150px;\\r\\n}\\n\"}]}]]}],[\"$r\",\"Solution\",null,{\"children\":[[\"$r\",\"p\",null,{\"children\":[\"当开启 \",[\"$r\",\"a\",null,{\"href\":\"/reference/react/StrictMode\",\"children\":\"严格模式\"}],\" 时（例如在本站的示例沙盒（sandbox）中），React 在开发环境中会将每个组件重新挂载一次。这使得计数器组件被挂载了两次，于是定时器也被设置了两次，因此计数器会每秒增加两次。\"]}],[\"$r\",\"p\",null,{\"children\":\"然而，React 的行为并不是导致这个 bug 的根本原因：代码中本就存在这个 bug。React 的行为只是让这个 bug 更加明显。真正的原因是这个 Effect 开启了一个进程但没有提供清理它的方式。\"}],[\"$r\",\"p\",null,{\"children\":[\"要修复这段代码，保存 \",[\"$r\",\"code\",null,{\"children\":\"setInterval\"}],\" 返回的 interval ID，并使用 \",[\"$r\",\"a\",null,{\"href\":\"https://developer.mozilla.org/zh-CN/docs/Web/API/clearInterval\",\"target\":\"_blank\",\"rel\":\"nofollow noopener noreferrer\",\"children\":[\"$r\",\"code\",null,{\"children\":\"clearInterval\"}]}],\" 实现一个清理函数：\"]}],[\"$r\",\"Sandpack\",null,{\"children\":[[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"meta\":\"src/Counter.js active\",\"children\":\"import { useState, useEffect } from 'react';\\r\\n\\r\\nexport default function Counter() {\\r\\n  const [count, setCount] = useState(0);\\r\\n\\r\\n  useEffect(() =\u003e {\\r\\n    function onTick() {\\r\\n      setCount(c =\u003e c + 1);\\r\\n    }\\r\\n\\r\\n    const intervalId = setInterval(onTick, 1000);\\r\\n    return () =\u003e clearInterval(intervalId);\\r\\n  }, []);\\r\\n\\r\\n  return \u003ch1\u003e{count}\u003c/h1\u003e;\\r\\n}\\n\"}]}],[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"meta\":\"src/App.js hidden\",\"children\":\"import { useState } from 'react';\\r\\nimport Counter from './Counter.js';\\r\\n\\r\\nexport default function App() {\\r\\n  const [show, setShow] = useState(false);\\r\\n  return (\\r\\n    \u003c\u003e\\r\\n      \u003cbutton onClick={() =\u003e setShow(s =\u003e !s)}\u003e{show ? '隐藏' : '展示'}计数器\u003c/button\u003e\\r\\n      \u003cbr /\u003e\\r\\n      \u003chr /\u003e\\r\\n      {show \u0026\u0026 \u003cCounter /\u003e}\\r\\n    \u003c/\u003e\\r\\n  );\\r\\n}\\n\"}]}],[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-css\",\"children\":\"label {\\r\\n  display: block;\\r\\n  margin-top: 20px;\\r\\n  margin-bottom: 20px;\\r\\n}\\r\\n\\r\\nbody {\\r\\n  min-height: 150px;\\r\\n}\\n\"}]}]]}],[\"$r\",\"p\",null,{\"children\":[\"在开发环境中，React 仍然会重新挂载一次你的组件，以确保你已经正确地实现了清理函数。因此，在调用 \",[\"$r\",\"code\",null,{\"children\":\"setInterval\"}],\" 后会紧接着调用 \",[\"$r\",\"code\",null,{\"children\":\"clearInterval\"}],\"，然后再调用 \",[\"$r\",\"code\",null,{\"children\":\"setInterval\"}],\"。在生产环境中，则只调用一次 \",[\"$r\",\"code\",null,{\"children\":\"setInterval\"}],\"。两种情况下用户可见的行为都是相同的：计数器每秒递增一次。\"]}]]}],[\"$r\",\"h4\",null,{\"id\":\"fix-fetching-inside-an-effect\",\"children\":\"解决在 Effect 中获取数据的问题 \"}],[\"$r\",\"p\",null,{\"children\":[\"下面这个组件显示所选人物的传记。它在挂载时和每当 \",[\"$r\",\"code\",null,{\"children\":\"person\"}],\" 改变时，通过调用一个异步函数 \",[\"$r\",\"code\",null,{\"children\":\"fetchBio(person)\"}],\" 来加载传记。该异步函数返回一个 \",[\"$r\",\"a\",null,{\"href\":\"https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise\",\"target\":\"_blank\",\"rel\":\"nofollow noopener noreferrer\",\"children\":\"Promise\"}],\"，最终解析为一个字符串。当请求结束时，它调用 \",[\"$r\",\"code\",null,{\"children\":\"setBio\"}],\" 以将该字符串显示在选择框下方。\"]}],[\"$r\",\"Sandpack\",null,{\"children\":[[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"meta\":\"src/App.js\",\"children\":\"import { useState, useEffect } from 'react';\\r\\nimport { fetchBio } from './api.js';\\r\\n\\r\\nexport default function Page() {\\r\\n  const [person, setPerson] = useState('Alice');\\r\\n  const [bio, setBio] = useState(null);\\r\\n\\r\\n  useEffect(() =\u003e {\\r\\n    setBio(null);\\r\\n    fetchBio(person).then(result =\u003e {\\r\\n      setBio(result);\\r\\n    });\\r\\n  }, [person]);\\r\\n\\r\\n  return (\\r\\n    \u003c\u003e\\r\\n      \u003cselect value={person} onChange={e =\u003e {\\r\\n        setPerson(e.target.value);\\r\\n      }}\u003e\\r\\n        \u003coption value=\\\"Alice\\\"\u003eAlice\u003c/option\u003e\\r\\n        \u003coption value=\\\"Bob\\\"\u003eBob\u003c/option\u003e\\r\\n        \u003coption value=\\\"Taylor\\\"\u003eTaylor\u003c/option\u003e\\r\\n      \u003c/select\u003e\\r\\n      \u003chr /\u003e\\r\\n      \u003cp\u003e\u003ci\u003e{bio ?? '加载中……'}\u003c/i\u003e\u003c/p\u003e\\r\\n    \u003c/\u003e\\r\\n  );\\r\\n}\\n\"}]}],[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"meta\":\"src/api.js hidden\",\"children\":\"export async function fetchBio(person) {\\r\\n  const delay = person === 'Bob' ? 2000 : 200;\\r\\n  return new Promise(resolve =\u003e {\\r\\n    setTimeout(() =\u003e {\\r\\n      resolve('这是' + person + '的传记。');\\r\\n    }, delay);\\r\\n  })\\r\\n}\\r\\n\\n\"}]}]]}],[\"$r\",\"p\",null,{\"children\":[\"这段代码中有一个 bug。试试先选择 \",[\"$r\",\"code\",null,{\"children\":\"Alice\"}],\"，再选择 \",[\"$r\",\"code\",null,{\"children\":\"Bob\"}],\"，接着立即选择 \",[\"$r\",\"code\",null,{\"children\":\"Taylor\"}],\"。如果操作得足够快，你会观察到这个 bug：虽然 Taylor 被选中了，但下面的一段却说：“这是 Bob 的传记。”\"]}],[\"$r\",\"p\",null,{\"children\":\"为什么会出现这种情况？试试修复这个 Effect 中的 bug。\"}],[\"$r\",\"Hint\",null,{\"children\":[\"$r\",\"p\",null,{\"children\":\"如果 Effect 需要异步获取某些数据，它往往需要清理函数。\"}]}],[\"$r\",\"Solution\",null,{\"children\":[[\"$r\",\"p\",null,{\"children\":\"要触发这个 bug，事情需要按以下顺序发生：\"}],[\"$r\",\"ul\",null,{\"children\":[\"\\n\",[\"$r\",\"li\",null,{\"children\":[\"选中 \",[\"$r\",\"code\",null,{\"children\":\"'Bob'\"}],\" 触发 \",[\"$r\",\"code\",null,{\"children\":\"fetchBio('Bob')\"}]]}],\"\\n\",[\"$r\",\"li\",null,{\"children\":[\"选中 \",[\"$r\",\"code\",null,{\"children\":\"'Taylor'\"}],\" 触发 \",[\"$r\",\"code\",null,{\"children\":\"fetchBio('Taylor')\"}]]}],\"\\n\",[\"$r\",\"li\",null,{\"children\":[\"$r\",\"strong\",null,{\"children\":[[\"$r\",\"code\",null,{\"children\":\"fetchBio('Taylor')\"}],\" 在 \",[\"$r\",\"code\",null,{\"children\":\"fetchBio('Bob')\"}],\" 之前完成。\"]}]}],\"\\n\",[\"$r\",\"li\",null,{\"children\":[\"渲染 \",[\"$r\",\"code\",null,{\"children\":\"'Taylor'\"}],\" 时的 Effect 调用 \",[\"$r\",\"code\",null,{\"children\":\"setBio('这是Taylor的传记')\"}]]}],\"\\n\",[\"$r\",\"li\",null,{\"children\":[[\"$r\",\"code\",null,{\"children\":\"fetchBio('Bob')\"}],\" 请求完成\"]}],\"\\n\",[\"$r\",\"li\",null,{\"children\":[\"渲染 \",[\"$r\",\"code\",null,{\"children\":\"'Bob'\"}],\" 时的 Effect 调用 \",[\"$r\",\"code\",null,{\"children\":\"setBio('这是Bob的传记')\"}]]}],\"\\n\"]}],[\"$r\",\"p\",null,{\"children\":[\"这就是为什么即使选择了 Taylor，但显示的仍然是 Bob 的传记。像这样的 bug 被称为 \",[\"$r\",\"a\",null,{\"href\":\"https://en.wikipedia.org/wiki/Race_condition\",\"target\":\"_blank\",\"rel\":\"nofollow noopener noreferrer\",\"children\":\"竞态条件\"}],\"，因为两个异步操作在“竞速”，并且可能会以意外的顺序完成。\"]}],[\"$r\",\"p\",null,{\"children\":\"要修复这个 bug，添加一个清理函数：\"}],[\"$r\",\"Sandpack\",null,{\"children\":[[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"meta\":\"src/App.js\",\"children\":\"import { useState, useEffect } from 'react';\\r\\nimport { fetchBio } from './api.js';\\r\\n\\r\\nexport default function Page() {\\r\\n  const [person, setPerson] = useState('Alice');\\r\\n  const [bio, setBio] = useState(null);\\r\\n  useEffect(() =\u003e {\\r\\n    let ignore = false;\\r\\n    setBio(null);\\r\\n    fetchBio(person).then(result =\u003e {\\r\\n      if (!ignore) {\\r\\n        setBio(result);\\r\\n      }\\r\\n    });\\r\\n    return () =\u003e {\\r\\n      ignore = true;\\r\\n    }\\r\\n  }, [person]);\\r\\n\\r\\n  return (\\r\\n    \u003c\u003e\\r\\n      \u003cselect value={person} onChange={e =\u003e {\\r\\n        setPerson(e.target.value);\\r\\n      }}\u003e\\r\\n        \u003coption value=\\\"Alice\\\"\u003eAlice\u003c/option\u003e\\r\\n        \u003coption value=\\\"Bob\\\"\u003eBob\u003c/option\u003e\\r\\n        \u003coption value=\\\"Taylor\\\"\u003eTaylor\u003c/option\u003e\\r\\n      \u003c/select\u003e\\r\\n      \u003chr /\u003e\\r\\n      \u003cp\u003e\u003ci\u003e{bio ?? '加载中……'}\u003c/i\u003e\u003c/p\u003e\\r\\n    \u003c/\u003e\\r\\n  );\\r\\n}\\n\"}]}],[\"$r\",\"pre\",null,{\"children\":[\"$r\",\"code\",null,{\"className\":\"language-js\",\"meta\":\"src/api.js hidden\",\"children\":\"export async function fetchBio(person) {\\r\\n  const delay = person === 'Bob' ? 2000 : 200;\\r\\n  return new Promise(resolve =\u003e {\\r\\n    setTimeout(() =\u003e {\\r\\n      resolve('这是' + person + '的传记。');\\r\\n    }, delay);\\r\\n  })\\r\\n}\\r\\n\\n\"}]}]]}],[\"$r\",\"p\",null,{\"children\":[\"每轮渲染的 Effect 都有其独立的 \",[\"$r\",\"code\",null,{\"children\":\"ignore\"}],\" 变量。最初，\",[\"$r\",\"code\",null,{\"children\":\"ignore\"}],\" 变量被设置为 \",[\"$r\",\"code\",null,{\"children\":\"false\"}],\"。但如果一个 Effect 被清理（例如，当你选择不同的人时），它的 \",[\"$r\",\"code\",null,{\"children\":\"ignore\"}],\" 变量会变为 \",[\"$r\",\"code\",null,{\"children\":\"true\"}],\"。因此，请求完成的顺序已经不再重要。只有最后选中的人的 Effect 的 \",[\"$r\",\"code\",null,{\"children\":\"ignore\"}],\" 变量会是 \",[\"$r\",\"code\",null,{\"children\":\"false\"}],\"，因此它将会调用 \",[\"$r\",\"code\",null,{\"children\":\"setBio(result)\"}],\"。而之前的 Effect 已经被清理，所以 \",[\"$r\",\"code\",null,{\"children\":\"if (!ignore)\"}],\" 的检查会阻止它们调用 \",[\"$r\",\"code\",null,{\"children\":\"setBio\"}],\"：\"]}],[\"$r\",\"ul\",null,{\"children\":[\"\\n\",[\"$r\",\"li\",null,{\"children\":[\"选中 \",[\"$r\",\"code\",null,{\"children\":\"'Bob'\"}],\" 触发 \",[\"$r\",\"code\",null,{\"children\":\"fetchBio('Bob')\"}]]}],\"\\n\",[\"$r\",\"li\",null,{\"children\":[\"选中 \",[\"$r\",\"code\",null,{\"children\":\"'Taylor'\"}],\" 触发 \",[\"$r\",\"code\",null,{\"children\":\"fetchBio('Taylor')\"}],\"，\",[\"$r\",\"strong\",null,{\"children\":\"并清理之前的（Bob 的） Effect\"}]]}],\"\\n\",[\"$r\",\"li\",null,{\"children\":[[\"$r\",\"code\",null,{\"children\":\"fetchBio('Taylor')\"}],\" 在 \",[\"$r\",\"code\",null,{\"children\":\"fetchBio('Bob')\"}],\" \",[\"$r\",\"strong\",null,{\"children\":\"之前\"}],\" 完成。\"]}],\"\\n\",[\"$r\",\"li\",null,{\"children\":[\"渲染 \",[\"$r\",\"code\",null,{\"children\":\"'Taylor'\"}],\" 时的 Effect 调用 \",[\"$r\",\"code\",null,{\"children\":\"setBio('这是Taylor的传记')\"}]]}],\"\\n\",[\"$r\",\"li\",null,{\"children\":[[\"$r\",\"code\",null,{\"children\":\"fetchBio('Bob')\"}],\" 请求完成\"]}],\"\\n\",[\"$r\",\"li\",null,{\"children\":[\"渲染 \",[\"$r\",\"code\",null,{\"children\":\"'Bob'\"}],\" 时的 Effect 不会做任何事情，因为它的 \",[\"$r\",\"code\",null,{\"children\":\"ignore\"}],\" 变量被设为了 \",[\"$r\",\"code\",null,{\"children\":\"true\"}],\"。\"]}],\"\\n\"]}],[\"$r\",\"p\",null,{\"children\":[\"除了忽略过时 API 调用的结果外，你还可以使用 \",[\"$r\",\"a\",null,{\"href\":\"https://developer.mozilla.org/zh-CN/docs/Web/API/AbortController\",\"target\":\"_blank\",\"rel\":\"nofollow noopener noreferrer\",\"children\":[\"$r\",\"code\",null,{\"children\":\"AbortController\"}]}],\" 来取消不再需要的请求。然而，仅凭这一点还不足以防止竞态条件。因为可能在 fetch 之后还有更多的异步操作，因此使用像 \",[\"$r\",\"code\",null,{\"children\":\"ignore\"}],\" 这样的显式标志是解决这类问题最可靠的方法。\"]}]]}]]}]]","meta":{"title":"使用 Effect 进行同步"},"languages":null},"__N_SSG":true},"page":"/[[...markdownPath]]","query":{"markdownPath":["learn","synchronizing-with-effects"]},"buildId":"o3sV9gi4zL8eH-vfCdLA_","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>